{"version":3,"file":"local-documents-helper.js","names":["newRxError","fillWithDefaultSettings","randomToken","overwritable","LOCAL_DOC_STATE_BY_PARENT","WeakMap","LOCAL_DOC_STATE_BY_PARENT_RESOLVED","getLocalDocStateByParent","parent","statePromise","get","database","collectionName","name","collection","createLocalDocumentStorageInstance","databaseInstanceToken","storage","databaseName","instanceCreationOptions","multiInstance","createStorageInstance","getCollectionLocalInstanceName","schema","RX_LOCAL_DOCUMENT_SCHEMA","options","devMode","isDevMode","closeStateByParent","delete","then","state","storageInstance","close","removeLocalDocumentsStorageInstance","remove","title","version","primaryKey","type","properties","id","maxLength","data","additionalProperties","required"],"sources":["../../../../src/plugins/local-documents/local-documents-helper.ts"],"sourcesContent":["import { newRxError } from '../../rx-error.ts';\nimport { fillWithDefaultSettings } from '../../rx-schema-helper.ts';\nimport type {\n    LocalDocumentParent,\n    LocalDocumentState,\n    RxDatabase,\n    RxDocumentData,\n    RxJsonSchema,\n    RxLocalDocumentData,\n    RxStorage\n} from '../../types/index.d.ts';\nimport { randomToken } from '../../plugins/utils/index.ts';\nimport { overwritable } from '../../overwritable.ts';\n\nexport const LOCAL_DOC_STATE_BY_PARENT: WeakMap<LocalDocumentParent, Promise<LocalDocumentState>> = new WeakMap();\nexport const LOCAL_DOC_STATE_BY_PARENT_RESOLVED: WeakMap<LocalDocumentParent, LocalDocumentState> = new WeakMap();\n\nexport function getLocalDocStateByParent(parent: LocalDocumentParent): Promise<LocalDocumentState> {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (!statePromise) {\n        const database: RxDatabase = parent.database ? parent.database : parent as any;\n        const collectionName = parent.database ? parent.name : '';\n        throw newRxError('LD8', {\n            database: database.name,\n            collection: collectionName\n        });\n    }\n    return statePromise;\n}\n\nexport function createLocalDocumentStorageInstance(\n    databaseInstanceToken: string,\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string,\n    instanceCreationOptions: any,\n    multiInstance: boolean\n) {\n    return storage.createStorageInstance<RxLocalDocumentData>({\n        databaseInstanceToken,\n        databaseName: databaseName,\n        /**\n         * Use a different collection name for the local documents instance\n         * so that the local docs can be kept while deleting the normal instance\n         * after migration.\n         */\n        collectionName: getCollectionLocalInstanceName(collectionName),\n        schema: RX_LOCAL_DOCUMENT_SCHEMA,\n        options: instanceCreationOptions,\n        multiInstance,\n        devMode: overwritable.isDevMode()\n    });\n}\n\nexport function closeStateByParent(parent: LocalDocumentParent) {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (statePromise) {\n        LOCAL_DOC_STATE_BY_PARENT.delete(parent);\n        return statePromise.then(state => state.storageInstance.close());\n    }\n}\n\nexport async function removeLocalDocumentsStorageInstance(\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string\n) {\n    const databaseInstanceToken = randomToken(10);\n    const storageInstance = await createLocalDocumentStorageInstance(\n        databaseInstanceToken,\n        storage,\n        databaseName,\n        collectionName,\n        {},\n        false\n    );\n    await storageInstance.remove();\n}\n\nexport function getCollectionLocalInstanceName(collectionName: string): string {\n    return 'plugin-local-documents-' + collectionName;\n}\n\nexport const RX_LOCAL_DOCUMENT_SCHEMA: RxJsonSchema<RxDocumentData<RxLocalDocumentData>> = fillWithDefaultSettings({\n    title: 'RxLocalDocument',\n    version: 0,\n    primaryKey: 'id',\n    type: 'object',\n    properties: {\n        id: {\n            type: 'string',\n            maxLength: 128\n        },\n        data: {\n            type: 'object',\n            additionalProperties: true\n        }\n    },\n    required: [\n        'id',\n        'data'\n    ]\n});\n"],"mappings":"AAAA,SAASA,UAAU,QAAQ,mBAAmB;AAC9C,SAASC,uBAAuB,QAAQ,2BAA2B;AAUnE,SAASC,WAAW,QAAQ,8BAA8B;AAC1D,SAASC,YAAY,QAAQ,uBAAuB;AAEpD,OAAO,IAAMC,yBAAoF,GAAG,IAAIC,OAAO,CAAC,CAAC;AACjH,OAAO,IAAMC,kCAAoF,GAAG,IAAID,OAAO,CAAC,CAAC;AAEjH,OAAO,SAASE,wBAAwBA,CAACC,MAA2B,EAA+B;EAC/F,IAAMC,YAAY,GAAGL,yBAAyB,CAACM,GAAG,CAACF,MAAM,CAAC;EAC1D,IAAI,CAACC,YAAY,EAAE;IACf,IAAME,QAAoB,GAAGH,MAAM,CAACG,QAAQ,GAAGH,MAAM,CAACG,QAAQ,GAAGH,MAAa;IAC9E,IAAMI,cAAc,GAAGJ,MAAM,CAACG,QAAQ,GAAGH,MAAM,CAACK,IAAI,GAAG,EAAE;IACzD,MAAMb,UAAU,CAAC,KAAK,EAAE;MACpBW,QAAQ,EAAEA,QAAQ,CAACE,IAAI;MACvBC,UAAU,EAAEF;IAChB,CAAC,CAAC;EACN;EACA,OAAOH,YAAY;AACvB;AAEA,OAAO,SAASM,kCAAkCA,CAC9CC,qBAA6B,EAC7BC,OAA4B,EAC5BC,YAAoB,EACpBN,cAAsB,EACtBO,uBAA4B,EAC5BC,aAAsB,EACxB;EACE,OAAOH,OAAO,CAACI,qBAAqB,CAAsB;IACtDL,qBAAqB;IACrBE,YAAY,EAAEA,YAAY;IAC1B;AACR;AACA;AACA;AACA;IACQN,cAAc,EAAEU,8BAA8B,CAACV,cAAc,CAAC;IAC9DW,MAAM,EAAEC,wBAAwB;IAChCC,OAAO,EAAEN,uBAAuB;IAChCC,aAAa;IACbM,OAAO,EAAEvB,YAAY,CAACwB,SAAS,CAAC;EACpC,CAAC,CAAC;AACN;AAEA,OAAO,SAASC,kBAAkBA,CAACpB,MAA2B,EAAE;EAC5D,IAAMC,YAAY,GAAGL,yBAAyB,CAACM,GAAG,CAACF,MAAM,CAAC;EAC1D,IAAIC,YAAY,EAAE;IACdL,yBAAyB,CAACyB,MAAM,CAACrB,MAAM,CAAC;IACxC,OAAOC,YAAY,CAACqB,IAAI,CAACC,KAAK,IAAIA,KAAK,CAACC,eAAe,CAACC,KAAK,CAAC,CAAC,CAAC;EACpE;AACJ;AAEA,OAAO,eAAeC,mCAAmCA,CACrDjB,OAA4B,EAC5BC,YAAoB,EACpBN,cAAsB,EACxB;EACE,IAAMI,qBAAqB,GAAGd,WAAW,CAAC,EAAE,CAAC;EAC7C,IAAM8B,eAAe,GAAG,MAAMjB,kCAAkC,CAC5DC,qBAAqB,EACrBC,OAAO,EACPC,YAAY,EACZN,cAAc,EACd,CAAC,CAAC,EACF,KACJ,CAAC;EACD,MAAMoB,eAAe,CAACG,MAAM,CAAC,CAAC;AAClC;AAEA,OAAO,SAASb,8BAA8BA,CAACV,cAAsB,EAAU;EAC3E,OAAO,yBAAyB,GAAGA,cAAc;AACrD;AAEA,OAAO,IAAMY,wBAA2E,GAAGvB,uBAAuB,CAAC;EAC/GmC,KAAK,EAAE,iBAAiB;EACxBC,OAAO,EAAE,CAAC;EACVC,UAAU,EAAE,IAAI;EAChBC,IAAI,EAAE,QAAQ;EACdC,UAAU,EAAE;IACRC,EAAE,EAAE;MACAF,IAAI,EAAE,QAAQ;MACdG,SAAS,EAAE;IACf,CAAC;IACDC,IAAI,EAAE;MACFJ,IAAI,EAAE,QAAQ;MACdK,oBAAoB,EAAE;IAC1B;EACJ,CAAC;EACDC,QAAQ,EAAE,CACN,IAAI,EACJ,MAAM;AAEd,CAAC,CAAC","ignoreList":[]}