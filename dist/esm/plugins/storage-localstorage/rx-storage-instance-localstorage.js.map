{"version":3,"file":"rx-storage-instance-localstorage.js","names":["Subject","PROMISE_RESOLVE_TRUE","PROMISE_RESOLVE_VOID","ensureNotFalsy","now","toArray","categorizeBulkWriteRows","getPrimaryFieldOfPrimaryKey","getQueryMatcher","getSortComparator","newRxError","getIndexableStringMonad","getStartIndexStringFromLowerBound","getStartIndexStringFromUpperBound","pushAtSortPosition","boundEQ","boundGE","boundGT","boundLE","boundLT","RX_STORAGE_NAME_LOCALSTORAGE","storageEventStream$","storageEventStreamObservable","asObservable","storageEventStreamSubscribed","getStorageEventStream","window","addEventListener","ev","key","next","fromStorageEvent","newValue","instanceId","RxStorageInstanceLocalstorage","storage","databaseName","collectionName","schema","internals","options","settings","multiInstance","databaseInstanceToken","changes$","removed","localStorage","primaryPath","primaryKey","docsKey","version","changestreamStorageKey","indexesKey","changeStreamSub","subscribe","latestChanges","JSON","parse","eventBulk","_proto","prototype","getDoc","docId","docString","getItem","setDoc","doc","setItem","stringify","getIndex","index","indexString","getIndexName","setIndex","value","bulkWrite","documentWrites","context","ret","error","docsInDb","Map","forEach","row","document","set","categorized","errors","indexValues","Object","values","indexes","map","idx","bulkInsertDocs","bulkUpdateDocs","rows","i","indexValue","newIndexString","getIndexableString","insertPosition","sortByIndexStringComparator","previous","previousIndexString","prev","splice","args","indexBefore","compareDocsWithIndex","events","length","lastState","newestRow","checkpoint","id","lwt","_meta","storageItemData","itemString","Promise","resolve","findDocumentsById","docIds","withDeleted","_deleted","push","query","preparedQuery","queryPlan","skip","limit","Infinity","skipPlusLimit","queryMatcher","selectorSatisfiedByIndex","queryPlanFields","mustManuallyResort","sortSatisfiedByIndex","lowerBound","startKeys","lowerBoundString","upperBound","endKeys","upperBoundString","docsWithIndex","indexOfLower","inclusiveStart","indexOfUpper","inclusiveEnd","done","currentRow","currentDoc","sortComparator","sort","slice","documents","count","result","mode","changeStream","cleanup","minimumDeletedTime","_this","maxDeletionTime","CLEANUP_INDEX","_loop","currentIndexRow","currentDocId","removeItem","getAttachmentData","_documentId","_attachmentId","remove","ensureNotRemoved","unsubscribe","firstIndex","indexedDocs","indexName","close","closed","complete","createLocalstorageStorageInstance","params","useIndexes","useIndexesFinal","indexAr","indexId","instance","join","a","b","indexStringA","indexStringB","Error"],"sources":["../../../../src/plugins/storage-localstorage/rx-storage-instance-localstorage.ts"],"sourcesContent":["import { Observable, Subject, Subscription } from 'rxjs';\nimport {\n    PROMISE_RESOLVE_TRUE,\n    PROMISE_RESOLVE_VOID,\n    ensureNotFalsy,\n    now,\n    toArray\n} from '../utils/index.ts';\nimport type {\n    BulkWriteRow,\n    ById,\n    EventBulk,\n    PreparedQuery,\n    QueryMatcher,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxJsonSchema,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageCountResult,\n    RxStorageDefaultCheckpoint,\n    RxStorageInstance,\n    RxStorageInstanceCreationParams,\n    RxStorageQueryResult,\n    StringKeys\n} from '../../types/index';\nimport {\n    categorizeBulkWriteRows\n} from '../../rx-storage-helper.ts';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper.ts';\nimport { getQueryMatcher, getSortComparator } from '../../rx-query-helper.ts';\nimport { newRxError } from '../../rx-error.ts';\nimport type { RxStorageLocalstorage } from './index.ts';\nimport { getIndexableStringMonad, getStartIndexStringFromLowerBound, getStartIndexStringFromUpperBound } from '../../custom-index.ts';\nimport { pushAtSortPosition } from 'array-push-at-sort-position';\nimport { boundEQ, boundGE, boundGT, boundLE, boundLT } from '../storage-memory/binary-search-bounds.ts';\n\nexport const RX_STORAGE_NAME_LOCALSTORAGE = 'localstorage';\n\n\nexport type LocalstorageStorageInternals<RxDocType = any> = {\n    indexes: ById<IndexMeta<RxDocType>>;\n};\n\nexport type LocalstorageInstanceCreationOptions = {};\n\nexport type LocalstorageStorageSettings = {\n    localStorage?: typeof localStorage\n};\n\n// index-string to doc-id mapped\nexport type LocalstorageIndex = string[][];\n\nexport type ChangeStreamStoredData<RxDocType> = {\n    databaseInstanceToken: string;\n    eventBulk: EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, any>;\n}\n\n\n/**\n * StorageEvents are not send to the same\n * browser tab where they where created.\n * This makes it hard to write unit tests\n * so we redistribute the events here instead.\n */\nexport const storageEventStream$: Subject<{\n    fromStorageEvent: boolean;\n    key: string;\n    newValue: string | null;\n    databaseInstanceToken?: string;\n}> = new Subject();\nconst storageEventStreamObservable = storageEventStream$.asObservable();\nlet storageEventStreamSubscribed = false;\nexport function getStorageEventStream() {\n    if (!storageEventStreamSubscribed && typeof window !== 'undefined') {\n        storageEventStreamSubscribed = true;\n        window.addEventListener('storage', (ev: StorageEvent) => {\n            if (!ev.key) {\n                return;\n            }\n            storageEventStream$.next({\n                fromStorageEvent: true,\n                key: ev.key,\n                newValue: ev.newValue\n            });\n        });\n    }\n    return storageEventStreamObservable;\n}\n\nlet instanceId = 0;\nexport class RxStorageInstanceLocalstorage<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    LocalstorageStorageInternals,\n    LocalstorageInstanceCreationOptions,\n    RxStorageDefaultCheckpoint\n> {\n    public readonly primaryPath: StringKeys<RxDocType>;\n\n    /**\n     * Under this key the whole state\n     * will be stored as stringified json\n     * inside of the localstorage.\n     */\n    public readonly docsKey: string;\n    public readonly changestreamStorageKey: string;\n    public readonly indexesKey: string;\n    private changeStreamSub: Subscription;\n\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> = new Subject();\n    public closed?: Promise<void>;\n    public readonly localStorage: typeof localStorage;\n    public removed: boolean = false;\n    public readonly instanceId = instanceId++;\n\n    constructor(\n        public readonly storage: RxStorageLocalstorage,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: LocalstorageStorageInternals,\n        public readonly options: Readonly<LocalstorageInstanceCreationOptions>,\n        public readonly settings: LocalstorageStorageSettings,\n        public readonly multiInstance: boolean,\n        public readonly databaseInstanceToken: string\n    ) {\n        this.localStorage = settings.localStorage ? settings.localStorage : window.localStorage;\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey) as any;\n        this.docsKey = 'RxDB-ls-doc-' + this.databaseName + '--' + this.collectionName + '--' + this.schema.version;\n        this.changestreamStorageKey = 'RxDB-ls-changes-' + this.databaseName + '--' + this.collectionName + '--' + this.schema.version;\n        this.indexesKey = 'RxDB-ls-idx-' + this.databaseName + '--' + this.collectionName + '--' + this.schema.version;\n\n        this.changeStreamSub = getStorageEventStream().subscribe((ev) => {\n            if (\n                ev.key !== this.changestreamStorageKey ||\n                !ev.newValue ||\n                (\n                    ev.fromStorageEvent &&\n                    ev.databaseInstanceToken === this.databaseInstanceToken\n                )\n            ) {\n                return;\n            }\n\n            const latestChanges: ChangeStreamStoredData<RxDocType> = JSON.parse(ev.newValue);\n            if (\n                ev.fromStorageEvent &&\n                latestChanges.databaseInstanceToken === this.databaseInstanceToken\n            ) {\n                return;\n            }\n            this.changes$.next(latestChanges.eventBulk);\n        });\n    }\n\n    getDoc(docId: string | RxDocumentWriteData<RxDocType>[StringKeys<RxDocType>]): RxDocumentData<RxDocType> | undefined {\n        const docString = this.localStorage.getItem(this.docsKey + '-' + docId as string);\n        if (docString) {\n            return JSON.parse(docString);\n        }\n    }\n    setDoc(doc: RxDocumentData<RxDocType>) {\n        const docId = doc[this.primaryPath];\n        this.localStorage.setItem(this.docsKey + '-' + docId, JSON.stringify(doc));\n    }\n    getIndex(index: string[]): LocalstorageIndex {\n        const indexString = this.localStorage.getItem(this.indexesKey + getIndexName(index));\n        if (!indexString) {\n            return [];\n        } else {\n            return JSON.parse(indexString);\n        }\n    }\n    setIndex(index: string[], value: LocalstorageIndex) {\n        this.localStorage.setItem(this.indexesKey + getIndexName(index), JSON.stringify(value));\n    }\n\n\n    bulkWrite(\n        documentWrites: BulkWriteRow<RxDocType>[],\n        context: string\n    ): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            error: []\n        };\n\n        const docsInDb = new Map<RxDocumentData<RxDocType>[StringKeys<RxDocType>] | string, RxDocumentData<RxDocType>>();\n        documentWrites.forEach(row => {\n            const docId = row.document[this.primaryPath];\n            const doc = this.getDoc(docId);\n            if (doc) {\n                docsInDb.set(docId, doc);\n            }\n        });\n\n        const categorized = categorizeBulkWriteRows<RxDocType>(\n            this,\n            this.primaryPath,\n            docsInDb,\n            documentWrites,\n            context\n        );\n        ret.error = categorized.errors;\n\n\n        const indexValues = Object.values(this.internals.indexes).map(idx => {\n            return this.getIndex(idx.index);\n        });\n\n        [\n            categorized.bulkInsertDocs,\n            categorized.bulkUpdateDocs\n        ].forEach(rows => {\n            rows.forEach(row => {\n                // write new document data\n                this.setDoc(row.document);\n\n                // update the indexes\n                const docId = row.document[this.primaryPath] as string;\n                Object.values(this.internals.indexes).forEach((idx, i) => {\n                    const indexValue = indexValues[i];\n                    const newIndexString = idx.getIndexableString(row.document);\n                    const insertPosition = pushAtSortPosition<string[]>(\n                        indexValue,\n                        [\n                            newIndexString,\n                            docId,\n                        ],\n                        sortByIndexStringComparator,\n                        0\n                    );\n                    if (row.previous) {\n                        const previousIndexString = idx.getIndexableString(row.previous);\n                        if (previousIndexString === newIndexString) {\n                            /**\n                             * Performance shortcut.\n                             * If index was not changed -> The old doc must be before or after the new one.\n                             */\n                            const prev = indexValue[insertPosition - 1];\n                            if (prev && prev[1] === docId) {\n                                indexValue.splice(insertPosition - 1, 1);\n                            } else {\n                                const next = indexValue[insertPosition + 1];\n                                if (next[1] === docId) {\n                                    indexValue.splice(insertPosition + 1, 1);\n                                } else {\n                                    throw newRxError('SNH', {\n                                        document: row.document,\n                                        args: {\n                                            insertPosition,\n                                            indexValue,\n                                            row,\n                                            idx\n                                        }\n                                    });\n                                }\n                            }\n                        } else {\n                            /**\n                             * Index changed, we must search for the old one and remove it.\n                             */\n                            const indexBefore = boundEQ(\n                                indexValue,\n                                [\n                                    previousIndexString\n                                ] as any,\n                                compareDocsWithIndex\n                            );\n                            indexValue.splice(indexBefore, 1);\n                        }\n                    }\n                });\n\n            });\n        });\n\n        indexValues.forEach((indexValue, i) => {\n            const index = Object.values(this.internals.indexes);\n            this.setIndex(index[i].index, indexValue);\n        });\n\n        if (categorized.eventBulk.events.length > 0) {\n            const lastState = ensureNotFalsy(categorized.newestRow).document;\n            categorized.eventBulk.checkpoint = {\n                id: lastState[this.primaryPath],\n                lwt: lastState._meta.lwt\n            };\n            const storageItemData: ChangeStreamStoredData<RxDocType> = {\n                databaseInstanceToken: this.databaseInstanceToken,\n                eventBulk: categorized.eventBulk\n            };\n            const itemString = JSON.stringify(storageItemData);\n            this.localStorage.setItem(\n                this.changestreamStorageKey,\n                itemString\n            );\n            storageEventStream$.next({\n                fromStorageEvent: false,\n                key: this.changestreamStorageKey,\n                newValue: itemString,\n                databaseInstanceToken: this.databaseInstanceToken\n            });\n        }\n        return Promise.resolve(ret);\n    }\n\n    async findDocumentsById(\n        docIds: string[],\n        withDeleted: boolean\n    ): Promise<RxDocumentData<RxDocType>[]> {\n        const ret: RxDocumentData<RxDocType>[] = [];\n        docIds.forEach(docId => {\n            const doc = this.getDoc(docId);\n            if (doc) {\n                if (withDeleted || !doc._deleted) {\n                    ret.push(doc);\n                }\n            }\n        });\n        return ret;\n    }\n\n    async query(\n        preparedQuery: PreparedQuery<RxDocType>\n    ): Promise<RxStorageQueryResult<RxDocType>> {\n        const queryPlan = preparedQuery.queryPlan;\n        const query = preparedQuery.query;\n\n        const skip = query.skip ? query.skip : 0;\n        const limit = query.limit ? query.limit : Infinity;\n        const skipPlusLimit = skip + limit;\n\n        let queryMatcher: QueryMatcher<RxDocumentData<RxDocType>> | false = false;\n        if (!queryPlan.selectorSatisfiedByIndex) {\n            queryMatcher = getQueryMatcher(\n                this.schema,\n                preparedQuery.query\n            );\n        }\n\n        const queryPlanFields: string[] = queryPlan.index;\n        const mustManuallyResort = !queryPlan.sortSatisfiedByIndex;\n        const index: string[] | undefined = queryPlanFields;\n        const lowerBound: any[] = queryPlan.startKeys;\n        const lowerBoundString = getStartIndexStringFromLowerBound(\n            this.schema,\n            index,\n            lowerBound\n        );\n\n        let upperBound: any[] = queryPlan.endKeys;\n        upperBound = upperBound;\n        const upperBoundString = getStartIndexStringFromUpperBound(\n            this.schema,\n            index,\n            upperBound\n        );\n        const docsWithIndex = this.getIndex(index);\n        let indexOfLower = (queryPlan.inclusiveStart ? boundGE : boundGT)(\n            docsWithIndex,\n            [\n                lowerBoundString\n            ] as any,\n            compareDocsWithIndex\n        );\n\n        const indexOfUpper = (queryPlan.inclusiveEnd ? boundLE : boundLT)(\n            docsWithIndex,\n            [\n                upperBoundString\n            ] as any,\n            compareDocsWithIndex\n        );\n\n        let rows: RxDocumentData<RxDocType>[] = [];\n        let done = false;\n        while (!done) {\n            const currentRow = docsWithIndex[indexOfLower];\n            if (\n                !currentRow ||\n                indexOfLower > indexOfUpper\n            ) {\n                break;\n            }\n            const docId = currentRow[1];\n            const currentDoc = ensureNotFalsy(this.getDoc(docId));\n\n            if (!queryMatcher || queryMatcher(currentDoc)) {\n                rows.push(currentDoc);\n            }\n\n            if (\n                (rows.length >= skipPlusLimit && !mustManuallyResort)\n            ) {\n                done = true;\n            }\n\n            indexOfLower++;\n        }\n\n        if (mustManuallyResort) {\n            const sortComparator = getSortComparator(this.schema, preparedQuery.query);\n            rows = rows.sort(sortComparator);\n        }\n\n        // apply skip and limit boundaries.\n        rows = rows.slice(skip, skipPlusLimit);\n        return Promise.resolve({\n            documents: rows\n        });\n    }\n\n    async count(\n        preparedQuery: PreparedQuery<RxDocType>\n    ): Promise<RxStorageCountResult> {\n        const result = await this.query(preparedQuery);\n        return {\n            count: result.documents.length,\n            mode: 'fast'\n        };\n    }\n\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> {\n        return this.changes$.asObservable();\n    }\n    cleanup(minimumDeletedTime: number): Promise<boolean> {\n        const maxDeletionTime = now() - minimumDeletedTime;\n        const indexValue = this.getIndex(CLEANUP_INDEX);\n        const lowerBoundString = getStartIndexStringFromLowerBound(\n            this.schema,\n            CLEANUP_INDEX,\n            [\n                true,\n                0,\n                ''\n            ]\n        );\n        let indexOfLower = boundGT(\n            indexValue,\n            [\n                lowerBoundString\n            ] as any,\n            compareDocsWithIndex\n        );\n\n        const indexValues = Object.values(this.internals.indexes).map(idx => {\n            return this.getIndex(idx.index);\n        });\n\n        let done = false;\n        while (!done) {\n            const currentIndexRow = indexValue[indexOfLower];\n            if (!currentIndexRow) {\n                break;\n            }\n            const currentDocId = currentIndexRow[1];\n            const currentDoc = ensureNotFalsy(this.getDoc(currentDocId));\n            if (currentDoc._meta.lwt > maxDeletionTime) {\n                done = true;\n            } else {\n                this.localStorage.removeItem(this.docsKey + '-' + currentDocId);\n                Object.values(this.internals.indexes).forEach((idx, i) => {\n                    const indexValue = indexValues[i];\n                    const indexString = idx.getIndexableString(currentDoc);\n                    const indexBefore = boundEQ(\n                        indexValue,\n                        [\n                            indexString\n                        ] as any,\n                        compareDocsWithIndex\n                    );\n                    indexValue.splice(indexBefore, 1);\n                });\n                indexOfLower++;\n            }\n        }\n\n        indexValues.forEach((indexValue, i) => {\n            const index = Object.values(this.internals.indexes);\n            this.setIndex(index[i].index, indexValue);\n        });\n\n        return PROMISE_RESOLVE_TRUE;\n    }\n\n    getAttachmentData(_documentId: string, _attachmentId: string): Promise<string> {\n        throw newRxError('LS1');\n    }\n\n    remove(): Promise<void> {\n        ensureNotRemoved(this);\n        this.removed = true;\n\n        // delete changes\n        this.changeStreamSub.unsubscribe();\n        this.localStorage.removeItem(this.changestreamStorageKey);\n\n        // delete documents\n        const firstIndex = Object.values(this.internals.indexes)[0];\n        const indexedDocs = this.getIndex(firstIndex.index);\n        indexedDocs.forEach(row => {\n            const docId = row[1];\n            this.localStorage.removeItem(this.docsKey + '-' + docId);\n        });\n\n        // delete indexes\n        Object.values(this.internals.indexes).forEach(idx => {\n            this.localStorage.removeItem(this.indexesKey + idx.indexName);\n        });\n\n        return PROMISE_RESOLVE_VOID;\n    }\n\n    close(): Promise<void> {\n        this.changeStreamSub.unsubscribe();\n        this.removed = true;\n\n        if (this.closed) {\n            return this.closed;\n        }\n        this.closed = (async () => {\n            this.changes$.complete();\n            this.localStorage.removeItem(this.changestreamStorageKey);\n        })();\n        return this.closed;\n    }\n}\n\nexport async function createLocalstorageStorageInstance<RxDocType>(\n    storage: RxStorageLocalstorage,\n    params: RxStorageInstanceCreationParams<RxDocType, LocalstorageInstanceCreationOptions>,\n    settings: LocalstorageStorageSettings\n): Promise<RxStorageInstanceLocalstorage<RxDocType>> {\n    const primaryPath = getPrimaryFieldOfPrimaryKey(params.schema.primaryKey);\n\n    const useIndexes = params.schema.indexes ? params.schema.indexes.slice(0) : [];\n    useIndexes.push([primaryPath]);\n    const useIndexesFinal = useIndexes.map(index => {\n        const indexAr = toArray(index);\n        return indexAr;\n    });\n    useIndexesFinal.push(CLEANUP_INDEX);\n    const indexes: ById<IndexMeta<RxDocType>> = {};\n    useIndexesFinal.forEach((indexAr, indexId) => {\n        const indexName = getIndexName(indexAr);\n        indexes[indexName] = {\n            indexId: '|' + indexId + '|',\n            indexName,\n            getIndexableString: getIndexableStringMonad(params.schema, indexAr),\n            index: indexAr\n        };\n    });\n\n    const internals: LocalstorageStorageInternals<RxDocType> = {\n        indexes\n    };\n\n    const instance = new RxStorageInstanceLocalstorage(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        params.schema,\n        internals,\n        params.options,\n        settings,\n        params.multiInstance,\n        params.databaseInstanceToken\n    );\n    return instance;\n}\n\n\nexport function getIndexName(index: string[]): string {\n    return index.join('|');\n}\nexport const CLEANUP_INDEX: string[] = ['_deleted', '_meta.lwt'];\nexport type IndexMeta<RxDocType> = {\n    indexId: string;\n    indexName: string;\n    index: string[];\n    getIndexableString: (doc: RxDocumentData<RxDocType>) => string;\n};\n\nfunction sortByIndexStringComparator(a: [string, string], b: [string, string]) {\n    if (a[0] < b[0]) {\n        return -1;\n    } else {\n        return 1;\n    }\n}\n\nfunction compareDocsWithIndex<RxDocType>(\n    a: [string, string],\n    b: [string, string]\n): 1 | 0 | -1 {\n    const indexStringA = a[0];\n    const indexStringB = b[0];\n    if (indexStringA < indexStringB) {\n        return -1;\n    } else if (indexStringA === indexStringB) {\n        return 0;\n    } else {\n        return 1;\n    }\n}\n\nfunction ensureNotRemoved(\n    instance: RxStorageInstanceLocalstorage<any>\n) {\n    if (instance.removed) {\n        throw new Error('removed');\n    }\n}\n"],"mappings":"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","ignoreList":[]}