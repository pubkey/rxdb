{"version":3,"file":"check-document.js","names":["newRxError","fillPrimaryKey","getPrimaryFieldOfPrimaryKey","ensurePrimaryKeyValid","primaryKey","docData","document","trim","includes","containsDateInstance","obj","key","Object","prototype","hasOwnProperty","call","Date","checkWriteRows","storageInstance","rows","primaryPath","schema","_loop","writeRow","previous","keys","_meta","forEach","metaFieldName","dataBefore","dataAfter","args","structuredClone","JSON","parse","stringify","err","collection","collectionName"],"sources":["../../../../src/plugins/dev-mode/check-document.ts"],"sourcesContent":["import { newRxError } from '../../rx-error.ts';\nimport { fillPrimaryKey, getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper.ts';\nimport type { BulkWriteRow, RxDocumentData, RxStorageInstance } from '../../types/index.d.ts';\n\nexport function ensurePrimaryKeyValid(\n    primaryKey: string,\n    docData: RxDocumentData<any>\n) {\n    if (!primaryKey) {\n        throw newRxError('DOC20', {\n            primaryKey,\n            document: docData\n        });\n    }\n\n\n    /**\n     * This is required so that we can left-pad\n     * the primaryKey and we are still able to de-left-pad\n     * it to get again the original key.\n     */\n    if (\n        primaryKey !== primaryKey.trim()\n    ) {\n        throw newRxError('DOC21', {\n            primaryKey,\n            document: docData\n        });\n    }\n    if (\n        primaryKey.includes('\\r') ||\n        primaryKey.includes('\\n')\n    ) {\n        throw newRxError('DOC22', {\n            primaryKey,\n            document: docData\n        });\n    }\n    if (\n        primaryKey.includes('\"')\n    ) {\n        throw newRxError('DOC23', {\n            primaryKey,\n            document: docData\n        });\n    }\n}\n\n/**\n * Deeply checks if the object contains an\n * instance of the JavaScript Date class.\n * @recursive\n */\nexport function containsDateInstance(obj: any): boolean {\n    if (typeof obj !== 'object' || obj === null) {\n        return false;\n    }\n    for (let key in obj) {\n        if (Object.prototype.hasOwnProperty.call(obj, key)) {\n            if (obj[key] instanceof Date) {\n                return true;\n            }\n            if (typeof obj[key] === 'object' && containsDateInstance(obj[key])) {\n                return true;\n            }\n        }\n    }\n    return false;\n}\n\n\nexport function checkWriteRows<RxDocType>(\n    storageInstance: RxStorageInstance<RxDocType, any, any, any>,\n    rows: BulkWriteRow<RxDocType>[]\n) {\n    const primaryPath = getPrimaryFieldOfPrimaryKey(storageInstance.schema.primaryKey);\n    for (const writeRow of rows) {\n        // ensure that the primary key has not been changed\n        writeRow.document = fillPrimaryKey(\n            primaryPath,\n            storageInstance.schema,\n            writeRow.document\n        );\n\n\n\n        /**\n         * Ensure that _meta fields have been merged\n         * and not replaced.\n         * This is important so that when one plugin A\n         * sets a _meta field and another plugin B does a write\n         * to the document, it must be ensured that the\n         * field of plugin A was not removed.\n         */\n        if (writeRow.previous) {\n            Object.keys(writeRow.previous._meta)\n                .forEach(metaFieldName => {\n                    if (!Object.prototype.hasOwnProperty.call(writeRow.document._meta, metaFieldName)) {\n                        throw newRxError('SNH', {\n                            dataBefore: writeRow.previous,\n                            dataAfter: writeRow.document,\n                            args: {\n                                metaFieldName\n                            }\n                        });\n                    }\n                });\n        }\n\n        /**\n         * Ensure it can be structured cloned\n         */\n        try {\n            /**\n             * Notice that structuredClone() is not available\n             * in ReactNative, so we test for JSON.stringify() instead\n             * @link https://github.com/pubkey/rxdb/issues/5046#issuecomment-1827374498\n             */\n            if (typeof structuredClone === 'function') {\n                structuredClone(writeRow);\n            } else {\n                JSON.parse(JSON.stringify(writeRow));\n            }\n        } catch (err) {\n            throw newRxError('DOC24', {\n                collection: storageInstance.collectionName,\n                document: writeRow.document\n            });\n        }\n\n\n        /**\n         * Ensure it does not contain a Date() object\n         */\n        if (containsDateInstance(writeRow.document)) {\n            throw newRxError('DOC24', {\n                collection: storageInstance.collectionName,\n                document: writeRow.document\n            });\n        }\n    }\n\n}\n"],"mappings":"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","ignoreList":[]}