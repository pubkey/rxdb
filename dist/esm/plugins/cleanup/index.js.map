{"version":3,"file":"index.js","names":["runAsyncPluginHooks","DEFAULT_CLEANUP_POLICY","startCleanupForRxState","startCleanupForRxCollection","RxDBCleanupPlugin","name","rxdb","prototypes","RxCollection","proto","cleanup","minimumDeletedTime","cleanupPolicy","Object","assign","database","isDone","closed","storageInstance","collectionName","databaseName","hooks","createRxCollection","after","i","collection","createRxState","state"],"sources":["../../../../src/plugins/cleanup/index.ts"],"sourcesContent":["import { runAsyncPluginHooks } from '../../hooks.ts';\nimport type {\n    RxCollection,\n    RxPlugin\n} from '../../types/index.d.ts';\nimport { DEFAULT_CLEANUP_POLICY } from './cleanup-helper.ts';\nimport { startCleanupForRxState } from './cleanup-state.ts';\nimport { startCleanupForRxCollection } from './cleanup.ts';\n\nexport const RxDBCleanupPlugin: RxPlugin = {\n    name: 'cleanup',\n    rxdb: true,\n    prototypes: {\n        RxCollection: (proto: any) => {\n            proto.cleanup = async function (this: RxCollection, minimumDeletedTime?: number): Promise<void> {\n                const cleanupPolicy = Object.assign(\n                    {},\n                    DEFAULT_CLEANUP_POLICY,\n                    this.database.cleanupPolicy ? this.database.cleanupPolicy : {}\n                );\n\n                if (typeof minimumDeletedTime === 'undefined') {\n                    minimumDeletedTime = cleanupPolicy.minimumDeletedTime;\n                }\n\n                // run cleanup() until it returns true\n                let isDone = false;\n                while (!isDone && !this.closed) {\n                    isDone = await this.storageInstance.cleanup(minimumDeletedTime);\n                }\n\n                await runAsyncPluginHooks('postCleanup', {\n                    collectionName: this.name,\n                    databaseName: this.database.name\n                });\n            };\n        }\n    },\n    hooks: {\n        createRxCollection: {\n            after: (i) => {\n                startCleanupForRxCollection(i.collection);\n            }\n        },\n        createRxState: {\n            after: (i) => {\n                startCleanupForRxState(i.state);\n            }\n        }\n    }\n};\n\nexport * from './cleanup.ts';\n"],"mappings":"AAAA,SAASA,mBAAmB,QAAQ,gBAAgB;AAKpD,SAASC,sBAAsB,QAAQ,qBAAqB;AAC5D,SAASC,sBAAsB,QAAQ,oBAAoB;AAC3D,SAASC,2BAA2B,QAAQ,cAAc;AAE1D,OAAO,IAAMC,iBAA2B,GAAG;EACvCC,IAAI,EAAE,SAAS;EACfC,IAAI,EAAE,IAAI;EACVC,UAAU,EAAE;IACRC,YAAY,EAAGC,KAAU,IAAK;MAC1BA,KAAK,CAACC,OAAO,GAAG,gBAAoCC,kBAA2B,EAAiB;QAC5F,IAAMC,aAAa,GAAGC,MAAM,CAACC,MAAM,CAC/B,CAAC,CAAC,EACFb,sBAAsB,EACtB,IAAI,CAACc,QAAQ,CAACH,aAAa,GAAG,IAAI,CAACG,QAAQ,CAACH,aAAa,GAAG,CAAC,CACjE,CAAC;QAED,IAAI,OAAOD,kBAAkB,KAAK,WAAW,EAAE;UAC3CA,kBAAkB,GAAGC,aAAa,CAACD,kBAAkB;QACzD;;QAEA;QACA,IAAIK,MAAM,GAAG,KAAK;QAClB,OAAO,CAACA,MAAM,IAAI,CAAC,IAAI,CAACC,MAAM,EAAE;UAC5BD,MAAM,GAAG,MAAM,IAAI,CAACE,eAAe,CAACR,OAAO,CAACC,kBAAkB,CAAC;QACnE;QAEA,MAAMX,mBAAmB,CAAC,aAAa,EAAE;UACrCmB,cAAc,EAAE,IAAI,CAACd,IAAI;UACzBe,YAAY,EAAE,IAAI,CAACL,QAAQ,CAACV;QAChC,CAAC,CAAC;MACN,CAAC;IACL;EACJ,CAAC;EACDgB,KAAK,EAAE;IACHC,kBAAkB,EAAE;MAChBC,KAAK,EAAGC,CAAC,IAAK;QACVrB,2BAA2B,CAACqB,CAAC,CAACC,UAAU,CAAC;MAC7C;IACJ,CAAC;IACDC,aAAa,EAAE;MACXH,KAAK,EAAGC,CAAC,IAAK;QACVtB,sBAAsB,CAACsB,CAAC,CAACG,KAAK,CAAC;MACnC;IACJ;EACJ;AACJ,CAAC;AAED,cAAc,cAAc","ignoreList":[]}