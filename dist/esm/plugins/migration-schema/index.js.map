{"version":3,"file":"index.js","names":["shareReplay","getFromMapOrCreate","PROMISE_RESOLVE_FALSE","RXJS_SHARE_REPLAY_DEFAULTS","RxMigrationState","getMigrationStateByDatabase","mustMigrate","onDatabaseClose","addRxPlugin","RxDBLocalDocumentsPlugin","DATA_MIGRATOR_BY_COLLECTION","WeakMap","RxDBMigrationPlugin","name","rxdb","init","hooks","preCloseRxDatabase","after","prototypes","RxDatabase","proto","migrationStates","pipe","RxCollection","getMigrationState","asRxCollection","migrationStrategies","migrationNeeded","schema","version","RxDBMigrationSchemaPlugin"],"sources":["../../../../src/plugins/migration-schema/index.ts"],"sourcesContent":["import {\n    Observable\n} from 'rxjs';\nimport {\n    shareReplay\n} from 'rxjs';\nimport type {\n    RxPlugin,\n    RxCollection,\n    RxDatabase\n} from '../../types/index.ts';\nimport {\n    getFromMapOrCreate,\n    PROMISE_RESOLVE_FALSE,\n    RXJS_SHARE_REPLAY_DEFAULTS\n} from '../../plugins/utils/index.ts';\nimport {\n    RxMigrationState\n} from './rx-migration-state.ts';\nimport {\n    getMigrationStateByDatabase,\n    mustMigrate,\n    onDatabaseClose\n} from './migration-helpers.ts';\nimport { addRxPlugin } from '../../plugin.ts';\nimport { RxDBLocalDocumentsPlugin } from '../local-documents/index.ts';\n\nexport const DATA_MIGRATOR_BY_COLLECTION: WeakMap<RxCollection, RxMigrationState> = new WeakMap();\n\nexport const RxDBMigrationPlugin: RxPlugin = {\n    name: 'migration-schema',\n    rxdb: true,\n    init() {\n        addRxPlugin(RxDBLocalDocumentsPlugin);\n    },\n    hooks: {\n        preCloseRxDatabase: {\n            after: onDatabaseClose\n        }\n    },\n    prototypes: {\n        RxDatabase: (proto: any) => {\n            proto.migrationStates = function (this: RxDatabase): Observable<RxMigrationState[]> {\n                return getMigrationStateByDatabase(this).pipe(\n                    shareReplay(RXJS_SHARE_REPLAY_DEFAULTS)\n                );\n            };\n        },\n        RxCollection: (proto: any) => {\n            proto.getMigrationState = function (this: RxCollection): RxMigrationState {\n                return getFromMapOrCreate(\n                    DATA_MIGRATOR_BY_COLLECTION,\n                    this,\n                    () => new RxMigrationState(\n                        this.asRxCollection,\n                        this.migrationStrategies\n                    )\n                );\n            };\n            proto.migrationNeeded = function (this: RxCollection) {\n                if (this.schema.version === 0) {\n                    return PROMISE_RESOLVE_FALSE;\n                }\n                return mustMigrate(this.getMigrationState());\n            };\n        }\n    }\n};\n\nexport const RxDBMigrationSchemaPlugin = RxDBMigrationPlugin;\n\n\nexport * from './rx-migration-state.ts';\nexport * from './migration-helpers.ts';\nexport * from './migration-types.ts';\n"],"mappings":"AAGA,SACIA,WAAW,QACR,MAAM;AAMb,SACIC,kBAAkB,EAClBC,qBAAqB,EACrBC,0BAA0B,QACvB,8BAA8B;AACrC,SACIC,gBAAgB,QACb,yBAAyB;AAChC,SACIC,2BAA2B,EAC3BC,WAAW,EACXC,eAAe,QACZ,wBAAwB;AAC/B,SAASC,WAAW,QAAQ,iBAAiB;AAC7C,SAASC,wBAAwB,QAAQ,6BAA6B;AAEtE,OAAO,IAAMC,2BAAoE,GAAG,IAAIC,OAAO,CAAC,CAAC;AAEjG,OAAO,IAAMC,mBAA6B,GAAG;EACzCC,IAAI,EAAE,kBAAkB;EACxBC,IAAI,EAAE,IAAI;EACVC,IAAIA,CAAA,EAAG;IACHP,WAAW,CAACC,wBAAwB,CAAC;EACzC,CAAC;EACDO,KAAK,EAAE;IACHC,kBAAkB,EAAE;MAChBC,KAAK,EAAEX;IACX;EACJ,CAAC;EACDY,UAAU,EAAE;IACRC,UAAU,EAAGC,KAAU,IAAK;MACxBA,KAAK,CAACC,eAAe,GAAG,YAA4D;QAChF,OAAOjB,2BAA2B,CAAC,IAAI,CAAC,CAACkB,IAAI,CACzCvB,WAAW,CAACG,0BAA0B,CAC1C,CAAC;MACL,CAAC;IACL,CAAC;IACDqB,YAAY,EAAGH,KAAU,IAAK;MAC1BA,KAAK,CAACI,iBAAiB,GAAG,YAAgD;QACtE,OAAOxB,kBAAkB,CACrBS,2BAA2B,EAC3B,IAAI,EACJ,MAAM,IAAIN,gBAAgB,CACtB,IAAI,CAACsB,cAAc,EACnB,IAAI,CAACC,mBACT,CACJ,CAAC;MACL,CAAC;MACDN,KAAK,CAACO,eAAe,GAAG,YAA8B;QAClD,IAAI,IAAI,CAACC,MAAM,CAACC,OAAO,KAAK,CAAC,EAAE;UAC3B,OAAO5B,qBAAqB;QAChC;QACA,OAAOI,WAAW,CAAC,IAAI,CAACmB,iBAAiB,CAAC,CAAC,CAAC;MAChD,CAAC;IACL;EACJ;AACJ,CAAC;AAED,OAAO,IAAMM,yBAAyB,GAAGnB,mBAAmB;AAG5D,cAAc,yBAAyB;AACvC,cAAc,wBAAwB;AACtC,cAAc,sBAAsB","ignoreList":[]}