{"version":3,"file":"helper.js","names":["clone","createRevision","flatClone","getDefaultRevision","now","stripAttachmentsDataFromDocument","docStateToWriteDoc","databaseInstanceToken","hasAttachments","keepMeta","docState","previous","docData","Object","assign","_attachments","_meta","lwt","_rev","writeDocToDocState","writeDoc","keepAttachments","ret","stripAttachmentsDataFromMetaWriteRows","state","rows","map","row","document","getUnderlyingPersistentStorage","instance","underlyingPersistentStorage"],"sources":["../../../src/replication-protocol/helper.ts"],"sourcesContent":["import type {\n    BulkWriteRow,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxStorageInstance,\n    RxStorageInstanceReplicationState,\n    RxStorageReplicationMeta,\n    WithDeletedAndAttachments\n} from '../types/index.d.ts';\nimport {\n    clone,\n    createRevision,\n    flatClone,\n    getDefaultRevision,\n    now\n} from '../plugins/utils/index.ts';\nimport { stripAttachmentsDataFromDocument } from '../rx-storage-helper.ts';\n\nexport function docStateToWriteDoc<RxDocType>(\n    databaseInstanceToken: string,\n    hasAttachments: boolean,\n    keepMeta: boolean,\n    docState: WithDeletedAndAttachments<RxDocType>,\n    previous?: RxDocumentData<RxDocType>\n): RxDocumentWriteData<RxDocType> {\n    const docData: RxDocumentWriteData<RxDocType> = Object.assign(\n        {},\n        docState,\n        {\n            _attachments: hasAttachments && docState._attachments ? docState._attachments : {},\n            _meta: keepMeta ? (docState as any)._meta : Object.assign(\n                {},\n                previous ? previous._meta : {},\n                {\n                    lwt: now()\n                }\n            ),\n            _rev: keepMeta ? (docState as any)._rev : getDefaultRevision()\n        }\n    );\n    if (!docData._rev) {\n        docData._rev = createRevision(\n            databaseInstanceToken,\n            previous\n        );\n    }\n\n    return docData;\n}\n\nexport function writeDocToDocState<RxDocType>(\n    writeDoc: RxDocumentData<RxDocType>,\n    keepAttachments: boolean,\n    keepMeta: boolean\n): WithDeletedAndAttachments<RxDocType> {\n    const ret = flatClone(writeDoc);\n\n    if (!keepAttachments) {\n        delete (ret as any)._attachments;\n    }\n    if (!keepMeta) {\n        delete (ret as any)._meta;\n        delete (ret as any)._rev;\n    }\n    return ret;\n}\n\n\nexport function stripAttachmentsDataFromMetaWriteRows<RxDocType>(\n    state: RxStorageInstanceReplicationState<any>,\n    rows: BulkWriteRow<RxStorageReplicationMeta<RxDocType, any>>[]\n): BulkWriteRow<RxStorageReplicationMeta<RxDocType, any>>[] {\n    if (!state.hasAttachments) {\n        return rows;\n    }\n    return rows.map(row => {\n        const document = clone(row.document);\n        document.docData = stripAttachmentsDataFromDocument(document.docData);\n        return {\n            document,\n            previous: row.previous\n        };\n    });\n}\n\nexport function getUnderlyingPersistentStorage<RxDocType>(\n    instance: RxStorageInstance<RxDocType, any, any, any>\n): RxStorageInstance<RxDocType, any, any, any> {\n    while (true) {\n        if (instance.underlyingPersistentStorage) {\n            instance = instance.underlyingPersistentStorage;\n        } else {\n            return instance;\n        }\n    }\n}\n"],"mappings":"AASA,SACIA,KAAK,EACLC,cAAc,EACdC,SAAS,EACTC,kBAAkB,EAClBC,GAAG,QACA,2BAA2B;AAClC,SAASC,gCAAgC,QAAQ,yBAAyB;AAE1E,OAAO,SAASC,kBAAkBA,CAC9BC,qBAA6B,EAC7BC,cAAuB,EACvBC,QAAiB,EACjBC,QAA8C,EAC9CC,QAAoC,EACN;EAC9B,IAAMC,OAAuC,GAAGC,MAAM,CAACC,MAAM,CACzD,CAAC,CAAC,EACFJ,QAAQ,EACR;IACIK,YAAY,EAAEP,cAAc,IAAIE,QAAQ,CAACK,YAAY,GAAGL,QAAQ,CAACK,YAAY,GAAG,CAAC,CAAC;IAClFC,KAAK,EAAEP,QAAQ,GAAIC,QAAQ,CAASM,KAAK,GAAGH,MAAM,CAACC,MAAM,CACrD,CAAC,CAAC,EACFH,QAAQ,GAAGA,QAAQ,CAACK,KAAK,GAAG,CAAC,CAAC,EAC9B;MACIC,GAAG,EAAEb,GAAG,CAAC;IACb,CACJ,CAAC;IACDc,IAAI,EAAET,QAAQ,GAAIC,QAAQ,CAASQ,IAAI,GAAGf,kBAAkB,CAAC;EACjE,CACJ,CAAC;EACD,IAAI,CAACS,OAAO,CAACM,IAAI,EAAE;IACfN,OAAO,CAACM,IAAI,GAAGjB,cAAc,CACzBM,qBAAqB,EACrBI,QACJ,CAAC;EACL;EAEA,OAAOC,OAAO;AAClB;AAEA,OAAO,SAASO,kBAAkBA,CAC9BC,QAAmC,EACnCC,eAAwB,EACxBZ,QAAiB,EACmB;EACpC,IAAMa,GAAG,GAAGpB,SAAS,CAACkB,QAAQ,CAAC;EAE/B,IAAI,CAACC,eAAe,EAAE;IAClB,OAAQC,GAAG,CAASP,YAAY;EACpC;EACA,IAAI,CAACN,QAAQ,EAAE;IACX,OAAQa,GAAG,CAASN,KAAK;IACzB,OAAQM,GAAG,CAASJ,IAAI;EAC5B;EACA,OAAOI,GAAG;AACd;AAGA,OAAO,SAASC,qCAAqCA,CACjDC,KAA6C,EAC7CC,IAA8D,EACN;EACxD,IAAI,CAACD,KAAK,CAAChB,cAAc,EAAE;IACvB,OAAOiB,IAAI;EACf;EACA,OAAOA,IAAI,CAACC,GAAG,CAACC,GAAG,IAAI;IACnB,IAAMC,QAAQ,GAAG5B,KAAK,CAAC2B,GAAG,CAACC,QAAQ,CAAC;IACpCA,QAAQ,CAAChB,OAAO,GAAGP,gCAAgC,CAACuB,QAAQ,CAAChB,OAAO,CAAC;IACrE,OAAO;MACHgB,QAAQ;MACRjB,QAAQ,EAAEgB,GAAG,CAAChB;IAClB,CAAC;EACL,CAAC,CAAC;AACN;AAEA,OAAO,SAASkB,8BAA8BA,CAC1CC,QAAqD,EACV;EAC3C,OAAO,IAAI,EAAE;IACT,IAAIA,QAAQ,CAACC,2BAA2B,EAAE;MACtCD,QAAQ,GAAGA,QAAQ,CAACC,2BAA2B;IACnD,CAAC,MAAM;MACH,OAAOD,QAAQ;IACnB;EACJ;AACJ","ignoreList":[]}