{"version":3,"file":"index.js","names":["replicateRxStorageInstance","input","checkpointKey","getCheckpointKey","state","primaryPath","getPrimaryFieldOfPrimaryKey","forkInstance","schema","primaryKey","downstreamBulkWriteFlag","events","canceled","BehaviorSubject","active","down","up","processed","Subject","resolvedConflicts","error","stats","addNewTask","downstreamProcessChanges","downstreamResyncOnce","masterChangeStreamEmit","persistFromMaster","forkChangeStreamEmit","persistToMaster","persistToMasterConflictWrites","persistToMasterHadConflicts","processTasks","upstreamInitialSync","firstSyncDone","streamQueue","PROMISE_RESOLVE_VOID","checkpointQueue","lastCheckpointDoc","startReplicationDownstream","startReplicationUpstream","awaitRxStorageReplicationFirstInSync","firstValueFrom","combineLatest","pipe","filter","v","then","awaitRxStorageReplicationInSync","replicationState","Promise","all","awaitRxStorageReplicationIdle","rxStorageInstanceToReplicationHandler","instance","conflictHandler","databaseInstanceToken","replicationHandler","masterChangeStream$","changeStream","map","eventBulk","ret","checkpoint","documents","event","writeDocToDocState","ensureNotFalsy","documentData","masterChangesSince","batchSize","getChangedDocumentsSince","result","length","d","masterWrite","rows","rowById","forEach","row","docId","newDocumentState","ids","Object","keys","findDocumentsById","masterDocsState","conflicts","writeRows","entries","id","masterState","push","document","docStateToWriteDoc","assumedMasterState","realMasterState","isEqual","previous","bulkWrite","values","err","status","Error","documentInDb","cancelRxStorageReplication","next","complete"],"sources":["../../../src/replication-protocol/index.ts"],"sourcesContent":["/**\n * These files contain the replication protocol.\n * It can be used to replicated RxStorageInstances or RxCollections\n * or even to do a client(s)-server replication.\n */\n\n\nimport {\n    BehaviorSubject,\n    combineLatest,\n    filter,\n    firstValueFrom,\n    map,\n    Subject\n} from 'rxjs';\nimport {\n    getPrimaryFieldOfPrimaryKey\n} from '../rx-schema-helper';\nimport type {\n    BulkWriteRow,\n    ById,\n    DocumentsWithCheckpoint,\n    RxConflictHandler,\n    RxReplicationHandler,\n    RxReplicationWriteToMasterRow,\n    RxStorageInstance,\n    RxStorageInstanceReplicationInput,\n    RxStorageInstanceReplicationState,\n    WithDeleted\n} from '../types';\nimport {\n    ensureNotFalsy,\n    PROMISE_RESOLVE_VOID\n} from '../util';\nimport {\n    getCheckpointKey\n} from './checkpoint';\nimport { startReplicationDownstream } from './downstream';\nimport { docStateToWriteDoc, writeDocToDocState } from './helper';\nimport { startReplicationUpstream } from './upstream';\n\n\nexport * from './checkpoint';\nexport * from './downstream';\nexport * from './upstream';\nexport * from './meta-instance';\nexport * from './conflicts';\nexport * from './helper';\n\n\nexport function replicateRxStorageInstance<RxDocType>(\n    input: RxStorageInstanceReplicationInput<RxDocType>\n): RxStorageInstanceReplicationState<RxDocType> {\n    const checkpointKey = getCheckpointKey(input);\n    const state: RxStorageInstanceReplicationState<RxDocType> = {\n        primaryPath: getPrimaryFieldOfPrimaryKey(input.forkInstance.schema.primaryKey),\n        input,\n        checkpointKey,\n        downstreamBulkWriteFlag: 'replication-downstream-' + checkpointKey,\n        events: {\n            canceled: new BehaviorSubject<boolean>(false),\n            active: {\n                down: new BehaviorSubject<boolean>(true),\n                up: new BehaviorSubject<boolean>(true)\n            },\n            processed: {\n                down: new Subject(),\n                up: new Subject()\n            },\n            resolvedConflicts: new Subject(),\n            error: new Subject()\n        },\n        stats: {\n            down: {\n                addNewTask: 0,\n                downstreamProcessChanges: 0,\n                downstreamResyncOnce: 0,\n                masterChangeStreamEmit: 0,\n                persistFromMaster: 0\n            },\n            up: {\n                forkChangeStreamEmit: 0,\n                persistToMaster: 0,\n                persistToMasterConflictWrites: 0,\n                persistToMasterHadConflicts: 0,\n                processTasks: 0,\n                upstreamInitialSync: 0\n            }\n        },\n        firstSyncDone: {\n            down: new BehaviorSubject<boolean>(false),\n            up: new BehaviorSubject<boolean>(false)\n        },\n        streamQueue: {\n            down: PROMISE_RESOLVE_VOID,\n            up: PROMISE_RESOLVE_VOID\n        },\n        checkpointQueue: PROMISE_RESOLVE_VOID,\n        lastCheckpointDoc: {}\n    };\n\n    startReplicationDownstream(state);\n    startReplicationUpstream(state);\n    return state;\n}\n\nexport function awaitRxStorageReplicationFirstInSync(\n    state: RxStorageInstanceReplicationState<any>\n): Promise<void> {\n    return firstValueFrom(\n        combineLatest([\n            state.firstSyncDone.down.pipe(\n                filter(v => !!v)\n            ),\n            state.firstSyncDone.up.pipe(\n                filter(v => !!v)\n            )\n        ])\n    ).then(() => { });\n}\n\nexport function awaitRxStorageReplicationInSync(\n    replicationState: RxStorageInstanceReplicationState<any>\n) {\n    return Promise.all([\n        replicationState.streamQueue.up,\n        replicationState.streamQueue.down,\n        replicationState.checkpointQueue\n    ]);\n}\n\n\nexport async function awaitRxStorageReplicationIdle(\n    state: RxStorageInstanceReplicationState<any>\n) {\n    await awaitRxStorageReplicationFirstInSync(state);\n    while (true) {\n        const { down, up } = state.streamQueue;\n        await Promise.all([\n            up,\n            down\n        ]);\n        /**\n         * If the Promises have not been reasigned\n         * after awaiting them, we know that the replication\n         * is in idle state at this point in time.\n         */\n        if (\n            down === state.streamQueue.down &&\n            up === state.streamQueue.up\n        ) {\n            return;\n        }\n    }\n}\n\n\nexport function rxStorageInstanceToReplicationHandler<RxDocType, MasterCheckpointType>(\n    instance: RxStorageInstance<RxDocType, any, any, MasterCheckpointType>,\n    conflictHandler: RxConflictHandler<RxDocType>,\n    databaseInstanceToken: string\n): RxReplicationHandler<RxDocType, MasterCheckpointType> {\n    const primaryPath = getPrimaryFieldOfPrimaryKey(instance.schema.primaryKey);\n    const replicationHandler: RxReplicationHandler<RxDocType, MasterCheckpointType> = {\n        masterChangeStream$: instance.changeStream().pipe(\n            map(eventBulk => {\n                const ret: DocumentsWithCheckpoint<RxDocType, MasterCheckpointType> = {\n                    checkpoint: eventBulk.checkpoint,\n                    documents: eventBulk.events.map(event => {\n                        return writeDocToDocState(ensureNotFalsy(event.documentData) as any);\n                    })\n                };\n                return ret;\n            })\n        ),\n        masterChangesSince(\n            checkpoint,\n            batchSize\n        ) {\n            return instance.getChangedDocumentsSince(\n                batchSize,\n                checkpoint\n            ).then(result => {\n                return {\n                    checkpoint: result.documents.length > 0 ? result.checkpoint : checkpoint,\n                    documents: result.documents.map(d => writeDocToDocState(d))\n                };\n            });\n        },\n        async masterWrite(\n            rows\n        ) {\n            const rowById: ById<RxReplicationWriteToMasterRow<RxDocType>> = {};\n            rows.forEach(row => {\n                const docId: string = (row.newDocumentState as any)[primaryPath];\n                rowById[docId] = row;\n            });\n            const ids = Object.keys(rowById);\n\n            const masterDocsState = await instance.findDocumentsById(\n                ids,\n                true\n            );\n            const conflicts: WithDeleted<RxDocType>[] = [];\n            const writeRows: BulkWriteRow<RxDocType>[] = [];\n            await Promise.all(\n                Object.entries(rowById)\n                    .map(async ([id, row]) => {\n                        const masterState = masterDocsState[id];\n                        if (!masterState) {\n                            writeRows.push({\n                                document: docStateToWriteDoc(databaseInstanceToken, row.newDocumentState)\n                            });\n                        } else if (\n                            masterState &&\n                            !row.assumedMasterState\n                        ) {\n                            conflicts.push(writeDocToDocState(masterState));\n                        } else if (\n                            (await conflictHandler({\n                                realMasterState: writeDocToDocState(masterState),\n                                newDocumentState: ensureNotFalsy(row.assumedMasterState)\n                            }, 'rxStorageInstanceToReplicationHandler-masterWrite')).isEqual === true\n                        ) {\n                            writeRows.push({\n                                previous: masterState,\n                                document: docStateToWriteDoc(databaseInstanceToken, row.newDocumentState, masterState)\n                            });\n                        } else {\n                            conflicts.push(writeDocToDocState(masterState));\n                        }\n                    })\n            );\n\n\n            if (writeRows.length > 0) {\n                const result = await instance.bulkWrite(\n                    writeRows,\n                    'replication-master-write'\n                );\n                Object\n                    .values(result.error)\n                    .forEach(err => {\n                        if (err.status !== 409) {\n                            throw new Error('non conflict error');\n                        } else {\n                            conflicts.push(\n                                writeDocToDocState(ensureNotFalsy(err.documentInDb))\n                            );\n                        }\n                    });\n            }\n            return conflicts;\n        }\n    };\n\n    return replicationHandler;\n}\n\n\nexport function cancelRxStorageReplication(\n    replicationState: RxStorageInstanceReplicationState<any>\n) {\n    replicationState.events.canceled.next(true);\n    replicationState.events.active.up.complete();\n    replicationState.events.active.down.complete();\n    replicationState.events.processed.up.complete();\n    replicationState.events.processed.down.complete();\n    replicationState.events.resolvedConflicts.complete();\n    replicationState.events.canceled.complete();\n}\n"],"mappings":"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"}