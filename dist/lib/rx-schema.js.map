{"version":3,"file":"rx-schema.js","names":["_utils","require","_rxError","_hooks","_rxDocument","_rxSchemaHelper","_overwritable","RxSchema","jsonSchema","hashFunction","indexes","getIndexes","primaryPath","getPrimaryFieldOfPrimaryKey","primaryKey","finalFields","getFinalFields","_proto","prototype","validateChange","dataBefore","dataAfter","forEach","fieldName","deepEqual","newRxError","schema","getDocumentPrototype","proto","defineGetterSetter","overwriteGetterForCaching","getPrimaryOfDocumentData","documentData","getComposedPrimaryKeyOfDocumentData","_createClass2","default","key","get","version","values","Object","entries","properties","filter","v","hasOwnProperty","k","JSON","stringify","exports","map","index","isMaybeReadonlyArray","getPreviousVersions","c","Array","fill","createRxSchema","runPreCreateHooks","runPluginHooks","useJsonSchema","fillWithDefaultSettings","normalizeRxJsonSchema","overwritable","deepFreezeWhenDevMode","isRxSchema","obj","toTypedRxJsonSchema"],"sources":["../../src/rx-schema.ts"],"sourcesContent":["import {\n    overwriteGetterForCaching,\n    isMaybeReadonlyArray,\n    deepEqual\n} from './plugins/utils';\nimport {\n    newRxError,\n} from './rx-error';\nimport {\n    runPluginHooks\n} from './hooks';\nimport {\n    defineGetterSetter\n} from './rx-document';\n\nimport type {\n    DeepMutable,\n    DeepReadonly,\n    HashFunction,\n    MaybeReadonly,\n    RxDocumentData,\n    RxJsonSchema,\n    StringKeys\n} from './types';\nimport {\n    fillWithDefaultSettings,\n    getComposedPrimaryKeyOfDocumentData,\n    getFinalFields,\n    getPrimaryFieldOfPrimaryKey,\n    normalizeRxJsonSchema\n} from './rx-schema-helper';\nimport { overwritable } from './overwritable';\n\nexport class RxSchema<RxDocType = any> {\n    public indexes: MaybeReadonly<string[]>[];\n    public readonly primaryPath: StringKeys<RxDocumentData<RxDocType>>;\n    public finalFields: string[];\n\n    constructor(\n        public readonly jsonSchema: RxJsonSchema<RxDocumentData<RxDocType>>,\n        public readonly hashFunction: HashFunction\n    ) {\n        this.indexes = getIndexes(this.jsonSchema);\n\n        // primary is always required\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.jsonSchema.primaryKey);\n\n        this.finalFields = getFinalFields(this.jsonSchema);\n    }\n\n    public get version(): number {\n        return this.jsonSchema.version;\n    }\n\n    public get defaultValues(): { [P in keyof RxDocType]: RxDocType[P] } {\n        const values = {} as { [P in keyof RxDocType]: RxDocType[P] };\n        Object\n            .entries(this.jsonSchema.properties)\n            .filter(([, v]) => (v as any).hasOwnProperty('default'))\n            .forEach(([k, v]) => (values as any)[k] = (v as any).default);\n        return overwriteGetterForCaching(\n            this,\n            'defaultValues',\n            values\n        );\n    }\n\n    /**\n     * @overrides itself on the first call\n     *\n     * TODO this should be a pure function that\n     * caches the hash in a WeakMap.\n     */\n    public get hash(): string {\n        return overwriteGetterForCaching(\n            this,\n            'hash',\n            this.hashFunction(JSON.stringify(this.jsonSchema))\n        );\n    }\n\n    /**\n     * checks if a given change on a document is allowed\n     * Ensures that:\n     * - final fields are not modified\n     * @throws {Error} if not valid\n     */\n    validateChange(dataBefore: any, dataAfter: any): void {\n        this.finalFields.forEach(fieldName => {\n            if (!deepEqual(dataBefore[fieldName], dataAfter[fieldName])) {\n                throw newRxError('DOC9', {\n                    dataBefore,\n                    dataAfter,\n                    fieldName,\n                    schema: this.jsonSchema\n                });\n            }\n        });\n    }\n\n    /**\n     * creates the schema-based document-prototype,\n     * see RxCollection.getDocumentPrototype()\n     */\n    public getDocumentPrototype(): any {\n        const proto = {};\n        defineGetterSetter(this, proto, '');\n        overwriteGetterForCaching(\n            this,\n            'getDocumentPrototype',\n            () => proto\n        );\n        return proto;\n    }\n\n\n    getPrimaryOfDocumentData(\n        documentData: Partial<RxDocType>\n    ): string {\n        return getComposedPrimaryKeyOfDocumentData(\n            this.jsonSchema,\n            documentData\n        );\n    }\n}\n\nexport function getIndexes<RxDocType = any>(\n    jsonSchema: RxJsonSchema<RxDocType>\n): MaybeReadonly<string[]>[] {\n    return (jsonSchema.indexes || []).map(index => isMaybeReadonlyArray(index) ? index : [index]);\n}\n\n/**\n * array with previous version-numbers\n */\nexport function getPreviousVersions(schema: RxJsonSchema<any>): number[] {\n    const version = schema.version ? schema.version : 0;\n    let c = 0;\n    return new Array(version)\n        .fill(0)\n        .map(() => c++);\n}\n\nexport function createRxSchema<T>(\n    jsonSchema: RxJsonSchema<T>,\n    hashFunction: HashFunction,\n    runPreCreateHooks = true\n): RxSchema<T> {\n    if (runPreCreateHooks) {\n        runPluginHooks('preCreateRxSchema', jsonSchema);\n    }\n\n    let useJsonSchema = fillWithDefaultSettings(jsonSchema);\n    useJsonSchema = normalizeRxJsonSchema(useJsonSchema);\n    overwritable.deepFreezeWhenDevMode(useJsonSchema);\n\n    const schema = new RxSchema(useJsonSchema, hashFunction);\n    runPluginHooks('createRxSchema', schema);\n    return schema;\n}\n\nexport function isRxSchema(obj: any): boolean {\n    return obj instanceof RxSchema;\n}\n\n/**\n * Used as helper function the generate the document type out of the schema via typescript.\n * @link https://github.com/pubkey/rxdb/discussions/3467\n */\nexport function toTypedRxJsonSchema<T extends DeepReadonly<RxJsonSchema<any>>>(schema: T): DeepMutable<T> {\n    return schema as any;\n}\n"],"mappings":"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"}