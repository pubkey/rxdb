{"version":3,"file":"index.js","names":["pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","backupSingleDocument","rxDocument","options","data","toJSON","writtenFiles","docFolder","documentFolder","primary","clearFolder","fileLocation","path","join","writeJsonToFile","push","attachments","attachmentsFolder","ensureFolderExists","allAttachments","Promise","all","map","attachment","getData","content","attachmentFileLocation","id","writeToFile","BACKUP_STATES_BY_DB","WeakMap","addToBackupStates","db","has","set","ar","getFromMapOrThrow","newRxError","RxBackupState","database","isStopped","subs","persistRunning","PROMISE_RESOLVE_VOID","initialReplicationDone$","BehaviorSubject","internalWriteEvents$","Subject","writeEvents$","asObservable","batchSize","prepareFolders","persistOnce","_persistOnce","getMeta","meta","Object","entries","collections","collectionName","collection","primaryKey","schema","primaryPath","processedDocuments","Set","requestIdlePromise","collectionStates","checkpoint","lastCheckpoint","setMeta","hasMore","storageInstance","getChangedDocumentsSince","changesResult","documents","length","docIds","doc","filter","add","elem","pos","arr","indexOf","findByIds","docs","size","Array","from","values","next","name","documentId","files","deleted","docId","deleteFolder","getValue","watchForChanges","forEach","changes$","changeStream","sub","subscribe","awaitInitialBackup","firstValueFrom","pipe","cancel","PROMISE_RESOLVE_FALSE","unsubscribe","PROMISE_RESOLVE_TRUE","backup","backupState","live","RxDBBackupPlugin","rxdb","prototypes","RxDatabase","proto","hooks","preDestroyRxDatabase","after","states","get"],"sources":["../../../../src/plugins/backup/index.ts"],"sourcesContent":["import * as path from 'path';\nimport {\n    BehaviorSubject,\n    firstValueFrom,\n    Observable,\n    Subject,\n    Subscription\n} from 'rxjs';\nimport {\n    filter,\n    map\n} from 'rxjs/operators';\nimport { newRxError } from '../../rx-error';\nimport type {\n    BackupOptions,\n    RxBackupWriteEvent,\n    RxCollection,\n    RxDatabase,\n    RxDocument,\n    RxPlugin\n} from '../../types';\nimport {\n    getFromMapOrThrow,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_TRUE,\n    PROMISE_RESOLVE_VOID\n} from '../../util';\nimport {\n    clearFolder,\n    deleteFolder,\n    documentFolder,\n    ensureFolderExists,\n    getMeta,\n    prepareFolders,\n    setMeta,\n    writeJsonToFile,\n    writeToFile\n} from './file-util';\n\n\n/**\n * Backups a single documents,\n * returns the paths to all written files\n */\nexport async function backupSingleDocument(\n    rxDocument: RxDocument<any, any>,\n    options: BackupOptions\n): Promise<string[]> {\n    const data = rxDocument.toJSON(true);\n    const writtenFiles: string[] = [];\n\n    const docFolder = documentFolder(options, rxDocument.primary);\n    await clearFolder(docFolder);\n\n    const fileLocation = path.join(\n        docFolder,\n        'document.json'\n    );\n    await writeJsonToFile(fileLocation, data);\n    writtenFiles.push(fileLocation);\n\n    if (options.attachments) {\n        const attachmentsFolder = path.join(\n            docFolder,\n            'attachments'\n        );\n        ensureFolderExists(attachmentsFolder);\n        const attachments = (rxDocument as RxDocument).allAttachments();\n        await Promise.all(\n            attachments\n                .map(async (attachment) => {\n                    const content = await attachment.getData();\n                    const attachmentFileLocation = path.join(\n                        attachmentsFolder,\n                        attachment.id\n                    );\n                    await writeToFile(attachmentFileLocation, content as Buffer);\n                    writtenFiles.push(attachmentFileLocation);\n                })\n        );\n    }\n\n    return writtenFiles;\n}\n\nconst BACKUP_STATES_BY_DB: WeakMap<RxDatabase, RxBackupState[]> = new WeakMap();\nfunction addToBackupStates(db: RxDatabase, state: RxBackupState) {\n    if (!BACKUP_STATES_BY_DB.has(db)) {\n        BACKUP_STATES_BY_DB.set(db, []);\n    }\n    const ar = getFromMapOrThrow(BACKUP_STATES_BY_DB, db);\n    if (!ar) {\n        throw newRxError('SNH');\n    }\n    ar.push(state);\n}\n\nexport class RxBackupState {\n    public isStopped: boolean = false;\n    private subs: Subscription[] = [];\n    private persistRunning: Promise<void> = PROMISE_RESOLVE_VOID;\n    private initialReplicationDone$: BehaviorSubject<boolean> = new BehaviorSubject(false as any);\n\n    private readonly internalWriteEvents$: Subject<RxBackupWriteEvent> = new Subject();\n    public readonly writeEvents$: Observable<RxBackupWriteEvent> = this.internalWriteEvents$.asObservable();\n\n    constructor(\n        public readonly database: RxDatabase,\n        public readonly options: BackupOptions\n    ) {\n        if (!this.options.batchSize) {\n            this.options.batchSize = 10;\n        }\n        addToBackupStates(database, this);\n        prepareFolders(database, options);\n    }\n\n    /**\n     * Persists all data from all collections,\n     * beginning from the oldest sequence checkpoint\n     * to the newest one.\n     * Do not call this while it is already running.\n     * Returns true if there are more documents to process\n     */\n    public async persistOnce() {\n        return this.persistRunning = this.persistRunning.then(() => this._persistOnce());\n    }\n\n    public async _persistOnce() {\n        const meta = await getMeta(this.options);\n\n        await Promise.all(\n            Object\n                .entries(this.database.collections)\n                .map(async ([collectionName, collection]) => {\n                    const primaryKey = collection.schema.primaryPath;\n                    const processedDocuments: Set<string> = new Set();\n\n                    await this.database.requestIdlePromise();\n\n                    if (!meta.collectionStates[collectionName]) {\n                        meta.collectionStates[collectionName] = {};\n                    }\n                    let lastCheckpoint = meta.collectionStates[collectionName].checkpoint;\n\n                    let hasMore = true;\n                    while (hasMore && !this.isStopped) {\n                        await this.database.requestIdlePromise();\n                        const changesResult = await collection.storageInstance.getChangedDocumentsSince(\n                            this.options.batchSize ? this.options.batchSize : 0,\n                            lastCheckpoint\n                        );\n                        lastCheckpoint = changesResult.documents.length > 0 ? changesResult.checkpoint : lastCheckpoint;\n                        meta.collectionStates[collectionName].checkpoint = lastCheckpoint;\n\n                        const docIds: string[] = changesResult.documents\n                            .map(doc => doc[primaryKey])\n                            .filter(id => {\n                                if (\n                                    processedDocuments.has(id)\n                                ) {\n                                    return false;\n                                } else {\n                                    processedDocuments.add(id);\n                                    return true;\n                                }\n                            })\n                            .filter((elem, pos, arr) => arr.indexOf(elem) === pos); // unique\n                        await this.database.requestIdlePromise();\n\n                        const docs: Map<string, RxDocument> = await collection.findByIds(docIds);\n                        if (docs.size === 0) {\n                            hasMore = false;\n                            continue;\n                        }\n                        await Promise.all(\n                            Array\n                                .from(docs.values())\n                                .map(async (doc) => {\n                                    const writtenFiles = await backupSingleDocument(doc, this.options);\n                                    this.internalWriteEvents$.next({\n                                        collectionName: collection.name,\n                                        documentId: doc.primary,\n                                        files: writtenFiles,\n                                        deleted: false\n                                    });\n                                })\n                        );\n                        // handle deleted documents\n                        await Promise.all(\n                            docIds\n                                .filter(docId => !docs.has(docId))\n                                .map(async (docId) => {\n                                    await deleteFolder(documentFolder(this.options, docId));\n                                    this.internalWriteEvents$.next({\n                                        collectionName: collection.name,\n                                        documentId: docId,\n                                        files: [],\n                                        deleted: true\n                                    });\n                                })\n                        );\n                    }\n                    meta.collectionStates[collectionName].checkpoint = lastCheckpoint;\n                    await setMeta(this.options, meta);\n                })\n        );\n\n        if (!this.initialReplicationDone$.getValue()) {\n            this.initialReplicationDone$.next(true);\n        }\n    }\n\n    public watchForChanges() {\n        const collections: RxCollection[] = Object.values(this.database.collections);\n        collections.forEach(collection => {\n            const changes$ = collection.storageInstance.changeStream();\n            const sub = changes$.subscribe(() => {\n                this.persistOnce();\n            });\n            this.subs.push(sub);\n        });\n    }\n\n    /**\n     * Returns a promise that resolves when the initial backup is done\n     * and the filesystem is in sync with the database state\n     */\n    public awaitInitialBackup(): Promise<boolean> {\n        return firstValueFrom(\n            this.initialReplicationDone$.pipe(\n                filter(v => !!v),\n                map(() => true)\n            )\n        );\n    }\n\n    cancel(): Promise<boolean> {\n        if (this.isStopped) {\n            return PROMISE_RESOLVE_FALSE;\n        }\n        this.isStopped = true;\n        this.subs.forEach(sub => sub.unsubscribe());\n        return PROMISE_RESOLVE_TRUE;\n    }\n}\n\n\nexport function backup(\n    this: RxDatabase,\n    options: BackupOptions\n): RxBackupState {\n    const backupState = new RxBackupState(this, options);\n    backupState.persistOnce();\n\n    if (options.live) {\n        backupState.watchForChanges();\n    }\n\n    return backupState;\n}\n\nexport * from './file-util';\nexport const RxDBBackupPlugin: RxPlugin = {\n    name: 'backup',\n    rxdb: true,\n    prototypes: {\n        RxDatabase(proto: any) {\n            proto.backup = backup;\n        }\n    },\n    hooks: {\n        preDestroyRxDatabase: {\n            after: function preDestroyRxDatabase(db: RxDatabase) {\n                const states = BACKUP_STATES_BY_DB.get(db);\n                if (states) {\n                    states.forEach(state => state.cancel());\n                }\n            }\n        }\n    }\n};\n"],"mappings":"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"}