{"version":3,"file":"file-util.js","names":["writeToFile","location","data","Promise","res","rej","fs","writeFile","err","blobBufferUtil","toString","ensureFolderExists","folderPath","existsSync","mkdirSync","recursive","clearFolder","deleteFolder","rmdirSync","prepareFolders","database","options","directory","metaLoc","metaFileLocation","currentTime","now","metaData","createdAt","updatedAt","collectionStates","writeFileSync","JSON","stringify","Object","keys","collections","forEach","collectionName","path","join","writeJsonToFile","getMeta","loc","readFile","metaContent","parse","setMeta","meta","documentFolder","docId"],"sources":["../../../../src/plugins/backup/file-util.ts"],"sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport {\n    BackupMetaFileContent,\n    BackupOptions,\n    BlobBuffer,\n    RxDatabase\n} from '../../types';\nimport { blobBufferUtil, now } from '../../util';\n\n/**\n * ensure that the given folder exists\n */\nexport function ensureFolderExists(folderPath: string): void {\n    if (!fs.existsSync(folderPath)) {\n        fs.mkdirSync(folderPath, { recursive: true });\n    }\n}\n\n/**\n * deletes and recreates the folder\n */\nexport function clearFolder(folderPath: string): void {\n    deleteFolder(folderPath);\n    ensureFolderExists(folderPath);\n}\n\nexport function deleteFolder(folderPath: string): void {\n    // only remove if exists to not raise warning\n    if (fs.existsSync(folderPath)) {\n        fs.rmdirSync(folderPath, { recursive: true });\n    }\n}\n\nexport function prepareFolders(\n    database: RxDatabase,\n    options: BackupOptions\n) {\n    ensureFolderExists(options.directory);\n\n    const metaLoc = metaFileLocation(options);\n\n    if (!fs.existsSync(metaLoc)) {\n        const currentTime = now();\n        const metaData: BackupMetaFileContent = {\n            createdAt: currentTime,\n            updatedAt: currentTime,\n            collectionStates: {}\n        };\n        fs.writeFileSync(metaLoc, JSON.stringify(metaData), 'utf-8');\n    }\n\n    Object.keys(database.collections).forEach(collectionName => {\n        ensureFolderExists(\n            path.join(\n                options.directory,\n                collectionName\n            )\n        );\n    });\n}\n\nexport async function writeToFile(\n    location: string,\n    data: string | BlobBuffer\n): Promise<void> {\n    if (typeof data !== 'string') {\n        data = await blobBufferUtil.toString(data);\n    }\n    return new Promise(function (res, rej) {\n        fs.writeFile(\n            location,\n            data as string,\n            'utf-8',\n            (err) => {\n                if (err) {\n                    rej(err);\n                } else {\n                    res();\n                }\n            }\n        );\n    });\n}\n\nexport function writeJsonToFile(\n    location: string,\n    data: any\n): Promise<void> {\n    return writeToFile(\n        location,\n        JSON.stringify(data)\n    );\n}\n\nexport function metaFileLocation(options: BackupOptions): string {\n    return path.join(\n        options.directory,\n        'backup_meta.json'\n    );\n}\n\nexport function getMeta(options: BackupOptions): Promise<BackupMetaFileContent> {\n    const loc = metaFileLocation(options);\n    return new Promise((res, rej) => {\n        fs.readFile(loc, 'utf-8', (err, data) => {\n            if (err) {\n                rej(err);\n            } else {\n                const metaContent = JSON.parse(data);\n                res(metaContent);\n            }\n        });\n    });\n}\n\nexport function setMeta(\n    options: BackupOptions,\n    meta: BackupMetaFileContent\n): Promise<void> {\n    const loc = metaFileLocation(options);\n    return writeJsonToFile(loc, meta);\n}\n\nexport function documentFolder(\n    options: BackupOptions,\n    docId: string\n): string {\n    return path.join(\n        options.directory,\n        docId\n    );\n}\n"],"mappings":"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"}