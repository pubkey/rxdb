{"version":3,"file":"replication-helper.js","names":["DEFAULT_MODIFIER","d","Promise","resolve","swapDefaultDeletedTodeletedField","deletedField","doc","flatClone","isDeleted","_deleted","handlePulledDocuments","collection","docs","map","useDoc","primaryPath","schema","getComposedPrimaryKeyOfDocumentData","jsonSchema","awaitRetry","retryTime","window","addEventListener","navigator","onLine","promiseWait","listener","onlineAgain","res","removeEventListener","race","then"],"sources":["../../../../src/plugins/replication/replication-helper.ts"],"sourcesContent":["import type {\n    RxCollection,\n    WithDeleted\n} from '../../types';\nimport { flatClone } from '../../plugins/utils';\nimport { getComposedPrimaryKeyOfDocumentData } from '../../rx-schema-helper';\n\n// does nothing\nexport const DEFAULT_MODIFIER = (d: any) => Promise.resolve(d);\n\n\nexport function swapDefaultDeletedTodeletedField<RxDocType>(\n    deletedField: string,\n    doc: WithDeleted<RxDocType>\n): RxDocType {\n    if (deletedField === '_deleted') {\n        return doc;\n    } else {\n        doc = flatClone(doc);\n        const isDeleted = !!doc._deleted;\n        (doc as any)[deletedField] = isDeleted;\n        delete (doc as any)._deleted;\n        return doc;\n    }\n}\n\n/**\n * Must be run over all plain document data\n * that was pulled from the remote.\n * Used to fill up fields or modify the deleted field etc.\n */\nexport function handlePulledDocuments<RxDocType>(\n    collection: RxCollection<RxDocType>,\n    deletedField: string,\n    docs: RxDocType[]\n): WithDeleted<RxDocType>[] {\n    return docs.map(doc => {\n        const useDoc: WithDeleted<RxDocType> = flatClone(doc) as any;\n\n        /**\n         * Swap out the deleted field\n         */\n        if (deletedField !== '_deleted') {\n            const isDeleted = !!(useDoc as any)[deletedField];\n            (useDoc as any)._deleted = isDeleted;\n            delete (useDoc as any)[deletedField];\n        } else {\n            // ensure we have a boolean.\n            useDoc._deleted = !!useDoc._deleted;\n        }\n\n        /**\n         * Fill up composed primary\n         */\n        const primaryPath = collection.schema.primaryPath;\n        (useDoc as any)[primaryPath] = getComposedPrimaryKeyOfDocumentData(\n            collection.schema.jsonSchema,\n            useDoc\n        );\n        return useDoc as any;\n    });\n}\n\n\nexport function awaitRetry(\n    collection: RxCollection,\n    retryTime: number\n) {\n    if (\n        typeof window === 'undefined' ||\n        typeof window !== 'object' ||\n        typeof window.addEventListener === 'undefined' ||\n        navigator.onLine\n    ) {\n        return collection.promiseWait(retryTime);\n    }\n\n    let listener: any;\n    const onlineAgain = new Promise<void>(res => {\n        listener = () => {\n            window.removeEventListener('online', listener);\n            res();\n        };\n        window.addEventListener('online', listener);\n    });\n\n    return Promise.race([\n        onlineAgain,\n        collection.promiseWait(retryTime)\n    ]).then(() => {\n        window.removeEventListener('online', listener);\n    });\n}\n"],"mappings":";;;;;;;;;AAIA;AACA;AAEA;AACO,IAAMA,gBAAgB,GAAIC,CAAM,IAAKC,OAAO,CAACC,OAAO,CAACF,CAAC,CAAC;AAAC;AAGxD,SAASG,gCAAgC,CAC5CC,YAAoB,EACpBC,GAA2B,EAClB;EACT,IAAID,YAAY,KAAK,UAAU,EAAE;IAC7B,OAAOC,GAAG;EACd,CAAC,MAAM;IACHA,GAAG,GAAG,IAAAC,gBAAS,EAACD,GAAG,CAAC;IACpB,IAAME,SAAS,GAAG,CAAC,CAACF,GAAG,CAACG,QAAQ;IAC/BH,GAAG,CAASD,YAAY,CAAC,GAAGG,SAAS;IACtC,OAAQF,GAAG,CAASG,QAAQ;IAC5B,OAAOH,GAAG;EACd;AACJ;;AAEA;AACA;AACA;AACA;AACA;AACO,SAASI,qBAAqB,CACjCC,UAAmC,EACnCN,YAAoB,EACpBO,IAAiB,EACO;EACxB,OAAOA,IAAI,CAACC,GAAG,CAACP,GAAG,IAAI;IACnB,IAAMQ,MAA8B,GAAG,IAAAP,gBAAS,EAACD,GAAG,CAAQ;;IAE5D;AACR;AACA;IACQ,IAAID,YAAY,KAAK,UAAU,EAAE;MAC7B,IAAMG,SAAS,GAAG,CAAC,CAAEM,MAAM,CAAST,YAAY,CAAC;MAChDS,MAAM,CAASL,QAAQ,GAAGD,SAAS;MACpC,OAAQM,MAAM,CAAST,YAAY,CAAC;IACxC,CAAC,MAAM;MACH;MACAS,MAAM,CAACL,QAAQ,GAAG,CAAC,CAACK,MAAM,CAACL,QAAQ;IACvC;;IAEA;AACR;AACA;IACQ,IAAMM,WAAW,GAAGJ,UAAU,CAACK,MAAM,CAACD,WAAW;IAChDD,MAAM,CAASC,WAAW,CAAC,GAAG,IAAAE,mDAAmC,EAC9DN,UAAU,CAACK,MAAM,CAACE,UAAU,EAC5BJ,MAAM,CACT;IACD,OAAOA,MAAM;EACjB,CAAC,CAAC;AACN;AAGO,SAASK,UAAU,CACtBR,UAAwB,EACxBS,SAAiB,EACnB;EACE,IACI,OAAOC,MAAM,KAAK,WAAW,IAC7B,OAAOA,MAAM,KAAK,QAAQ,IAC1B,OAAOA,MAAM,CAACC,gBAAgB,KAAK,WAAW,IAC9CC,SAAS,CAACC,MAAM,EAClB;IACE,OAAOb,UAAU,CAACc,WAAW,CAACL,SAAS,CAAC;EAC5C;EAEA,IAAIM,QAAa;EACjB,IAAMC,WAAW,GAAG,IAAIzB,OAAO,CAAO0B,GAAG,IAAI;IACzCF,QAAQ,GAAG,MAAM;MACbL,MAAM,CAACQ,mBAAmB,CAAC,QAAQ,EAAEH,QAAQ,CAAC;MAC9CE,GAAG,EAAE;IACT,CAAC;IACDP,MAAM,CAACC,gBAAgB,CAAC,QAAQ,EAAEI,QAAQ,CAAC;EAC/C,CAAC,CAAC;EAEF,OAAOxB,OAAO,CAAC4B,IAAI,CAAC,CAChBH,WAAW,EACXhB,UAAU,CAACc,WAAW,CAACL,SAAS,CAAC,CACpC,CAAC,CAACW,IAAI,CAAC,MAAM;IACVV,MAAM,CAACQ,mBAAmB,CAAC,QAAQ,EAAEH,QAAQ,CAAC;EAClD,CAAC,CAAC;AACN"}