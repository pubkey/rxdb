{"version":3,"file":"index.js","names":["body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","REPLICATION_STATE_BY_COLLECTION","WeakMap","RxReplicationState","replicationIdentifierHash","collection","deletedField","pull","push","live","retryTime","autoStart","subs","subjects","received","Subject","send","error","canceled","BehaviorSubject","active","initialReplicationComplete","received$","asObservable","send$","error$","canceled$","active$","callOnStart","undefined","remoteEvents$","replicationStates","get","set","onDestroy","cancel","Object","keys","forEach","key","defineProperty","startPromise","Promise","res","start","isStopped","pullModifier","modifier","DEFAULT_MODIFIER","pushModifier","database","storage","createStorageInstance","databaseName","name","collectionName","databaseInstanceToken","token","multiInstance","options","schema","RX_REPLICATION_META_INSTANCE_SCHEMA","metaInstance","internalReplicationState","replicateRxStorageInstance","pushBatchSize","batchSize","pullBatchSize","forkInstance","storageInstance","hashFunction","identifier","conflictHandler","replicationHandler","masterChangeStream$","pipe","mergeMap","ev","useEv","flatClone","documents","map","doc","swapdeletedFieldToDefaultDeleted","all","d","masterChangesSince","checkpoint","useResult","done","handler","err","emitError","newRxError","errors","Array","isArray","direction","next","promiseWait","ensureNotFalsy","masterWrite","rows","row","newDocumentState","swapDefaultDeletedTodeletedField","assumedMasterState","useRows","conflicts","pushRows","events","subscribe","processed","down","document","up","writeToMasterRow","stream$","awaitRxStorageReplicationFirstInSync","getValue","awaitInitialReplication","awaitInSync","awaitRxStorageReplicationInSync","reSync","emitEvent","PROMISE_RESOLVE_FALSE","promises","checkpointQueue","close","sub","unsubscribe","complete","replicateRxCollection","replicationIdentifier","waitForLeadership","fastUnsecureHash","join","replicationState","startReplicationOnLeaderShip","mustWaitForLeadership","waitTillRun","PROMISE_RESOLVE_TRUE","isDeleted","_deleted"],"sources":["../../../../src/plugins/replication/index.ts"],"sourcesContent":["/**\n * This plugin contains the primitives to create\n * a RxDB client-server replication.\n * It is used in the other replication plugins\n * but also can be used as standalone with a custom replication handler.\n */\n\nimport {\n    BehaviorSubject,\n    mergeMap,\n    Observable,\n    Subject,\n    Subscription\n} from 'rxjs';\nimport type {\n    ReplicationOptions,\n    ReplicationPullHandlerResult,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxCollection,\n    RxDocumentData,\n    RxError,\n    RxReplicationPullStreamItem,\n    RxReplicationWriteToMasterRow,\n    RxStorageInstance,\n    RxStorageInstanceReplicationState,\n    RxStorageReplicationMeta,\n    RxTypeError,\n    WithDeleted\n} from '../../types';\nimport {\n    ensureNotFalsy,\n    fastUnsecureHash,\n    flatClone,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_TRUE\n} from '../../util';\nimport {\n    awaitRxStorageReplicationFirstInSync,\n    awaitRxStorageReplicationInSync,\n    replicateRxStorageInstance,\n    RX_REPLICATION_META_INSTANCE_SCHEMA\n} from '../../replication-protocol';\nimport { newRxError } from '../../rx-error';\nimport { DEFAULT_MODIFIER } from './replication-helper';\n\n\nexport const REPLICATION_STATE_BY_COLLECTION: WeakMap<RxCollection, RxReplicationState<any, any>[]> = new WeakMap();\n\nexport class RxReplicationState<RxDocType, CheckpointType> {\n    public readonly subs: Subscription[] = [];\n    public readonly subjects = {\n        received: new Subject<RxDocumentData<RxDocType>>(), // all documents that are received from the endpoint\n        send: new Subject<WithDeleted<RxDocType>>(), // all documents that are send to the endpoint\n        error: new Subject<RxError | RxTypeError>(), // all errors that are received from the endpoint, emits new Error() objects\n        canceled: new BehaviorSubject<boolean>(false), // true when the replication was canceled\n        active: new BehaviorSubject<boolean>(false), // true when something is running, false when not\n        initialReplicationComplete: new BehaviorSubject<boolean>(false) // true the initial replication-cycle is over\n    };\n\n\n    readonly received$: Observable<RxDocumentData<RxDocType>> = this.subjects.received.asObservable();\n    readonly send$: Observable<WithDeleted<RxDocType>> = this.subjects.send.asObservable();\n    readonly error$: Observable<RxError | RxTypeError> = this.subjects.error.asObservable();\n    readonly canceled$: Observable<any> = this.subjects.canceled.asObservable();\n    readonly active$: Observable<boolean> = this.subjects.active.asObservable();\n\n    private startPromise: Promise<void>;\n    constructor(\n        /**\n         * hash of the identifier, used to flag revisions\n         * and to identify which documents state came from the remote.\n         */\n        public readonly replicationIdentifierHash: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly deletedField: string,\n        public readonly pull?: ReplicationPullOptions<RxDocType, CheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live?: boolean,\n        public retryTime?: number,\n        public autoStart?: boolean,\n    ) {\n        let replicationStates = REPLICATION_STATE_BY_COLLECTION.get(collection);\n        if (!replicationStates) {\n            replicationStates = [];\n            REPLICATION_STATE_BY_COLLECTION.set(collection, replicationStates);\n        }\n        replicationStates.push(this);\n\n\n        // stop the replication when the collection gets destroyed\n        this.collection.onDestroy.push(() => this.cancel());\n\n        // create getters for the observables\n        Object.keys(this.subjects).forEach(key => {\n            Object.defineProperty(this, key + '$', {\n                get: function () {\n                    return this.subjects[key].asObservable();\n                }\n            });\n        });\n\n        const startPromise = new Promise<void>(res => {\n            this.callOnStart = res;\n        });\n        this.startPromise = startPromise;\n    }\n\n    private callOnStart: () => void = undefined as any;\n\n    public internalReplicationState?: RxStorageInstanceReplicationState<RxDocType>;\n    public metaInstance?: RxStorageInstance<RxStorageReplicationMeta, any, {}, any>;\n    public remoteEvents$: Subject<RxReplicationPullStreamItem<RxDocType, CheckpointType>> = new Subject();\n\n    public async start(): Promise<void> {\n        if (this.isStopped()) {\n            return;\n        }\n\n        // fill in defaults for pull & push\n        const pullModifier = this.pull && this.pull.modifier ? this.pull.modifier : DEFAULT_MODIFIER;\n        const pushModifier = this.push && this.push.modifier ? this.push.modifier : DEFAULT_MODIFIER;\n\n        const database = this.collection.database;\n        this.metaInstance = await this.collection.database.storage.createStorageInstance({\n            databaseName: database.name,\n            collectionName: this.collection.name + '-rx-replication-' + this.replicationIdentifierHash,\n            databaseInstanceToken: database.token,\n            multiInstance: database.multiInstance, // TODO is this always false?\n            options: {},\n            schema: RX_REPLICATION_META_INSTANCE_SCHEMA\n        });\n\n        this.internalReplicationState = replicateRxStorageInstance({\n            pushBatchSize: this.push && this.push.batchSize ? this.push.batchSize : 100,\n            pullBatchSize: this.pull && this.pull.batchSize ? this.pull.batchSize : 100,\n            forkInstance: this.collection.storageInstance,\n            metaInstance: this.metaInstance,\n            hashFunction: database.hashFunction,\n            identifier: 'rx-replication-' + this.replicationIdentifierHash,\n            conflictHandler: this.collection.conflictHandler,\n            replicationHandler: {\n                masterChangeStream$: this.remoteEvents$.asObservable().pipe(\n                    mergeMap(async (ev) => {\n                        if (ev === 'RESYNC') {\n                            return ev;\n                        }\n                        const useEv = flatClone(ev);\n                        if (this.deletedField !== '_deleted') {\n                            useEv.documents = useEv.documents.map(doc => swapdeletedFieldToDefaultDeleted(this.deletedField, doc))\n                        }\n                        useEv.documents = await Promise.all(\n                            useEv.documents.map(d => pullModifier(d))\n                        );\n                        return useEv;\n                    })\n                ),\n                masterChangesSince: async (\n                    checkpoint: CheckpointType,\n                    batchSize: number\n                ) => {\n                    if (!this.pull) {\n                        return {\n                            checkpoint: null,\n                            documents: []\n                        };\n                    }\n\n                    /**\n                     * Retries must be done here in the replication primitives plugin,\n                     * because the replication protocol itself has no\n                     * error handling.\n                     */\n                    let done = false;\n                    let result: ReplicationPullHandlerResult<RxDocType> = {} as any;\n                    while (!done) {\n                        try {\n                            result = await this.pull.handler(\n                                checkpoint,\n                                batchSize\n                            );\n                            done = true;\n                        } catch (err: any | Error | Error[]) {\n                            const emitError = newRxError('RC_PULL', {\n                                checkpoint,\n                                errors: Array.isArray(err) ? err : [err],\n                                direction: 'pull'\n                            });\n                            this.subjects.error.next(emitError);\n                            await this.collection.promiseWait(ensureNotFalsy(this.retryTime));\n                        }\n                    }\n\n                    const useResult = flatClone(result);\n                    if (this.deletedField !== '_deleted') {\n                        useResult.documents = useResult.documents.map(doc => swapdeletedFieldToDefaultDeleted(this.deletedField, doc))\n                    }\n                    useResult.documents = await Promise.all(\n                        useResult.documents.map(d => pullModifier(d))\n                    );\n\n                    return useResult;\n                },\n                masterWrite: async (\n                    rows: RxReplicationWriteToMasterRow<RxDocType>[]\n                ) => {\n                    if (!this.push) {\n                        return [];\n                    }\n                    let done = false;\n                    const useRows = await Promise.all(\n                        rows.map(async (row) => {\n                            row.newDocumentState = await pushModifier(row.newDocumentState);\n                            if (row.assumedMasterState) {\n                                row.assumedMasterState = await pushModifier(row.assumedMasterState);\n                            }\n\n                            if (this.deletedField !== '_deleted') {\n                                row.newDocumentState = swapDefaultDeletedTodeletedField(this.deletedField, row.newDocumentState) as any;\n                                if (row.assumedMasterState) {\n                                    row.assumedMasterState = swapDefaultDeletedTodeletedField(this.deletedField, row.assumedMasterState) as any;\n                                }\n                            }\n\n                            return row;\n                        })\n                    );\n\n                    let result: WithDeleted<RxDocType>[] = {} as any;\n                    while (!done) {\n                        try {\n                            result = await this.push.handler(useRows);\n                            done = true;\n                        } catch (err: any | Error | Error[]) {\n                            const emitError = newRxError('RC_PUSH', {\n                                pushRows: rows,\n                                errors: Array.isArray(err) ? err : [err],\n                                direction: 'push'\n                            });\n                            this.subjects.error.next(emitError);\n                            await this.collection.promiseWait(ensureNotFalsy(this.retryTime));\n                        }\n                    }\n\n\n                    const conflicts = ensureNotFalsy(result).map(doc => swapdeletedFieldToDefaultDeleted(this.deletedField, doc));\n                    return conflicts;\n                }\n            }\n        });\n        this.subs.push(\n            this.internalReplicationState.events.error.subscribe(err => {\n                this.subjects.error.next(err);\n            })\n        );\n        this.subs.push(\n            this.internalReplicationState.events.processed.down\n                .subscribe(row => this.subjects.received.next(row.document))\n        );\n        this.subs.push(\n            this.internalReplicationState.events.processed.up\n                .subscribe(writeToMasterRow => {\n                    this.subjects.send.next(writeToMasterRow.newDocumentState);\n                })\n        );\n        if (\n            this.pull &&\n            this.pull.stream$ &&\n            this.live\n        ) {\n            this.subs.push(\n                this.pull.stream$.subscribe({\n                    next: ev => {\n                        this.remoteEvents$.next(ev);\n                    },\n                    error: err => {\n                        this.subjects.error.next(err);\n                    }\n                })\n            );\n        }\n\n        if (!this.live) {\n            await awaitRxStorageReplicationFirstInSync(this.internalReplicationState);\n            await this.cancel();\n        }\n        this.callOnStart();\n    }\n\n    isStopped(): boolean {\n        if (this.subjects.canceled.getValue()) {\n            return true;\n        }\n        return false;\n    }\n\n    async awaitInitialReplication(): Promise<void> {\n        await this.startPromise;\n        return awaitRxStorageReplicationFirstInSync(\n            ensureNotFalsy(this.internalReplicationState)\n        );\n    }\n\n    /**\n     * Returns a promise that resolves when:\n     * - All local data is replicated with the remote\n     * - No replication cycle is running or in retry-state\n     *\n     * WARNING: USing this function directly in a multi-tab browser application\n     * is dangerous because only the leading instance will ever be replicated,\n     * so this promise will not resolve in the other tabs.\n     * For multi-tab support you should set and observe a flag in a local document.\n     */\n    async awaitInSync(): Promise<true> {\n        await this.startPromise;\n        await awaitRxStorageReplicationFirstInSync(ensureNotFalsy(this.internalReplicationState));\n        await awaitRxStorageReplicationInSync(ensureNotFalsy(this.internalReplicationState));\n        return true;\n    }\n\n    reSync() {\n        this.remoteEvents$.next('RESYNC');\n    }\n    emitEvent(ev: RxReplicationPullStreamItem<RxDocType, CheckpointType>) {\n        this.remoteEvents$.next(ev);\n    }\n\n    cancel(): Promise<any> {\n        if (this.isStopped()) {\n            return PROMISE_RESOLVE_FALSE;\n        }\n\n        const promises: Promise<any>[] = [];\n\n        if (this.internalReplicationState) {\n            this.internalReplicationState.events.canceled.next(true);\n        }\n        if (this.metaInstance) {\n            promises.push(\n                ensureNotFalsy(this.internalReplicationState).checkpointQueue\n                    .then(() => ensureNotFalsy(this.metaInstance).close())\n            );\n        }\n\n        this.subs.forEach(sub => sub.unsubscribe());\n        this.subjects.canceled.next(true);\n\n        this.subjects.active.complete();\n        this.subjects.canceled.complete();\n        this.subjects.error.complete();\n        this.subjects.received.complete();\n        this.subjects.send.complete();\n\n        return Promise.all(promises);\n    }\n}\n\n\nexport function replicateRxCollection<RxDocType, CheckpointType>(\n    {\n        replicationIdentifier,\n        collection,\n        deletedField = '_deleted',\n        pull,\n        push,\n        live = true,\n        retryTime = 1000 * 5,\n        waitForLeadership = true,\n        autoStart = true,\n    }: ReplicationOptions<RxDocType, CheckpointType>\n): RxReplicationState<RxDocType, CheckpointType> {\n    const replicationIdentifierHash = fastUnsecureHash(\n        [\n            collection.database.name,\n            collection.name,\n            replicationIdentifier\n        ].join('|')\n    );\n    const replicationState = new RxReplicationState<RxDocType, CheckpointType>(\n        replicationIdentifierHash,\n        collection,\n        deletedField,\n        pull,\n        push,\n        live,\n        retryTime,\n        autoStart\n    );\n\n\n    startReplicationOnLeaderShip(waitForLeadership, replicationState);\n    return replicationState as any;\n}\n\n\nexport function startReplicationOnLeaderShip(\n    waitForLeadership: boolean,\n    replicationState: RxReplicationState<any, any>\n) {\n    /**\n        * Always await this Promise to ensure that the current instance\n        * is leader when waitForLeadership=true\n        */\n    const mustWaitForLeadership = waitForLeadership && replicationState.collection.database.multiInstance;\n    const waitTillRun: Promise<any> = mustWaitForLeadership ? replicationState.collection.database.waitForLeadership() : PROMISE_RESOLVE_TRUE;\n    return waitTillRun.then(() => {\n        if (replicationState.isStopped()) {\n            return;\n        }\n        if (replicationState.autoStart) {\n            replicationState.start();\n        }\n    });\n}\n\n\nexport function swapDefaultDeletedTodeletedField<RxDocType>(\n    deletedField: string,\n    doc: WithDeleted<RxDocType>\n): RxDocType {\n    if (deletedField === '_deleted') {\n        return doc;\n    } else {\n        doc = flatClone(doc);\n        const isDeleted = !!doc._deleted;\n        (doc as any)[deletedField] = isDeleted;\n        delete (doc as any)._deleted;\n        return doc;\n    }\n}\n\n\nexport function swapdeletedFieldToDefaultDeleted<RxDocType>(\n    deletedField: string,\n    doc: RxDocType\n): WithDeleted<RxDocType> {\n    if (deletedField === '_deleted') {\n        return doc as any;\n    } else {\n        doc = flatClone(doc);\n        const isDeleted = !!(doc as any)[deletedField];\n        (doc as any)._deleted = isDeleted;\n        delete (doc as any)[deletedField];\n        return doc as any;\n    }\n}\n"],"mappings":"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"}