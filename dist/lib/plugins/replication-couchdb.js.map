{"version":3,"file":"replication-couchdb.js","names":["INTERNAL_POUCHDBS","WeakSet","RxCouchDBReplicationStateBase","collection","syncOptions","_subs","_subjects","change","Subject","docs","denied","active","BehaviorSubject","complete","alive","error","canceled","Object","keys","forEach","key","defineProperty","get","asObservable","awaitInitialReplication","options","live","newRxError","database","name","multiInstance","waitForLeadership","that","firstValueFrom","complete$","pipe","filter","x","cancel","PROMISE_RESOLVE_FALSE","ret","PROMISE_RESOLVE_TRUE","_pouchEventEmitterObject","Promise","res","ensureNotFalsy","on","sub","unsubscribe","setPouchEventEmitter","rxRepState","evEmitter","push","fromEvent","subscribe","ev","next","observers","length","direction","doc","language","info","promiseWait","first","mergeMap","requestIdlePromise","then","getIsAlive","emitter","state","pull","reduce","acc","val","isAlive","resolve","skipUntil","createRxCouchDBReplicationState","pouchReplicationFunction","pouch","sync","bind","replicate","to","from","syncCouchDB","remote","retry","query","useOptions","flatClone","isInstanceOfPouchDB","has","isRxCollection","storageInstance","internals","getPouchDBOfRxCollection","syncFun","selector","getPreparedQuery","repState","waitTillRun","destroyed","pouchSync","onDestroy","RxDBReplicationCouchDBPlugin","rxdb","init","addPouchPlugin","PouchReplicationPlugin","prototypes","RxCollection","proto","hooks","createRxCollection","after","args","add"],"sources":["../../../src/plugins/replication-couchdb.ts"],"sourcesContent":["/**\n * this plugin adds the RxCollection.sync()-function to rxdb\n * you can use it to sync collections with remote or local couchdb-instances\n */\n\nimport PouchReplicationPlugin from 'pouchdb-replication';\nimport {\n    BehaviorSubject,\n    Subject,\n    fromEvent,\n    Subscription,\n    Observable,\n    firstValueFrom\n} from 'rxjs';\nimport {\n    skipUntil,\n    filter,\n    first,\n    mergeMap\n} from 'rxjs/operators';\n\nimport {\n    promiseWait,\n    flatClone,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_TRUE,\n    ensureNotFalsy\n} from '../util';\nimport {\n    newRxError\n} from '../rx-error';\nimport {\n    isInstanceOf as isInstanceOfPouchDB,\n    addPouchPlugin,\n    getPouchDBOfRxCollection\n} from '../plugins/pouchdb';\n\nimport {\n    isRxCollection\n} from '../rx-collection';\nimport type {\n    RxCollection,\n    PouchSyncHandler,\n    PouchReplicationOptions,\n    RxPlugin,\n    SyncOptions,\n    PouchDBInstance\n} from '../types';\n\n/**\n * Contains all pouchdb instances that\n * are used inside of RxDB by collections or databases.\n * Used to ensure the remote of a replication cannot be an internal pouchdb.\n */\nconst INTERNAL_POUCHDBS = new WeakSet();\n\nexport class RxCouchDBReplicationStateBase {\n    public _subs: Subscription[] = [];\n\n    // can be used for debuging or custom event-handling\n    // will be set some time after sync() is called\n    public _pouchEventEmitterObject?: PouchSyncHandler | null;\n    public _subjects = {\n        change: new Subject(),\n        docs: new Subject(),\n        denied: new Subject(),\n        active: new BehaviorSubject(false),\n        complete: new BehaviorSubject(false),\n        alive: new BehaviorSubject(false),\n        error: new Subject(),\n    };\n\n    public canceled: boolean = false;\n\n    constructor(\n        public readonly collection: RxCollection,\n        public readonly syncOptions: SyncOptions\n    ) {\n        // create getters\n        Object.keys(this._subjects).forEach(key => {\n            Object.defineProperty(this, key + '$', {\n                get: function () {\n                    return this._subjects[key].asObservable();\n                }\n            });\n        });\n    }\n\n    awaitInitialReplication(): Promise<void> {\n        if (this.syncOptions.options && this.syncOptions.options.live) {\n            throw newRxError('RC4', {\n                database: this.collection.database.name,\n                collection: this.collection.name\n            });\n        }\n        if (this.collection.database.multiInstance && this.syncOptions.waitForLeadership) {\n            throw newRxError('RC5', {\n                database: this.collection.database.name,\n                collection: this.collection.name\n            });\n        }\n\n        const that: RxCouchDBReplicationState = this as any;\n        return firstValueFrom(\n            that.complete$.pipe(\n                filter(x => !!x)\n            )\n        );\n    }\n\n    /**\n     * Returns false when the replication has already been canceled\n     */\n    cancel(): Promise<boolean> {\n        if (this.canceled) {\n            return PROMISE_RESOLVE_FALSE;\n        }\n        this.canceled = true;\n        let ret = PROMISE_RESOLVE_TRUE;\n        if (this._pouchEventEmitterObject) {\n            /**\n             * Calling cancel() does not return a promise,\n             * so we have to await the complete event\n             * to know that everything is cleaned up properly.\n             */\n            ret = new Promise<true>(res => {\n                ensureNotFalsy(this._pouchEventEmitterObject)\n                    .on('complete', () => {\n                        res(true);\n                    });\n            });\n            this._pouchEventEmitterObject.cancel();\n        }\n        this._subs.forEach(sub => sub.unsubscribe());\n        return ret;\n    }\n}\n\nexport type RxCouchDBReplicationState = RxCouchDBReplicationStateBase & {\n    change$: Observable<any>;\n    docs$: Observable<any>;\n    denied$: Observable<any>;\n    active$: Observable<any>;\n    alive$: Observable<boolean>;\n    complete$: Observable<any>;\n    error$: Observable<any>;\n};\n\nexport function setPouchEventEmitter(\n    rxRepState: RxCouchDBReplicationState,\n    evEmitter: PouchSyncHandler\n) {\n    if (rxRepState._pouchEventEmitterObject) {\n        throw newRxError('RC1');\n    }\n    rxRepState._pouchEventEmitterObject = evEmitter;\n\n    // change\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'change')\n            .subscribe(ev => {\n                rxRepState._subjects.change.next(ev);\n            })\n    );\n\n    // denied\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'denied')\n            .subscribe(ev => rxRepState._subjects.denied.next(ev))\n    );\n\n    // docs\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'change')\n            .subscribe(ev => {\n                if (\n                    rxRepState._subjects.docs.observers.length === 0 ||\n                    (ev as any).direction !== 'pull'\n                ) return;\n\n                (ev as any).change.docs\n                    .filter((doc: any) => doc.language !== 'query') // remove internal docs\n                    // do primary-swap and keycompression\n                    .forEach((doc: any) => rxRepState._subjects.docs.next(doc));\n            }));\n\n    // error\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'error')\n            .subscribe(ev => rxRepState._subjects.error.next(ev))\n    );\n\n    // active\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'active')\n            .subscribe(() => rxRepState._subjects.active.next(true))\n    );\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'paused')\n            .subscribe(() => rxRepState._subjects.active.next(false))\n    );\n\n    // complete\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'complete')\n            .subscribe(async (info: any) => {\n                /**\n                 * when complete fires, it might be that not all changeEvents\n                 * have passed throught, because of the delay of .wachtForChanges()\n                 * Therefore we have to first ensure that all previous changeEvents have been handled\n                 */\n                await promiseWait(100);\n                rxRepState._subjects.complete.next(info);\n            })\n    );\n    // auto-cancel one-time replications on complelete to not cause memory leak\n    if (\n        !rxRepState.syncOptions.options ||\n        !rxRepState.syncOptions.options.live\n    ) {\n        rxRepState._subs.push(\n            rxRepState.complete$.pipe(\n                filter(x => !!x),\n                first(),\n                mergeMap(() => {\n                    return rxRepState.collection.database\n                        .requestIdlePromise()\n                        .then(() => rxRepState.cancel());\n                })\n            ).subscribe()\n        );\n    }\n\n    function getIsAlive(emitter: any): Promise<boolean> {\n        // \"state\" will live in emitter.state if single direction replication\n        // or in emitter.push.state & emitter.pull.state when syncing for both\n        let state = emitter.state;\n        if (!state) {\n            state = [emitter.pull.state, emitter.push.state]\n                .reduce((acc, val) => {\n                    if (acc === 'active' || val === 'active') return 'active';\n                    return acc === 'stopped' ? acc : val;\n                }, '');\n        }\n\n        // If it's active, we can't determine whether the connection is active\n        // or not yet\n        if (state === 'active') {\n            return promiseWait(15).then(() => getIsAlive(emitter));\n        }\n\n        const isAlive = state !== 'stopped';\n        return Promise.resolve(isAlive);\n    }\n\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'paused')\n            .pipe(\n                skipUntil(fromEvent(evEmitter as any, 'active'))\n            ).subscribe(() => {\n                getIsAlive(rxRepState._pouchEventEmitterObject)\n                    .then(isAlive => rxRepState._subjects.alive.next(isAlive));\n            })\n    );\n}\n\nexport function createRxCouchDBReplicationState(\n    collection: RxCollection,\n    syncOptions: SyncOptions\n): RxCouchDBReplicationState {\n    return new RxCouchDBReplicationStateBase(\n        collection,\n        syncOptions\n    ) as RxCouchDBReplicationState;\n}\n\n/**\n * get the correct function-name for pouchdb-replication\n */\nexport function pouchReplicationFunction(\n    pouch: PouchDBInstance,\n    {\n        pull = true,\n        push = true\n    }\n): any {\n    if (pull && push) {\n        return pouch.sync.bind(pouch);\n    }\n    if (!pull && push) {\n        return (pouch.replicate as any).to.bind(pouch);\n    }\n    if (pull && !push) {\n        return (pouch.replicate as any).from.bind(pouch);\n    }\n    if (!pull && !push) {\n        throw newRxError('UT3', {\n            pull,\n            push\n        });\n    }\n}\n\nexport function syncCouchDB(\n    this: RxCollection,\n    {\n        remote,\n        waitForLeadership = true,\n        direction = {\n            pull: true,\n            push: true\n        },\n        options = {\n            live: true,\n            retry: true\n        },\n        query\n    }: SyncOptions) {\n    const useOptions: PouchReplicationOptions & { selector: any } = flatClone(options) as any;\n\n    // prevent #641 by not allowing internal pouchdbs as remote\n    if (\n        isInstanceOfPouchDB(remote) &&\n        INTERNAL_POUCHDBS.has(remote)\n    ) {\n        throw newRxError('RC3', {\n            database: this.database.name,\n            collection: this.name\n        });\n    }\n\n    // if remote is RxCollection, get internal pouchdb\n    if (isRxCollection(remote)) {\n        remote = (remote as RxCollection).storageInstance.internals.pouch;\n    }\n\n    if (query && this !== query.collection) {\n        throw newRxError('RC2', {\n            query\n        });\n    }\n\n    const pouch = getPouchDBOfRxCollection(this);\n    const syncFun = pouchReplicationFunction(pouch, direction);\n    if (query) {\n        useOptions.selector = query.getPreparedQuery().selector;\n    }\n\n    const repState: any = createRxCouchDBReplicationState(\n        this,\n        {\n            remote,\n            waitForLeadership,\n            direction,\n            options,\n            query\n        }\n    );\n\n    // run internal so .sync() does not have to be async\n    const waitTillRun = (\n        waitForLeadership &&\n        this.database.multiInstance // do not await leadership if not multiInstance\n    ) ? this.database.waitForLeadership() : promiseWait(0);\n    (waitTillRun as any).then(() => {\n        if (this.destroyed || repState.canceled) {\n            return;\n        }\n        const pouchSync = syncFun(remote, useOptions);\n        setPouchEventEmitter(repState, pouchSync);\n\n        this.onDestroy.push(() => repState.cancel());\n    });\n\n    return repState;\n}\n\n\n\nexport const RxDBReplicationCouchDBPlugin: RxPlugin = {\n    name: 'replication-couchdb',\n    rxdb: true,\n    init() {\n        // add pouchdb-replication-plugin\n        addPouchPlugin(PouchReplicationPlugin);\n    },\n    prototypes: {\n        RxCollection: (proto: any) => {\n            proto.syncCouchDB = syncCouchDB;\n        }\n    },\n    hooks: {\n        createRxCollection: {\n            after: args => {\n                const collection = args.collection;\n                const pouch: PouchDBInstance | undefined = collection.storageInstance.internals.pouch;\n                if (pouch) {\n                    INTERNAL_POUCHDBS.add(collection.storageInstance.internals.pouch);\n                }\n            }\n        }\n    }\n};\n"],"mappings":"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"}