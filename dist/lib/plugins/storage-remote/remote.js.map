{"version":3,"file":"remote.js","names":["exposeRxStorageRemote","settings","instanceByFullName","Map","messages$","pipe","filter","msg","method","subscribe","customRequestHandler","send","createErrorAnswer","Error","result","params","createAnswer","err","getRxStorageInstance","storage","createStorageInstance","database","storageInstances","Array","from","collectionName","storageInstance","find","instance","console","dir","JSON","stringify","schema","deepEqual","existingSchema","Promise","resolve","connectionId","isArray","fullName","databaseName","version","join","state","get","storageInstancePromise","connectionIds","Set","set","add","subs","push","changeStream","changes","message","answerTo","return","conflictResultionTasks","conflicts","connectionClosed","closeThisConnection","forEach","sub","unsubscribe","ensureNotFalsy","delete","collection","collections","onDestroy","subMsg","plainMessage","size"],"sources":["../../../../src/plugins/storage-remote/remote.ts"],"sourcesContent":["import { filter, Subscription } from 'rxjs';\nimport type {\n    RxStorageInstance,\n    RxStorageInstanceCreationParams\n} from '../../types';\nimport {\n    deepEqual,\n    ensureNotFalsy\n} from '../../plugins/utils';\nimport { createAnswer, createErrorAnswer } from './storage-remote-helpers';\nimport type {\n    MessageFromRemote,\n    MessageToRemote,\n    RxStorageRemoteExposeSettings,\n    RxStorageRemoteExposeSettingsRxDatabase,\n    RxStorageRemoteExposeSettingsRxStorage,\n    RxStorageRemoteExposeType\n} from './storage-remote-types';\n\n/**\n * Run this on the 'remote' part,\n * so that RxStorageMessageChannel can connect to it.\n */\nexport function exposeRxStorageRemote(settings: RxStorageRemoteExposeSettings): RxStorageRemoteExposeType {\n    type InstanceState = {\n        storageInstancePromise: Promise<RxStorageInstance<any, any, any>>;\n        connectionIds: Set<string>;\n        params: RxStorageInstanceCreationParams<any, any>;\n    };\n    const instanceByFullName: Map<string, InstanceState> = new Map();\n\n\n    settings.messages$.pipe(\n        filter(msg => msg.method === 'custom')\n    ).subscribe(async (msg) => {\n        if (!settings.customRequestHandler) {\n            settings.send(createErrorAnswer(\n                msg,\n                new Error('Remote storage: cannot resolve custom request because settings.customRequestHandler is not set')\n            ));\n        } else {\n            try {\n                const result = await settings.customRequestHandler(msg.params);\n                settings.send(createAnswer(msg, result));\n            } catch (err: any) {\n                settings.send(createErrorAnswer(\n                    msg,\n                    err\n                ));\n            }\n        }\n    });\n\n\n    function getRxStorageInstance<RxDocType>(params: any): Promise<RxStorageInstance<RxDocType, any, any, any>> {\n        if ((settings as RxStorageRemoteExposeSettingsRxStorage).storage) {\n            return (settings as RxStorageRemoteExposeSettingsRxStorage).storage.createStorageInstance(params);\n        } else if ((settings as RxStorageRemoteExposeSettingsRxDatabase).database) {\n            const storageInstances = Array.from((settings as RxStorageRemoteExposeSettingsRxDatabase).database.storageInstances);\n            const collectionName = params.collectionName;\n            const storageInstance = storageInstances.find(instance => instance.collectionName === collectionName);\n            if (!storageInstance) {\n                console.dir(storageInstances);\n                throw new Error('storageInstance does not exist ' + JSON.stringify({\n                    collectionName\n                }));\n            }\n            const schema = params.schema;\n            if (!deepEqual(schema, storageInstance.schema)) {\n                throw new Error('Wrong schema ' + JSON.stringify({\n                    schema,\n                    existingSchema: storageInstance.schema\n                }));\n            }\n            return Promise.resolve(storageInstance);\n        } else {\n            throw new Error('no base given');\n        }\n    }\n\n    settings.messages$.pipe(\n        filter(msg => msg.method === 'create')\n    ).subscribe(async (msg) => {\n        const connectionId = msg.connectionId;\n\n        /**\n         * Do an isArray check here\n         * for runtime check types to ensure we have\n         * instance creation params and not method input params.\n        */\n        if (Array.isArray(msg.params)) {\n            return;\n        }\n        const params = msg.params;\n        const collectionName = params.collectionName;\n\n        /**\n         * We de-duplicate the storage instances.\n         * This makes sense in many environments like\n         * electron where on main process contains the storage\n         * for multiple renderer processes. Same goes for SharedWorkers etc.\n         */\n        const fullName = [\n            params.databaseName,\n            params.collectionName,\n            params.schema.version\n        ].join('|');\n        let state = instanceByFullName.get(fullName);\n        if (!state) {\n            try {\n                state = {\n                    /**\n                     * We work with a promise here to ensure\n                     * that parallel create-calls will still end up\n                     * with exactly one instance and not more.\n                     */\n                    storageInstancePromise: getRxStorageInstance(params),\n                    connectionIds: new Set(),\n                    params\n                };\n                instanceByFullName.set(fullName, state);\n            } catch (err: any) {\n                settings.send(createErrorAnswer(msg, err));\n                return;\n            }\n        } else {\n            // if instance already existed, ensure that the schema is equal\n            if (!deepEqual(params.schema, state.params.schema)) {\n                settings.send(createErrorAnswer(msg, new Error('Remote storage: schema not equal to existing storage')));\n                return;\n            }\n        }\n        state.connectionIds.add(msg.connectionId);\n        const subs: Subscription[] = [];\n\n        const storageInstance = await state.storageInstancePromise;\n        /**\n         * Automatically subscribe to the changeStream()\n         * because we always need them.\n         */\n        subs.push(\n            storageInstance.changeStream().subscribe(changes => {\n                const message: MessageFromRemote = {\n                    connectionId,\n                    answerTo: 'changestream',\n                    method: 'changeStream',\n                    return: changes\n                };\n                settings.send(message);\n            })\n        );\n        subs.push(\n            storageInstance.conflictResultionTasks().subscribe(conflicts => {\n                const message: MessageFromRemote = {\n                    connectionId,\n                    answerTo: 'conflictResultionTasks',\n                    method: 'conflictResultionTasks',\n                    return: conflicts\n                };\n                settings.send(message);\n            })\n        );\n\n\n        let connectionClosed = false;\n        function closeThisConnection() {\n            if (connectionClosed) {\n                return;\n            }\n            connectionClosed = true;\n            subs.forEach(sub => sub.unsubscribe());\n            ensureNotFalsy(state).connectionIds.delete(connectionId);\n            instanceByFullName.delete(fullName);\n            /**\n             * TODO how to notify the other ports on remove() ?\n             */\n        }\n\n        // also close the connection when the collection gets destroyed\n        if ((settings as RxStorageRemoteExposeSettingsRxDatabase).database) {\n            const database = (settings as RxStorageRemoteExposeSettingsRxDatabase).database;\n            const collection = database.collections[collectionName];\n            if (collection) {\n                collection.onDestroy.push(() => closeThisConnection());\n            } else {\n                database.onDestroy.push(() => closeThisConnection());\n            }\n        }\n\n        subs.push(\n            settings.messages$.pipe(\n                filter(subMsg => (subMsg as MessageToRemote).connectionId === connectionId)\n            ).subscribe(async (plainMessage) => {\n                const message: MessageToRemote = plainMessage as any;\n                if (\n                    message.method === 'create' ||\n                    message.method === 'custom'\n                ) {\n                    return;\n                }\n                if (!Array.isArray(message.params)) {\n                    return;\n                }\n                let result;\n                try {\n                    if (\n                        message.method === 'close' &&\n                        (settings as RxStorageRemoteExposeSettingsRxDatabase).database\n                    ) {\n                        /**\n                         * Do not close the storageInstance if it was taken from\n                         * a running RxDatabase.\n                         * In that case we only close the instance\n                         * when the RxDatabase gets destroyed.\n                         */\n                        settings.send(createAnswer(message, null));\n                        return;\n                    }\n                    /**\n                     * On calls to 'close()',\n                     * we only close the main instance if there are no other\n                     * ports connected.\n                     */\n                    if (\n                        message.method === 'close' &&\n                        ensureNotFalsy(state).connectionIds.size > 1\n                    ) {\n                        settings.send(createAnswer(message, null));\n                        ensureNotFalsy(state).connectionIds.delete(connectionId);\n                        subs.forEach(sub => sub.unsubscribe());\n                        return;\n                    }\n                    result = await (storageInstance as any)[message.method](\n                        message.params[0],\n                        message.params[1],\n                        message.params[2],\n                        message.params[3]\n                    );\n                    if (\n                        message.method === 'close' ||\n                        message.method === 'remove'\n                    ) {\n                        closeThisConnection();\n                    }\n                    settings.send(createAnswer(message, result));\n                } catch (err: any) {\n                    settings.send(createErrorAnswer(message, err));\n                }\n            })\n        );\n\n        settings.send(createAnswer(msg, 'ok'));\n    });\n\n    return {\n        instanceByFullName\n    };\n}\n"],"mappings":";;;;;;AAAA;AAKA;AAIA;AAUA;AACA;AACA;AACA;AACO,SAASA,qBAAqB,CAACC,QAAuC,EAA6B;EAMtG,IAAMC,kBAA8C,GAAG,IAAIC,GAAG,EAAE;EAGhEF,QAAQ,CAACG,SAAS,CAACC,IAAI,CACnB,IAAAC,YAAM,EAACC,GAAG,IAAIA,GAAG,CAACC,MAAM,KAAK,QAAQ,CAAC,CACzC,CAACC,SAAS,CAAC,MAAOF,GAAG,IAAK;IACvB,IAAI,CAACN,QAAQ,CAACS,oBAAoB,EAAE;MAChCT,QAAQ,CAACU,IAAI,CAAC,IAAAC,uCAAiB,EAC3BL,GAAG,EACH,IAAIM,KAAK,CAAC,gGAAgG,CAAC,CAC9G,CAAC;IACN,CAAC,MAAM;MACH,IAAI;QACA,IAAMC,MAAM,GAAG,MAAMb,QAAQ,CAACS,oBAAoB,CAACH,GAAG,CAACQ,MAAM,CAAC;QAC9Dd,QAAQ,CAACU,IAAI,CAAC,IAAAK,kCAAY,EAACT,GAAG,EAAEO,MAAM,CAAC,CAAC;MAC5C,CAAC,CAAC,OAAOG,GAAQ,EAAE;QACfhB,QAAQ,CAACU,IAAI,CAAC,IAAAC,uCAAiB,EAC3BL,GAAG,EACHU,GAAG,CACN,CAAC;MACN;IACJ;EACJ,CAAC,CAAC;EAGF,SAASC,oBAAoB,CAAYH,MAAW,EAAwD;IACxG,IAAKd,QAAQ,CAA4CkB,OAAO,EAAE;MAC9D,OAAQlB,QAAQ,CAA4CkB,OAAO,CAACC,qBAAqB,CAACL,MAAM,CAAC;IACrG,CAAC,MAAM,IAAKd,QAAQ,CAA6CoB,QAAQ,EAAE;MACvE,IAAMC,gBAAgB,GAAGC,KAAK,CAACC,IAAI,CAAEvB,QAAQ,CAA6CoB,QAAQ,CAACC,gBAAgB,CAAC;MACpH,IAAMG,cAAc,GAAGV,MAAM,CAACU,cAAc;MAC5C,IAAMC,eAAe,GAAGJ,gBAAgB,CAACK,IAAI,CAACC,QAAQ,IAAIA,QAAQ,CAACH,cAAc,KAAKA,cAAc,CAAC;MACrG,IAAI,CAACC,eAAe,EAAE;QAClBG,OAAO,CAACC,GAAG,CAACR,gBAAgB,CAAC;QAC7B,MAAM,IAAIT,KAAK,CAAC,iCAAiC,GAAGkB,IAAI,CAACC,SAAS,CAAC;UAC/DP;QACJ,CAAC,CAAC,CAAC;MACP;MACA,IAAMQ,MAAM,GAAGlB,MAAM,CAACkB,MAAM;MAC5B,IAAI,CAAC,IAAAC,gBAAS,EAACD,MAAM,EAAEP,eAAe,CAACO,MAAM,CAAC,EAAE;QAC5C,MAAM,IAAIpB,KAAK,CAAC,eAAe,GAAGkB,IAAI,CAACC,SAAS,CAAC;UAC7CC,MAAM;UACNE,cAAc,EAAET,eAAe,CAACO;QACpC,CAAC,CAAC,CAAC;MACP;MACA,OAAOG,OAAO,CAACC,OAAO,CAACX,eAAe,CAAC;IAC3C,CAAC,MAAM;MACH,MAAM,IAAIb,KAAK,CAAC,eAAe,CAAC;IACpC;EACJ;EAEAZ,QAAQ,CAACG,SAAS,CAACC,IAAI,CACnB,IAAAC,YAAM,EAACC,GAAG,IAAIA,GAAG,CAACC,MAAM,KAAK,QAAQ,CAAC,CACzC,CAACC,SAAS,CAAC,MAAOF,GAAG,IAAK;IACvB,IAAM+B,YAAY,GAAG/B,GAAG,CAAC+B,YAAY;;IAErC;AACR;AACA;AACA;AACA;IACQ,IAAIf,KAAK,CAACgB,OAAO,CAAChC,GAAG,CAACQ,MAAM,CAAC,EAAE;MAC3B;IACJ;IACA,IAAMA,MAAM,GAAGR,GAAG,CAACQ,MAAM;IACzB,IAAMU,cAAc,GAAGV,MAAM,CAACU,cAAc;;IAE5C;AACR;AACA;AACA;AACA;AACA;IACQ,IAAMe,QAAQ,GAAG,CACbzB,MAAM,CAAC0B,YAAY,EACnB1B,MAAM,CAACU,cAAc,EACrBV,MAAM,CAACkB,MAAM,CAACS,OAAO,CACxB,CAACC,IAAI,CAAC,GAAG,CAAC;IACX,IAAIC,KAAK,GAAG1C,kBAAkB,CAAC2C,GAAG,CAACL,QAAQ,CAAC;IAC5C,IAAI,CAACI,KAAK,EAAE;MACR,IAAI;QACAA,KAAK,GAAG;UACJ;AACpB;AACA;AACA;AACA;UACoBE,sBAAsB,EAAE5B,oBAAoB,CAACH,MAAM,CAAC;UACpDgC,aAAa,EAAE,IAAIC,GAAG,EAAE;UACxBjC;QACJ,CAAC;QACDb,kBAAkB,CAAC+C,GAAG,CAACT,QAAQ,EAAEI,KAAK,CAAC;MAC3C,CAAC,CAAC,OAAO3B,GAAQ,EAAE;QACfhB,QAAQ,CAACU,IAAI,CAAC,IAAAC,uCAAiB,EAACL,GAAG,EAAEU,GAAG,CAAC,CAAC;QAC1C;MACJ;IACJ,CAAC,MAAM;MACH;MACA,IAAI,CAAC,IAAAiB,gBAAS,EAACnB,MAAM,CAACkB,MAAM,EAAEW,KAAK,CAAC7B,MAAM,CAACkB,MAAM,CAAC,EAAE;QAChDhC,QAAQ,CAACU,IAAI,CAAC,IAAAC,uCAAiB,EAACL,GAAG,EAAE,IAAIM,KAAK,CAAC,sDAAsD,CAAC,CAAC,CAAC;QACxG;MACJ;IACJ;IACA+B,KAAK,CAACG,aAAa,CAACG,GAAG,CAAC3C,GAAG,CAAC+B,YAAY,CAAC;IACzC,IAAMa,IAAoB,GAAG,EAAE;IAE/B,IAAMzB,eAAe,GAAG,MAAMkB,KAAK,CAACE,sBAAsB;IAC1D;AACR;AACA;AACA;IACQK,IAAI,CAACC,IAAI,CACL1B,eAAe,CAAC2B,YAAY,EAAE,CAAC5C,SAAS,CAAC6C,OAAO,IAAI;MAChD,IAAMC,OAA0B,GAAG;QAC/BjB,YAAY;QACZkB,QAAQ,EAAE,cAAc;QACxBhD,MAAM,EAAE,cAAc;QACtBiD,MAAM,EAAEH;MACZ,CAAC;MACDrD,QAAQ,CAACU,IAAI,CAAC4C,OAAO,CAAC;IAC1B,CAAC,CAAC,CACL;IACDJ,IAAI,CAACC,IAAI,CACL1B,eAAe,CAACgC,sBAAsB,EAAE,CAACjD,SAAS,CAACkD,SAAS,IAAI;MAC5D,IAAMJ,OAA0B,GAAG;QAC/BjB,YAAY;QACZkB,QAAQ,EAAE,wBAAwB;QAClChD,MAAM,EAAE,wBAAwB;QAChCiD,MAAM,EAAEE;MACZ,CAAC;MACD1D,QAAQ,CAACU,IAAI,CAAC4C,OAAO,CAAC;IAC1B,CAAC,CAAC,CACL;IAGD,IAAIK,gBAAgB,GAAG,KAAK;IAC5B,SAASC,mBAAmB,GAAG;MAC3B,IAAID,gBAAgB,EAAE;QAClB;MACJ;MACAA,gBAAgB,GAAG,IAAI;MACvBT,IAAI,CAACW,OAAO,CAACC,GAAG,IAAIA,GAAG,CAACC,WAAW,EAAE,CAAC;MACtC,IAAAC,qBAAc,EAACrB,KAAK,CAAC,CAACG,aAAa,CAACmB,MAAM,CAAC5B,YAAY,CAAC;MACxDpC,kBAAkB,CAACgE,MAAM,CAAC1B,QAAQ,CAAC;MACnC;AACZ;AACA;IACQ;;IAEA;IACA,IAAKvC,QAAQ,CAA6CoB,QAAQ,EAAE;MAChE,IAAMA,QAAQ,GAAIpB,QAAQ,CAA6CoB,QAAQ;MAC/E,IAAM8C,UAAU,GAAG9C,QAAQ,CAAC+C,WAAW,CAAC3C,cAAc,CAAC;MACvD,IAAI0C,UAAU,EAAE;QACZA,UAAU,CAACE,SAAS,CAACjB,IAAI,CAAC,MAAMS,mBAAmB,EAAE,CAAC;MAC1D,CAAC,MAAM;QACHxC,QAAQ,CAACgD,SAAS,CAACjB,IAAI,CAAC,MAAMS,mBAAmB,EAAE,CAAC;MACxD;IACJ;IAEAV,IAAI,CAACC,IAAI,CACLnD,QAAQ,CAACG,SAAS,CAACC,IAAI,CACnB,IAAAC,YAAM,EAACgE,MAAM,IAAKA,MAAM,CAAqBhC,YAAY,KAAKA,YAAY,CAAC,CAC9E,CAAC7B,SAAS,CAAC,MAAO8D,YAAY,IAAK;MAChC,IAAMhB,OAAwB,GAAGgB,YAAmB;MACpD,IACIhB,OAAO,CAAC/C,MAAM,KAAK,QAAQ,IAC3B+C,OAAO,CAAC/C,MAAM,KAAK,QAAQ,EAC7B;QACE;MACJ;MACA,IAAI,CAACe,KAAK,CAACgB,OAAO,CAACgB,OAAO,CAACxC,MAAM,CAAC,EAAE;QAChC;MACJ;MACA,IAAID,MAAM;MACV,IAAI;QACA,IACIyC,OAAO,CAAC/C,MAAM,KAAK,OAAO,IACzBP,QAAQ,CAA6CoB,QAAQ,EAChE;UACE;AACxB;AACA;AACA;AACA;AACA;UACwBpB,QAAQ,CAACU,IAAI,CAAC,IAAAK,kCAAY,EAACuC,OAAO,EAAE,IAAI,CAAC,CAAC;UAC1C;QACJ;QACA;AACpB;AACA;AACA;AACA;QACoB,IACIA,OAAO,CAAC/C,MAAM,KAAK,OAAO,IAC1B,IAAAyD,qBAAc,EAACrB,KAAK,CAAC,CAACG,aAAa,CAACyB,IAAI,GAAG,CAAC,EAC9C;UACEvE,QAAQ,CAACU,IAAI,CAAC,IAAAK,kCAAY,EAACuC,OAAO,EAAE,IAAI,CAAC,CAAC;UAC1C,IAAAU,qBAAc,EAACrB,KAAK,CAAC,CAACG,aAAa,CAACmB,MAAM,CAAC5B,YAAY,CAAC;UACxDa,IAAI,CAACW,OAAO,CAACC,GAAG,IAAIA,GAAG,CAACC,WAAW,EAAE,CAAC;UACtC;QACJ;QACAlD,MAAM,GAAG,MAAOY,eAAe,CAAS6B,OAAO,CAAC/C,MAAM,CAAC,CACnD+C,OAAO,CAACxC,MAAM,CAAC,CAAC,CAAC,EACjBwC,OAAO,CAACxC,MAAM,CAAC,CAAC,CAAC,EACjBwC,OAAO,CAACxC,MAAM,CAAC,CAAC,CAAC,EACjBwC,OAAO,CAACxC,MAAM,CAAC,CAAC,CAAC,CACpB;QACD,IACIwC,OAAO,CAAC/C,MAAM,KAAK,OAAO,IAC1B+C,OAAO,CAAC/C,MAAM,KAAK,QAAQ,EAC7B;UACEqD,mBAAmB,EAAE;QACzB;QACA5D,QAAQ,CAACU,IAAI,CAAC,IAAAK,kCAAY,EAACuC,OAAO,EAAEzC,MAAM,CAAC,CAAC;MAChD,CAAC,CAAC,OAAOG,GAAQ,EAAE;QACfhB,QAAQ,CAACU,IAAI,CAAC,IAAAC,uCAAiB,EAAC2C,OAAO,EAAEtC,GAAG,CAAC,CAAC;MAClD;IACJ,CAAC,CAAC,CACL;IAEDhB,QAAQ,CAACU,IAAI,CAAC,IAAAK,kCAAY,EAACT,GAAG,EAAE,IAAI,CAAC,CAAC;EAC1C,CAAC,CAAC;EAEF,OAAO;IACHL;EACJ,CAAC;AACL"}