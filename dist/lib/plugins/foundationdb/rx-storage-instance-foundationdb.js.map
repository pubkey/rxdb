{"version":3,"file":"rx-storage-instance-foundationdb.js","names":["RxStorageInstanceFoundationDB","storage","databaseName","collectionName","schema","internals","options","settings","closed","changes$","Subject","primaryPath","getPrimaryFieldOfPrimaryKey","primaryKey","bulkWrite","documentWrites","context","dbsPromise","dbs","categorized","root","doTransaction","tx","ret","success","error","ids","map","row","document","mainTx","at","main","subspace","attachmentTx","attachments","docsInDB","Map","Promise","all","id","get","doc","set","categorizeBulkWriteRows","errors","forEach","err","documentId","bulkInsertDocs","writeRow","docId","Object","values","indexes","indexMeta","indexString","getIndexableString","indexTx","db","bulkUpdateDocs","oldIndexString","ensureNotFalsy","previous","newIndexString","attachmentsAdd","attachment","attachmentMapKey","attachmentId","attachmentData","attachmentsUpdate","attachmentsRemove","result","eventBulk","events","length","lastState","getNewestOfDocumentStates","checkpoint","lwt","_meta","next","findDocumentsById","withDeleted","docInDb","_deleted","query","preparedQuery","queryFoundationDB","getAttachmentData","data","getChangedDocumentsSince","limit","require","keySelector","StreamingMode","index","indexName","getFoundationDBIndexName","lowerBoundString","checkpointPartialDoc","innerResult","getRangeAll","firstGreaterThan","INDEX_MAX","streamingMode","Exact","range","docIds","docsData","concat","lastDoc","lastOfArray","documents","changeStream","asObservable","remove","clearRange","PROMISE_RESOLVE_VOID","close","cleanup","minimumDeletedTime","maxDeletionTime","now","CLEANUP_INDEX","getStartIndexStringFromLowerBound","upperBoundString","getStartIndexStringFromUpperBound","noMoreUndeleted","batchSize","pop","subIndexDB","docData","conflictResultionTasks","resolveConflictResultionTask","_taskSolution","reject","newRxError","database","collection","complete","createFoundationDBStorageInstance","params","open","directory","encoders","connection","clusterFile","createOrOpen","dir","version","withKeyEncoding","string","withValueEncoding","json","indexDBs","useIndexes","slice","push","useIndexesFinal","indexAr","Array","isArray","unshift","indexDB","getIndexableStringMonad","instance","resolve"],"sources":["../../../../src/plugins/foundationdb/rx-storage-instance-foundationdb.ts"],"sourcesContent":["import { Observable, Subject } from 'rxjs';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper';\nimport type {\n    BulkWriteRow,\n    CategorizeBulkWriteRowsOutput,\n    EventBulk,\n    RxAttachmentWriteData,\n    RxConflictResultionTask,\n    RxConflictResultionTaskSolution,\n    RxDocumentData,\n    RxDocumentDataById,\n    RxJsonSchema,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageDefaultCheckpoint,\n    RxStorageInstance,\n    RxStorageInstanceCreationParams,\n    RxStorageQueryResult,\n    StringKeys\n} from '../../types';\nimport type {\n    FoundationDBDatabase,\n    FoundationDBIndexMeta,\n    FoundationDBStorageInternals,\n    RxStorageFoundationDB,\n    RxStorageFoundationDBInstanceCreationOptions,\n    RxStorageFoundationDBSettings\n} from './foundationdb-types';\n// import {\n//     open as foundationDBOpen,\n//     directory as foundationDBDirectory,\n//     encoders as foundationDBEncoders,\n//     keySelector as foundationDBKeySelector,\n//     StreamingMode as foundationDBStreamingMode\n// } from 'foundationdb';\nimport {\n    categorizeBulkWriteRows,\n    getNewestOfDocumentStates\n} from '../../rx-storage-helper';\nimport {\n\n    CLEANUP_INDEX,\n    getFoundationDBIndexName\n} from './foundationdb-helpers';\nimport { newRxError } from '../../rx-error';\nimport {\n    getIndexableStringMonad,\n    getStartIndexStringFromLowerBound,\n    getStartIndexStringFromUpperBound\n} from '../../custom-index';\nimport {\n    ensureNotFalsy, lastOfArray, now\n    , PROMISE_RESOLVE_VOID\n} from '../../util';\nimport { queryFoundationDB } from './foundationdb-query';\nimport { INDEX_MAX } from '../../query-planner';\nimport { attachmentMapKey } from '../memory';\n\nexport class RxStorageInstanceFoundationDB<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    FoundationDBStorageInternals<RxDocType>,\n    RxStorageFoundationDBInstanceCreationOptions,\n    RxStorageDefaultCheckpoint\n> {\n    public readonly primaryPath: StringKeys<RxDocumentData<RxDocType>>;\n\n    public closed = false;\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> = new Subject();\n\n    constructor(\n        public readonly storage: RxStorageFoundationDB,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: FoundationDBStorageInternals<RxDocType>,\n        public readonly options: Readonly<RxStorageFoundationDBInstanceCreationOptions>,\n        public readonly settings: RxStorageFoundationDBSettings\n    ) {\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\n    }\n\n    async bulkWrite(\n        documentWrites: BulkWriteRow<RxDocType>[],\n        context: string\n    ): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        const dbs = await this.internals.dbsPromise;\n        let categorized: CategorizeBulkWriteRowsOutput<RxDocType> | undefined = null as any;\n        const result = await dbs.root.doTransaction(async (tx: any) => {\n            const ret: RxStorageBulkWriteResponse<RxDocType> = {\n                success: {},\n                error: {}\n            };\n\n            const ids = documentWrites.map(row => (row.document as any)[this.primaryPath]);\n            const mainTx = tx.at(dbs.main.subspace);\n            const attachmentTx = tx.at(dbs.attachments.subspace);\n            const docsInDB = new Map<string, RxDocumentData<RxDocType>>();\n            /**\n             * TODO this might be faster if fdb\n             * any time adds a bulk-fetch-by-key method.\n             */\n            await Promise.all(\n                ids.map(async (id) => {\n                    const doc = await mainTx.get(id);\n                    docsInDB.set(id, doc);\n                })\n            );\n\n\n            categorized = categorizeBulkWriteRows<RxDocType>(\n                this,\n                this.primaryPath as any,\n                docsInDB,\n                documentWrites,\n                context\n            );\n\n            categorized.errors.forEach(err => {\n                ret.error[err.documentId] = err;\n            });\n\n            // INSERTS\n            categorized.bulkInsertDocs.forEach(writeRow => {\n                const docId: string = writeRow.document[this.primaryPath] as any;\n                ret.success[docId] = writeRow.document;\n\n                // insert document data\n                mainTx.set(docId, writeRow.document);\n\n                // insert secondary indexes\n                Object.values(dbs.indexes).forEach(indexMeta => {\n                    const indexString = indexMeta.getIndexableString(writeRow.document);\n                    const indexTx = tx.at(indexMeta.db.subspace);\n                    indexTx.set(indexString, docId);\n                });\n            });\n            // UPDATES\n            categorized.bulkUpdateDocs.forEach((writeRow: BulkWriteRow<RxDocType>) => {\n                const docId: string = writeRow.document[this.primaryPath] as any;\n\n                // overwrite document data\n                mainTx.set(docId, writeRow.document);\n\n                // update secondary indexes\n                Object.values(dbs.indexes).forEach(indexMeta => {\n                    const oldIndexString = indexMeta.getIndexableString(ensureNotFalsy(writeRow.previous));\n                    const newIndexString = indexMeta.getIndexableString(writeRow.document);\n                    if (oldIndexString !== newIndexString) {\n                        const indexTx = tx.at(indexMeta.db.subspace);\n                        indexTx.delete(oldIndexString);\n                        indexTx.set(newIndexString, docId);\n                    }\n                });\n                ret.success[docId] = writeRow.document;\n            });\n\n            // attachments\n            categorized.attachmentsAdd.forEach(attachment => {\n                attachmentTx.set(\n                    attachmentMapKey(attachment.documentId, attachment.attachmentId),\n                    attachment.attachmentData\n                );\n            });\n            categorized.attachmentsUpdate.forEach(attachment => {\n                attachmentTx.set(\n                    attachmentMapKey(attachment.documentId, attachment.attachmentId),\n                    attachment.attachmentData\n                );\n            });\n            categorized.attachmentsRemove.forEach(attachment => {\n                attachmentTx.delete(\n                    attachmentMapKey(attachment.documentId, attachment.attachmentId)\n                );\n            });\n\n            return ret;\n        });\n        /**\n         * The events must be emitted AFTER the transaction\n         * has finished.\n         * Otherwise an observable changestream might cause a read\n         * to a document that does not already exist outside of the transaction.\n         */\n        if (ensureNotFalsy(categorized).eventBulk.events.length > 0) {\n            const lastState = getNewestOfDocumentStates<any>(\n                this.primaryPath as any,\n                Object.values(result.success)\n            );\n            ensureNotFalsy(categorized).eventBulk.checkpoint = {\n                id: lastState[this.primaryPath],\n                lwt: lastState._meta.lwt\n            };\n            this.changes$.next(ensureNotFalsy(categorized).eventBulk);\n        }\n        return result;\n    }\n\n    async findDocumentsById(ids: string[], withDeleted: boolean): Promise<RxDocumentDataById<RxDocType>> {\n        const dbs = await this.internals.dbsPromise;\n        return dbs.main.doTransaction(async (tx: any) => {\n            const ret: RxDocumentDataById<RxDocType> = {};\n            await Promise.all(\n                ids.map(async (docId) => {\n                    const docInDb = await tx.get(docId);\n                    if (\n                        docInDb &&\n                        (\n                            !docInDb._deleted ||\n                            withDeleted\n                        )\n                    ) {\n                        ret[docId] = docInDb;\n                    }\n                })\n            );\n            return ret;\n        });\n    }\n    query(preparedQuery: any): Promise<RxStorageQueryResult<RxDocType>> {\n        return queryFoundationDB(this, preparedQuery);\n    }\n    async getAttachmentData(documentId: string, attachmentId: string): Promise<string> {\n        const dbs = await this.internals.dbsPromise;\n        const attachment = await dbs.attachments.get(attachmentMapKey(documentId, attachmentId));\n        return attachment.data;\n    }\n    async getChangedDocumentsSince(limit: number, checkpoint?: RxStorageDefaultCheckpoint): Promise<{ documents: RxDocumentData<RxDocType>[]; checkpoint: RxStorageDefaultCheckpoint; }> {\n        const {\n            keySelector,\n            StreamingMode\n        } = require('foundationdb');\n        const dbs = await this.internals.dbsPromise;\n        const index = [\n            '_meta.lwt',\n            this.primaryPath as any\n        ];\n        const indexName = getFoundationDBIndexName(index);\n        const indexMeta = dbs.indexes[indexName];\n        let lowerBoundString = '';\n        if (checkpoint) {\n            const checkpointPartialDoc: any = {\n                [this.primaryPath]: checkpoint.id,\n                _meta: {\n                    lwt: checkpoint.lwt\n                }\n            };\n            lowerBoundString = indexMeta.getIndexableString(checkpointPartialDoc);\n        }\n        const result: RxDocumentData<RxDocType>[] = await dbs.root.doTransaction(async (tx: any) => {\n            let innerResult: RxDocumentData<RxDocType>[] = [];\n            const indexTx = tx.at(indexMeta.db.subspace);\n            const mainTx = tx.at(dbs.main.subspace);\n            const range = await indexTx.getRangeAll(\n                keySelector.firstGreaterThan(lowerBoundString),\n                INDEX_MAX,\n                {\n                    limit,\n                    streamingMode: StreamingMode.Exact\n                }\n            );\n            const docIds = range.map((row: string[]) => row[1]);\n            const docsData: RxDocumentData<RxDocType>[] = await Promise.all(\n                docIds.map((docId: string) => mainTx.get(docId))\n            );\n            innerResult = innerResult.concat(docsData);\n            return innerResult;\n        });\n        const lastDoc = lastOfArray(result);\n        return {\n            documents: result,\n            checkpoint: lastDoc ? {\n                id: lastDoc[this.primaryPath] as any,\n                lwt: lastDoc._meta.lwt\n            } : checkpoint ? checkpoint : {\n                id: '',\n                lwt: 0\n            }\n        };\n    }\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocType>, RxStorageDefaultCheckpoint>> {\n        return this.changes$.asObservable();\n    }\n\n    async remove(): Promise<void> {\n        const dbs = await this.internals.dbsPromise;\n        await dbs.root.doTransaction((tx: any) => {\n            tx.clearRange('', INDEX_MAX);\n            return PROMISE_RESOLVE_VOID;\n        });\n        return this.close();\n    }\n    async cleanup(minimumDeletedTime: number): Promise<boolean> {\n        const {\n            keySelector,\n            StreamingMode\n        } = require('foundationdb');\n        const maxDeletionTime = now() - minimumDeletedTime;\n        const dbs = await this.internals.dbsPromise;\n        const index = CLEANUP_INDEX;\n        const indexName = getFoundationDBIndexName(index);\n        const indexMeta = dbs.indexes[indexName];\n        const lowerBoundString = getStartIndexStringFromLowerBound(\n            this.schema,\n            index,\n            [\n                true,\n                /**\n                 * Do not use 0 here,\n                 * because 1 is the minimum value for _meta.lwt\n                 */\n                1\n            ]\n        );\n        const upperBoundString = getStartIndexStringFromUpperBound(\n            this.schema,\n            index,\n            [\n                true,\n                maxDeletionTime\n            ]\n        );\n        let noMoreUndeleted: boolean = true;\n        await dbs.root.doTransaction(async (tx: any) => {\n            const batchSize = ensureNotFalsy(this.settings.batchSize);\n            const indexTx = tx.at(indexMeta.db.subspace);\n            const mainTx = tx.at(dbs.main.subspace);\n            const range = await indexTx.getRangeAll(\n                keySelector.firstGreaterThan(lowerBoundString),\n                upperBoundString,\n                {\n                    limit: batchSize + 1, // get one more extra to detect what to return from cleanup()\n                    streamingMode: StreamingMode.Exact\n                }\n            );\n            if (range.length > batchSize) {\n                noMoreUndeleted = false;\n                range.pop();\n            }\n            const docIds = range.map((row: string[]) => row[1]);\n            const docsData: RxDocumentData<RxDocType>[] = await Promise.all(docIds.map((docId: string) => mainTx.get(docId)));\n\n            Object\n                .values(dbs.indexes)\n                .forEach(indexMeta => {\n                    const subIndexDB = tx.at(indexMeta.db.subspace);\n                    docsData.forEach(docData => {\n                        const indexString = indexMeta.getIndexableString(docData);\n                        subIndexDB.delete(indexString);\n                    });\n                });\n            docIds.forEach((id: string) => mainTx.delete(id));\n        });\n\n        return noMoreUndeleted;\n    }\n\n    conflictResultionTasks(): Observable<RxConflictResultionTask<RxDocType>> {\n        return new Subject<any>().asObservable();\n    }\n    resolveConflictResultionTask(_taskSolution: RxConflictResultionTaskSolution<RxDocType>): Promise<void> {\n        return PROMISE_RESOLVE_VOID;\n    }\n\n    async close() {\n        if (this.closed) {\n            return Promise.reject(newRxError('SNH', {\n                database: this.databaseName,\n                collection: this.collectionName\n            }));\n        }\n        this.closed = true;\n        this.changes$.complete();\n\n        const dbs = await this.internals.dbsPromise;\n        dbs.root.close();\n\n        // TODO shouldnt we close the index databases?\n        // Object.values(dbs.indexes).forEach(db => db.close());\n    }\n}\n\n\nexport function createFoundationDBStorageInstance<RxDocType>(\n    storage: RxStorageFoundationDB,\n    params: RxStorageInstanceCreationParams<RxDocType, RxStorageFoundationDBInstanceCreationOptions>,\n    settings: RxStorageFoundationDBSettings\n): Promise<RxStorageInstanceFoundationDB<RxDocType>> {\n    const primaryPath = getPrimaryFieldOfPrimaryKey(params.schema.primaryKey);\n\n    const {\n        open,\n        directory,\n        encoders\n    } = require('foundationdb');\n\n    const connection = open(settings.clusterFile);\n    const dbsPromise = (async () => {\n        const dir = await directory.createOrOpen(connection, 'rxdb');\n\n        const root = connection\n            .at(dir)\n            .at(params.databaseName + '.')\n            .at(params.collectionName + '.')\n            .at(params.schema.version + '.');\n        const main: FoundationDBDatabase<RxDocType> = root\n            .at('main.')\n            .withKeyEncoding(encoders.string) // automatically encode & decode keys using tuples\n            .withValueEncoding(encoders.json) as any; // and values using JSON\n\n\n        const events: FoundationDBDatabase<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> = root\n            .at('events.')\n            .withKeyEncoding(encoders.string)\n            .withValueEncoding(encoders.json) as any;\n\n        const attachments: FoundationDBDatabase<RxAttachmentWriteData> = root\n            .at('attachments.')\n            .withKeyEncoding(encoders.string)\n            .withValueEncoding(encoders.json) as any;\n\n\n        const indexDBs: { [indexName: string]: FoundationDBIndexMeta<RxDocType> } = {};\n        const useIndexes = params.schema.indexes ? params.schema.indexes.slice(0) : [];\n        useIndexes.push([primaryPath]);\n        const useIndexesFinal = useIndexes.map(index => {\n            const indexAr = Array.isArray(index) ? index.slice(0) : [index];\n            indexAr.unshift('_deleted');\n            return indexAr;\n        })\n        // used for `getChangedDocumentsSince()`\n        useIndexesFinal.push([\n            '_meta.lwt',\n            primaryPath\n        ]);\n        useIndexesFinal.push(CLEANUP_INDEX);\n        useIndexesFinal.forEach(indexAr => {\n            const indexName = getFoundationDBIndexName(indexAr);\n            const indexDB = root.at(indexName + '.')\n                .withKeyEncoding(encoders.string)\n                .withValueEncoding(encoders.string);\n            indexDBs[indexName] = {\n                indexName,\n                db: indexDB,\n                getIndexableString: getIndexableStringMonad(params.schema, indexAr),\n                index: indexAr\n            };\n        });\n\n        return {\n            root,\n            main,\n            events,\n            attachments,\n            indexes: indexDBs\n        };\n    })();\n\n\n    const internals: FoundationDBStorageInternals<RxDocType> = {\n        connection,\n        dbsPromise: dbsPromise\n    };\n\n    const instance = new RxStorageInstanceFoundationDB(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        params.schema,\n        internals,\n        params.options,\n        settings\n    );\n    return Promise.resolve(instance);\n}\n"],"mappings":"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"}