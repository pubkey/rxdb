{"version":3,"file":"foundationdb-query.js","names":["pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","queryFoundationDB","instance","preparedQuery","queryPlan","query","skip","limit","Infinity","skipPlusLimit","queryPlanFields","index","mustManuallyResort","sortFieldsSameAsIndexFields","queryMatcher","RxStorageDexieStatics","getQueryMatcher","schema","sortComparator","getSortComparator","internals","dbsPromise","dbs","indexForName","slice","unshift","indexName","getFoundationDBIndexName","indexDB","ensureNotFalsy","indexes","db","lowerBound","startKeys","concat","lowerBoundString","getStartIndexStringFromLowerBound","upperBound","endKeys","upperBoundString","getStartIndexStringFromUpperBound","root","doTransaction","tx","innerResult","indexTx","at","subspace","mainTx","main","range","getRangeBatch","done","next","docIds","map","row","Promise","all","docId","get","docsData","forEach","docData","push","length","sort","documents"],"sources":["../../../../src/plugins/foundationdb/foundationdb-query.ts"],"sourcesContent":["import {\n    getStartIndexStringFromLowerBound,\n    getStartIndexStringFromUpperBound\n} from '../../custom-index';\nimport type {\n    RxDocumentData,\n    RxStorageQueryResult\n} from '../../types';\nimport { ensureNotFalsy } from '../../util';\nimport { RxStorageDexieStatics } from '../dexie';\nimport { getFoundationDBIndexName } from './foundationdb-helpers';\nimport type {\n    FoundationDBPreparedQuery\n} from './foundationdb-types';\nimport { RxStorageInstanceFoundationDB } from './rx-storage-instance-foundationdb';\n\nexport async function queryFoundationDB<RxDocType>(\n    instance: RxStorageInstanceFoundationDB<RxDocType>,\n    preparedQuery: FoundationDBPreparedQuery<RxDocType>\n): Promise<RxStorageQueryResult<RxDocType>> {\n    const queryPlan = preparedQuery.queryPlan;\n    const query = preparedQuery.query;\n    const skip = query.skip ? query.skip : 0;\n    const limit = query.limit ? query.limit : Infinity;\n    const skipPlusLimit = skip + limit;\n    const queryPlanFields: string[] = queryPlan.index;\n    const mustManuallyResort = !queryPlan.sortFieldsSameAsIndexFields;\n\n    const queryMatcher = RxStorageDexieStatics.getQueryMatcher(\n        instance.schema,\n        preparedQuery\n    );\n    const sortComparator = RxStorageDexieStatics.getSortComparator(instance.schema, preparedQuery);\n    const dbs = await instance.internals.dbsPromise;\n\n\n    const indexForName = queryPlanFields.slice(0);\n    indexForName.unshift('_deleted');\n    const indexName = getFoundationDBIndexName(indexForName);\n    const indexDB = ensureNotFalsy(dbs.indexes[indexName]).db;\n\n    let lowerBound: any[] = queryPlan.startKeys;\n    lowerBound = [false].concat(lowerBound);\n    const lowerBoundString = getStartIndexStringFromLowerBound(\n        instance.schema,\n        indexForName,\n        lowerBound\n    );\n\n    let upperBound: any[] = queryPlan.endKeys;\n    upperBound = [false].concat(upperBound);\n    const upperBoundString = getStartIndexStringFromUpperBound(\n        instance.schema,\n        indexForName,\n        upperBound\n    );\n    let result = await dbs.root.doTransaction(async (tx: any) => {\n        const innerResult: RxDocumentData<RxDocType>[] = [];\n        const indexTx = tx.at(indexDB.subspace);\n        const mainTx = tx.at(dbs.main.subspace);\n\n        const range = indexTx.getRangeBatch(\n            lowerBoundString,\n            upperBoundString,\n            {\n                // TODO these options seem to be broken in the foundationdb node bindings\n                // limit: instance.settings.batchSize,\n                // streamingMode: StreamingMode.Exact\n            }\n        );\n        let done = false;\n        while (!done) {\n            const next = await range.next();\n            if (next.done) {\n                done = true;\n                break;\n            }\n            const docIds = next.value.map((row: string[]) => row[1]);\n            const docsData: RxDocumentData<RxDocType>[] = await Promise.all(docIds.map((docId: string) => mainTx.get(docId)));\n            docsData.forEach((docData) => {\n                if (!done) {\n                    if (\n                        queryMatcher(docData)\n                    ) {\n                        innerResult.push(docData);\n                    }\n                }\n                if (\n                    !mustManuallyResort &&\n                    innerResult.length === skipPlusLimit\n                ) {\n                    done = true;\n                    range.return();\n                }\n            });\n        }\n        return innerResult;\n    });\n    if (mustManuallyResort) {\n        result = result.sort(sortComparator);\n    }\n\n    // apply skip and limit boundaries.\n    result = result.slice(skip, skipPlusLimit);\n\n    return {\n        documents: result\n    };\n}\n"],"mappings":"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"}