{"version":3,"file":"rx-local-document.js","names":["body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","RxDocumentParent","createRxDocumentConstructor","RxLocalDocumentClass","id","jsonData","parent","RxLocalDocumentPrototype","isLocal","_handleChangeEvent","changeEvent","documentId","primary","operation","newData","documentData","_dataSync$","next","docCache","_isDeleted$","allAttachments$","newRxError","document","primaryPath","$","asObservable","$emit","get","objPath","_data","undefined","newRxTypeError","valueObj","objectPath","overwritable","deepFreezeWhenDevMode","get$","includes","pipe","map","data","distinctUntilChanged","atomicUpdate","mutationFunction","Promise","res","rej","_atomicQueue","done","oldDocData","getValue","clone","newDocData","flatClone","_saveData","err","isConflict","isBulkWriteConflictError","_rev","createRevision","documentInDb","atomicPatch","patch","docData","Object","entries","forEach","k","getLocalDocStateByParent","oldData","storageInstance","bulkWrite","previous","docResult","success","getFromObjectOrThrow","error","remove","writeData","_deleted","_meta","getDefaultRxDocumentMeta","getDefaultRevision","_attachments","writeSingle","INIT_DONE","_init","docBaseProto","basePrototype","props","getOwnPropertyNames","key","exists","getOwnPropertyDescriptor","desc","defineProperty","getThrowingFun","functionName","createRxLocalDocument","newDoc","__proto__","set"],"sources":["../../../../src/plugins/local-documents/rx-local-document.ts"],"sourcesContent":["import objectPath from 'object-path';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport { overwritable } from '../../overwritable';\nimport { basePrototype, createRxDocumentConstructor } from '../../rx-document';\nimport { isBulkWriteConflictError, newRxError, newRxTypeError } from '../../rx-error';\nimport { writeSingle } from '../../rx-storage-helper';\nimport type {\n    LocalDocumentAtomicUpdateFunction,\n    LocalDocumentState,\n    RxChangeEvent,\n    RxCollection,\n    RxDatabase,\n    RxDocument,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxLocalDocument,\n    RxLocalDocumentData\n} from '../../types';\nimport { clone, createRevision, flatClone, getDefaultRevision, getDefaultRxDocumentMeta, getFromObjectOrThrow } from '../../util';\nimport { getLocalDocStateByParent } from './local-documents-helper';\n\nconst RxDocumentParent = createRxDocumentConstructor() as any;\n\nclass RxLocalDocumentClass<DocData = any> extends RxDocumentParent {\n    constructor(\n        public readonly id: string,\n        jsonData: DocData,\n        public readonly parent: RxCollection | RxDatabase,\n        public readonly state: LocalDocumentState\n    ) {\n        super(null, jsonData);\n    }\n}\n\n\n\nconst RxLocalDocumentPrototype: any = {\n    get isLocal() {\n        return true;\n    },\n\n    //\n    // overwrites\n    //\n\n    _handleChangeEvent(\n        this: any,\n        changeEvent: RxChangeEvent<RxLocalDocumentData>\n    ) {\n        if (changeEvent.documentId !== this.primary) {\n            return;\n        }\n        switch (changeEvent.operation) {\n            case 'UPDATE':\n                const newData = changeEvent.documentData;\n                this._dataSync$.next(newData);\n                break;\n            case 'DELETE':\n                // remove from docCache to assure new upserted RxDocuments will be a new instance\n                const docCache = this.state.docCache;\n                docCache.delete(this.primary);\n                this._isDeleted$.next(true);\n                break;\n        }\n    },\n\n    get allAttachments$() {\n        // this is overwritten here because we cannot re-set getters on the prototype\n        throw newRxError('LD1', {\n            document: this\n        });\n    },\n    get primaryPath() {\n        return 'id';\n    },\n    get primary() {\n        return this.id;\n    },\n    get $() {\n        return (this as RxDocument)._dataSync$.asObservable();\n    },\n    $emit(this: any, changeEvent: RxChangeEvent<RxLocalDocumentData>) {\n        return this.parent.$emit(changeEvent);\n    },\n    get(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (!this._data) {\n            return undefined;\n        }\n        if (typeof objPath !== 'string') {\n            throw newRxTypeError('LD2', {\n                objPath\n            });\n        }\n\n        let valueObj = objectPath.get(this._data, objPath);\n        valueObj = overwritable.deepFreezeWhenDevMode(valueObj);\n        return valueObj;\n    },\n    get$(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (objPath.includes('.item.')) {\n            throw newRxError('LD3', {\n                objPath\n            });\n        }\n        if (objPath === this.primaryPath) {\n            throw newRxError('LD4');\n        }\n\n        return this._dataSync$\n            .pipe(\n                map(data => objectPath.get(data, objPath)),\n                distinctUntilChanged()\n            );\n    },\n    atomicUpdate(mutationFunction: LocalDocumentAtomicUpdateFunction<any>) {\n        return new Promise((res, rej) => {\n            this._atomicQueue = this._atomicQueue\n                .then(async () => {\n                    let done = false;\n                    // we need a hacky while loop to stay incide the chain-link of _atomicQueue\n                    // while still having the option to run a retry on conflicts\n                    while (!done) {\n                        const oldDocData = this._dataSync$.getValue();\n                        const newData = await mutationFunction(clone(oldDocData.data), this);\n                        try {\n                            // always await because mutationFunction might be async\n\n                            const newDocData = flatClone(oldDocData);\n                            newDocData.data = newData;\n\n                            await this._saveData(newDocData, oldDocData);\n                            done = true;\n                        } catch (err) {\n                            /**\n                             * conflicts cannot happen by just using RxDB in one process\n                             * There are two ways they still can appear which is\n                             * replication and multi-tab usage\n                             * Because atomicUpdate has a mutation function,\n                             * we can just re-run the mutation until there is no conflict\n                             */\n                            const isConflict = isBulkWriteConflictError(err as any);\n                            if (isConflict) {\n                                // conflict error -> retrying\n                                newData._rev = createRevision(newData, isConflict.documentInDb);\n                            } else {\n                                rej(err);\n                                return;\n                            }\n                        }\n                    }\n                    res(this);\n                });\n        });\n    },\n    atomicPatch(patch: Partial<any>) {\n        return this.atomicUpdate((docData: any) => {\n            Object\n                .entries(patch)\n                .forEach(([k, v]) => {\n                    docData[k] = v;\n                });\n            return docData;\n        });\n    },\n    async _saveData(this: RxLocalDocument<any>, newData: RxDocumentData<RxLocalDocumentData>) {\n        const state = await getLocalDocStateByParent(this.parent);\n        const oldData: RxDocumentData<RxLocalDocumentData> = this._dataSync$.getValue() as any;\n        newData.id = (this as any).id;\n        newData._rev = createRevision(newData, oldData);\n        return state.storageInstance.bulkWrite([{\n            previous: oldData,\n            document: newData\n        }], 'local-document-save-data')\n            .then((res) => {\n                const docResult = res.success[newData.id];\n                if (!docResult) {\n                    throw getFromObjectOrThrow(res.error, newData.id);\n                }\n                newData = flatClone(newData);\n                newData._rev = docResult._rev;\n            });\n    },\n\n    async remove(this: any): Promise<void> {\n        const state = await getLocalDocStateByParent(this.parent);\n        const writeData: RxDocumentWriteData<RxLocalDocumentData> = {\n            id: this.id,\n            data: {},\n            _deleted: true,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision(),\n            _attachments: {}\n        };\n        writeData._rev = createRevision(writeData, this._data);\n        return writeSingle(state.storageInstance, {\n            previous: this._data,\n            document: writeData\n        }, 'local-document-remove')\n            .then(() => {\n                this.state.docCache.delete(this.id);\n            });\n    }\n};\n\n\n\nlet INIT_DONE = false;\nconst _init = () => {\n    if (INIT_DONE) return;\n    else INIT_DONE = true;\n\n    // add functions of RxDocument\n    const docBaseProto = basePrototype;\n    const props = Object.getOwnPropertyNames(docBaseProto);\n    props.forEach(key => {\n        const exists = Object.getOwnPropertyDescriptor(RxLocalDocumentPrototype, key);\n        if (exists) return;\n        const desc: any = Object.getOwnPropertyDescriptor(docBaseProto, key);\n        Object.defineProperty(RxLocalDocumentPrototype, key, desc);\n    });\n\n\n    /**\n     * Overwrite things that do not work on local documents\n     * with a throwing function.\n     */\n    const getThrowingFun = (k: string) => () => {\n        throw newRxError('LD6', {\n            functionName: k\n        });\n    };\n    [\n        'populate',\n        'update',\n        'putAttachment',\n        'getAttachment',\n        'allAttachments'\n    ].forEach((k: string) => RxLocalDocumentPrototype[k] = getThrowingFun(k));\n};\n\n\n\nexport function createRxLocalDocument<DocData>(\n    id: string,\n    data: RxDocumentData<RxLocalDocumentData<DocData>>,\n    parent: any,\n    state: LocalDocumentState\n): RxLocalDocument<DocData> {\n    _init();\n    const newDoc = new RxLocalDocumentClass(id, data, parent, state);\n    newDoc.__proto__ = RxLocalDocumentPrototype;\n    state.docCache.set(id, newDoc as any);\n    return newDoc as any;\n}\n"],"mappings":"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"}