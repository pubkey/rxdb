{"version":3,"file":"couchdb-helper.js","names":["_utils","require","COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX","exports","mergeUrlQueryParams","params","Object","entries","filter","_k","value","map","key","join","couchDBDocToRxDocData","primaryPath","couchDocData","doc","couchSwapIdToPrimary","_deleted","_rev","primaryKey","docData","flatClone","_id","couchSwapPrimaryToId","idValue","ret","getDefaultFetch","window","fetch","bind","getFetchWithCouchDBAuthorization","username","password","url","options","assign","headers","b64EncodeUnicode"],"sources":["../../../../src/plugins/replication-couchdb/couchdb-helper.ts"],"sourcesContent":["import type {\n    RxDocumentData,\n    StringKeys,\n    WithDeleted\n} from '../../types';\nimport { b64EncodeUnicode, flatClone } from '../../plugins/utils';\nimport { URLQueryParams } from './couchdb-types';\n\n\nexport const COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX = 'couchdb';\n\n\nexport function mergeUrlQueryParams(\n    params: URLQueryParams\n): string {\n    return Object.entries(params)\n        .filter(([_k, value]) => typeof value !== 'undefined')\n        .map(([key, value]) => key + '=' + value)\n        .join('&');\n}\n\nexport function couchDBDocToRxDocData<RxDocType>(\n    primaryPath: string,\n    couchDocData: any\n): WithDeleted<RxDocType> {\n    const doc = couchSwapIdToPrimary(primaryPath as any, couchDocData);\n\n    // ensure deleted flag is set.\n    doc._deleted = !!doc._deleted;\n\n    delete doc._rev;\n\n    return doc;\n}\n\n\nexport function couchSwapIdToPrimary<T>(\n    primaryKey: StringKeys<RxDocumentData<T>>,\n    docData: any\n): any {\n    if (primaryKey === '_id' || docData[primaryKey]) {\n        return flatClone(docData);\n    }\n    docData = flatClone(docData);\n    docData[primaryKey] = docData._id;\n    delete docData._id;\n\n    return docData;\n}\n\n/**\n * Swaps the primaryKey of the document\n * to the _id property.\n */\nexport function couchSwapPrimaryToId<RxDocType>(\n    primaryKey: StringKeys<RxDocumentData<RxDocType>>,\n    docData: any\n): RxDocType & { _id: string; } {\n    // optimisation shortcut\n    if (primaryKey === '_id') {\n        return docData;\n    }\n\n    const idValue = docData[primaryKey];\n    const ret = flatClone(docData);\n    delete ret[primaryKey];\n    ret._id = idValue;\n    return ret;\n}\n\n\nexport function getDefaultFetch() {\n    if (\n        typeof window === 'object' &&\n        (window as any)['fetch']\n    ) {\n        /**\n         * @link https://stackoverflow.com/a/47180009/3443137\n         */\n        return window.fetch.bind(window);\n    } else {\n        return fetch;\n    }\n}\n\n/**\n * Returns a fetch handler that contains the username and password\n * in the Authorization header\n */\nexport function getFetchWithCouchDBAuthorization(username: string, password: string): typeof fetch {\n    const ret: typeof fetch = (url, options) => {\n        options = Object.assign({}, options);\n        if (!options.headers) {\n            options.headers = {};\n        }\n        (options as any).headers['Authorization'] = 'Basic ' + b64EncodeUnicode(username + ':' + password);\n        return fetch(url, options);\n    };\n    return ret;\n}\n"],"mappings":";;;;;;;;;;;;AAKA,IAAAA,MAAA,GAAAC,OAAA;AAIO,IAAMC,8CAA8C,GAAAC,OAAA,CAAAD,8CAAA,GAAG,SAAS;AAGhE,SAASE,mBAAmBA,CAC/BC,MAAsB,EAChB;EACN,OAAOC,MAAM,CAACC,OAAO,CAACF,MAAM,CAAC,CACxBG,MAAM,CAAC,CAAC,CAACC,EAAE,EAAEC,KAAK,CAAC,KAAK,OAAOA,KAAK,KAAK,WAAW,CAAC,CACrDC,GAAG,CAAC,CAAC,CAACC,GAAG,EAAEF,KAAK,CAAC,KAAKE,GAAG,GAAG,GAAG,GAAGF,KAAK,CAAC,CACxCG,IAAI,CAAC,GAAG,CAAC;AAClB;AAEO,SAASC,qBAAqBA,CACjCC,WAAmB,EACnBC,YAAiB,EACK;EACtB,IAAMC,GAAG,GAAGC,oBAAoB,CAACH,WAAW,EAASC,YAAY,CAAC;;EAElE;EACAC,GAAG,CAACE,QAAQ,GAAG,CAAC,CAACF,GAAG,CAACE,QAAQ;EAE7B,OAAOF,GAAG,CAACG,IAAI;EAEf,OAAOH,GAAG;AACd;AAGO,SAASC,oBAAoBA,CAChCG,UAAyC,EACzCC,OAAY,EACT;EACH,IAAID,UAAU,KAAK,KAAK,IAAIC,OAAO,CAACD,UAAU,CAAC,EAAE;IAC7C,OAAO,IAAAE,gBAAS,EAACD,OAAO,CAAC;EAC7B;EACAA,OAAO,GAAG,IAAAC,gBAAS,EAACD,OAAO,CAAC;EAC5BA,OAAO,CAACD,UAAU,CAAC,GAAGC,OAAO,CAACE,GAAG;EACjC,OAAOF,OAAO,CAACE,GAAG;EAElB,OAAOF,OAAO;AAClB;;AAEA;AACA;AACA;AACA;AACO,SAASG,oBAAoBA,CAChCJ,UAAiD,EACjDC,OAAY,EACgB;EAC5B;EACA,IAAID,UAAU,KAAK,KAAK,EAAE;IACtB,OAAOC,OAAO;EAClB;EAEA,IAAMI,OAAO,GAAGJ,OAAO,CAACD,UAAU,CAAC;EACnC,IAAMM,GAAG,GAAG,IAAAJ,gBAAS,EAACD,OAAO,CAAC;EAC9B,OAAOK,GAAG,CAACN,UAAU,CAAC;EACtBM,GAAG,CAACH,GAAG,GAAGE,OAAO;EACjB,OAAOC,GAAG;AACd;AAGO,SAASC,eAAeA,CAAA,EAAG;EAC9B,IACI,OAAOC,MAAM,KAAK,QAAQ,IACzBA,MAAM,CAAS,OAAO,CAAC,EAC1B;IACE;AACR;AACA;IACQ,OAAOA,MAAM,CAACC,KAAK,CAACC,IAAI,CAACF,MAAM,CAAC;EACpC,CAAC,MAAM;IACH,OAAOC,KAAK;EAChB;AACJ;;AAEA;AACA;AACA;AACA;AACO,SAASE,gCAAgCA,CAACC,QAAgB,EAAEC,QAAgB,EAAgB;EAC/F,IAAMP,GAAiB,GAAGA,CAACQ,GAAG,EAAEC,OAAO,KAAK;IACxCA,OAAO,GAAG9B,MAAM,CAAC+B,MAAM,CAAC,CAAC,CAAC,EAAED,OAAO,CAAC;IACpC,IAAI,CAACA,OAAO,CAACE,OAAO,EAAE;MAClBF,OAAO,CAACE,OAAO,GAAG,CAAC,CAAC;IACxB;IACCF,OAAO,CAASE,OAAO,CAAC,eAAe,CAAC,GAAG,QAAQ,GAAG,IAAAC,uBAAgB,EAACN,QAAQ,GAAG,GAAG,GAAGC,QAAQ,CAAC;IAClG,OAAOJ,KAAK,CAACK,GAAG,EAAEC,OAAO,CAAC;EAC9B,CAAC;EACD,OAAOT,GAAG;AACd"}