{"version":3,"file":"checkpoint.js","names":["getComposedPrimaryKeyOfDocumentData","stackCheckpoints","createRevision","ensureNotFalsy","fastUnsecureHash","getDefaultRevision","getDefaultRxDocumentMeta","getFromObjectOrThrow","now","RX_REPLICATION_META_INSTANCE_SCHEMA","pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","setCheckpoint","direction","checkpoint","previousCheckpointDoc","lastCheckpointDoc","events","canceled","getValue","JSON","stringify","data","newDoc","id","isCheckpoint","itemId","replicationIdentifier","checkpointKey","_deleted","_attachments","_meta","_rev","lwt","input","metaInstance","bulkWrite","previous","document","success","error","status","documentInDb","getLastCheckpointDoc","checkpointDocId","findDocumentsById","checkpointResult","checkpointDoc","undefined","getCheckpointKey","hash","identifier","forkInstance","storage","name","databaseName","collectionName","join"],"sources":["../../../src/replication/checkpoint.ts"],"sourcesContent":["import { getComposedPrimaryKeyOfDocumentData } from '../rx-schema-helper';\nimport { stackCheckpoints } from '../rx-storage-helper';\nimport type {\n    RxDocumentData,\n    RxStorageInstanceReplicationInput,\n    RxStorageInstanceReplicationState,\n    RxStorageReplicationDirection,\n    RxStorageReplicationMeta\n} from '../types';\nimport {\n    createRevision,\n    ensureNotFalsy,\n    fastUnsecureHash,\n    getDefaultRevision,\n    getDefaultRxDocumentMeta,\n    getFromObjectOrThrow,\n    now\n} from '../util';\nimport { RX_REPLICATION_META_INSTANCE_SCHEMA } from './meta-instance';\n\nexport async function getLastCheckpointDoc<RxDocType, CheckpointType>(\n    state: RxStorageInstanceReplicationState<RxDocType>,\n    direction: RxStorageReplicationDirection\n): Promise<undefined | CheckpointType> {\n    const checkpointDocId = getComposedPrimaryKeyOfDocumentData(\n        RX_REPLICATION_META_INSTANCE_SCHEMA,\n        {\n            isCheckpoint: '1',\n            itemId: direction,\n            replicationIdentifier: state.checkpointKey\n        }\n    );\n    const checkpointResult = await state.input.metaInstance.findDocumentsById(\n        [\n            checkpointDocId\n        ],\n        false\n    );\n\n    const checkpointDoc = checkpointResult[checkpointDocId];\n    state.lastCheckpointDoc[direction] = checkpointDoc;\n    if (checkpointDoc) {\n        return checkpointDoc.data;\n    } else {\n        return undefined;\n    }\n}\n\n\n/**\n * Sets the checkpoint,\n * automatically resolves conflicts that appear.\n */\nexport async function setCheckpoint<RxDocType, CheckpointType>(\n    state: RxStorageInstanceReplicationState<RxDocType>,\n    direction: RxStorageReplicationDirection,\n    checkpoint: CheckpointType\n) {\n    let previousCheckpointDoc = state.lastCheckpointDoc[direction];\n\n    if (\n        checkpoint &&\n        /**\n         * If the replication is already canceled,\n         * we do not write a checkpoint\n         * because that could mean we write a checkpoint\n         * for data that has been fetched from the master\n         * but not been written to the child.\n         */\n        !state.events.canceled.getValue() &&\n        /**\n         * Only write checkpoint if it is different from before\n         * to have less writes to the storage.\n         */\n        (\n            !previousCheckpointDoc ||\n            JSON.stringify(previousCheckpointDoc.data) !== JSON.stringify(checkpoint)\n        )\n    ) {\n        const newDoc: RxDocumentData<RxStorageReplicationMeta> = {\n            id: '',\n            isCheckpoint: '1',\n            itemId: direction,\n            replicationIdentifier: state.checkpointKey,\n            _deleted: false,\n            _attachments: {},\n            data: checkpoint,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision()\n        };\n        newDoc.id = getComposedPrimaryKeyOfDocumentData(\n            RX_REPLICATION_META_INSTANCE_SCHEMA,\n            newDoc\n        );\n        while (true) {\n            /**\n             * Instead of just storign the new checkpoint,\n             * we have to stack up the checkpoint with the previous one.\n             * This is required for plugins like the sharding RxStorage\n             * where the changeStream events only contain a Partial of the\n             * checkpoint.\n             */\n            if (previousCheckpointDoc) {\n                newDoc.data = stackCheckpoints([\n                    previousCheckpointDoc.data,\n                    newDoc.data\n                ]);\n            }\n            newDoc._meta.lwt = now();\n            newDoc._rev = createRevision(newDoc, previousCheckpointDoc);\n            const result = await state.input.metaInstance.bulkWrite([{\n                previous: previousCheckpointDoc,\n                document: newDoc\n            }], 'replication-set-checkpoint');\n            if (result.success[newDoc.id]) {\n                state.lastCheckpointDoc[direction] = getFromObjectOrThrow(\n                    result.success,\n                    newDoc.id\n                );\n                return;\n            } else {\n                const error = getFromObjectOrThrow(\n                    result.error,\n                    newDoc.id\n                );\n                if (error.status !== 409) {\n                    throw error;\n                } else {\n                    previousCheckpointDoc = ensureNotFalsy(error.documentInDb);\n                    newDoc._rev = createRevision(newDoc, previousCheckpointDoc);\n                }\n            }\n        }\n    }\n}\n\n\nexport function getCheckpointKey<RxDocType>(\n    input: RxStorageInstanceReplicationInput<RxDocType>\n): string {\n    const hash = fastUnsecureHash([\n        input.identifier,\n        input.forkInstance.storage.name,\n        input.forkInstance.databaseName,\n        input.forkInstance.collectionName\n    ].join('||'));\n    return 'rx-storage-replication-' + hash;\n}\n"],"mappings":"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"}