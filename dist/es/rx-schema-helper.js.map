{"version":3,"file":"rx-schema-helper.js","names":["objectPath","newRxError","clone","flatClone","isMaybeReadonlyArray","RX_META_LWT_MINIMUM","sortObject","trimDots","getPseudoSchemaForVersion","version","primaryKey","pseudoSchema","fillWithDefaultSettings","type","properties","maxLength","required","getSchemaByObjectPath","rxJsonSchema","path","usePath","replace","ret","get","fillPrimaryKey","primaryPath","jsonSchema","documentData","cloned","newPrimary","getComposedPrimaryKeyOfDocumentData","existingPrimary","args","schema","getPrimaryFieldOfPrimaryKey","key","compositePrimary","fields","map","field","value","join","separator","normalizeRxJsonSchema","normalizedSchema","indexes","Array","from","schemaObj","additionalProperties","hasOwnProperty","keyCompression","slice","encrypted","_rev","minLength","_attachments","_deleted","_meta","RX_META_SCHEMA","push","finalFields","getFinalFields","concat","filter","includes","elem","pos","arr","indexOf","index","arIndex","modifiedIndex","lwt","minimum","maximum","multipleOf","Object","keys","forEach","DEFAULT_CHECKPOINT_SCHEMA","id"],"sources":["../../src/rx-schema-helper.ts"],"sourcesContent":["import objectPath from 'object-path';\nimport { newRxError } from './rx-error';\nimport type {\n    CompositePrimaryKey,\n    DeepReadonly,\n    JsonSchema,\n    PrimaryKey,\n    RxDocumentData,\n    RxJsonSchema,\n    RxStorageDefaultCheckpoint,\n    StringKeys\n} from './types';\nimport { clone, flatClone, isMaybeReadonlyArray, RX_META_LWT_MINIMUM, sortObject, trimDots } from './util';\n\n/**\n * Helper function to create a valid RxJsonSchema\n * with a given version.\n */\nexport function getPseudoSchemaForVersion<T = any>(\n    version: number,\n    primaryKey: StringKeys<T>\n): RxJsonSchema<RxDocumentData<T>> {\n    const pseudoSchema: RxJsonSchema<RxDocumentData<T>> = fillWithDefaultSettings({\n        version,\n        type: 'object',\n        primaryKey: primaryKey as any,\n        properties: {\n            [primaryKey]: {\n                type: 'string',\n                maxLength: 100\n            }\n        } as any,\n        required: [primaryKey]\n    });\n    return pseudoSchema;\n}\n\n/**\n * Returns the sub-schema for a given path\n */\nexport function getSchemaByObjectPath<T = any>(\n    rxJsonSchema: RxJsonSchema<T>,\n    path: keyof T | string\n): JsonSchema {\n    let usePath: string = path as string;\n    usePath = usePath.replace(/\\./g, '.properties.');\n    usePath = 'properties.' + usePath;\n    usePath = trimDots(usePath);\n\n    const ret = objectPath.get(rxJsonSchema, usePath);\n    return ret;\n}\n\nexport function fillPrimaryKey<T>(\n    primaryPath: keyof T,\n    jsonSchema: RxJsonSchema<T>,\n    documentData: RxDocumentData<T>\n): RxDocumentData<T> {\n    const cloned = flatClone(documentData);\n    const newPrimary = getComposedPrimaryKeyOfDocumentData<T>(\n        jsonSchema,\n        documentData\n    );\n    const existingPrimary: string | undefined = documentData[primaryPath] as any;\n    if (\n        existingPrimary &&\n        existingPrimary !== newPrimary\n    ) {\n        throw newRxError(\n            'DOC19',\n            {\n                args: {\n                    documentData,\n                    existingPrimary,\n                    newPrimary,\n                },\n                schema: jsonSchema\n            });\n    }\n\n    (cloned as any)[primaryPath] = newPrimary;\n    return cloned;\n}\n\nexport function getPrimaryFieldOfPrimaryKey<RxDocType>(\n    primaryKey: PrimaryKey<RxDocType>\n): StringKeys<RxDocType> {\n    if (typeof primaryKey === 'string') {\n        return primaryKey as any;\n    } else {\n        return (primaryKey as CompositePrimaryKey<RxDocType>).key;\n    }\n}\n\n/**\n * Returns the composed primaryKey of a document by its data.\n */\nexport function getComposedPrimaryKeyOfDocumentData<RxDocType>(\n    jsonSchema: RxJsonSchema<RxDocType> | RxJsonSchema<RxDocumentData<RxDocType>>,\n    documentData: Partial<RxDocType>\n): string {\n    if (typeof jsonSchema.primaryKey === 'string') {\n        return (documentData as any)[jsonSchema.primaryKey];\n    }\n\n    const compositePrimary: CompositePrimaryKey<RxDocType> = jsonSchema.primaryKey as any;\n    return compositePrimary.fields.map(field => {\n        const value = objectPath.get(documentData as any, field as string);\n        if (typeof value === 'undefined') {\n            throw newRxError('DOC18', { args: { field, documentData } });\n        }\n        return value;\n    }).join(compositePrimary.separator);\n}\n\n\n/**\n * Normalize the RxJsonSchema.\n * We need this to ensure everything is set up properly\n * and we have the same hash on schemas that represent the same value but\n * have different json.\n * \n * - Orders the schemas attributes by alphabetical order\n * - Adds the primaryKey to all indexes that do not contain the primaryKey\n * - We need this for deterministic sort order on all queries, which is required for event-reduce to work.\n *\n * @return RxJsonSchema - ordered and filled\n */\nexport function normalizeRxJsonSchema<T>(jsonSchema: RxJsonSchema<T>): RxJsonSchema<T> {\n    // TODO do we need the deep clone() here?\n    const normalizedSchema: RxJsonSchema<T> = sortObject(clone(jsonSchema));\n\n    // indexes must NOT be sorted because sort order is important here.\n    if (jsonSchema.indexes) {\n        normalizedSchema.indexes = Array.from(jsonSchema.indexes);\n    }\n\n    // primaryKey.fields must NOT be sorted because sort order is important here.\n    if (\n        typeof normalizedSchema.primaryKey === 'object' &&\n        typeof jsonSchema.primaryKey === 'object'\n    ) {\n        normalizedSchema.primaryKey.fields = jsonSchema.primaryKey.fields;\n    }\n\n\n\n    return normalizedSchema;\n}\n\n/**\n * fills the schema-json with default-settings\n * @return cloned schemaObj\n */\nexport function fillWithDefaultSettings<T = any>(\n    schemaObj: RxJsonSchema<T>\n): RxJsonSchema<RxDocumentData<T>> {\n    schemaObj = flatClone(schemaObj);\n    const primaryPath: string = getPrimaryFieldOfPrimaryKey(schemaObj.primaryKey);\n    schemaObj.properties = flatClone(schemaObj.properties);\n\n    // additionalProperties is always false\n    schemaObj.additionalProperties = false;\n\n    // fill with key-compression-state ()\n    if (!schemaObj.hasOwnProperty('keyCompression')) {\n        schemaObj.keyCompression = false;\n    }\n\n    // indexes must be array\n    schemaObj.indexes = schemaObj.indexes ? schemaObj.indexes.slice(0) : [];\n\n    // required must be array\n    schemaObj.required = schemaObj.required ? schemaObj.required.slice(0) : [];\n\n    // encrypted must be array\n    schemaObj.encrypted = schemaObj.encrypted ? schemaObj.encrypted.slice(0) : [];\n\n    /**\n     * TODO we should not need to add the internal fields to the schema.\n     * Better remove the fields before validation.\n     */\n    // add _rev\n    (schemaObj.properties as any)._rev = {\n        type: 'string',\n        minLength: 1\n    };\n\n    // add attachments\n    (schemaObj.properties as any)._attachments = {\n        type: 'object'\n    };\n\n    // add deleted flag\n    (schemaObj.properties as any)._deleted = {\n        type: 'boolean'\n    };\n\n    // add meta property\n    (schemaObj.properties as any)._meta = RX_META_SCHEMA;\n\n    /**\n     * meta fields are all required\n     */\n    schemaObj.required = schemaObj.required ? schemaObj.required.slice(0) : [];\n    (schemaObj.required as string[]).push('_deleted');\n    (schemaObj.required as string[]).push('_rev');\n    (schemaObj.required as string[]).push('_meta');\n    (schemaObj.required as string[]).push('_attachments');\n\n    // final fields are always required\n    const finalFields = getFinalFields(schemaObj);\n    schemaObj.required = schemaObj.required\n        .concat(finalFields as any)\n        .filter((field: string) => !field.includes('.'))\n        .filter((elem: any, pos: any, arr: any) => arr.indexOf(elem) === pos); // unique;\n\n    // version is 0 by default\n    schemaObj.version = schemaObj.version || 0;\n\n    /**\n     * Append primary key to indexes that do not contain the primaryKey.\n     * All indexes must have the primaryKey to ensure a deterministic sort order.\n     */\n    if (schemaObj.indexes) {\n        schemaObj.indexes = schemaObj.indexes.map(index => {\n            const arIndex = isMaybeReadonlyArray(index) ? index.slice(0) : [index];\n            if (!arIndex.includes(primaryPath)) {\n                const modifiedIndex = arIndex.slice(0);\n                modifiedIndex.push(primaryPath);\n                return modifiedIndex;\n            }\n            return arIndex;\n        });\n    }\n\n    return schemaObj as any;\n}\n\n\nexport const RX_META_SCHEMA: JsonSchema = {\n    type: 'object',\n    properties: {\n        /**\n         * The last-write time.\n         * Unix time in milliseconds.\n         */\n        lwt: {\n            type: 'number',\n            /**\n             * We use 1 as minimum so that the value is never falsy.\n             */\n            minimum: RX_META_LWT_MINIMUM,\n            maximum: 1000000000000000,\n            multipleOf: 0.01\n        }\n    },\n    /**\n     * Additional properties are allowed\n     * and can be used by plugins to set various flags.\n     */\n    additionalProperties: true as any,\n    required: [\n        'lwt'\n    ]\n}\n\n\n/**\n * returns the final-fields of the schema\n * @return field-names of the final-fields\n */\nexport function getFinalFields<T = any>(\n    jsonSchema: RxJsonSchema<T>\n): string[] {\n    const ret = Object.keys(jsonSchema.properties)\n        .filter(key => (jsonSchema as any).properties[key].final);\n\n    // primary is also final\n    const primaryPath = getPrimaryFieldOfPrimaryKey(jsonSchema.primaryKey);\n    ret.push(primaryPath);\n\n    // fields of composite primary are final\n    if (typeof jsonSchema.primaryKey !== 'string') {\n        (jsonSchema.primaryKey as CompositePrimaryKey<T>).fields\n            .forEach(field => ret.push(field as string));\n    }\n\n    return ret;\n}\n\n\nexport const DEFAULT_CHECKPOINT_SCHEMA: DeepReadonly<JsonSchema<RxStorageDefaultCheckpoint>> = {\n    type: 'object',\n    properties: {\n        id: {\n            type: 'string'\n        },\n        lwt: {\n            type: 'number'\n        }\n    },\n    required: [\n        'id',\n        'lwt'\n    ],\n    additionalProperties: false\n} as const;\n"],"mappings":"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"}