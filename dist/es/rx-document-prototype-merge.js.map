{"version":3,"file":"rx-document-prototype-merge.js","names":["createRxDocumentConstructor","basePrototype","createWithConstructor","createRxDocumentWithConstructor","runPluginHooks","overwritable","constructorForCollection","WeakMap","getDocumentPrototype","rxCollection","schemaProto","schema","ormProto","getDocumentOrmPrototype","baseProto","proto","forEach","obj","props","Object","getOwnPropertyNames","key","desc","getOwnPropertyDescriptor","enumerable","startsWith","endsWith","value","defineProperty","get","bind","configurable","writable","getRxDocumentConstructor","has","ret","set","createNewRxDocument","docData","doc","deepFreezeWhenDevMode","_runHooksSync","entries","methods","k","v"],"sources":["../../src/rx-document-prototype-merge.ts"],"sourcesContent":["/**\n * For the ORM capabilities,\n * we have to merge the document prototype\n * with the ORM functions and the data\n * We do this iterating over the properties and\n * adding them to a new object.\n * In the future we should do this by chaining the __proto__ objects\n */\n\nimport type {\n    RxCollection,\n    RxDocument,\n    RxDocumentData\n} from './types';\nimport {\n    createRxDocumentConstructor,\n    basePrototype,\n    createWithConstructor as createRxDocumentWithConstructor\n} from './rx-document';\nimport {\n    runPluginHooks\n} from './hooks';\nimport { overwritable } from './overwritable';\n\nconst constructorForCollection = new WeakMap();\n\nexport function getDocumentPrototype(\n    rxCollection: RxCollection\n): any {\n    const schemaProto = rxCollection.schema.getDocumentPrototype();\n    const ormProto = getDocumentOrmPrototype(rxCollection);\n    const baseProto = basePrototype;\n    const proto = {};\n    [\n        schemaProto,\n        ormProto,\n        baseProto\n    ].forEach(obj => {\n        const props = Object.getOwnPropertyNames(obj);\n        props.forEach(key => {\n            const desc: any = Object.getOwnPropertyDescriptor(obj, key);\n\n\n            /**\n             * When enumerable is true, it will show on console.dir(instance)\n             * To not pollute the output, only getters and methods are enumerable\n             */\n            let enumerable = true;\n            if (\n                key.startsWith('_') ||\n                key.endsWith('_') ||\n                key.startsWith('$') ||\n                key.endsWith('$')\n            ) enumerable = false;\n\n            if (typeof desc.value === 'function') {\n                // when getting a function, we automatically do a .bind(this)\n                Object.defineProperty(proto, key, {\n                    get() {\n                        return desc.value.bind(this);\n                    },\n                    enumerable,\n                    configurable: false\n                });\n\n            } else {\n                desc.enumerable = enumerable;\n                desc.configurable = false;\n                if (desc.writable)\n                    desc.writable = false;\n                Object.defineProperty(proto, key, desc);\n            }\n        });\n    });\n    return proto;\n}\n\nexport function getRxDocumentConstructor<RxDocType, ORM>(\n    rxCollection: RxCollection<RxDocType, ORM>\n) {\n    if (!constructorForCollection.has(rxCollection)) {\n        const ret = createRxDocumentConstructor(\n            getDocumentPrototype(rxCollection)\n        );\n        constructorForCollection.set(rxCollection, ret);\n    }\n    return constructorForCollection.get(rxCollection);\n}\n\n/**\n * Create a RxDocument-instance from the jsonData\n * and the prototype merge.\n * You should never call this method directly,\n * instead you should get the document from collection._docCache.getCachedRxDocument().\n */\nexport function createNewRxDocument<RxDocType, ORM>(\n    rxCollection: RxCollection<RxDocType, ORM>,\n    docData: RxDocumentData<RxDocType>\n): RxDocument<RxDocType, ORM> {\n    const doc = createRxDocumentWithConstructor(\n        getRxDocumentConstructor(rxCollection),\n        rxCollection as any,\n        overwritable.deepFreezeWhenDevMode(docData as any)\n    );\n    rxCollection._runHooksSync('post', 'create', docData, doc);\n    runPluginHooks('postCreateRxDocument', doc);\n    return doc as any;\n}\n\n\n/**\n * returns the prototype-object\n * that contains the orm-methods,\n * used in the proto-merge\n */\nexport function getDocumentOrmPrototype(rxCollection: RxCollection): any {\n    const proto: any = {};\n    Object\n        .entries(rxCollection.methods)\n        .forEach(([k, v]) => {\n            proto[k] = v;\n        });\n    return proto;\n}\n"],"mappings":"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"}