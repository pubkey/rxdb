{"version":3,"file":"rx-document-prototype-merge.js","names":["createRxDocumentConstructor","basePrototype","createWithConstructor","createRxDocumentWithConstructor","runPluginHooks","overwritable","protoForCollection","WeakMap","constructorForCollection","getDocumentPrototype","rxCollection","has","schemaProto","schema","ormProto","getDocumentOrmPrototype","baseProto","proto","forEach","obj","props","Object","getOwnPropertyNames","key","desc","getOwnPropertyDescriptor","enumerable","startsWith","endsWith","value","defineProperty","get","bind","configurable","writable","set","getRxDocumentConstructor","ret","createRxDocument","docData","primary","primaryPath","cacheDoc","_docCache","doc","deepFreezeWhenDevMode","_runHooksSync","createRxDocuments","docsJSON","map","json","entries","methods","k","v"],"sources":["../../src/rx-document-prototype-merge.ts"],"sourcesContent":["/**\n * For the ORM capabilities,\n * we have to merge the document prototype\n * with the ORM functions and the data\n * We do this iterating over the properties and\n * adding them to a new object.\n * In the future we should do this by chaining the __proto__ objects\n */\n\nimport type {\n    RxCollection,\n    RxDocument,\n    RxDocumentData\n} from './types';\nimport {\n    createRxDocumentConstructor,\n    basePrototype,\n    createWithConstructor as createRxDocumentWithConstructor\n} from './rx-document';\nimport {\n    runPluginHooks\n} from './hooks';\nimport { overwritable } from './overwritable';\n\n// caches\nconst protoForCollection: WeakMap<RxCollection, any> = new WeakMap();\nconst constructorForCollection: WeakMap<RxCollection, any> = new WeakMap();\n\nexport function getDocumentPrototype(\n    rxCollection: RxCollection\n): any {\n    if (!protoForCollection.has(rxCollection)) {\n        const schemaProto = rxCollection.schema.getDocumentPrototype();\n        const ormProto = getDocumentOrmPrototype(rxCollection);\n        const baseProto = basePrototype;\n        const proto = {};\n        [\n            schemaProto,\n            ormProto,\n            baseProto\n        ].forEach(obj => {\n            const props = Object.getOwnPropertyNames(obj);\n            props.forEach(key => {\n                const desc: any = Object.getOwnPropertyDescriptor(obj, key);\n\n\n                /**\n                 * When enumerable is true, it will show on console.dir(instance)\n                 * To not pollute the output, only getters and methods are enumerable\n                 */\n                let enumerable = true;\n                if (\n                    key.startsWith('_') ||\n                    key.endsWith('_') ||\n                    key.startsWith('$') ||\n                    key.endsWith('$')\n                ) enumerable = false;\n\n                if (typeof desc.value === 'function') {\n                    // when getting a function, we automatically do a .bind(this)\n                    Object.defineProperty(proto, key, {\n                        get() {\n                            return desc.value.bind(this);\n                        },\n                        enumerable,\n                        configurable: false\n                    });\n\n                } else {\n                    desc.enumerable = enumerable;\n                    desc.configurable = false;\n                    if (desc.writable)\n                        desc.writable = false;\n                    Object.defineProperty(proto, key, desc);\n                }\n            });\n        });\n        protoForCollection.set(rxCollection, proto);\n\n    }\n    return protoForCollection.get(rxCollection);\n}\n\nexport function getRxDocumentConstructor(\n    rxCollection: RxCollection\n) {\n    if (!constructorForCollection.has(rxCollection)) {\n        const ret = createRxDocumentConstructor(\n            getDocumentPrototype(rxCollection)\n        );\n        constructorForCollection.set(rxCollection, ret);\n    }\n    return constructorForCollection.get(rxCollection);\n}\n\n/**\n * Create a RxDocument-instance from the jsonData\n * and the prototype merge.\n * If the document already exists in the _docCache,\n * return that instead to ensure we have no duplicates.\n */\nexport function createRxDocument<RxDocType, ORM>(\n    rxCollection: RxCollection<RxDocType, ORM>,\n    docData: RxDocumentData<RxDocType>\n): RxDocument<RxDocType, ORM> {\n    const primary: string = docData[rxCollection.schema.primaryPath] as any;\n\n    // return from cache if exists\n    const cacheDoc = rxCollection._docCache.get(primary);\n    if (cacheDoc) {\n        return cacheDoc as any;\n    }\n\n    const doc = createRxDocumentWithConstructor(\n        getRxDocumentConstructor(rxCollection as any),\n        rxCollection as any,\n        overwritable.deepFreezeWhenDevMode(docData as any)\n    );\n\n    rxCollection._docCache.set(primary, doc as any);\n    rxCollection._runHooksSync('post', 'create', docData, doc);\n    runPluginHooks('postCreateRxDocument', doc);\n    return doc as any;\n}\n\n/**\n * create RxDocument from the docs-array\n */\nexport function createRxDocuments<DT, OM>(\n    rxCollection: RxCollection,\n    docsJSON: any[]\n): RxDocument<DT, OM>[] {\n    return docsJSON.map(\n        json => createRxDocument<DT, OM>(rxCollection as any, json)\n    );\n}\n\n/**\n * returns the prototype-object\n * that contains the orm-methods,\n * used in the proto-merge\n */\nexport function getDocumentOrmPrototype(rxCollection: RxCollection): any {\n    const proto: any = {};\n    Object\n        .entries(rxCollection.methods)\n        .forEach(([k, v]) => {\n            proto[k] = v;\n        });\n    return proto;\n}\n"],"mappings":"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"}