{"version":3,"file":"index.js","names":["createQueryBuilder","OTHER_MANGO_ATTRIBUTES","OTHER_MANGO_OPERATORS","RxQueryBase","tunnelQueryCache","clone","runPluginHooks","RXQUERY_OTHER_FLAG","runBuildingStep","rxQuery","functionName","value","queryBuilder","mangoQuery","other","_path","queryBuilderJson","toJSON","op","queryObj","query","collection","newQuery","path","tunneled","applyBuildingStep","proto","RxDBQueryBuilderPlugin","name","rxdb","prototypes","RxQuery","forEach","attribute","operator"],"sources":["../../../../src/plugins/query-builder/index.ts"],"sourcesContent":["import {\n    createQueryBuilder,\n    OTHER_MANGO_ATTRIBUTES,\n    OTHER_MANGO_OPERATORS\n} from './mquery/nosql-query-builder';\nimport type { RxPlugin, RxQuery } from '../../types';\nimport { RxQueryBase, tunnelQueryCache } from '../../rx-query';\nimport { clone } from '../../plugins/utils';\nimport { runPluginHooks } from '../../hooks';\n\n// if the query-builder plugin is used, we have to save its last path\nconst RXQUERY_OTHER_FLAG = 'queryBuilderPath';\n\nexport function runBuildingStep<RxDocumentType, RxQueryResult>(\n    rxQuery: RxQuery<RxDocumentType, RxQueryResult>,\n    functionName: string,\n    value: any\n): RxQuery<RxDocumentType, RxQueryResult> {\n    const queryBuilder = createQueryBuilder(clone(rxQuery.mangoQuery));\n    if (rxQuery.other[RXQUERY_OTHER_FLAG]) {\n        queryBuilder._path = rxQuery.other[RXQUERY_OTHER_FLAG];\n    }\n\n    (queryBuilder as any)[functionName](value); // run\n\n    const queryBuilderJson = queryBuilder.toJSON();\n\n\n    runPluginHooks('preCreateRxQuery', {\n        op: rxQuery.op,\n        queryObj: queryBuilderJson.query,\n        collection: rxQuery.collection\n    });\n\n\n    const newQuery = new RxQueryBase(\n        rxQuery.op,\n        queryBuilderJson.query,\n        rxQuery.collection\n    ) as RxQuery;\n\n\n\n    if (queryBuilderJson.path) {\n        newQuery.other[RXQUERY_OTHER_FLAG] = queryBuilderJson.path;\n    }\n\n    const tunneled = tunnelQueryCache(newQuery);\n    return tunneled;\n}\n\nexport function applyBuildingStep(\n    proto: any,\n    functionName: string\n): void {\n    proto[functionName] = function (this: RxQuery, value: any) {\n        return runBuildingStep(this, functionName, value);\n    };\n}\n\nexport * from './mquery/nosql-query-builder';\n\nexport const RxDBQueryBuilderPlugin: RxPlugin = {\n    name: 'query-builder',\n    rxdb: true,\n    prototypes: {\n        RxQuery(proto: any) {\n            [\n                'where',\n                'equals',\n                'eq',\n                'or',\n                'nor',\n                'and',\n                'mod',\n                'exists',\n                'elemMatch',\n                'sort'\n            ].forEach(attribute => {\n                applyBuildingStep(proto, attribute);\n            });\n            OTHER_MANGO_ATTRIBUTES.forEach(attribute => {\n                applyBuildingStep(proto, attribute);\n            });\n            OTHER_MANGO_OPERATORS.forEach(operator => {\n                applyBuildingStep(proto, operator);\n            });\n        }\n    }\n};\n"],"mappings":"AAAA,SACIA,kBAAkB,EAClBC,sBAAsB,EACtBC,qBAAqB,QAClB,8BAA8B;AAErC,SAASC,WAAW,EAAEC,gBAAgB,QAAQ,gBAAgB;AAC9D,SAASC,KAAK,QAAQ,qBAAqB;AAC3C,SAASC,cAAc,QAAQ,aAAa;;AAE5C;AACA,IAAMC,kBAAkB,GAAG,kBAAkB;AAE7C,OAAO,SAASC,eAAe,CAC3BC,OAA+C,EAC/CC,YAAoB,EACpBC,KAAU,EAC4B;EACtC,IAAMC,YAAY,GAAGZ,kBAAkB,CAACK,KAAK,CAACI,OAAO,CAACI,UAAU,CAAC,CAAC;EAClE,IAAIJ,OAAO,CAACK,KAAK,CAACP,kBAAkB,CAAC,EAAE;IACnCK,YAAY,CAACG,KAAK,GAAGN,OAAO,CAACK,KAAK,CAACP,kBAAkB,CAAC;EAC1D;EAECK,YAAY,CAASF,YAAY,CAAC,CAACC,KAAK,CAAC,CAAC,CAAC;;EAE5C,IAAMK,gBAAgB,GAAGJ,YAAY,CAACK,MAAM,EAAE;EAG9CX,cAAc,CAAC,kBAAkB,EAAE;IAC/BY,EAAE,EAAET,OAAO,CAACS,EAAE;IACdC,QAAQ,EAAEH,gBAAgB,CAACI,KAAK;IAChCC,UAAU,EAAEZ,OAAO,CAACY;EACxB,CAAC,CAAC;EAGF,IAAMC,QAAQ,GAAG,IAAInB,WAAW,CAC5BM,OAAO,CAACS,EAAE,EACVF,gBAAgB,CAACI,KAAK,EACtBX,OAAO,CAACY,UAAU,CACV;EAIZ,IAAIL,gBAAgB,CAACO,IAAI,EAAE;IACvBD,QAAQ,CAACR,KAAK,CAACP,kBAAkB,CAAC,GAAGS,gBAAgB,CAACO,IAAI;EAC9D;EAEA,IAAMC,QAAQ,GAAGpB,gBAAgB,CAACkB,QAAQ,CAAC;EAC3C,OAAOE,QAAQ;AACnB;AAEA,OAAO,SAASC,iBAAiB,CAC7BC,KAAU,EACVhB,YAAoB,EAChB;EACJgB,KAAK,CAAChB,YAAY,CAAC,GAAG,UAAyBC,KAAU,EAAE;IACvD,OAAOH,eAAe,CAAC,IAAI,EAAEE,YAAY,EAAEC,KAAK,CAAC;EACrD,CAAC;AACL;AAEA,cAAc,8BAA8B;AAE5C,OAAO,IAAMgB,sBAAgC,GAAG;EAC5CC,IAAI,EAAE,eAAe;EACrBC,IAAI,EAAE,IAAI;EACVC,UAAU,EAAE;IACRC,OAAO,CAACL,KAAU,EAAE;MAChB,CACI,OAAO,EACP,QAAQ,EACR,IAAI,EACJ,IAAI,EACJ,KAAK,EACL,KAAK,EACL,KAAK,EACL,QAAQ,EACR,WAAW,EACX,MAAM,CACT,CAACM,OAAO,CAACC,SAAS,IAAI;QACnBR,iBAAiB,CAACC,KAAK,EAAEO,SAAS,CAAC;MACvC,CAAC,CAAC;MACFhC,sBAAsB,CAAC+B,OAAO,CAACC,SAAS,IAAI;QACxCR,iBAAiB,CAACC,KAAK,EAAEO,SAAS,CAAC;MACvC,CAAC,CAAC;MACF/B,qBAAqB,CAAC8B,OAAO,CAACE,QAAQ,IAAI;QACtCT,iBAAiB,CAACC,KAAK,EAAEQ,QAAQ,CAAC;MACtC,CAAC,CAAC;IACN;EACJ;AACJ,CAAC"}