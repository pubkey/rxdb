{"version":3,"file":"index.js","names":["map","blobBufferUtil","flatClone","PROMISE_RESOLVE_VOID","newRxError","ensureSchemaSupportsAttachments","doc","schemaJson","collection","schema","jsonSchema","attachments","link","_assignMethodsToAttachment","attachment","Object","entries","forEach","funName","fun","defineProperty","get","bind","RxAttachment","id","type","length","digest","remove","incrementalWriteQueue","addWrite","_data","docWriteData","_attachments","then","getData","storageInstance","getAttachmentData","primary","plainDataBase64","createBlobBufferFromBase64","ret","getStringData","data","toString","asString","fromStorageInstanceResult","attachmentData","rxDocument","putAttachment","dataSize","size","toBase64String","dataString","writeResult","newDocument","_docCache","getCachedRxDocument","attachmentDataOfId","getAttachment","docData","allAttachments","keys","preMigrateDocument","newAttachments","Promise","all","attachmentId","docPrimary","oldCollection","primaryPath","rawAttachmentData","postMigrateDocument","_action","RxDBAttachmentsPlugin","name","rxdb","prototypes","RxDocument","proto","allAttachments$","$","pipe","overwritable","hooks","after"],"sources":["../../../../src/plugins/attachments/index.ts"],"sourcesContent":["import {\n    map\n} from 'rxjs/operators';\n\nimport {\n    blobBufferUtil,\n    flatClone,\n    PROMISE_RESOLVE_VOID\n} from '../../util';\nimport {\n    newRxError\n} from '../../rx-error';\nimport type {\n    RxDocument,\n    RxPlugin,\n    BlobBuffer,\n    OldRxCollection,\n    RxDocumentWriteData,\n    RxAttachmentData,\n    RxDocumentData,\n    RxAttachmentCreator,\n    RxAttachmentWriteData\n} from '../../types';\n\nfunction ensureSchemaSupportsAttachments(doc: any) {\n    const schemaJson = doc.collection.schema.jsonSchema;\n    if (!schemaJson.attachments) {\n        throw newRxError('AT1', {\n            link: 'https://pubkey.github.io/rxdb/rx-attachment.html'\n        });\n    }\n}\n\nconst _assignMethodsToAttachment = function (attachment: any) {\n    Object\n        .entries(attachment.doc.collection.attachments)\n        .forEach(([funName, fun]) => {\n            Object.defineProperty(attachment, funName, {\n                get: () => (fun as any).bind(attachment)\n            });\n        });\n};\n\n/**\n * an RxAttachment is basically just the attachment-stub\n * wrapped so that you can access the attachment-data\n */\nexport class RxAttachment {\n    public doc: RxDocument;\n    public id: string;\n    public type: string;\n    public length: number;\n    public digest: string;\n    constructor({\n        doc,\n        id,\n        type,\n        length,\n        digest\n    }: any) {\n        this.doc = doc;\n        this.id = id;\n        this.type = type;\n        this.length = length;\n        this.digest = digest;\n\n        _assignMethodsToAttachment(this);\n    }\n\n    remove(): Promise<void> {\n        return this.doc.collection.incrementalWriteQueue.addWrite(\n            this.doc._data,\n            docWriteData => {\n                delete docWriteData._attachments[this.id];\n                return docWriteData;\n            }\n        ).then(() => { });\n    }\n\n    /**\n     * returns the data for the attachment\n     */\n    async getData(): Promise<BlobBuffer> {\n        const plainDataBase64 = await this.doc.collection.storageInstance.getAttachmentData(\n            this.doc.primary,\n            this.id\n        );\n        const ret = await blobBufferUtil.createBlobBufferFromBase64(\n            plainDataBase64,\n            this.type as any\n        );\n        return ret;\n    }\n\n    async getStringData(): Promise<string> {\n        const data = await this.getData();\n        const asString = await blobBufferUtil.toString(data);\n        return asString;\n    }\n}\n\nexport function fromStorageInstanceResult<RxDocType>(\n    id: string,\n    attachmentData: RxAttachmentData,\n    rxDocument: RxDocument<RxDocType>\n) {\n    return new RxAttachment({\n        doc: rxDocument,\n        id,\n        type: attachmentData.type,\n        length: attachmentData.length,\n        digest: attachmentData.digest\n    });\n}\n\nexport async function putAttachment<RxDocType>(\n    this: RxDocument<RxDocType>,\n    attachmentData: RxAttachmentCreator\n): Promise<RxAttachment> {\n    ensureSchemaSupportsAttachments(this);\n\n    const dataSize = blobBufferUtil.size(attachmentData.data);\n    const dataString = await blobBufferUtil.toBase64String(attachmentData.data);\n\n    const id = attachmentData.id;\n    const type = attachmentData.type;\n    const data = dataString;\n\n    return this.collection.incrementalWriteQueue.addWrite(\n        this._data,\n        (docWriteData: RxDocumentWriteData<RxDocType>) => {\n            docWriteData._attachments = flatClone(docWriteData._attachments);\n\n            docWriteData._attachments[id] = {\n                length: dataSize,\n                type,\n                data\n            };\n            return docWriteData;\n        }).then(writeResult => {\n            const newDocument = this.collection._docCache.getCachedRxDocument(writeResult);\n            const attachmentDataOfId = writeResult._attachments[id];\n            const attachment = fromStorageInstanceResult(\n                id,\n                attachmentDataOfId,\n                newDocument\n            );\n            return attachment;\n        });\n}\n\n/**\n * get an attachment of the document by its id\n */\nexport function getAttachment(\n    this: RxDocument,\n    id: string\n): RxAttachment | null {\n    ensureSchemaSupportsAttachments(this);\n    const docData: any = this._data;\n    if (!docData._attachments || !docData._attachments[id])\n        return null;\n\n    const attachmentData = docData._attachments[id];\n    const attachment = fromStorageInstanceResult(\n        id,\n        attachmentData,\n        this\n    );\n    return attachment;\n}\n\n/**\n * returns all attachments of the document\n */\nexport function allAttachments(\n    this: RxDocument\n): RxAttachment[] {\n    ensureSchemaSupportsAttachments(this);\n    const docData: any = this._data;\n\n    // if there are no attachments, the field is missing\n    if (!docData._attachments) {\n        return [];\n    }\n    return Object.keys(docData._attachments)\n        .map(id => {\n            return fromStorageInstanceResult(\n                id,\n                docData._attachments[id],\n                this\n            );\n        });\n}\n\nexport async function preMigrateDocument<RxDocType>(\n    data: {\n        docData: RxDocumentData<RxDocType>;\n        oldCollection: OldRxCollection;\n    }\n): Promise<void> {\n    const attachments = data.docData._attachments;\n    if (attachments) {\n        const newAttachments: { [attachmentId: string]: RxAttachmentWriteData; } = {};\n        await Promise.all(\n            Object.keys(attachments).map(async (attachmentId) => {\n                const attachment: RxAttachmentData = attachments[attachmentId];\n                const docPrimary: string = (data.docData as any)[data.oldCollection.schema.primaryPath];\n                const rawAttachmentData = await data.oldCollection.storageInstance.getAttachmentData(docPrimary, attachmentId);\n                newAttachments[attachmentId] = {\n                    length: attachment.length,\n                    type: attachment.type,\n                    data: rawAttachmentData\n                };\n            })\n        );\n\n        /**\n         * Hooks mutate the input\n         * instead of returning stuff\n         */\n        (data.docData as RxDocumentWriteData<RxDocType>)._attachments = newAttachments;\n    }\n}\n\nexport function postMigrateDocument(_action: any): Promise<void> {\n    /**\n     * No longer needed because\n     * we store the attachments data buffers directly in the document.\n     */\n    return PROMISE_RESOLVE_VOID;\n}\n\nexport const RxDBAttachmentsPlugin: RxPlugin = {\n    name: 'attachments',\n    rxdb: true,\n    prototypes: {\n        RxDocument: (proto: any) => {\n            proto.putAttachment = putAttachment;\n            proto.getAttachment = getAttachment;\n            proto.allAttachments = allAttachments;\n            Object.defineProperty(proto, 'allAttachments$', {\n                get: function allAttachments$(this: RxDocument) {\n                    return this.$\n                        .pipe(\n                            map(data => Object.entries(\n                                data._attachments\n                            )),\n                            map(entries => {\n                                return (entries as any)\n                                    .map(([id, attachmentData]: any) => {\n                                        return fromStorageInstanceResult(\n                                            id,\n                                            attachmentData,\n                                            this\n                                        );\n                                    });\n                            })\n                        );\n                }\n            });\n        }\n    },\n    overwritable: {},\n    hooks: {\n        preMigrateDocument: {\n            after: preMigrateDocument\n        },\n        postMigrateDocument: {\n            after: postMigrateDocument\n        }\n    }\n};\n"],"mappings":"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"}