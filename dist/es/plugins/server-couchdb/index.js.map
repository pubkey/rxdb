{"version":3,"file":"index.js","names":["os","nodePath","express","corsFn","addPouchPlugin","PouchDB","newRxError","RxDBReplicationCouchDBPlugin","PouchAdapterHttp","adapterObject","addRxPlugin","flatClone","PROMISE_RESOLVE_VOID","pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","recover","spawnServer","startupPromise","response","app","pouchApp","server","path","port","cors","startServer","pouchdbExpressOptions","db","collectionsPath","SERVERS_OF_DB","has","set","storage","adapter","Error","adapterObj","pouchDBOptions","Object","assign","prefix","getPrefix","log","pseudo","defaults","APP_OF_DB","keys","collections","forEach","colName","tunnelCollectionPath","DBS_WITH_SERVER","add","use","origin","originToSend","usePouchExpressOptions","inMemoryConfig","logPath","join","tmpdir","ExpressPouchDB","Promise","res","rej","answered","listen","on","err","get","push","all","values","map","collection","url","name","pingDb","aaa","info","close","require","error","console","PouchdbAllDbs","WeakMap","WeakSet","normalizeDbName","split","filter","str","pop","length","ret","startsWith","pathWithSlash","endsWith","collectionPath","req","next","baseUrl","to","schema","version","toFull","originalUrl","replace","res1","setTimeout","ensureNoMoreCollections","args","database","onDestroy","RxDBServerCouchDBPlugin","rxdb","init","prototypes","RxDatabase","proto","serverCouchDB","overwritable","hooks","preDestroyRxDatabase","after","preCreateRxCollection"],"sources":["../../../../src/plugins/server-couchdb/index.ts"],"sourcesContent":["import * as os from 'os';\nimport * as nodePath from 'path';\n\nimport express from 'express';\nimport type { Express } from 'express';\nimport corsFn from 'cors';\n\nimport {\n    addPouchPlugin,\n    PouchDB,\n    RxStoragePouch\n} from '../../plugins/pouchdb';\nimport {\n    newRxError\n} from '../../rx-error';\nimport type {\n    PouchDBExpressServerOptions,\n    RxDatabase,\n    RxPlugin,\n    CouchDBServerResponse\n} from '../../types';\n\nimport { RxDBReplicationCouchDBPlugin } from '../replication-couchdb';\n\nimport PouchAdapterHttp from 'pouchdb-adapter-http';\nimport { adapterObject, addRxPlugin } from '../../index';\nimport {\n    flatClone, PROMISE_RESOLVE_VOID\n} from '../../util';\n\nlet ExpressPouchDB: any;\ntry {\n    ExpressPouchDB = require('express-pouchdb');\n} catch (error) {\n    console.error(\n        'Since version 8.4.0 the module \\'express-pouchdb\\' is not longer delivered with RxDB.\\n' +\n        'You can install it with \\'npm install express-pouchdb\\''\n    );\n}\n\n// we have to clean up after tests so there is no stupid logging\n// @link https://github.com/pouchdb/pouchdb-server/issues/226\nconst PouchdbAllDbs = require('pouchdb-all-dbs');\nPouchdbAllDbs(PouchDB);\n\nconst APP_OF_DB: WeakMap<RxDatabase, Express> = new WeakMap();\nconst SERVERS_OF_DB = new WeakMap();\nconst DBS_WITH_SERVER = new WeakSet();\n\n\nconst normalizeDbName = function (db: RxDatabase) {\n    const split = db.name.split('/').filter((str: string) => str !== '');\n    return split.pop();\n};\n\nconst getPrefix = function (db: RxDatabase) {\n    const split = db.name.split('/').filter((str: string) => str !== '');\n    split.pop(); // last was the name\n    if (split.length === 0) {\n        return '';\n    }\n    let ret = split.join('/') + '/';\n    if (db.name.startsWith('/')) {\n        ret = '/' + ret;\n    }\n    return ret;\n};\n\n/**\n * tunnel requests so collection-names can be used as paths\n */\nfunction tunnelCollectionPath(\n    db: RxDatabase,\n    path: string,\n    app: Express,\n    colName: string\n) {\n    const pathWithSlash = path.endsWith('/') ? path : path + '/';\n    const collectionPath = pathWithSlash + colName;\n    app.use(collectionPath, async function (req: any, res: any, next: any) {\n        if (req.baseUrl.endsWith(collectionPath)) {\n\n            while (!db[colName]) {\n                // if the collection is migrated,\n                // it can happen that it does not exist at this moment\n                await new Promise(res1 => setTimeout(res1, 50));\n            }\n            const to = normalizeDbName(db) + '-rxdb-' + db[colName].schema.version + '-' + colName;\n            const toFull = req.originalUrl.replace(collectionPath, pathWithSlash + to);\n            req.originalUrl = toFull;\n        }\n        next();\n    });\n}\n\nexport async function spawnServer(\n    this: RxDatabase,\n    {\n        path = '/db',\n        port = 3000,\n        cors = false,\n        startServer = true,\n        pouchdbExpressOptions = {}\n    }\n): Promise<CouchDBServerResponse> {\n    const db: RxDatabase = this;\n    const collectionsPath = startServer ? path : '/';\n    if (!SERVERS_OF_DB.has(db)) {\n        SERVERS_OF_DB.set(db, []);\n    }\n\n    const storage: RxStoragePouch = db.storage as any;\n    if (!storage.adapter) {\n        throw new Error('The RxDB server plugin only works with pouchdb storage.');\n    }\n\n    const adapterObj = adapterObject(storage.adapter);\n    const pouchDBOptions = Object.assign(\n        { prefix: getPrefix(db), log: false },\n        adapterObj,\n    );\n\n    const pseudo = PouchDB.defaults(pouchDBOptions);\n    const app = express();\n    APP_OF_DB.set(db, app);\n\n    Object.keys(db.collections).forEach(colName => {\n        // tunnel requests so collection-names can be used as paths\n        tunnelCollectionPath(db, collectionsPath, app, colName);\n    });\n\n    // remember to throw error if collection is created after the server is already there\n    DBS_WITH_SERVER.add(db);\n\n    if (cors) {\n        app.use(corsFn({\n            'origin': function (origin, callback) {\n                const originToSend: any = origin || '*';\n                callback(null, originToSend);\n            },\n            'credentials': true,\n            'methods': 'DELETE,GET,HEAD,OPTIONS,PATCH,POST,PUT',\n        }));\n    }\n\n    /**\n     * Overwrite the defaults of PouchDBExpressServerOptions.\n     * In RxDB the defaults should not pollute anything with folders so we store the config in memory\n     * and the logs in the tmp folder of the os.\n     */\n    const usePouchExpressOptions: PouchDBExpressServerOptions = flatClone(pouchdbExpressOptions);\n    if (typeof usePouchExpressOptions.inMemoryConfig === 'undefined') {\n        usePouchExpressOptions.inMemoryConfig = true;\n    }\n    if (typeof usePouchExpressOptions.logPath === 'undefined') {\n        usePouchExpressOptions.logPath = nodePath.join(\n            os.tmpdir(),\n            'rxdb-server-log.txt'\n        );\n    }\n\n    const pouchApp = ExpressPouchDB(pseudo, usePouchExpressOptions);\n    app.use(collectionsPath, pouchApp);\n\n    let server = null;\n    let startupPromise: Promise<void> = PROMISE_RESOLVE_VOID;\n    if (startServer) {\n        /**\n         * Listen for errors on server startup.\n         * and properly handle the error instead of returning a startupPromise\n         */\n        startupPromise = new Promise((res, rej) => {\n            let answered = false;\n            server = app.listen(port, () => {\n                if (!answered) {\n                    answered = true;\n                    res();\n                }\n            });\n            server.on('error', (err) => {\n                if (!answered) {\n                    answered = true;\n                    rej(err);\n                }\n            });\n        });\n        SERVERS_OF_DB.get(db).push(server);\n\n        /**\n         * When the database has no documents, there is no db file\n         * and so the replication would not work.\n         * This is a hack which ensures that the couchdb instance exists\n         * and we can replicate even if there is no document in the beginning.\n         */\n        await Promise.all(\n            Object.values(db.collections).map(async (collection) => {\n                const url = 'http://0.0.0.0:' + port + collectionsPath + '/' + collection.name;\n                try {\n                    const pingDb = new PouchDB(url);\n                    pingDb.aaa = 'pingDB for ' + url;\n                    await pingDb.info();\n                    await pingDb.close();\n                } catch (_err) { }\n            })\n        );\n    }\n    await startupPromise;\n\n    const response: CouchDBServerResponse = {\n        app,\n        pouchApp,\n        server\n    };\n    return response;\n}\n\n/**\n * when a server is created, no more collections can be spawned\n */\nfunction ensureNoMoreCollections(args: any) {\n    if (DBS_WITH_SERVER.has(args.database)) {\n        const err = newRxError(\n            'S1', {\n                collection: args.name,\n                database: args.database.name\n            }\n        );\n        throw err;\n    }\n}\n\n/**\n * runs when the database gets destroyed\n */\nexport function onDestroy(db: RxDatabase) {\n    if (SERVERS_OF_DB.has(db)) {\n        SERVERS_OF_DB.get(db).forEach((server: any) => server.close());\n    }\n}\n\nexport const RxDBServerCouchDBPlugin: RxPlugin = {\n    name: 'server-couchdb',\n    rxdb: true,\n    init() {\n        addPouchPlugin(PouchAdapterHttp);\n        addRxPlugin(RxDBReplicationCouchDBPlugin);\n    },\n    prototypes: {\n        RxDatabase: (proto: any) => {\n            proto.serverCouchDB = spawnServer;\n        }\n    },\n    overwritable: {},\n    hooks: {\n        preDestroyRxDatabase: {\n            after: onDestroy\n        },\n        preCreateRxCollection: {\n            after: ensureNoMoreCollections\n        }\n    }\n};\n"],"mappings":"AAAA,OAAO,KAAKA,EAAE,MAAM,IAAI;AACxB,OAAO,KAAKC,QAAQ,MAAM,MAAM;AAEhC,OAAOC,OAAO,MAAM,SAAS;AAE7B,OAAOC,MAAM,MAAM,MAAM;AAEzB,SACIC,cAAc,EACdC,OAAO,QAEJ,uBAAuB;AAC9B,SACIC,UAAU,QACP,gBAAgB;AAQvB,SAASC,4BAA4B,QAAQ,wBAAwB;AAErE,OAAOC,gBAAgB,MAAM,sBAAsB;AACnD,SAASC,aAAa,EAAEC,WAAW,QAAQ,aAAa;AACxD,SACIC,SAAS,EAAEC,oBAAoB,QAC5B,YAAY;AAWZ,iBAAiBC,IAAI,EAAEC,KAAK,EAAEC,KAAK,EAAE;EAC3C,IAAI,CAACF,IAAI,CAACG,CAAC,EAAE;IACZ,IAAID,KAAK,iBAAiB,EAAE;MAC3B,IAAIA,KAAK,CAACC,CAAC,EAAE;QACZ,IAAIF,KAAK,GAAG,CAAC,EAAE;UACdA,KAAK,GAAGC,KAAK,CAACC,CAAC;QAChB;QACAD,KAAK,GAAGA,KAAK,CAACE,CAAC;MAChB,CAAC,MAAM;QACNF,KAAK,CAACG,CAAC,GAAG,QAAQC,IAAI,CAAC,IAAI,EAAEN,IAAI,EAAEC,KAAK,CAAC;QACzC;MACD;IACD;IACA,IAAIC,KAAK,IAAIA,KAAK,CAACK,IAAI,EAAE;MACxBL,KAAK,CAACK,IAAI,CAAC,QAAQD,IAAI,CAAC,IAAI,EAAEN,IAAI,EAAEC,KAAK,CAAC,EAAE,QAAQK,IAAI,CAAC,IAAI,EAAEN,IAAI,EAAE,CAAC,CAAC,CAAC;MACxE;IACD;IACAA,IAAI,CAACG,CAAC,GAAGF,KAAK;IACdD,IAAI,CAACI,CAAC,GAAGF,KAAK;IACd,MAAMM,QAAQ,GAAGR,IAAI,CAACK,CAAC;IACvB,IAAIG,QAAQ,EAAE;MACbA,QAAQ,CAACR,IAAI,CAAC;IACf;EACD;AACD;;AAyJA;AACA;AACA;AAzNO,IAAM,QAAQ,aAAc,YAAW;EAC7C,iBAAiB,CAAC;EAClB,MAAMS,SAAS,CAACF,IAAI,GAAG,UAASG,WAAW,EAAEC,UAAU,EAAE;IACxD,IAAMC,MAAM,GAAG,WAAW;IAC1B,IAAMX,KAAK,GAAG,IAAI,CAACE,CAAC;IACpB,IAAIF,KAAK,EAAE;MACV,IAAMY,QAAQ,GAAGZ,KAAK,GAAG,CAAC,GAAGS,WAAW,GAAGC,UAAU;MACrD,IAAIE,QAAQ,EAAE;QACb,IAAI;UACH,QAAQD,MAAM,EAAE,CAAC,EAAEC,QAAQ,CAAC,IAAI,CAACT,CAAC,CAAC,CAAC;QACrC,CAAC,CAAC,OAAOU,CAAC,EAAE;UACX,QAAQF,MAAM,EAAE,CAAC,EAAEE,CAAC,CAAC;QACtB;QACA,OAAOF,MAAM;MACd,CAAC,MAAM;QACN,OAAO,IAAI;MACZ;IACD;IACA,IAAI,CAACP,CAAC,GAAG,UAASU,KAAK,EAAE;MACxB,IAAI;QACH,IAAMb,KAAK,GAAGa,KAAK,CAACX,CAAC;QACrB,IAAIW,KAAK,CAACZ,CAAC,GAAG,CAAC,EAAE;UAChB,QAAQS,MAAM,EAAE,CAAC,EAAEF,WAAW,GAAGA,WAAW,CAACR,KAAK,CAAC,GAAGA,KAAK,CAAC;QAC7D,CAAC,MAAM,IAAIS,UAAU,EAAE;UACtB,QAAQC,MAAM,EAAE,CAAC,EAAED,UAAU,CAACT,KAAK,CAAC,CAAC;QACtC,CAAC,MAAM;UACN,QAAQU,MAAM,EAAE,CAAC,EAAEV,KAAK,CAAC;QAC1B;MACD,CAAC,CAAC,OAAOY,CAAC,EAAE;QACX,QAAQF,MAAM,EAAE,CAAC,EAAEE,CAAC,CAAC;MACtB;IACD,CAAC;IACD,OAAOF,MAAM;EACd,CAAC;EACD;AACD,CAAC,EAAG;AA6BG,wBAAwBI,QAAQ,EAAE;EACxC,OAAOA,QAAQ,iBAAiB,IAAIA,QAAQ,CAACb,CAAC,GAAG,CAAC;AACnD;AA4LO,cAAcc,IAAI,EAAEC,MAAM,EAAEC,IAAI,EAAE;EACxC,IAAIC,KAAK;EACT,SAAS;IACR,IAAIC,cAAc,GAAGJ,IAAI,EAAE;IAC3B,IAAI,eAAeI,cAAc,CAAC,EAAE;MACnCA,cAAc,GAAGA,cAAc,CAACjB,CAAC;IAClC;IACA,IAAI,CAACiB,cAAc,EAAE;MACpB,OAAOT,MAAM;IACd;IACA,IAAIS,cAAc,CAACd,IAAI,EAAE;MACxBa,KAAK,GAAG,CAAC;MACT;IACD;IACA,IAAIR,MAAM,GAAGO,IAAI,EAAE;IACnB,IAAIP,MAAM,IAAIA,MAAM,CAACL,IAAI,EAAE;MAC1B,IAAI,eAAeK,MAAM,CAAC,EAAE;QAC3BA,MAAM,GAAGA,MAAM,CAACT,CAAC;MAClB,CAAC,MAAM;QACNiB,KAAK,GAAG,CAAC;QACT;MACD;IACD;IACA,IAAIF,MAAM,EAAE;MACX,IAAII,WAAW,GAAGJ,MAAM,EAAE;MAC1B,IAAII,WAAW,IAAIA,WAAW,CAACf,IAAI,IAAI,CAAC,eAAee,WAAW,CAAC,EAAE;QACpEF,KAAK,GAAG,CAAC;QACT;MACD;IACD;EACD;EACA,IAAIpB,IAAI,GAAG,WAAW;EACtB,IAAIuB,MAAM,GAAG,QAAQjB,IAAI,CAAC,IAAI,EAAEN,IAAI,EAAE,CAAC,CAAC;EACxC,CAACoB,KAAK,KAAK,CAAC,GAAGC,cAAc,CAACd,IAAI,CAACiB,gBAAgB,CAAC,GAAGJ,KAAK,KAAK,CAAC,GAAGR,MAAM,CAACL,IAAI,CAACkB,gBAAgB,CAAC,GAAGH,WAAW,CAACf,IAAI,CAACmB,kBAAkB,CAAC,EAAEnB,IAAI,CAAC,KAAK,CAAC,EAAEgB,MAAM,CAAC;EAC/J,OAAOvB,IAAI;EACX,SAASyB,gBAAgB,CAACvB,KAAK,EAAE;IAChCU,MAAM,GAAGV,KAAK;IACd,GAAG;MACF,IAAIgB,MAAM,EAAE;QACXI,WAAW,GAAGJ,MAAM,EAAE;QACtB,IAAII,WAAW,IAAIA,WAAW,CAACf,IAAI,IAAI,CAAC,eAAee,WAAW,CAAC,EAAE;UACpEA,WAAW,CAACf,IAAI,CAACmB,kBAAkB,CAAC,CAACnB,IAAI,CAAC,KAAK,CAAC,EAAEgB,MAAM,CAAC;UACzD;QACD;MACD;MACAF,cAAc,GAAGJ,IAAI,EAAE;MACvB,IAAI,CAACI,cAAc,IAAK,eAAeA,cAAc,CAAC,IAAI,CAACA,cAAc,CAACjB,CAAE,EAAE;QAC7E,QAAQJ,IAAI,EAAE,CAAC,EAAEY,MAAM,CAAC;QACxB;MACD;MACA,IAAIS,cAAc,CAACd,IAAI,EAAE;QACxBc,cAAc,CAACd,IAAI,CAACiB,gBAAgB,CAAC,CAACjB,IAAI,CAAC,KAAK,CAAC,EAAEgB,MAAM,CAAC;QAC1D;MACD;MACAX,MAAM,GAAGO,IAAI,EAAE;MACf,IAAI,eAAeP,MAAM,CAAC,EAAE;QAC3BA,MAAM,GAAGA,MAAM,CAACR,CAAC;MAClB;IACD,CAAC,QAAQ,CAACQ,MAAM,IAAI,CAACA,MAAM,CAACL,IAAI;IAChCK,MAAM,CAACL,IAAI,CAACkB,gBAAgB,CAAC,CAAClB,IAAI,CAAC,KAAK,CAAC,EAAEgB,MAAM,CAAC;EACnD;EACA,SAASC,gBAAgB,CAACH,cAAc,EAAE;IACzC,IAAIA,cAAc,EAAE;MACnBT,MAAM,GAAGO,IAAI,EAAE;MACf,IAAIP,MAAM,IAAIA,MAAM,CAACL,IAAI,EAAE;QAC1BK,MAAM,CAACL,IAAI,CAACkB,gBAAgB,CAAC,CAAClB,IAAI,CAAC,KAAK,CAAC,EAAEgB,MAAM,CAAC;MACnD,CAAC,MAAM;QACNE,gBAAgB,CAACb,MAAM,CAAC;MACzB;IACD,CAAC,MAAM;MACN,QAAQZ,IAAI,EAAE,CAAC,EAAEY,MAAM,CAAC;IACzB;EACD;EACA,SAASc,kBAAkB,GAAG;IAC7B,IAAIL,cAAc,GAAGJ,IAAI,EAAE,EAAE;MAC5B,IAAII,cAAc,CAACd,IAAI,EAAE;QACxBc,cAAc,CAACd,IAAI,CAACiB,gBAAgB,CAAC,CAACjB,IAAI,CAAC,KAAK,CAAC,EAAEgB,MAAM,CAAC;MAC3D,CAAC,MAAM;QACNC,gBAAgB,CAACH,cAAc,CAAC;MACjC;IACD,CAAC,MAAM;MACN,QAAQrB,IAAI,EAAE,CAAC,EAAEY,MAAM,CAAC;IACzB;EACD;AACD;AA+NO,gBAAgBO,IAAI,EAAEQ,OAAO,EAAE;EACrC,IAAI;IACH,IAAIf,MAAM,GAAGO,IAAI,EAAE;EACpB,CAAC,CAAC,OAAML,CAAC,EAAE;IACV,OAAOa,OAAO,CAACb,CAAC,CAAC;EAClB;EACA,IAAIF,MAAM,IAAIA,MAAM,CAACL,IAAI,EAAE;IAC1B,OAAOK,MAAM,CAACL,IAAI,CAAC,KAAK,CAAC,EAAEoB,OAAO,CAAC;EACpC;EACA,OAAOf,MAAM;AACd;AA7dA,WAAsBgB,WAAW,YAAXA,WAAW;EAAA,IASC;IAAA;MAAA,uBAsGxBC,cAAc;QAEpB,IAAMC,QAA+B,GAAG;UACpCC,GAAG,EAAHA,GAAG;UACHC,QAAQ,EAARA,QAAQ;UACRC,MAAM,EAANA;QACJ,CAAC;QACD,OAAOH,QAAQ;MAAC;IAAA;IAAA,YA5GO,IAAI;IAAA,qBAPvBI,IAAI;MAAJA,IAAI,0BAAG,KAAK;MAAA,iBACZC,IAAI;MAAJA,IAAI,0BAAG,IAAI;MAAA,iBACXC,IAAI;MAAJA,IAAI,0BAAG,KAAK;MAAA,wBACZC,WAAW;MAAXA,WAAW,iCAAG,IAAI;MAAA,6BAClBC,qBAAqB;MAArBA,qBAAqB,sCAAG,CAAC,CAAC;IAG9B,IAAMC,EAAc,QAAO;IAC3B,IAAMC,eAAe,GAAGH,WAAW,GAAGH,IAAI,GAAG,GAAG;IAChD,IAAI,CAACO,aAAa,CAACC,GAAG,CAACH,EAAE,CAAC,EAAE;MACxBE,aAAa,CAACE,GAAG,CAACJ,EAAE,EAAE,EAAE,CAAC;IAC7B;IAEA,IAAMK,OAAuB,GAAGL,EAAE,CAACK,OAAc;IACjD,IAAI,CAACA,OAAO,CAACC,OAAO,EAAE;MAClB,MAAM,IAAIC,KAAK,CAAC,yDAAyD,CAAC;IAC9E;IAEA,IAAMC,UAAU,GAAGnD,aAAa,CAACgD,OAAO,CAACC,OAAO,CAAC;IACjD,IAAMG,cAAc,GAAGC,MAAM,CAACC,MAAM,CAChC;MAAEC,MAAM,EAAEC,SAAS,CAACb,EAAE,CAAC;MAAEc,GAAG,EAAE;IAAM,CAAC,EACrCN,UAAU,CACb;IAED,IAAMO,MAAM,GAAG9D,OAAO,CAAC+D,QAAQ,CAACP,cAAc,CAAC;IAC/C,IAAMjB,GAAG,GAAG1C,OAAO,EAAE;IACrBmE,SAAS,CAACb,GAAG,CAACJ,EAAE,EAAER,GAAG,CAAC;IAEtBkB,MAAM,CAACQ,IAAI,CAAClB,EAAE,CAACmB,WAAW,CAAC,CAACC,OAAO,CAAC,UAAAC,OAAO,EAAI;MAC3C;MACAC,oBAAoB,CAACtB,EAAE,EAAEC,eAAe,EAAET,GAAG,EAAE6B,OAAO,CAAC;IAC3D,CAAC,CAAC;;IAEF;IACAE,eAAe,CAACC,GAAG,CAACxB,EAAE,CAAC;IAEvB,IAAIH,IAAI,EAAE;MACNL,GAAG,CAACiC,GAAG,CAAC1E,MAAM,CAAC;QACX,QAAQ,EAAE,gBAAU2E,OAAM,EAAEpD,QAAQ,EAAE;UAClC,IAAMqD,YAAiB,GAAGD,OAAM,IAAI,GAAG;UACvCpD,QAAQ,CAAC,IAAI,EAAEqD,YAAY,CAAC;QAChC,CAAC;QACD,aAAa,EAAE,IAAI;QACnB,SAAS,EAAE;MACf,CAAC,CAAC,CAAC;IACP;;IAEA;AACJ;AACA;AACA;AACA;IACI,IAAMC,sBAAmD,GAAGrE,SAAS,CAACwC,qBAAqB,CAAC;IAC5F,IAAI,OAAO6B,sBAAsB,CAACC,cAAc,KAAK,WAAW,EAAE;MAC9DD,sBAAsB,CAACC,cAAc,GAAG,IAAI;IAChD;IACA,IAAI,OAAOD,sBAAsB,CAACE,OAAO,KAAK,WAAW,EAAE;MACvDF,sBAAsB,CAACE,OAAO,GAAGjF,QAAQ,CAACkF,IAAI,CAC1CnF,EAAE,CAACoF,MAAM,EAAE,EACX,qBAAqB,CACxB;IACL;IAEA,IAAMvC,QAAQ,GAAGwC,cAAc,CAAClB,MAAM,EAAEa,sBAAsB,CAAC;IAC/DpC,GAAG,CAACiC,GAAG,CAACxB,eAAe,EAAER,QAAQ,CAAC;IAElC,IAAIC,MAAM,GAAG,IAAI;IACjB,IAAIJ,cAA6B,GAAG9B,oBAAoB;IAAC;MAAA,IACrDsC,WAAW;QACX;AACR;AACA;AACA;QACQR,cAAc,GAAG,IAAI4C,OAAO,CAAC,UAACC,GAAG,EAAEC,GAAG,EAAK;UACvC,IAAIC,QAAQ,GAAG,KAAK;UACpB3C,MAAM,GAAGF,GAAG,CAAC8C,MAAM,CAAC1C,IAAI,EAAE,YAAM;YAC5B,IAAI,CAACyC,QAAQ,EAAE;cACXA,QAAQ,GAAG,IAAI;cACfF,GAAG,EAAE;YACT;UACJ,CAAC,CAAC;UACFzC,MAAM,CAAC6C,EAAE,CAAC,OAAO,EAAE,UAACC,GAAG,EAAK;YACxB,IAAI,CAACH,QAAQ,EAAE;cACXA,QAAQ,GAAG,IAAI;cACfD,GAAG,CAACI,GAAG,CAAC;YACZ;UACJ,CAAC,CAAC;QACN,CAAC,CAAC;QACFtC,aAAa,CAACuC,GAAG,CAACzC,EAAE,CAAC,CAAC0C,IAAI,CAAChD,MAAM,CAAC;;QAElC;AACR;AACA;AACA;AACA;AACA;QALQ,uBAMMwC,OAAO,CAACS,GAAG,CACbjC,MAAM,CAACkC,MAAM,CAAC5C,EAAE,CAACmB,WAAW,CAAC,CAAC0B,GAAG,WAAQC,UAAU;UAAA,IAAK;YACpD,IAAMC,GAAG,GAAG,iBAAiB,GAAGnD,IAAI,GAAGK,eAAe,GAAG,GAAG,GAAG6C,UAAU,CAACE,IAAI;YAAC,gCAC3E;cACA,IAAMC,MAAM,GAAG,IAAIhG,OAAO,CAAC8F,GAAG,CAAC;cAC/BE,MAAM,CAACC,GAAG,GAAG,aAAa,GAAGH,GAAG;cAAC,uBAC3BE,MAAM,CAACE,IAAI,EAAE;gBAAA,uBACbF,MAAM,CAACG,KAAK,EAAE;cAAA;YACxB,CAAC;YAAA;UACL,CAAC;YAAA;UAAA;QAAA,EAAC,CACL;MAAA;IAAA;IAAA;EAUT,CAAC;IAAA;EAAA;AAAA;AAxLD,IAAInB,cAAmB;AACvB,IAAI;EACAA,cAAc,GAAGoB,OAAO,CAAC,iBAAiB,CAAC;AAC/C,CAAC,CAAC,OAAOC,KAAK,EAAE;EACZC,OAAO,CAACD,KAAK,CACT,yFAAyF,GACzF,yDAAyD,CAC5D;AACL;;AAEA;AACA;AACA,IAAME,aAAa,GAAGH,OAAO,CAAC,iBAAiB,CAAC;AAChDG,aAAa,CAACvG,OAAO,CAAC;AAEtB,IAAMgE,SAAuC,GAAG,IAAIwC,OAAO,EAAE;AAC7D,IAAMvD,aAAa,GAAG,IAAIuD,OAAO,EAAE;AACnC,IAAMlC,eAAe,GAAG,IAAImC,OAAO,EAAE;AAGrC,IAAMC,eAAe,GAAG,SAAlBA,eAAe,CAAa3D,EAAc,EAAE;EAC9C,IAAM4D,KAAK,GAAG5D,EAAE,CAACgD,IAAI,CAACY,KAAK,CAAC,GAAG,CAAC,CAACC,MAAM,CAAC,UAACC,GAAW;IAAA,OAAKA,GAAG,KAAK,EAAE;EAAA,EAAC;EACpE,OAAOF,KAAK,CAACG,GAAG,EAAE;AACtB,CAAC;AAED,IAAMlD,SAAS,GAAG,SAAZA,SAAS,CAAab,EAAc,EAAE;EACxC,IAAM4D,KAAK,GAAG5D,EAAE,CAACgD,IAAI,CAACY,KAAK,CAAC,GAAG,CAAC,CAACC,MAAM,CAAC,UAACC,GAAW;IAAA,OAAKA,GAAG,KAAK,EAAE;EAAA,EAAC;EACpEF,KAAK,CAACG,GAAG,EAAE,CAAC,CAAC;EACb,IAAIH,KAAK,CAACI,MAAM,KAAK,CAAC,EAAE;IACpB,OAAO,EAAE;EACb;EACA,IAAIC,GAAG,GAAGL,KAAK,CAAC7B,IAAI,CAAC,GAAG,CAAC,GAAG,GAAG;EAC/B,IAAI/B,EAAE,CAACgD,IAAI,CAACkB,UAAU,CAAC,GAAG,CAAC,EAAE;IACzBD,GAAG,GAAG,GAAG,GAAGA,GAAG;EACnB;EACA,OAAOA,GAAG;AACd,CAAC;;AAED;AACA;AACA;AACA,SAAS3C,oBAAoB,CACzBtB,EAAc,EACdL,IAAY,EACZH,GAAY,EACZ6B,OAAe,EACjB;EACE,IAAM8C,aAAa,GAAGxE,IAAI,CAACyE,QAAQ,CAAC,GAAG,CAAC,GAAGzE,IAAI,GAAGA,IAAI,GAAG,GAAG;EAC5D,IAAM0E,cAAc,GAAGF,aAAa,GAAG9C,OAAO;EAC9C7B,GAAG,CAACiC,GAAG,CAAC4C,cAAc,YAAkBC,GAAQ,EAAEnC,GAAQ,EAAEoC,IAAS;IAAA,IAAE;MAAA;QAYnEA,IAAI,EAAE;MAAC;MAAA;QAAA,IAXHD,GAAG,CAACE,OAAO,CAACJ,QAAQ,CAACC,cAAc,CAAC;UAAA;YAOpC,IAAMI,EAAE,GAAGd,eAAe,CAAC3D,EAAE,CAAC,GAAG,QAAQ,GAAGA,EAAE,CAACqB,OAAO,CAAC,CAACqD,MAAM,CAACC,OAAO,GAAG,GAAG,GAAGtD,OAAO;YACtF,IAAMuD,MAAM,GAAGN,GAAG,CAACO,WAAW,CAACC,OAAO,CAACT,cAAc,EAAEF,aAAa,GAAGM,EAAE,CAAC;YAC1EH,GAAG,CAACO,WAAW,GAAGD,MAAM;UAAC;UAAA;YAAA,OAPlB,CAAC5E,EAAE,CAACqB,OAAO,CAAC;UAAA,uBAAE;YACjB;YACA;YAAA,uBACM,IAAIa,OAAO,CAAC,UAAA6C,IAAI;cAAA,OAAIC,UAAU,CAACD,IAAI,EAAE,EAAE,CAAC;YAAA,EAAC;UACnD,CAAC;UAAA;QAAA;MAAA;MAAA;IAMT,CAAC;MAAA;IAAA;EAAA,EAAC;AACN;AA8HA,SAASE,uBAAuB,CAACC,IAAS,EAAE;EACxC,IAAI3D,eAAe,CAACpB,GAAG,CAAC+E,IAAI,CAACC,QAAQ,CAAC,EAAE;IACpC,IAAM3C,GAAG,GAAGtF,UAAU,CAClB,IAAI,EAAE;MACF4F,UAAU,EAAEoC,IAAI,CAAClC,IAAI;MACrBmC,QAAQ,EAAED,IAAI,CAACC,QAAQ,CAACnC;IAC5B,CAAC,CACJ;IACD,MAAMR,GAAG;EACb;AACJ;;AAEA;AACA;AACA;AACA,OAAO,SAAS4C,SAAS,CAACpF,EAAc,EAAE;EACtC,IAAIE,aAAa,CAACC,GAAG,CAACH,EAAE,CAAC,EAAE;IACvBE,aAAa,CAACuC,GAAG,CAACzC,EAAE,CAAC,CAACoB,OAAO,CAAC,UAAC1B,MAAW;MAAA,OAAKA,MAAM,CAAC0D,KAAK,EAAE;IAAA,EAAC;EAClE;AACJ;AAEA,OAAO,IAAMiC,uBAAiC,GAAG;EAC7CrC,IAAI,EAAE,gBAAgB;EACtBsC,IAAI,EAAE,IAAI;EACVC,IAAI,kBAAG;IACHvI,cAAc,CAACI,gBAAgB,CAAC;IAChCE,WAAW,CAACH,4BAA4B,CAAC;EAC7C,CAAC;EACDqI,UAAU,EAAE;IACRC,UAAU,EAAE,oBAACC,KAAU,EAAK;MACxBA,KAAK,CAACC,aAAa,GAAGtG,WAAW;IACrC;EACJ,CAAC;EACDuG,YAAY,EAAE,CAAC,CAAC;EAChBC,KAAK,EAAE;IACHC,oBAAoB,EAAE;MAClBC,KAAK,EAAEX;IACX,CAAC;IACDY,qBAAqB,EAAE;MACnBD,KAAK,EAAEd;IACX;EACJ;AACJ,CAAC"}