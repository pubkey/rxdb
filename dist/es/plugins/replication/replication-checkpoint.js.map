{"version":3,"sources":["../../../../src/plugins/replication/replication-checkpoint.ts"],"names":["getSingleDocument","writeSingle","createRevision","flatClone","getDefaultRevision","getDefaultRxDocumentMeta","newRxError","wasLastWriteFromPullReplication","getPrimaryKeyOfInternalDocument","INTERNAL_CONTEXT_REPLICATION_PRIMITIVES","pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","setLastPullDocument","collection","replicationIdentifierHash","lastPulledDoc","pullCheckpointId","pullLastDocumentKey","database","internalStore","lastPullCheckpointDoc","insertData","id","key","context","data","_meta","_rev","_deleted","_attachments","document","newDoc","previous","getChangesSinceLastPushSequence","isStopped","batchSize","getLastPushSequence","lastPushSequence","changedDocIds","changedDocs","lastSequence","hasChangesSinceLastSequence","retry","Map","Set","storageInstance","getChangedDocuments","sinceSequence","limit","direction","changesResults","changedDocuments","length","docIds","map","row","findDocumentsById","docs","forEach","has","changedDoc","args","add","set","doc","sequence","size","setLastPushSequence","docId","pushSequenceDocumentKey","docData","getLastPullDocument","lastPullCheckpoint"],"mappings":"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","sourcesContent":["import type {\n    RxCollection,\n    RxDocumentData,\n    InternalStoreReplicationPullDocType,\n    InternalStoreReplicationPushDocType,\n    DeepReadonlyObject\n} from '../../types';\nimport {\n    getSingleDocument,\n    writeSingle\n} from '../../rx-storage-helper';\nimport {\n    createRevision,\n    flatClone,\n    getDefaultRevision,\n    getDefaultRxDocumentMeta\n} from '../../util';\nimport { newRxError } from '../../rx-error';\nimport { wasLastWriteFromPullReplication } from './revision-flag';\nimport {\n    getPrimaryKeyOfInternalDocument,\n    INTERNAL_CONTEXT_REPLICATION_PRIMITIVES\n} from '../../rx-database-internal-store';\n\n//\n// things for the push-checkpoint\n//\n\nconst pushSequenceDocumentKey = (replicationIdentifierHash: string) => 'replication-checkpoint-push-' + replicationIdentifierHash;\nconst pullLastDocumentKey = (replicationIdentifierHash: string) => 'replication-checkpoint-pull-' + replicationIdentifierHash;\n\n/**\n * Get the last push checkpoint\n */\nexport function getLastPushSequence(\n    collection: RxCollection,\n    replicationIdentifierHash: string\n): Promise<number> {\n    return getSingleDocument<InternalStoreReplicationPushDocType>(\n        collection.database.internalStore,\n        getPrimaryKeyOfInternalDocument(\n            pushSequenceDocumentKey(replicationIdentifierHash),\n            INTERNAL_CONTEXT_REPLICATION_PRIMITIVES\n        )\n    ).then(doc => {\n        if (!doc) {\n            return 0;\n        } else {\n            return doc.data.lastPushSequence;\n        }\n    });\n}\n\nexport async function setLastPushSequence(\n    collection: RxCollection,\n    replicationIdentifierHash: string,\n    sequence: number\n): Promise<RxDocumentData<InternalStoreReplicationPushDocType>> {\n    const docId = getPrimaryKeyOfInternalDocument(\n        pushSequenceDocumentKey(replicationIdentifierHash),\n        INTERNAL_CONTEXT_REPLICATION_PRIMITIVES\n    );\n\n    const doc = await getSingleDocument<InternalStoreReplicationPushDocType>(\n        collection.database.internalStore,\n        docId\n    );\n    if (!doc) {\n        const insertData = {\n            id: docId,\n            key: pushSequenceDocumentKey(replicationIdentifierHash),\n            context: INTERNAL_CONTEXT_REPLICATION_PRIMITIVES,\n            data: {\n                lastPushSequence: sequence\n            },\n            _deleted: false,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision(),\n            _attachments: {}\n        };\n        insertData._rev = createRevision(insertData);\n        const res = await writeSingle(\n            collection.database.internalStore,\n            {\n                document: insertData\n            }\n        );\n        return res;\n    } else {\n        const newDoc = flatClone(doc);\n        newDoc.data = {\n            lastPushSequence: sequence\n        };\n        const docData = {\n            id: docId,\n            key: pushSequenceDocumentKey(replicationIdentifierHash),\n            context: INTERNAL_CONTEXT_REPLICATION_PRIMITIVES,\n            data: {\n                lastPushSequence: sequence\n            },\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision(),\n            _deleted: false,\n            _attachments: {}\n        };\n        docData._rev = createRevision(docData, doc);\n        const res = await writeSingle<InternalStoreReplicationPushDocType>(\n            collection.database.internalStore,\n            {\n                previous: doc,\n                document: docData\n            }\n        );\n        return res;\n    }\n}\n\n\n\nexport async function getChangesSinceLastPushSequence<RxDocType>(\n    collection: RxCollection<RxDocType, any>,\n    replicationIdentifierHash: string,\n    /**\n     * A function that returns true\n     * when the underlaying RxReplication is stopped.\n     * So that we do not run requests against a close RxStorageInstance.\n     */\n    isStopped: () => boolean,\n    batchSize = 10\n): Promise<{\n    // for better performance we also store the ids of the changed docs.\n    changedDocIds: Set<string>,\n    changedDocs: Map<string, {\n        id: string;\n        doc: RxDocumentData<RxDocType>;\n        sequence: number;\n    }>;\n    lastSequence: number;\n    hasChangesSinceLastSequence: boolean;\n}> {\n    let lastPushSequence = await getLastPushSequence(\n        collection,\n        replicationIdentifierHash\n    );\n\n    let retry = true;\n    let lastSequence: number = lastPushSequence;\n    const changedDocs: Map<string, {\n        id: string;\n        doc: RxDocumentData<RxDocType>;\n        sequence: number;\n    }> = new Map();\n    const changedDocIds: Set<string> = new Set();\n\n    /**\n     * it can happen that all docs in the batch\n     * do not have to be replicated.\n     * Then we have to continue grapping the feed\n     * until we reach the end of it\n     */\n    while (retry && !isStopped()) {\n        const changesResults = await collection.storageInstance.getChangedDocuments({\n            sinceSequence: lastPushSequence,\n            limit: batchSize,\n            direction: 'after'\n        });\n\n        lastSequence = changesResults.lastSequence;\n\n        // optimisation shortcut, do not proceed if there are no changed documents\n        if (changesResults.changedDocuments.length === 0) {\n            retry = false;\n            continue;\n        }\n\n        const docIds = changesResults.changedDocuments.map(row => row.id);\n\n        if (isStopped()) {\n            break;\n        }\n\n\n        const docs = await collection.storageInstance.findDocumentsById(\n            docIds,\n            true\n        );\n\n        changesResults.changedDocuments.forEach((row) => {\n            const id = row.id;\n            if (changedDocs.has(id)) {\n                return;\n            }\n            const changedDoc = docs[id];\n            if (!changedDoc) {\n                throw newRxError('SNH', { args: { docs, docIds } });\n            }\n\n            /**\n             * filter out changes with revisions resulting from the pull-stream\n             * so that they will not be upstreamed again\n             */\n            if (\n                wasLastWriteFromPullReplication(\n                    replicationIdentifierHash,\n                    changedDoc\n                )\n            ) {\n                return false;\n            }\n            changedDocIds.add(id);\n            changedDocs.set(id, {\n                id,\n                doc: changedDoc,\n                sequence: row.sequence\n            });\n        });\n\n        if (changedDocs.size < batchSize && changesResults.changedDocuments.length === batchSize) {\n            // no pushable docs found but also not reached the end -> re-run\n            lastPushSequence = lastSequence;\n            retry = true;\n        } else {\n            retry = false;\n        }\n    }\n\n    return {\n        changedDocIds,\n        changedDocs,\n        lastSequence,\n        hasChangesSinceLastSequence: lastPushSequence !== lastSequence,\n    };\n}\n\n\n\n//\n// things for pull-checkpoint\n//\n\nexport function getLastPullDocument<RxDocType>(\n    collection: RxCollection<RxDocType>,\n    replicationIdentifierHash: string,\n): Promise<RxDocumentData<RxDocType> | null> {\n\n    return getSingleDocument<InternalStoreReplicationPullDocType<RxDocType>>(\n        collection.database.internalStore,\n        getPrimaryKeyOfInternalDocument(\n            pullLastDocumentKey(replicationIdentifierHash),\n            INTERNAL_CONTEXT_REPLICATION_PRIMITIVES\n        )\n    ).then(lastPullCheckpoint => {\n        if (!lastPullCheckpoint) {\n            return null;\n        } else {\n            return lastPullCheckpoint.data.lastPulledDoc;\n        }\n    });\n}\n\nexport async function setLastPullDocument<RxDocType>(\n    collection: RxCollection,\n    replicationIdentifierHash: string,\n    lastPulledDoc: RxDocumentData<RxDocType> | DeepReadonlyObject<RxDocumentData<RxDocType>>\n): Promise<RxDocumentData<InternalStoreReplicationPullDocType<RxDocType>>> {\n    const pullCheckpointId = getPrimaryKeyOfInternalDocument(\n        pullLastDocumentKey(replicationIdentifierHash),\n        INTERNAL_CONTEXT_REPLICATION_PRIMITIVES\n    );\n\n    const lastPullCheckpointDoc = await getSingleDocument<InternalStoreReplicationPullDocType<RxDocType>>(\n        collection.database.internalStore,\n        pullCheckpointId\n    );\n\n    if (!lastPullCheckpointDoc) {\n        const insertData = {\n            id: pullCheckpointId,\n            key: pullLastDocumentKey(replicationIdentifierHash),\n            context: INTERNAL_CONTEXT_REPLICATION_PRIMITIVES,\n            data: {\n                lastPulledDoc: lastPulledDoc as any\n            },\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision(),\n            _deleted: false,\n            _attachments: {}\n        };\n        insertData._rev = createRevision(insertData);\n        return writeSingle<InternalStoreReplicationPullDocType<RxDocType>>(\n            collection.database.internalStore,\n            {\n                document: insertData\n            }\n        );\n    } else {\n        const newDoc = flatClone(lastPullCheckpointDoc);\n        newDoc.data = { lastPulledDoc: lastPulledDoc as any };\n        newDoc._rev = createRevision(newDoc, lastPullCheckpointDoc);\n        return writeSingle<InternalStoreReplicationPullDocType<RxDocType>>(\n            collection.database.internalStore,\n            {\n                previous: lastPullCheckpointDoc,\n                document: newDoc\n            }\n        );\n    }\n}\n"],"file":"replication-checkpoint.js"}