{"version":3,"file":"index.js","names":["BehaviorSubject","combineLatest","mergeMap","Subject","RxDBLeaderElectionPlugin","ensureNotFalsy","errorToPlainJson","flatClone","getFromMapOrCreate","PROMISE_RESOLVE_FALSE","PROMISE_RESOLVE_TRUE","toArray","awaitRxStorageReplicationFirstInSync","awaitRxStorageReplicationInSync","cancelRxStorageReplication","getRxReplicationMetaInstanceSchema","replicateRxStorageInstance","newRxError","awaitRetry","DEFAULT_MODIFIER","swapDefaultDeletedTodeletedField","handlePulledDocuments","addConnectedStorageToCollection","addRxPlugin","hasEncryption","overwritable","runAsyncPluginHooks","REPLICATION_STATE_BY_COLLECTION","WeakMap","RxReplicationState","replicationIdentifierHash","collection","deletedField","pull","push","live","retryTime","autoStart","subs","subjects","received","send","error","canceled","active","received$","asObservable","send$","error$","canceled$","active$","callOnStart","undefined","remoteEvents$","replicationStates","onDestroy","cancel","Object","keys","forEach","key","defineProperty","get","startPromise","Promise","res","_proto","prototype","start","isStopped","pullModifier","modifier","pushModifier","database","metaInstanceCollectionName","name","metaInstanceSchema","schema","jsonSchema","metaInstance","all","storage","createStorageInstance","databaseName","collectionName","databaseInstanceToken","token","multiInstance","options","password","devMode","isDevMode","internalReplicationState","pushBatchSize","batchSize","pullBatchSize","initialCheckpoint","upstream","downstream","forkInstance","storageInstance","hashFunction","identifier","conflictHandler","replicationHandler","masterChangeStream$","pipe","ev","useEv","documents","map","d","masterChangesSince","checkpoint","done","result","handler","err","emitError","errors","er","direction","next","useResult","masterWrite","rows","useRows","row","newDocumentState","assumedMasterState","length","Array","isArray","pushRows","args","rxdb","conflicts","events","subscribe","processed","down","document","up","writeToMasterRow","isActive","stream$","getValue","awaitInitialReplication","awaitInSync","requestIdlePromise","reSync","emitEvent","promises","checkpointQueue","then","close","sub","unsubscribe","complete","replicateRxCollection","replicationIdentifier","waitForLeadership","join","replicationState","startReplicationOnLeaderShip","mustWaitForLeadership","waitTillRun"],"sources":["../../../../src/plugins/replication/index.ts"],"sourcesContent":["/**\n * This plugin contains the primitives to create\n * a RxDB client-server replication.\n * It is used in the other replication plugins\n * but also can be used as standalone with a custom replication handler.\n */\n\nimport {\n    BehaviorSubject,\n    combineLatest,\n    mergeMap,\n    Observable,\n    Subject,\n    Subscription\n} from 'rxjs';\nimport type {\n    ReplicationOptions,\n    ReplicationPullHandlerResult,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxCollection,\n    RxDocumentData,\n    RxError,\n    RxReplicationPullStreamItem,\n    RxReplicationWriteToMasterRow,\n    RxStorageInstance,\n    RxStorageInstanceReplicationState,\n    RxStorageReplicationMeta,\n    RxTypeError,\n    WithDeleted\n} from '../../types';\nimport { RxDBLeaderElectionPlugin } from '../leader-election';\nimport {\n    ensureNotFalsy,\n    errorToPlainJson,\n    flatClone,\n    getFromMapOrCreate,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_TRUE,\n    toArray\n} from '../../plugins/utils';\nimport {\n    awaitRxStorageReplicationFirstInSync,\n    awaitRxStorageReplicationInSync,\n    cancelRxStorageReplication,\n    getRxReplicationMetaInstanceSchema,\n    replicateRxStorageInstance\n} from '../../replication-protocol';\nimport { newRxError } from '../../rx-error';\nimport {\n    awaitRetry,\n    DEFAULT_MODIFIER,\n    swapDefaultDeletedTodeletedField,\n    handlePulledDocuments\n} from './replication-helper';\nimport {\n    addConnectedStorageToCollection\n} from '../../rx-database-internal-store';\nimport { addRxPlugin } from '../../plugin';\nimport { hasEncryption } from '../../rx-storage-helper';\nimport { overwritable } from '../../overwritable';\nimport {\n    runAsyncPluginHooks\n} from '../../hooks';\n\n\nexport const REPLICATION_STATE_BY_COLLECTION: WeakMap<RxCollection, RxReplicationState<any, any>[]> = new WeakMap();\n\nexport class RxReplicationState<RxDocType, CheckpointType> {\n    public readonly subs: Subscription[] = [];\n    public readonly subjects = {\n        received: new Subject<RxDocumentData<RxDocType>>(), // all documents that are received from the endpoint\n        send: new Subject<WithDeleted<RxDocType>>(), // all documents that are send to the endpoint\n        error: new Subject<RxError | RxTypeError>(), // all errors that are received from the endpoint, emits new Error() objects\n        canceled: new BehaviorSubject<boolean>(false), // true when the replication was canceled\n        active: new BehaviorSubject<boolean>(false) // true when something is running, false when not\n    };\n\n    readonly received$: Observable<RxDocumentData<RxDocType>> = this.subjects.received.asObservable();\n    readonly send$: Observable<WithDeleted<RxDocType>> = this.subjects.send.asObservable();\n    readonly error$: Observable<RxError | RxTypeError> = this.subjects.error.asObservable();\n    readonly canceled$: Observable<any> = this.subjects.canceled.asObservable();\n    readonly active$: Observable<boolean> = this.subjects.active.asObservable();\n\n    private startPromise: Promise<void>;\n    constructor(\n        /**\n         * hash of the identifier, used to flag revisions\n         * and to identify which documents state came from the remote.\n         */\n        public readonly replicationIdentifierHash: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly deletedField: string,\n        public readonly pull?: ReplicationPullOptions<RxDocType, CheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live?: boolean,\n        public retryTime?: number,\n        public autoStart?: boolean,\n    ) {\n        const replicationStates = getFromMapOrCreate(\n            REPLICATION_STATE_BY_COLLECTION,\n            collection,\n            () => []\n        );\n        replicationStates.push(this);\n\n        // stop the replication when the collection gets destroyed\n        this.collection.onDestroy.push(() => this.cancel());\n\n        // create getters for the observables\n        Object.keys(this.subjects).forEach(key => {\n            Object.defineProperty(this, key + '$', {\n                get: function () {\n                    return this.subjects[key].asObservable();\n                }\n            });\n        });\n        const startPromise = new Promise<void>(res => {\n            this.callOnStart = res;\n        });\n        this.startPromise = startPromise;\n    }\n\n    private callOnStart: () => void = undefined as any;\n\n    public internalReplicationState?: RxStorageInstanceReplicationState<RxDocType>;\n    public metaInstance?: RxStorageInstance<RxStorageReplicationMeta, any, {}, any>;\n    public remoteEvents$: Subject<RxReplicationPullStreamItem<RxDocType, CheckpointType>> = new Subject();\n\n    public async start(): Promise<void> {\n        if (this.isStopped()) {\n            return;\n        }\n\n        // fill in defaults for pull & push\n        const pullModifier = this.pull && this.pull.modifier ? this.pull.modifier : DEFAULT_MODIFIER;\n        const pushModifier = this.push && this.push.modifier ? this.push.modifier : DEFAULT_MODIFIER;\n\n        const database = this.collection.database;\n        const metaInstanceCollectionName = this.collection.name + '-rx-replication-' + this.replicationIdentifierHash;\n        const metaInstanceSchema = getRxReplicationMetaInstanceSchema(\n            this.collection.schema.jsonSchema,\n            hasEncryption(this.collection.schema.jsonSchema)\n        );\n        const [metaInstance] = await Promise.all([\n            this.collection.database.storage.createStorageInstance({\n                databaseName: database.name,\n                collectionName: metaInstanceCollectionName,\n                databaseInstanceToken: database.token,\n                multiInstance: database.multiInstance, // TODO is this always false?\n                options: {},\n                schema: metaInstanceSchema,\n                password: database.password,\n                devMode: overwritable.isDevMode()\n            }),\n            addConnectedStorageToCollection(\n                this.collection,\n                metaInstanceCollectionName,\n                metaInstanceSchema\n            )\n        ]);\n        this.metaInstance = metaInstance;\n\n        this.internalReplicationState = replicateRxStorageInstance({\n            pushBatchSize: this.push && this.push.batchSize ? this.push.batchSize : 100,\n            pullBatchSize: this.pull && this.pull.batchSize ? this.pull.batchSize : 100,\n            initialCheckpoint: {\n                upstream: this.push ? this.push.initialCheckpoint : undefined,\n                downstream: this.pull ? this.pull.initialCheckpoint : undefined\n            },\n            forkInstance: this.collection.storageInstance,\n            metaInstance: this.metaInstance,\n            hashFunction: database.hashFunction,\n            identifier: 'rxdbreplication' + this.replicationIdentifierHash,\n            conflictHandler: this.collection.conflictHandler,\n            replicationHandler: {\n                masterChangeStream$: this.remoteEvents$.asObservable().pipe(\n                    mergeMap(async (ev) => {\n                        if (ev === 'RESYNC') {\n                            return ev;\n                        }\n                        const useEv = flatClone(ev);\n                        useEv.documents = handlePulledDocuments(this.collection, this.deletedField, useEv.documents);\n                        useEv.documents = await Promise.all(\n                            useEv.documents.map(d => pullModifier(d))\n                        );\n                        return useEv;\n                    })\n                ),\n                masterChangesSince: async (\n                    checkpoint: CheckpointType,\n                    batchSize: number\n                ) => {\n                    if (!this.pull) {\n                        return {\n                            checkpoint: null,\n                            documents: []\n                        };\n                    }\n                    /**\n                     * Retries must be done here in the replication primitives plugin,\n                     * because the replication protocol itself has no\n                     * error handling.\n                     */\n                    let done = false;\n                    let result: ReplicationPullHandlerResult<RxDocType, CheckpointType> = {} as any;\n                    while (!done && !this.isStopped()) {\n                        try {\n                            result = await this.pull.handler(\n                                checkpoint,\n                                batchSize\n                            );\n                            done = true;\n                        } catch (err: any | Error | Error[]) {\n                            const emitError = newRxError('RC_PULL', {\n                                checkpoint,\n                                errors: toArray(err).map(er => errorToPlainJson(er)),\n                                direction: 'pull'\n                            });\n                            this.subjects.error.next(emitError);\n                            await awaitRetry(this.collection, ensureNotFalsy(this.retryTime));\n                        }\n                    }\n\n                    if (this.isStopped()) {\n                        return {\n                            checkpoint: null,\n                            documents: []\n                        };\n                    }\n\n                    const useResult = flatClone(result);\n                    useResult.documents = handlePulledDocuments(this.collection, this.deletedField, useResult.documents);\n                    useResult.documents = await Promise.all(\n                        useResult.documents.map(d => pullModifier(d))\n                    );\n                    return useResult;\n                },\n                masterWrite: async (\n                    rows: RxReplicationWriteToMasterRow<RxDocType>[]\n                ) => {\n                    if (!this.push) {\n                        return [];\n                    }\n                    let done = false;\n\n                    await runAsyncPluginHooks('preReplicationMasterWrite', {\n                        rows,\n                        collection: this.collection\n                    });\n\n                    const useRows = await Promise.all(\n                        rows.map(async (row) => {\n                            row.newDocumentState = await pushModifier(row.newDocumentState);\n                            if (row.assumedMasterState) {\n                                row.assumedMasterState = await pushModifier(row.assumedMasterState);\n                            }\n                            if (this.deletedField !== '_deleted') {\n                                row.newDocumentState = swapDefaultDeletedTodeletedField(this.deletedField, row.newDocumentState) as any;\n                                if (row.assumedMasterState) {\n                                    row.assumedMasterState = swapDefaultDeletedTodeletedField(this.deletedField, row.assumedMasterState) as any;\n                                }\n                            }\n                            return row;\n                        })\n                    );\n\n                    let result: WithDeleted<RxDocType>[] = null as any;\n\n                    // In case all the rows have been filtered and nothing has to be sent\n                    if (useRows.length === 0) {\n                        done = true;\n                        result = [];\n                    }\n\n                    while (!done && !this.isStopped()) {\n                        try {\n                            result = await this.push.handler(useRows);\n                            /**\n                             * It is a common problem that people have wrongly behaving backend\n                             * that do not return an array with the conflicts on push requests.\n                             * So we run this check here to make it easier to debug.\n                             * @link https://github.com/pubkey/rxdb/issues/4103\n                             */\n                            if (!Array.isArray(result)) {\n                                throw newRxError(\n                                    'RC_PUSH_NO_AR',\n                                    {\n                                        pushRows: rows,\n                                        direction: 'push',\n                                        args: { result }\n                                    }\n                                );\n                            }\n                            done = true;\n                        } catch (err: any | Error | Error[] | RxError) {\n                            const emitError = (err as RxError).rxdb ? err : newRxError('RC_PUSH', {\n                                pushRows: rows,\n                                errors: toArray(err).map(er => errorToPlainJson(er)),\n                                direction: 'push'\n                            });\n                            this.subjects.error.next(emitError);\n                            await awaitRetry(this.collection, ensureNotFalsy(this.retryTime));\n                        }\n                    }\n                    if (this.isStopped()) {\n                        return [];\n                    }\n\n                    await runAsyncPluginHooks('preReplicationMasterWriteDocumentsHandle', {\n                        result,\n                        collection: this.collection\n                    });\n\n                    const conflicts = handlePulledDocuments(this.collection, this.deletedField, ensureNotFalsy(result));\n                    return conflicts;\n                }\n            }\n        });\n        this.subs.push(\n            this.internalReplicationState.events.error.subscribe(err => {\n                this.subjects.error.next(err);\n            }),\n            this.internalReplicationState.events.processed.down\n                .subscribe(row => this.subjects.received.next(row.document as any)),\n            this.internalReplicationState.events.processed.up\n                .subscribe(writeToMasterRow => {\n                    this.subjects.send.next(writeToMasterRow.newDocumentState);\n                }),\n            combineLatest([\n                this.internalReplicationState.events.active.down,\n                this.internalReplicationState.events.active.up\n            ]).subscribe(([down, up]) => {\n                const isActive = down || up;\n                this.subjects.active.next(isActive);\n            })\n        );\n\n        if (\n            this.pull &&\n            this.pull.stream$ &&\n            this.live\n        ) {\n            this.subs.push(\n                this.pull.stream$.subscribe({\n                    next: ev => {\n                        this.remoteEvents$.next(ev);\n                    },\n                    error: err => {\n                        this.subjects.error.next(err);\n                    }\n                })\n            );\n        }\n\n        /**\n         * Non-live replications run once\n         * and then automatically get canceled.\n         */\n        if (!this.live) {\n            await awaitRxStorageReplicationFirstInSync(this.internalReplicationState);\n            await awaitRxStorageReplicationInSync(this.internalReplicationState);\n            await this.cancel();\n        }\n        this.callOnStart();\n    }\n\n    isStopped(): boolean {\n        if (this.subjects.canceled.getValue()) {\n            return true;\n        }\n        return false;\n    }\n\n    async awaitInitialReplication(): Promise<void> {\n        await this.startPromise;\n        return awaitRxStorageReplicationFirstInSync(\n            ensureNotFalsy(this.internalReplicationState)\n        );\n    }\n\n    /**\n     * Returns a promise that resolves when:\n     * - All local data is replicated with the remote\n     * - No replication cycle is running or in retry-state\n     *\n     * WARNING: USing this function directly in a multi-tab browser application\n     * is dangerous because only the leading instance will ever be replicated,\n     * so this promise will not resolve in the other tabs.\n     * For multi-tab support you should set and observe a flag in a local document.\n     */\n    async awaitInSync(): Promise<true> {\n        await this.startPromise;\n        await awaitRxStorageReplicationFirstInSync(ensureNotFalsy(this.internalReplicationState));\n\n        /**\n         * Often awaitInSync() is called directly after a document write,\n         * like in the unit tests.\n         * So we first have to await the idleness to ensure that all RxChangeEvents\n         * are processed already.\n         */\n        await this.collection.database.requestIdlePromise();\n\n        await awaitRxStorageReplicationInSync(ensureNotFalsy(this.internalReplicationState));\n\n        return true;\n    }\n\n    reSync() {\n        this.remoteEvents$.next('RESYNC');\n    }\n    emitEvent(ev: RxReplicationPullStreamItem<RxDocType, CheckpointType>) {\n        this.remoteEvents$.next(ev);\n    }\n\n    cancel(): Promise<any> {\n        if (this.isStopped()) {\n            return PROMISE_RESOLVE_FALSE;\n        }\n\n        const promises: Promise<any>[] = [];\n\n        if (this.internalReplicationState) {\n            cancelRxStorageReplication(this.internalReplicationState);\n        }\n        if (this.metaInstance) {\n            promises.push(\n                ensureNotFalsy(this.internalReplicationState).checkpointQueue\n                    .then(() => ensureNotFalsy(this.metaInstance).close())\n            );\n        }\n\n        this.subs.forEach(sub => sub.unsubscribe());\n        this.subjects.canceled.next(true);\n\n        this.subjects.active.complete();\n        this.subjects.canceled.complete();\n        this.subjects.error.complete();\n        this.subjects.received.complete();\n        this.subjects.send.complete();\n\n        return Promise.all(promises);\n    }\n}\n\n\nexport function replicateRxCollection<RxDocType, CheckpointType>(\n    {\n        replicationIdentifier,\n        collection,\n        deletedField = '_deleted',\n        pull,\n        push,\n        live = true,\n        retryTime = 1000 * 5,\n        waitForLeadership = true,\n        autoStart = true,\n    }: ReplicationOptions<RxDocType, CheckpointType>\n): RxReplicationState<RxDocType, CheckpointType> {\n    addRxPlugin(RxDBLeaderElectionPlugin);\n    const replicationIdentifierHash = collection.database.hashFunction(\n        [\n            collection.database.name,\n            collection.name,\n            replicationIdentifier\n        ].join('|')\n    );\n    const replicationState = new RxReplicationState<RxDocType, CheckpointType>(\n        replicationIdentifierHash,\n        collection,\n        deletedField,\n        pull,\n        push,\n        live,\n        retryTime,\n        autoStart\n    );\n\n\n    startReplicationOnLeaderShip(waitForLeadership, replicationState);\n    return replicationState as any;\n}\n\n\nexport function startReplicationOnLeaderShip(\n    waitForLeadership: boolean,\n    replicationState: RxReplicationState<any, any>\n) {\n    /**\n     * Always await this Promise to ensure that the current instance\n     * is leader when waitForLeadership=true\n     */\n    const mustWaitForLeadership = waitForLeadership && replicationState.collection.database.multiInstance;\n    const waitTillRun: Promise<any> = mustWaitForLeadership ? replicationState.collection.database.waitForLeadership() : PROMISE_RESOLVE_TRUE;\n    return waitTillRun.then(() => {\n        if (replicationState.isStopped()) {\n            return;\n        }\n        if (replicationState.autoStart) {\n            replicationState.start();\n        }\n    });\n}\n"],"mappings":"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"}