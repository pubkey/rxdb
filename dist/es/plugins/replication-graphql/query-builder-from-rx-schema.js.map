{"version":3,"file":"query-builder-from-rx-schema.js","names":["fillUpOptionals","SPACING","ensureNotFalsy","ucfirst","pullQueryBuilderFromRxSchema","collectionName","input","schema","prefixes","ucCollectionName","queryName","pull","outputFields","Object","keys","properties","filter","k","ignoreOutputKeys","includes","checkpointInputName","checkpoint","builder","limit","query","join","checkpointFields","variables","pullStreamBuilderFromRxSchema","headersName","headers","stream","pushQueryBuilderFromRxSchema","push","variableName","pushRow","returnFields","pushRows","sendRows","transformPushDoc","doc","sendDoc","entries","forEach","v","ignoreInputKeys","newRow","newDocumentState","assumedMasterState","undefined"],"sources":["../../../../src/plugins/replication-graphql/query-builder-from-rx-schema.ts"],"sourcesContent":["import {\n    GraphQLSchemaFromRxSchemaInputSingleCollection,\n    fillUpOptionals,\n    Prefixes,\n    SPACING\n} from './graphql-schema-from-rx-schema';\nimport { ensureNotFalsy, ucfirst } from '../../util';\nimport type {\n    RxGraphQLReplicationPullQueryBuilder,\n    RxGraphQLReplicationPullStreamQueryBuilder,\n    RxGraphQLReplicationPushQueryBuilder,\n    WithDeleted\n} from '../../types';\n\nexport function pullQueryBuilderFromRxSchema(\n    collectionName: string,\n    input: GraphQLSchemaFromRxSchemaInputSingleCollection,\n): RxGraphQLReplicationPullQueryBuilder<any> {\n    input = fillUpOptionals(input);\n    const schema = input.schema;\n    const prefixes: Prefixes = input.prefixes as any;\n\n    const ucCollectionName = ucfirst(collectionName);\n    const queryName = prefixes.pull + ucCollectionName;\n\n    const outputFields = Object.keys(schema.properties).filter(k => !(input.ignoreOutputKeys as string[]).includes(k));\n    // outputFields.push(input.deletedField);\n\n    const checkpointInputName = ucCollectionName + 'Input' + prefixes.checkpoint;\n\n    const builder: RxGraphQLReplicationPullQueryBuilder<any> = (checkpoint: any, limit: number) => {\n        const query = 'query ' + ucfirst(queryName) + '($checkpoint: ' + checkpointInputName + ', $limit: Int!) {\\n' +\n            SPACING + SPACING + queryName + '(checkpoint: $checkpoint, limit: $limit) {\\n' +\n            SPACING + SPACING + SPACING + 'documents {\\n' +\n            SPACING + SPACING + SPACING + SPACING + outputFields.join('\\n' + SPACING + SPACING + SPACING + SPACING) + '\\n' +\n            SPACING + SPACING + SPACING + '}\\n' +\n            SPACING + SPACING + SPACING + 'checkpoint {\\n' +\n            SPACING + SPACING + SPACING + SPACING + input.checkpointFields.join('\\n' + SPACING + SPACING + SPACING + SPACING) + '\\n' +\n            SPACING + SPACING + SPACING + '}\\n' +\n            SPACING + SPACING + '}\\n' +\n            '}';\n        return {\n            query,\n            variables: {\n                checkpoint,\n                limit\n            }\n        };\n    };\n\n    return builder;\n}\n\nexport function pullStreamBuilderFromRxSchema(\n    collectionName: string,\n    input: GraphQLSchemaFromRxSchemaInputSingleCollection,\n) {\n    input = fillUpOptionals(input);\n    const schema = input.schema;\n    const prefixes: Prefixes = input.prefixes as any;\n\n    const ucCollectionName = ucfirst(collectionName);\n    const outputFields = Object.keys(schema.properties).filter(k => !(input.ignoreOutputKeys as string[]).includes(k));\n\n    const headersName = ucCollectionName + 'Input' + prefixes.headers;\n\n    const query = 'subscription on' + ucfirst(ensureNotFalsy(prefixes.stream)) + '($headers: ' + headersName + ') {\\n' +\n        SPACING + prefixes.stream + ucCollectionName + '(headers: $headers) {\\n' +\n        SPACING + SPACING + SPACING + 'documents {\\n' +\n        SPACING + SPACING + SPACING + SPACING + outputFields.join('\\n' + SPACING + SPACING + SPACING + SPACING) + '\\n' +\n        SPACING + SPACING + SPACING + '}\\n' +\n        SPACING + SPACING + SPACING + 'checkpoint {\\n' +\n        SPACING + SPACING + SPACING + SPACING + input.checkpointFields.join('\\n' + SPACING + SPACING + SPACING + SPACING) + '\\n' +\n        SPACING + SPACING + SPACING + '}\\n' +\n        SPACING + '}' +\n        '}';\n\n    const builder: RxGraphQLReplicationPullStreamQueryBuilder = (headers: any) => {\n        return {\n            query,\n            variables: {\n                headers\n            }\n        }\n    };\n    return builder;\n}\n\n\nexport function pushQueryBuilderFromRxSchema(\n    collectionName: string,\n    input: GraphQLSchemaFromRxSchemaInputSingleCollection\n): RxGraphQLReplicationPushQueryBuilder {\n    input = fillUpOptionals(input);\n    const prefixes: Prefixes = input.prefixes as any;\n\n    const ucCollectionName = ucfirst(collectionName);\n    const queryName = prefixes.push + ucCollectionName;\n\n    const variableName = collectionName + prefixes.pushRow;\n\n\n    const returnFields: string[] = Object.keys(input.schema.properties);\n\n    const builder: RxGraphQLReplicationPushQueryBuilder = (pushRows) => {\n        const query = '' +\n            'mutation ' + prefixes.push + ucCollectionName + '($' + variableName + ': [' + ucCollectionName + 'Input' + prefixes.pushRow + '!]) {\\n' +\n            SPACING + queryName + '(' + variableName + ': $' + variableName + ') {\\n' +\n            SPACING + SPACING + returnFields.join(',\\n' + SPACING + SPACING) + '\\n' +\n            SPACING + '}\\n' +\n            '}';\n\n        const sendRows: typeof pushRows = [];\n        function transformPushDoc(doc: WithDeleted<any>) {\n            const sendDoc: any = {};\n            Object.entries(doc).forEach(([k, v]) => {\n                if (\n                    // skip if in ignoreInputKeys list\n                    !(input.ignoreInputKeys as string[]).includes(k) &&\n                    // only use properties that are in the schema\n                    input.schema.properties[k]\n                ) {\n                    sendDoc[k] = v;\n                }\n            });\n            return sendDoc;\n        }\n        pushRows.forEach(pushRow => {\n            const newRow: typeof pushRow = {\n                newDocumentState: transformPushDoc(pushRow.newDocumentState),\n                assumedMasterState: pushRow.assumedMasterState ? transformPushDoc(pushRow.assumedMasterState) : undefined\n            };\n            sendRows.push(newRow);\n        });\n        const variables = {\n            [variableName]: sendRows\n        };\n        return {\n            query,\n            variables\n        };\n    };\n\n    return builder;\n}\n"],"mappings":"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"}