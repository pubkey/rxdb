{"version":3,"file":"graphql-websocket.js","names":["SubscriptionClient","getFromMapOrThrow","WebSocket","IsomorphicWebSocket","GRAPHQL_WEBSOCKET_BY_URL","Map","getGraphQLWebSocket","url","has","get","wsClient","reconnect","socket","refCount","set","removeGraphQLWebSocketRef","console","log","obj","close"],"sources":["../../../../src/plugins/replication-graphql/graphql-websocket.ts"],"sourcesContent":["import { SubscriptionClient } from 'subscriptions-transport-ws';\nimport { getFromMapOrThrow } from '../../util';\n\nimport {\n    WebSocket as IsomorphicWebSocket\n} from 'isomorphic-ws';\n\nexport type WebsocketWithRefCount = {\n    url: string;\n    socket: SubscriptionClient;\n    refCount: number;\n};\n\nexport const GRAPHQL_WEBSOCKET_BY_URL: Map<string, WebsocketWithRefCount> = new Map();\n\n\nexport function getGraphQLWebSocket(\n    url: string\n): SubscriptionClient {\n    let has = GRAPHQL_WEBSOCKET_BY_URL.get(url);\n    if (!has) {\n        const wsClient = new SubscriptionClient(\n            url,\n            {\n                reconnect: true,\n            },\n            IsomorphicWebSocket\n        );\n        has = {\n            url,\n            socket: wsClient,\n            refCount: 1\n        };\n        GRAPHQL_WEBSOCKET_BY_URL.set(url, has);\n    } else {\n        has.refCount = has.refCount + 1;\n    }\n    return has.socket;\n}\n\n\nexport function removeGraphQLWebSocketRef(\n    url: string\n) {\n    console.log('removeGraphQLWebSocketRef: ' + url);\n    const obj = getFromMapOrThrow(GRAPHQL_WEBSOCKET_BY_URL, url);\n    obj.refCount = obj.refCount - 1;\n    console.log('obj.refCount: ' + obj.refCount);\n    if (obj.refCount === 0) {\n        GRAPHQL_WEBSOCKET_BY_URL.delete(url);\n        obj.socket.close();\n    }\n}\n"],"mappings":"AAAA,SAASA,kBAAT,QAAmC,4BAAnC;AACA,SAASC,iBAAT,QAAkC,YAAlC;AAEA,SACIC,SAAS,IAAIC,mBADjB,QAEO,eAFP;AAUA,OAAO,IAAMC,wBAA4D,GAAG,IAAIC,GAAJ,EAArE;AAGP,OAAO,SAASC,mBAAT,CACHC,GADG,EAEe;EAClB,IAAIC,GAAG,GAAGJ,wBAAwB,CAACK,GAAzB,CAA6BF,GAA7B,CAAV;;EACA,IAAI,CAACC,GAAL,EAAU;IACN,IAAME,QAAQ,GAAG,IAAIV,kBAAJ,CACbO,GADa,EAEb;MACII,SAAS,EAAE;IADf,CAFa,EAKbR,mBALa,CAAjB;IAOAK,GAAG,GAAG;MACFD,GAAG,EAAHA,GADE;MAEFK,MAAM,EAAEF,QAFN;MAGFG,QAAQ,EAAE;IAHR,CAAN;IAKAT,wBAAwB,CAACU,GAAzB,CAA6BP,GAA7B,EAAkCC,GAAlC;EACH,CAdD,MAcO;IACHA,GAAG,CAACK,QAAJ,GAAeL,GAAG,CAACK,QAAJ,GAAe,CAA9B;EACH;;EACD,OAAOL,GAAG,CAACI,MAAX;AACH;AAGD,OAAO,SAASG,yBAAT,CACHR,GADG,EAEL;EACES,OAAO,CAACC,GAAR,CAAY,gCAAgCV,GAA5C;EACA,IAAMW,GAAG,GAAGjB,iBAAiB,CAACG,wBAAD,EAA2BG,GAA3B,CAA7B;EACAW,GAAG,CAACL,QAAJ,GAAeK,GAAG,CAACL,QAAJ,GAAe,CAA9B;EACAG,OAAO,CAACC,GAAR,CAAY,mBAAmBC,GAAG,CAACL,QAAnC;;EACA,IAAIK,GAAG,CAACL,QAAJ,KAAiB,CAArB,EAAwB;IACpBT,wBAAwB,UAAxB,CAAgCG,GAAhC;IACAW,GAAG,CAACN,MAAJ,CAAWO,KAAX;EACH;AACJ"}