{"version":3,"file":"foundationdb-query.js","names":["getStartIndexStringFromLowerBound","getStartIndexStringFromUpperBound","ensureNotFalsy","RxStorageDexieStatics","getFoundationDBIndexName","pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","queryFoundationDB","instance","preparedQuery","queryPlan","query","skip","limit","Infinity","skipPlusLimit","queryPlanFields","index","mustManuallyResort","sortFieldsSameAsIndexFields","queryMatcher","getQueryMatcher","schema","sortComparator","getSortComparator","internals","dbsPromise","dbs","indexForName","slice","unshift","indexName","indexDB","indexes","db","lowerBound","startKeys","concat","lowerBoundString","upperBound","endKeys","upperBoundString","root","doTransaction","tx","innerResult","indexTx","at","subspace","mainTx","main","range","getRangeBatch","done","next","docIds","map","row","Promise","all","docId","get","docsData","forEach","docData","push","length","sort","documents"],"sources":["../../../../src/plugins/foundationdb/foundationdb-query.ts"],"sourcesContent":["import {\n    getStartIndexStringFromLowerBound,\n    getStartIndexStringFromUpperBound\n} from '../../custom-index';\nimport type {\n    RxDocumentData,\n    RxStorageQueryResult\n} from '../../types';\nimport { ensureNotFalsy } from '../../util';\nimport { RxStorageDexieStatics } from '../dexie';\nimport { getFoundationDBIndexName } from './foundationdb-helpers';\nimport type {\n    FoundationDBPreparedQuery\n} from './foundationdb-types';\nimport { RxStorageInstanceFoundationDB } from './rx-storage-instance-foundationdb';\n\nexport async function queryFoundationDB<RxDocType>(\n    instance: RxStorageInstanceFoundationDB<RxDocType>,\n    preparedQuery: FoundationDBPreparedQuery<RxDocType>\n): Promise<RxStorageQueryResult<RxDocType>> {\n    const queryPlan = preparedQuery.queryPlan;\n    const query = preparedQuery.query;\n    const skip = query.skip ? query.skip : 0;\n    const limit = query.limit ? query.limit : Infinity;\n    const skipPlusLimit = skip + limit;\n    const queryPlanFields: string[] = queryPlan.index;\n    const mustManuallyResort = !queryPlan.sortFieldsSameAsIndexFields;\n\n    const queryMatcher = RxStorageDexieStatics.getQueryMatcher(\n        instance.schema,\n        preparedQuery\n    );\n    const sortComparator = RxStorageDexieStatics.getSortComparator(instance.schema, preparedQuery);\n    const dbs = await instance.internals.dbsPromise;\n\n\n    const indexForName = queryPlanFields.slice(0);\n    indexForName.unshift('_deleted');\n    const indexName = getFoundationDBIndexName(indexForName);\n    const indexDB = ensureNotFalsy(dbs.indexes[indexName]).db;\n\n    let lowerBound: any[] = queryPlan.startKeys;\n    lowerBound = [false].concat(lowerBound);\n    const lowerBoundString = getStartIndexStringFromLowerBound(\n        instance.schema,\n        indexForName,\n        lowerBound\n    );\n\n    let upperBound: any[] = queryPlan.endKeys;\n    upperBound = [false].concat(upperBound);\n    const upperBoundString = getStartIndexStringFromUpperBound(\n        instance.schema,\n        indexForName,\n        upperBound\n    );\n    let result = await dbs.root.doTransaction(async (tx: any) => {\n        const innerResult: RxDocumentData<RxDocType>[] = [];\n        const indexTx = tx.at(indexDB.subspace);\n        const mainTx = tx.at(dbs.main.subspace);\n\n        const range = indexTx.getRangeBatch(\n            lowerBoundString,\n            upperBoundString,\n            {\n                // TODO these options seem to be broken in the foundationdb node bindings\n                // limit: instance.settings.batchSize,\n                // streamingMode: StreamingMode.Exact\n            }\n        );\n        let done = false;\n        while (!done) {\n            const next = await range.next();\n            if (next.done) {\n                done = true;\n                break;\n            }\n            const docIds = next.value.map((row: string[]) => row[1]);\n            const docsData: RxDocumentData<RxDocType>[] = await Promise.all(docIds.map((docId: string) => mainTx.get(docId)));\n            docsData.forEach((docData) => {\n                if (!done) {\n                    if (\n                        queryMatcher(docData)\n                    ) {\n                        innerResult.push(docData);\n                    }\n                }\n                if (\n                    !mustManuallyResort &&\n                    innerResult.length === skipPlusLimit\n                ) {\n                    done = true;\n                    range.return();\n                }\n            });\n        }\n        return innerResult;\n    });\n    if (mustManuallyResort) {\n        result = result.sort(sortComparator);\n    }\n\n    // apply skip and limit boundaries.\n    result = result.slice(skip, skipPlusLimit);\n\n    return {\n        documents: result\n    };\n}\n"],"mappings":"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"}