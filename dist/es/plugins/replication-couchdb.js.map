{"version":3,"file":"replication-couchdb.js","names":["PouchReplicationPlugin","BehaviorSubject","Subject","fromEvent","firstValueFrom","skipUntil","filter","first","mergeMap","promiseWait","flatClone","PROMISE_RESOLVE_FALSE","PROMISE_RESOLVE_TRUE","ensureNotFalsy","newRxError","isInstanceOf","isInstanceOfPouchDB","addPouchPlugin","getPouchDBOfRxCollection","isRxCollection","INTERNAL_POUCHDBS","WeakSet","RxCouchDBReplicationStateBase","collection","syncOptions","_subs","_subjects","change","docs","denied","active","complete","alive","error","canceled","Object","keys","forEach","key","defineProperty","get","asObservable","awaitInitialReplication","options","live","database","name","multiInstance","waitForLeadership","that","complete$","pipe","x","cancel","ret","_pouchEventEmitterObject","Promise","res","on","sub","unsubscribe","setPouchEventEmitter","rxRepState","evEmitter","push","subscribe","ev","next","observers","length","direction","doc","language","info","requestIdlePromise","then","getIsAlive","emitter","state","pull","reduce","acc","val","isAlive","resolve","createRxCouchDBReplicationState","pouchReplicationFunction","pouch","sync","bind","replicate","to","from","syncCouchDB","remote","retry","query","useOptions","has","storageInstance","internals","syncFun","selector","getPreparedQuery","repState","waitTillRun","destroyed","pouchSync","onDestroy","RxDBReplicationCouchDBPlugin","rxdb","init","prototypes","RxCollection","proto","hooks","createRxCollection","after","args","add"],"sources":["../../../src/plugins/replication-couchdb.ts"],"sourcesContent":["/**\n * this plugin adds the RxCollection.sync()-function to rxdb\n * you can use it to sync collections with remote or local couchdb-instances\n */\n\nimport PouchReplicationPlugin from 'pouchdb-replication';\nimport {\n    BehaviorSubject,\n    Subject,\n    fromEvent,\n    Subscription,\n    Observable,\n    firstValueFrom\n} from 'rxjs';\nimport {\n    skipUntil,\n    filter,\n    first,\n    mergeMap\n} from 'rxjs/operators';\n\nimport {\n    promiseWait,\n    flatClone,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_TRUE,\n    ensureNotFalsy\n} from '../util';\nimport {\n    newRxError\n} from '../rx-error';\nimport {\n    isInstanceOf as isInstanceOfPouchDB,\n    addPouchPlugin,\n    getPouchDBOfRxCollection\n} from '../plugins/pouchdb';\n\nimport {\n    isRxCollection\n} from '../rx-collection';\nimport type {\n    RxCollection,\n    PouchSyncHandler,\n    PouchReplicationOptions,\n    RxPlugin,\n    SyncOptions,\n    PouchDBInstance\n} from '../types';\n\n/**\n * Contains all pouchdb instances that\n * are used inside of RxDB by collections or databases.\n * Used to ensure the remote of a replication cannot be an internal pouchdb.\n */\nconst INTERNAL_POUCHDBS = new WeakSet();\n\nexport class RxCouchDBReplicationStateBase {\n    public _subs: Subscription[] = [];\n\n    // can be used for debugging or custom event-handling\n    // will be set some time after sync() is called\n    public _pouchEventEmitterObject?: PouchSyncHandler | null;\n    public _subjects = {\n        change: new Subject(),\n        docs: new Subject(),\n        denied: new Subject(),\n        active: new BehaviorSubject(false),\n        complete: new BehaviorSubject(false),\n        alive: new BehaviorSubject(false),\n        error: new Subject(),\n    };\n\n    public canceled: boolean = false;\n\n    constructor(\n        public readonly collection: RxCollection,\n        public readonly syncOptions: SyncOptions\n    ) {\n        // create getters\n        Object.keys(this._subjects).forEach(key => {\n            Object.defineProperty(this, key + '$', {\n                get: function () {\n                    return this._subjects[key].asObservable();\n                }\n            });\n        });\n    }\n\n    awaitInitialReplication(): Promise<void> {\n        if (this.syncOptions.options && this.syncOptions.options.live) {\n            throw newRxError('RC4', {\n                database: this.collection.database.name,\n                collection: this.collection.name\n            });\n        }\n        if (this.collection.database.multiInstance && this.syncOptions.waitForLeadership) {\n            throw newRxError('RC5', {\n                database: this.collection.database.name,\n                collection: this.collection.name\n            });\n        }\n\n        const that: RxCouchDBReplicationState = this as any;\n        return firstValueFrom(\n            that.complete$.pipe(\n                filter(x => !!x)\n            )\n        );\n    }\n\n    /**\n     * Returns false when the replication has already been canceled\n     */\n    cancel(): Promise<boolean> {\n        if (this.canceled) {\n            return PROMISE_RESOLVE_FALSE;\n        }\n        this.canceled = true;\n        let ret = PROMISE_RESOLVE_TRUE;\n        if (this._pouchEventEmitterObject) {\n            /**\n             * Calling cancel() does not return a promise,\n             * so we have to await the complete event\n             * to know that everything is cleaned up properly.\n             */\n            ret = new Promise<true>(res => {\n                ensureNotFalsy(this._pouchEventEmitterObject)\n                    .on('complete', () => {\n                        res(true);\n                    });\n            });\n            this._pouchEventEmitterObject.cancel();\n        }\n        this._subs.forEach(sub => sub.unsubscribe());\n        return ret;\n    }\n}\n\nexport type RxCouchDBReplicationState = RxCouchDBReplicationStateBase & {\n    change$: Observable<any>;\n    docs$: Observable<any>;\n    denied$: Observable<any>;\n    active$: Observable<any>;\n    alive$: Observable<boolean>;\n    complete$: Observable<any>;\n    error$: Observable<any>;\n};\n\nexport function setPouchEventEmitter(\n    rxRepState: RxCouchDBReplicationState,\n    evEmitter: PouchSyncHandler\n) {\n    if (rxRepState._pouchEventEmitterObject) {\n        throw newRxError('RC1');\n    }\n    rxRepState._pouchEventEmitterObject = evEmitter;\n\n    // change\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'change')\n            .subscribe(ev => {\n                rxRepState._subjects.change.next(ev);\n            })\n    );\n\n    // denied\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'denied')\n            .subscribe(ev => rxRepState._subjects.denied.next(ev))\n    );\n\n    // docs\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'change')\n            .subscribe(ev => {\n                if (\n                    rxRepState._subjects.docs.observers.length === 0 ||\n                    (ev as any).direction !== 'pull'\n                ) return;\n\n                (ev as any).change.docs\n                    .filter((doc: any) => doc.language !== 'query') // remove internal docs\n                    // do primary-swap and keycompression\n                    .forEach((doc: any) => rxRepState._subjects.docs.next(doc));\n            }));\n\n    // error\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'error')\n            .subscribe(ev => rxRepState._subjects.error.next(ev))\n    );\n\n    // active\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'active')\n            .subscribe(() => rxRepState._subjects.active.next(true))\n    );\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'paused')\n            .subscribe(() => rxRepState._subjects.active.next(false))\n    );\n\n    // complete\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'complete')\n            .subscribe(async (info: any) => {\n                /**\n                 * when complete fires, it might be that not all changeEvents\n                 * have passed through, because of the delay of .wachtForChanges()\n                 * Therefore we have to first ensure that all previous changeEvents have been handled\n                 */\n                await promiseWait(100);\n                rxRepState._subjects.complete.next(info);\n            })\n    );\n    // auto-cancel one-time replications on complelete to not cause memory leak\n    if (\n        !rxRepState.syncOptions.options ||\n        !rxRepState.syncOptions.options.live\n    ) {\n        rxRepState._subs.push(\n            rxRepState.complete$.pipe(\n                filter(x => !!x),\n                first(),\n                mergeMap(() => {\n                    return rxRepState.collection.database\n                        .requestIdlePromise()\n                        .then(() => rxRepState.cancel());\n                })\n            ).subscribe()\n        );\n    }\n\n    function getIsAlive(emitter: any): Promise<boolean> {\n        // \"state\" will live in emitter.state if single direction replication\n        // or in emitter.push.state & emitter.pull.state when syncing for both\n        let state = emitter.state;\n        if (!state) {\n            state = [emitter.pull.state, emitter.push.state]\n                .reduce((acc, val) => {\n                    if (acc === 'active' || val === 'active') return 'active';\n                    return acc === 'stopped' ? acc : val;\n                }, '');\n        }\n\n        // If it's active, we can't determine whether the connection is active\n        // or not yet\n        if (state === 'active') {\n            return promiseWait(15).then(() => getIsAlive(emitter));\n        }\n\n        const isAlive = state !== 'stopped';\n        return Promise.resolve(isAlive);\n    }\n\n    rxRepState._subs.push(\n        fromEvent(evEmitter as any, 'paused')\n            .pipe(\n                skipUntil(fromEvent(evEmitter as any, 'active'))\n            ).subscribe(() => {\n                getIsAlive(rxRepState._pouchEventEmitterObject)\n                    .then(isAlive => rxRepState._subjects.alive.next(isAlive));\n            })\n    );\n}\n\nexport function createRxCouchDBReplicationState(\n    collection: RxCollection,\n    syncOptions: SyncOptions\n): RxCouchDBReplicationState {\n    return new RxCouchDBReplicationStateBase(\n        collection,\n        syncOptions\n    ) as RxCouchDBReplicationState;\n}\n\n/**\n * get the correct function-name for pouchdb-replication\n */\nexport function pouchReplicationFunction(\n    pouch: PouchDBInstance,\n    {\n        pull = true,\n        push = true\n    }\n): any {\n    if (pull && push) {\n        return pouch.sync.bind(pouch);\n    }\n    if (!pull && push) {\n        return (pouch.replicate as any).to.bind(pouch);\n    }\n    if (pull && !push) {\n        return (pouch.replicate as any).from.bind(pouch);\n    }\n    if (!pull && !push) {\n        throw newRxError('UT3', {\n            pull,\n            push\n        });\n    }\n}\n\nexport function syncCouchDB(\n    this: RxCollection,\n    {\n        remote,\n        waitForLeadership = true,\n        direction = {\n            pull: true,\n            push: true\n        },\n        options = {\n            live: true,\n            retry: true\n        },\n        query\n    }: SyncOptions) {\n    const useOptions: PouchReplicationOptions & { selector: any; } = flatClone(options) as any;\n\n    // prevent #641 by not allowing internal pouchdbs as remote\n    if (\n        isInstanceOfPouchDB(remote) &&\n        INTERNAL_POUCHDBS.has(remote)\n    ) {\n        throw newRxError('RC3', {\n            database: this.database.name,\n            collection: this.name\n        });\n    }\n\n    // if remote is RxCollection, get internal pouchdb\n    if (isRxCollection(remote)) {\n        remote = (remote as RxCollection).storageInstance.internals.pouch;\n    }\n\n    if (query && this !== query.collection) {\n        throw newRxError('RC2', {\n            query\n        });\n    }\n\n    const pouch = getPouchDBOfRxCollection(this);\n    const syncFun = pouchReplicationFunction(pouch, direction);\n    if (query) {\n        useOptions.selector = query.getPreparedQuery().selector;\n    }\n\n    const repState: any = createRxCouchDBReplicationState(\n        this,\n        {\n            remote,\n            waitForLeadership,\n            direction,\n            options,\n            query\n        }\n    );\n\n    // run internal so .sync() does not have to be async\n    const waitTillRun = (\n        waitForLeadership &&\n        this.database.multiInstance // do not await leadership if not multiInstance\n    ) ? this.database.waitForLeadership() : promiseWait(0);\n    (waitTillRun as any).then(() => {\n        if (this.destroyed || repState.canceled) {\n            return;\n        }\n        const pouchSync = syncFun(remote, useOptions);\n        setPouchEventEmitter(repState, pouchSync);\n\n        this.onDestroy.push(() => repState.cancel());\n    });\n\n    return repState;\n}\n\n\n\nexport const RxDBReplicationCouchDBPlugin: RxPlugin = {\n    name: 'replication-couchdb',\n    rxdb: true,\n    init() {\n        // add pouchdb-replication-plugin\n        addPouchPlugin(PouchReplicationPlugin);\n    },\n    prototypes: {\n        RxCollection: (proto: any) => {\n            proto.syncCouchDB = syncCouchDB;\n        }\n    },\n    hooks: {\n        createRxCollection: {\n            after: args => {\n                const collection = args.collection;\n                const pouch: PouchDBInstance | undefined = collection.storageInstance.internals.pouch;\n                if (pouch) {\n                    INTERNAL_POUCHDBS.add(collection.storageInstance.internals.pouch);\n                }\n            }\n        }\n    }\n};\n"],"mappings":"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"}