{"version":3,"file":"lokijs-helper.js","names":["createLokiLocalState","lokijs","add","unloadAdd","ensureNotFalsy","flatClone","promiseWait","randomCouchString","LokiSaveQueue","newRxError","getBroadcastChannelReference","getLeaderElectorByBroadcastChannel","body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","mustUseLocalState","instance","closed","args","instanceClosed","databaseName","collectionName","internals","localState","leaderElector","waitUntilHasLeader","isLeader","databaseInstanceToken","options","schema","multiInstance","databaseSettings","hasLeader","applyOnce","handleRemoteRequest","msg","type","LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE","requestId","response","isError","broadcastChannel","postMessage","operation","params","err","console","dir","requestRemoteInstance","isRxStorageInstanceLoki","query","messageType","LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE","whenDeathListener","leaderDeadPromise","Promise","res","context","action","retry","addEventListener","responseListener","responsePromise","_rej","error","race","firstResolved","removeEventListener","closeLokiCollections","collections","LOKI_DATABASE_STATE_BY_NAME","get","databaseState","saveQueue","run","forEach","collection","name","Object","keys","length","unloads","u","remove","rej","database","close","CHANGES_COLLECTION_SUFFIX","RX_STORAGE_NAME_LOKIJS","stripLokiKey","docData","$loki","cloned","$lastWriteAt","_meta","lwt","OPEN_LOKIJS_STORAGE_INSTANCES","Set","LOKIJS_COLLECTION_DEFAULT_OPTIONS","disableChangesApi","disableMeta","disableDeltaChangesApi","disableFreeze","cloneMethod","clone","transactional","autoupdate","Map","getLokiDatabase","hasPersistence","adapter","push","lokiSaveQueue","useSettings","persistenceMethod","assign","autoload","verbose","autosave","throttledSaves","loadDatabasePromise","loadDatabase","recursiveWait","autoloadCallback","set","getLokiSortComparator","_schema","sort","sortOptions","fun","a","b","compareResult","find","sortPart","fieldName","direction","values","directionMultiplier","valueA","valueB","getLokiLeaderElector","broadcastChannelRefObject","elector"],"sources":["../../../../src/plugins/lokijs/lokijs-helper.ts"],"sourcesContent":["import { createLokiLocalState, RxStorageInstanceLoki } from './rx-storage-instance-loki';\nimport lokijs, { Collection } from 'lokijs';\nimport type {\n    LokiDatabaseSettings,\n    LokiDatabaseState,\n    LokiLocalDatabaseState,\n    LokiRemoteResponseBroadcastMessage,\n    MangoQuery,\n    MangoQuerySortDirection,\n    MangoQuerySortPart,\n    RxDocumentData,\n    RxJsonSchema\n} from '../../types';\nimport {\n    add as unloadAdd,\n    AddReturn\n} from 'unload';\nimport { ensureNotFalsy, flatClone, promiseWait, randomCouchString } from '../../util';\nimport { LokiSaveQueue } from './loki-save-queue';\nimport type { DeterministicSortComparator } from 'event-reduce-js';\nimport { newRxError } from '../../rx-error';\nimport {\n    LeaderElector,\n    OnMessageHandler\n} from 'broadcast-channel';\nimport { getBroadcastChannelReference } from '../../rx-storage-multiinstance';\nimport { getLeaderElectorByBroadcastChannel } from '../leader-election';\n\nexport const CHANGES_COLLECTION_SUFFIX = '-rxdb-changes';\nexport const LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE = 'rxdb-lokijs-remote-request';\nexport const LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE = 'rxdb-lokijs-remote-request-key-object';\nexport const RX_STORAGE_NAME_LOKIJS = 'lokijs';\n\n/**\n * Loki attaches a $loki property to all data\n * which must be removed before returning the data back to RxDB.\n */\nexport function stripLokiKey<T>(docData: RxDocumentData<T> & { $loki?: number; }): T {\n    if (!docData.$loki) {\n        return docData;\n    }\n    const cloned = flatClone(docData);\n\n    /**\n     * In RxDB version 12.0.0,\n     * we introduced the _meta field that already contains the last write time.\n     * To be backwards compatible, we have to move the $lastWriteAt to the _meta field.\n     * TODO remove this in the next major version.\n     */\n    if ((cloned as any).$lastWriteAt) {\n        cloned._meta = {\n            lwt: (cloned as any).$lastWriteAt\n        };\n        delete (cloned as any).$lastWriteAt;\n    }\n\n    delete cloned.$loki;\n    return cloned;\n}\n\n/**\n * Used to check in tests if all instances have been cleaned up.\n */\nexport const OPEN_LOKIJS_STORAGE_INSTANCES: Set<RxStorageInstanceLoki<any>> = new Set();\n\n\nexport const LOKIJS_COLLECTION_DEFAULT_OPTIONS: Partial<CollectionOptions<any>> = {\n    disableChangesApi: true,\n    disableMeta: true,\n    disableDeltaChangesApi: true,\n    disableFreeze: true,\n    // TODO use 'immutable' like WatermelonDB does it\n    cloneMethod: 'shallow-assign',\n    clone: false,\n    transactional: false,\n    autoupdate: false\n}\n\nconst LOKI_DATABASE_STATE_BY_NAME: Map<string, Promise<LokiDatabaseState>> = new Map();\nexport function getLokiDatabase(\n    databaseName: string,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiDatabaseState> {\n    let databaseState: Promise<LokiDatabaseState> | undefined = LOKI_DATABASE_STATE_BY_NAME.get(databaseName);\n    if (!databaseState) {\n        /**\n         * We assume that as soon as an adapter is passed,\n         * the database has to be persistend.\n         */\n        const hasPersistence: boolean = !!databaseSettings.adapter;\n        databaseState = (async () => {\n            let persistenceMethod = hasPersistence ? 'adapter' : 'memory';\n            if (databaseSettings.persistenceMethod) {\n                persistenceMethod = databaseSettings.persistenceMethod;\n            }\n            const useSettings = Object.assign(\n                // defaults\n                {\n                    autoload: hasPersistence,\n                    persistenceMethod,\n                    verbose: true\n                },\n                databaseSettings,\n                // overwrites\n                {\n                    /**\n                     * RxDB uses its custom load and save handling\n                     * so we disable the LokiJS save/load handlers.\n                     */\n                    autoload: false,\n                    autosave: false,\n                    throttledSaves: false\n                }\n            );\n            const database = new lokijs(\n                databaseName + '.db',\n                flatClone(useSettings)\n            );\n            const lokiSaveQueue = new LokiSaveQueue(\n                database,\n                useSettings\n            );\n\n            /**\n             * Wait until all data is loaded from persistence adapter.\n             * Wrap the loading into the saveQueue to ensure that when many\n             * collections are created at the same time, the load-calls do not interfere\n             * with each other and cause error logs.\n             */\n            if (hasPersistence) {\n                const loadDatabasePromise = new Promise<void>((res, rej) => {\n                    try {\n                        database.loadDatabase({\n                            recursiveWait: false\n                        }, (err) => {\n                            if (useSettings.autoloadCallback) {\n                                useSettings.autoloadCallback(err);\n                            }\n                            err ? rej(err) : res();\n                        });\n                    } catch (err) {\n                        rej(err);\n                    }\n                });\n                lokiSaveQueue.saveQueue = lokiSaveQueue.saveQueue.then(() => loadDatabasePromise);\n                await loadDatabasePromise;\n            }\n\n            /**\n             * Autosave database on process end\n             */\n            const unloads: AddReturn[] = [];\n            if (hasPersistence) {\n                unloads.push(\n                    unloadAdd(() => lokiSaveQueue.run())\n                );\n            }\n\n            const state: LokiDatabaseState = {\n                database,\n                databaseSettings: useSettings,\n                saveQueue: lokiSaveQueue,\n                collections: {},\n                unloads\n            };\n\n            return state;\n        })();\n        LOKI_DATABASE_STATE_BY_NAME.set(databaseName, databaseState);\n    }\n    return databaseState;\n}\n\nexport async function closeLokiCollections(\n    databaseName: string,\n    collections: Collection[]\n) {\n    const databaseState = await LOKI_DATABASE_STATE_BY_NAME.get(databaseName);\n    if (!databaseState) {\n        // already closed\n        return;\n    }\n    await databaseState.saveQueue.run();\n    collections.forEach(collection => {\n        const collectionName = collection.name;\n        delete databaseState.collections[collectionName];\n    });\n    if (Object.keys(databaseState.collections).length === 0) {\n        // all collections closed -> also close database\n        LOKI_DATABASE_STATE_BY_NAME.delete(databaseName);\n        databaseState.unloads.forEach(u => u.remove());\n        await new Promise<void>((res, rej) => {\n            databaseState.database.close(err => {\n                err ? rej(err) : res();\n            });\n        });\n    }\n}\n\n/**\n * This function is at lokijs-helper\n * because we need it in multiple places.\n */\nexport function getLokiSortComparator<RxDocType>(\n    _schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n    query: MangoQuery<RxDocType>\n): DeterministicSortComparator<RxDocType> {\n    if (!query.sort) {\n        throw newRxError('SNH', { query });\n    }\n    const sortOptions: MangoQuerySortPart<RxDocType>[] = query.sort;\n\n    const fun: DeterministicSortComparator<RxDocType> = (a: RxDocType, b: RxDocType) => {\n        let compareResult: number = 0; // 1 | -1\n        sortOptions.find(sortPart => {\n            const fieldName: string = Object.keys(sortPart)[0];\n            const direction: MangoQuerySortDirection = Object.values(sortPart)[0];\n            const directionMultiplier = direction === 'asc' ? 1 : -1;\n            const valueA: any = (a as any)[fieldName];\n            const valueB: any = (b as any)[fieldName];\n            if (valueA === valueB) {\n                return false;\n            } else {\n                if (valueA > valueB) {\n                    compareResult = 1 * directionMultiplier;\n                    return true;\n                } else {\n                    compareResult = -1 * directionMultiplier;\n                    return true;\n                }\n            }\n        });\n\n        /**\n         * Two different objects should never have the same sort position.\n         * We ensure this by having the unique primaryKey in the sort params\n         * which is added by RxDB if not existing yet.\n         */\n        if (!compareResult) {\n            throw newRxError('SNH', { args: { query, a, b } });\n        }\n\n        return compareResult as any;\n    }\n    return fun;\n}\n\nexport function getLokiLeaderElector(\n    databaseInstanceToken: string,\n    broadcastChannelRefObject: any,\n    databaseName: string\n): LeaderElector {\n    const broadcastChannel = getBroadcastChannelReference(\n        databaseInstanceToken,\n        databaseName,\n        broadcastChannelRefObject\n    );\n    const elector = getLeaderElectorByBroadcastChannel(broadcastChannel);\n    return elector;\n}\n\n/**\n * For multi-instance usage, we send requests to the RxStorage\n * to the current leading instance over the BroadcastChannel.\n */\nexport async function requestRemoteInstance(\n    instance: RxStorageInstanceLoki<any>,\n    operation: string,\n    params: any[]\n): Promise<any | any[]> {\n    const isRxStorageInstanceLoki = typeof (instance as any).query === 'function';\n    const messageType = isRxStorageInstanceLoki ? LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE : LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE;\n\n    const leaderElector = ensureNotFalsy(instance.internals.leaderElector);\n    await waitUntilHasLeader(leaderElector);\n    const broadcastChannel = leaderElector.broadcastChannel;\n\n    type WinningPromise = {\n        retry: boolean,\n        result?: any;\n        error?: any;\n    }\n\n    let whenDeathListener: OnMessageHandler<any>;\n    const leaderDeadPromise = new Promise<WinningPromise>(res => {\n        whenDeathListener = (msg: any) => {\n            if (msg.context === 'leader' && msg.action === 'death') {\n                res({\n                    retry: true\n                });\n            }\n        };\n        broadcastChannel.addEventListener('internal', whenDeathListener);\n    });\n    const requestId = randomCouchString(12);\n    let responseListener: OnMessageHandler<any>;\n    const responsePromise = new Promise<WinningPromise>((res, _rej) => {\n        responseListener = (msg: any) => {\n            if (\n                msg.type === messageType &&\n                msg.response === true &&\n                msg.requestId === requestId\n            ) {\n                if (msg.isError) {\n                    res({\n                        retry: false,\n                        error: msg.result\n                    });\n                } else {\n                    res({\n                        retry: false,\n                        result: msg.result\n                    });\n                }\n            }\n        };\n        broadcastChannel.addEventListener('message', responseListener);\n    });\n\n    // send out the request to the other instance\n    broadcastChannel.postMessage({\n        response: false,\n        type: messageType,\n        operation,\n        params,\n        requestId,\n        databaseName: instance.databaseName,\n        collectionName: instance.collectionName\n    });\n\n\n    return Promise.race([\n        leaderDeadPromise,\n        responsePromise\n    ]).then(firstResolved => {\n\n        // clean up listeners\n        broadcastChannel.removeEventListener('message', responseListener);\n        broadcastChannel.removeEventListener('internal', whenDeathListener);\n\n        if (firstResolved.retry) {\n            /**\n             * The leader died while a remote request was running\n             * we re-run the whole operation.\n             * We cannot just re-run requestRemoteInstance()\n             * because the current instance might be the new leader now\n             * and then we have to use the local state instead of requesting the remote.\n             */\n            return (instance as any)[operation](...params);\n        } else {\n            if (firstResolved.error) {\n                throw firstResolved.error;\n            } else {\n                return firstResolved.result;\n            }\n        }\n    });\n}\n\n/**\n * Handles a request that came from a remote instance via requestRemoteInstance()\n * Runs the requested operation over the local db instance and sends back the result.\n */\nexport async function handleRemoteRequest(\n    instance: RxStorageInstanceLoki<any>,\n    msg: any\n) {\n    if (\n        msg.type === LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n        msg.requestId &&\n        msg.databaseName === instance.databaseName &&\n        msg.collectionName === instance.collectionName &&\n        !msg.response\n    ) {\n        const operation = (msg as any).operation;\n        const params = (msg as any).params;\n        let result: any;\n        let isError = false;\n        try {\n            result = await (instance as any)[operation](...params);\n        } catch (err) {\n            console.dir(err);\n            isError = true;\n            result = err;\n        }\n        const response: LokiRemoteResponseBroadcastMessage = {\n            response: true,\n            requestId: msg.requestId,\n            databaseName: instance.databaseName,\n            collectionName: instance.collectionName,\n            result,\n            isError,\n            type: msg.type\n        };\n        ensureNotFalsy(instance.internals.leaderElector).broadcastChannel.postMessage(response);\n    }\n}\n\n\nexport async function waitUntilHasLeader(leaderElector: LeaderElector) {\n    while (\n        !leaderElector.hasLeader\n    ) {\n        await leaderElector.applyOnce();\n        await promiseWait(0);\n    }\n}\n\n/**\n * If the local state must be used, that one is returned.\n * Returns false if a remote instance must be used.\n */\nexport async function mustUseLocalState(\n    instance: RxStorageInstanceLoki<any>\n): Promise<LokiLocalDatabaseState | false> {\n    if (instance.closed) {\n        /**\n         * If this happens, it means that RxDB made a call to an already closed storage instance.\n         * This must never happen because when RxDB closes a collection or database,\n         * all tasks must be cleared so that no more calls are made the the storage.\n         */\n        throw newRxError('SNH', {\n            args: {\n                instanceClosed: instance.closed,\n                databaseName: instance.databaseName,\n                collectionName: instance.collectionName\n            }\n        });\n    }\n\n\n    if (instance.internals.localState) {\n        return instance.internals.localState;\n    }\n    const leaderElector = ensureNotFalsy(instance.internals.leaderElector);\n    await waitUntilHasLeader(leaderElector);\n\n    /**\n     * It might already have a localState after the applying\n     * because another subtask also called mustUSeLocalState()\n     */\n    if (instance.internals.localState) {\n        return instance.internals.localState;\n    }\n\n    if (\n        leaderElector.isLeader &&\n        !instance.internals.localState\n    ) {\n        // own is leader, use local instance\n        instance.internals.localState = createLokiLocalState<any>({\n            databaseInstanceToken: instance.databaseInstanceToken,\n            databaseName: instance.databaseName,\n            collectionName: instance.collectionName,\n            options: instance.options,\n            schema: (instance as RxStorageInstanceLoki<any>).schema,\n            multiInstance: instance.internals.leaderElector ? true : false\n        }, instance.databaseSettings);\n        return ensureNotFalsy(instance.internals.localState);\n    } else {\n        // other is leader, send message to remote leading instance\n        return false;\n    }\n}\n"],"mappings":"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"}