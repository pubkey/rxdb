{"version":3,"sources":["../../../../src/plugins/lokijs/rx-storage-instance-loki.ts"],"names":["lokijs","Subject","promiseWait","createRevision","getHeightOfRevision","parseRevision","lastOfArray","flatClone","now","ensureNotFalsy","randomCouchString","firstPropertyNameOfObject","newRxError","getPrimaryFieldOfPrimaryKey","LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE","CHANGES_COLLECTION_SUFFIX","closeLokiCollections","getLokiDatabase","getLokiEventKey","OPEN_LOKIJS_STORAGE_INSTANCES","LOKIJS_COLLECTION_DEFAULT_OPTIONS","stripLokiKey","getLeaderElectorByBroadcastChannel","instanceId","RxStorageInstanceLoki","databaseName","collectionName","schema","internals","options","databaseSettings","idleQueue","broadcastChannel","changes$","lastChangefeedSequence","primaryPath","primaryKey","add","leaderElector","awaitLeadership","then","addEventListener","msg","type","requestId","response","operation","params","isError","result","postMessage","getLocalState","ret","localState","mustUseLocalState","hasLeader","applyOnce","isLeader","createLokiLocalState","requestRemoteInstance","responsePromise","Promise","res","rej","listener","removeEventListener","addChangeDocumentMeta","id","lastDoc","changesCollection","chain","simplesort","limit","data","sequence","nextFeedSequence","insert","prepareQuery","mutateableQuery","Object","keys","selector","length","$and","_deleted","sort","isPrimaryInSort","find","p","push","getSortComparator","query","sortOptions","fun","a","b","compareResult","sortPart","fieldName","direction","values","directionMultiplier","valueA","valueB","args","getQueryMatcher","doc","docWithResetDeleted","fakeCollection","binaryIndices","setPrototypeOf","Collection","prototype","fakeResultSet","collection","Resultset","filteredrows","bulkWrite","documentWrites","success","Map","error","forEach","writeRow","startTime","document","documentInDb","by","newRevision","insertedIsDeleted","writeDoc","assign","_rev","_attachments","next","eventId","documentId","change","previous","endTime","set","revInDb","err","status","newRevHeight","isDeleted","$loki","update","databaseState","saveQueue","addWrite","bulkAddRevisions","documents","docData","newWriteRevision","oldRevision","mustUpdate","height","hash","storeAtLoki","findDocumentsById","ids","deleted","preparedQuery","skip","offset","foundDocuments","map","lokiDoc","getAttachmentData","_documentId","_attachmentId","Error","getChangedDocuments","desc","operator","sinceSequence","changedDocuments","useForLastSequence","lastSequence","changeStream","asObservable","close","complete","dbState","run","remove","database","removeCollection","name","indices","indexes","idx","Array","isArray","collectionOptions","unique","addCollection","collections","changesCollectionName","changesCollectionOptions","createLokiStorageInstance","instance"],"mappings":"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","sourcesContent":["import type {\n    DeterministicSortComparator,\n    QueryMatcher,\n    ChangeEvent\n} from 'event-reduce-js';\nimport lokijs from 'lokijs';\nimport {\n    Subject,\n    Observable\n} from 'rxjs';\nimport {\n    promiseWait,\n    createRevision,\n    getHeightOfRevision,\n    parseRevision,\n    lastOfArray,\n    flatClone,\n    now,\n    ensureNotFalsy,\n    randomCouchString,\n    firstPropertyNameOfObject\n} from '../../util';\nimport { newRxError } from '../../rx-error';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema';\nimport type {\n    RxStorageInstance,\n    LokiSettings,\n    RxStorageChangeEvent,\n    RxDocumentData,\n    BulkWriteRow,\n    RxStorageBulkWriteResponse,\n    RxStorageBulkWriteError,\n    RxStorageQueryResult,\n    BlobBuffer,\n    ChangeStreamOnceOptions,\n    RxJsonSchema,\n    MangoQuery,\n    MangoQuerySortPart,\n    MangoQuerySortDirection,\n    LokiStorageInternals,\n    RxStorageChangedDocumentMeta,\n    RxStorageInstanceCreationParams,\n    LokiRemoteRequestBroadcastMessage,\n    LokiRemoteResponseBroadcastMessage,\n    LokiDatabaseSettings,\n    RxDocumentWriteData,\n    LokiLocalDatabaseState\n} from '../../types';\nimport type {\n    CompareFunction\n} from 'array-push-at-sort-position';\nimport {\n    LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE,\n    CHANGES_COLLECTION_SUFFIX,\n    closeLokiCollections,\n    getLokiDatabase,\n    getLokiEventKey,\n    OPEN_LOKIJS_STORAGE_INSTANCES,\n    LOKIJS_COLLECTION_DEFAULT_OPTIONS,\n    stripLokiKey\n} from './lokijs-helper';\nimport type {\n    Collection\n} from 'lokijs';\nimport type {\n    BroadcastChannel,\n    LeaderElector\n} from 'broadcast-channel';\nimport { getLeaderElectorByBroadcastChannel } from '../leader-election';\nimport type { IdleQueue } from 'custom-idle-queue';\n\nlet instanceId = 1;\n\nexport class RxStorageInstanceLoki<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    LokiStorageInternals,\n    LokiSettings\n> {\n\n    public readonly primaryPath: keyof RxDocType;\n    private changes$: Subject<RxStorageChangeEvent<RxDocumentData<RxDocType>>> = new Subject();\n    private lastChangefeedSequence: number = 0;\n    public readonly instanceId = instanceId++;\n\n    public readonly leaderElector?: LeaderElector;\n\n    constructor(\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocType>>,\n        public readonly internals: LokiStorageInternals,\n        public readonly options: Readonly<LokiSettings>,\n        public readonly databaseSettings: LokiDatabaseSettings,\n        public readonly idleQueue: IdleQueue,\n        public readonly broadcastChannel?: BroadcastChannel<LokiRemoteRequestBroadcastMessage | LokiRemoteResponseBroadcastMessage>\n    ) {\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\n        OPEN_LOKIJS_STORAGE_INSTANCES.add(this);\n        if (broadcastChannel) {\n            this.leaderElector = getLeaderElectorByBroadcastChannel(broadcastChannel);\n            this.leaderElector.awaitLeadership().then(() => {\n                // this instance is leader now, so it has to reply to queries from other instances\n                ensureNotFalsy(this.broadcastChannel).addEventListener('message', async (msg) => {\n                    if (\n                        msg.type === LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n                        msg.requestId &&\n                        msg.databaseName === this.databaseName &&\n                        msg.collectionName === this.collectionName &&\n                        !msg.response\n                    ) {\n\n                        const operation = (msg as any).operation;\n                        const params = (msg as any).params;\n                        let result: any;\n                        let isError = false;\n                        try {\n                            result = await (this as any)[operation](...params);\n                        } catch (err) {\n                            result = err;\n                            isError = true;\n                        }\n                        const response: LokiRemoteResponseBroadcastMessage = {\n                            response: true,\n                            requestId: msg.requestId,\n                            databaseName: this.databaseName,\n                            collectionName: this.collectionName,\n                            result,\n                            isError,\n                            type: msg.type\n                        };\n                        ensureNotFalsy(this.broadcastChannel).postMessage(response);\n                    }\n                });\n            });\n        }\n    }\n\n    private getLocalState() {\n        const ret = ensureNotFalsy(this.internals.localState);\n        return ret;\n    }\n\n    /**\n     * If the local state must be used, that one is returned.\n     * Returns false if a remote instance must be used.\n     */\n    private async mustUseLocalState(): Promise<LokiLocalDatabaseState | false> {\n        if (this.internals.localState) {\n            return this.internals.localState;\n        }\n        const leaderElector = ensureNotFalsy(this.leaderElector);\n        while (\n            !leaderElector.hasLeader\n        ) {\n            await leaderElector.applyOnce();\n\n            // TODO why do we need this line to pass the tests?\n            // otherwise we somehow do never get a leader.\n            /**\n             * TODO why do we need this line to pass the tests?\n             * Without it, we somehow do never get a leader.\n             * Does applyOnce() fully block the cpu?\n             */\n            await promiseWait(0); // TODO remove this line\n        }\n        if (\n            leaderElector.isLeader &&\n            !this.internals.localState\n        ) {\n            // own is leader, use local instance\n            this.internals.localState = createLokiLocalState({\n                databaseName: this.databaseName,\n                collectionName: this.collectionName,\n                options: this.options,\n                schema: this.schema,\n                idleQueue: this.idleQueue,\n                broadcastChannel: this.broadcastChannel\n            }, this.databaseSettings);\n            return this.getLocalState();\n        } else {\n            // other is leader, send message to remote leading instance\n            return false;\n        }\n    }\n\n    private async requestRemoteInstance(\n        operation: string,\n        params: any[]\n    ): Promise<any | any[]> {\n        const broadcastChannel = ensureNotFalsy(this.broadcastChannel);\n        const requestId = randomCouchString(12);\n        const responsePromise = new Promise<any>((res, rej) => {\n            const listener = (msg: any) => {\n                if (\n                    msg.type === LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n                    msg.response === true &&\n                    msg.requestId === requestId\n                ) {\n                    if (msg.isError) {\n                        broadcastChannel.removeEventListener('message', listener);\n                        rej(msg.result);\n                    } else {\n                        broadcastChannel.removeEventListener('message', listener);\n                        res(msg.result);\n                    }\n                }\n            };\n            broadcastChannel.addEventListener('message', listener);\n        });\n\n        broadcastChannel.postMessage({\n            response: false,\n            type: LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE,\n            operation,\n            params,\n            requestId,\n            databaseName: this.databaseName,\n            collectionName: this.collectionName\n        });\n        const result = await responsePromise;\n        return result;\n    }\n\n    /**\n     * Adds an entry to the changes feed\n     * that can be queried to check which documents have been\n     * changed since sequence X.\n     */\n    private async addChangeDocumentMeta(id: string) {\n        const localState = await this.getLocalState();\n        if (!this.lastChangefeedSequence) {\n            const lastDoc = localState.changesCollection\n                .chain()\n                .simplesort('sequence', true)\n                .limit(1)\n                .data()[0];\n            if (lastDoc) {\n                this.lastChangefeedSequence = lastDoc.sequence;\n            }\n        }\n\n        const nextFeedSequence = this.lastChangefeedSequence + 1;\n        localState.changesCollection.insert({\n            id,\n            sequence: nextFeedSequence\n        });\n        this.lastChangefeedSequence = nextFeedSequence;\n    }\n\n    prepareQuery(mutateableQuery: MangoQuery<RxDocType>) {\n        if (Object.keys(mutateableQuery.selector).length > 0) {\n            mutateableQuery.selector = {\n                $and: [\n                    {\n                        _deleted: false\n                    },\n                    mutateableQuery.selector\n                ]\n            };\n        } else {\n            mutateableQuery.selector = {\n                _deleted: false\n            };\n        }\n\n        /**\n         * To ensure a deterministic sorting,\n         * we have to ensure the primary key is always part\n         * of the sort query.\n         */\n        if (!mutateableQuery.sort) {\n            mutateableQuery.sort = [{ [this.primaryPath]: 'asc' }] as any;\n        } else {\n            const isPrimaryInSort = mutateableQuery.sort\n                .find(p => firstPropertyNameOfObject(p) === this.primaryPath);\n            if (!isPrimaryInSort) {\n                mutateableQuery.sort.push({ [this.primaryPath]: 'asc' } as any);\n            }\n        }\n\n        return mutateableQuery;\n    }\n\n    getSortComparator(query: MangoQuery<RxDocType>): DeterministicSortComparator<RxDocType> {\n        // TODO if no sort is given, use sort by primary.\n        // This should be done inside of RxDB and not in the storage implementations.\n        const sortOptions: MangoQuerySortPart<RxDocType>[] = query.sort ? (query.sort as any) : [{\n            [this.primaryPath]: 'asc'\n        }];\n        const fun: DeterministicSortComparator<RxDocType> = (a: RxDocType, b: RxDocType) => {\n            let compareResult: number = 0; // 1 | -1\n            sortOptions.find(sortPart => {\n                const fieldName: string = Object.keys(sortPart)[0];\n                const direction: MangoQuerySortDirection = Object.values(sortPart)[0];\n                const directionMultiplier = direction === 'asc' ? 1 : -1;\n                const valueA: any = (a as any)[fieldName];\n                const valueB: any = (b as any)[fieldName];\n                if (valueA === valueB) {\n                    return false;\n                } else {\n                    if (valueA > valueB) {\n                        compareResult = 1 * directionMultiplier;\n                        return true;\n                    } else {\n                        compareResult = -1 * directionMultiplier;\n                        return true;\n                    }\n                }\n            });\n\n            /**\n             * Two different objects should never have the same sort position.\n             * We ensure this by having the unique primaryKey in the sort params\n             * at this.prepareQuery()\n             */\n            if (!compareResult) {\n                throw newRxError('SNH', { args: { query, a, b } });\n            }\n\n            return compareResult as any;\n        }\n        return fun;\n    }\n\n    /**\n     * Returns a function that determines if a document matches a query selector.\n     * It is important to have the exact same logix as lokijs uses, to be sure\n     * that the event-reduce algorithm works correct.\n     * But LokisJS does not export such a function, the query logic is deep inside of\n     * the Resultset prototype.\n     * Because I am lazy, I do not copy paste and maintain that code.\n     * Instead we create a fake Resultset and apply the prototype method Resultset.prototype.find(),\n     * same with Collection.\n     */\n    getQueryMatcher(query: MangoQuery<RxDocType>): QueryMatcher<RxDocumentWriteData<RxDocType>> {\n        const fun: QueryMatcher<RxDocumentWriteData<RxDocType>> = (doc: RxDocumentWriteData<RxDocType>) => {\n            const docWithResetDeleted = flatClone(doc);\n            docWithResetDeleted._deleted = !!docWithResetDeleted._deleted;\n\n            const fakeCollection = {\n                data: [docWithResetDeleted],\n                binaryIndices: {}\n            };\n            Object.setPrototypeOf(fakeCollection, (lokijs as any).Collection.prototype);\n            const fakeResultSet: any = {\n                collection: fakeCollection\n            };\n            Object.setPrototypeOf(fakeResultSet, (lokijs as any).Resultset.prototype);\n            fakeResultSet.find(query.selector, true);\n\n            const ret = fakeResultSet.filteredrows.length > 0;\n            return ret;\n        }\n        return fun;\n    }\n\n    async bulkWrite(documentWrites: BulkWriteRow<RxDocType>[]): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        if (documentWrites.length === 0) {\n            throw newRxError('P2', {\n                args: {\n                    documentWrites\n                }\n            });\n        }\n\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('bulkWrite', [documentWrites]);\n        }\n\n        /**\n         * lokijs is in memory and non-async, so we emulate async behavior\n         * to ensure all RxStorage implementations behave equal.\n         */\n        await promiseWait(0);\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            success: new Map(),\n            error: new Map()\n        };\n\n        documentWrites.forEach(writeRow => {\n            const startTime = now();\n            const id: string = writeRow.document[this.primaryPath] as any;\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n\n            if (!documentInDb) {\n                // insert new document\n                const newRevision = '1-' + createRevision(writeRow.document);\n\n                /**\n                 * It is possible to insert already deleted documents,\n                 * this can happen on replication.\n                 */\n                const insertedIsDeleted = writeRow.document._deleted ? true : false;\n\n                const writeDoc = Object.assign(\n                    {},\n                    writeRow.document,\n                    {\n                        _rev: newRevision,\n                        _deleted: insertedIsDeleted,\n                        // TODO attachments are currently not working with lokijs\n                        _attachments: {} as any\n                    }\n                );\n                localState.collection.insert(flatClone(writeDoc));\n                if (!insertedIsDeleted) {\n                    this.addChangeDocumentMeta(id);\n                    this.changes$.next({\n                        eventId: getLokiEventKey(false, id, newRevision),\n                        documentId: id,\n                        change: {\n                            doc: writeDoc,\n                            id,\n                            operation: 'INSERT',\n                            previous: null\n                        },\n                        startTime,\n                        endTime: now()\n                    });\n                }\n                ret.success.set(id, writeDoc as any);\n            } else {\n                // update existing document\n                const revInDb: string = documentInDb._rev;\n\n                // inserting a deleted document is possible\n                // without sending the previous data.\n                if (!writeRow.previous && documentInDb._deleted) {\n                    writeRow.previous = documentInDb;\n                }\n\n                if (\n                    (\n                        !writeRow.previous &&\n                        !documentInDb._deleted\n                    ) ||\n                    (\n                        !!writeRow.previous &&\n                        revInDb !== writeRow.previous._rev\n                    )\n                ) {\n                    // conflict error\n                    const err: RxStorageBulkWriteError<RxDocType> = {\n                        isError: true,\n                        status: 409,\n                        documentId: id,\n                        writeRow: writeRow\n                    };\n                    ret.error.set(id, err);\n                } else {\n                    const newRevHeight = getHeightOfRevision(revInDb) + 1;\n                    const newRevision = newRevHeight + '-' + createRevision(writeRow.document);\n                    const isDeleted = !!writeRow.document._deleted;\n                    const writeDoc: any = Object.assign(\n                        {},\n                        writeRow.document,\n                        {\n                            $loki: documentInDb.$loki,\n                            _rev: newRevision,\n                            _deleted: isDeleted,\n                            // TODO attachments are currently not working with lokijs\n                            _attachments: {}\n                        }\n                    );\n                    localState.collection.update(writeDoc);\n                    this.addChangeDocumentMeta(id);\n\n                    let change: ChangeEvent<RxDocumentData<RxDocType>> | null = null;\n                    if (writeRow.previous && writeRow.previous._deleted && !writeDoc._deleted) {\n                        change = {\n                            id,\n                            operation: 'INSERT',\n                            previous: null,\n                            doc: stripLokiKey(writeDoc)\n                        };\n                    } else if (writeRow.previous && !writeRow.previous._deleted && !writeDoc._deleted) {\n                        change = {\n                            id,\n                            operation: 'UPDATE',\n                            previous: writeRow.previous,\n                            doc: stripLokiKey(writeDoc)\n                        };\n                    } else if (writeRow.previous && !writeRow.previous._deleted && writeDoc._deleted) {\n                        /**\n                         * On delete, we send the 'new' rev in the previous property,\n                         * to have the equal behavior as pouchdb.\n                         */\n                        const previous = flatClone(writeRow.previous);\n                        previous._rev = newRevision;\n                        change = {\n                            id,\n                            operation: 'DELETE',\n                            previous,\n                            doc: null\n                        };\n                    }\n                    if (!change) {\n                        throw newRxError('SNH', { args: { writeRow } });\n                    }\n                    this.changes$.next({\n                        eventId: getLokiEventKey(false, id, newRevision),\n                        documentId: id,\n                        change,\n                        startTime,\n                        endTime: now()\n                    });\n                    ret.success.set(id, stripLokiKey(writeDoc));\n                }\n            }\n        });\n        localState.databaseState.saveQueue.addWrite();\n        return ret;\n    }\n\n    async bulkAddRevisions(documents: RxDocumentData<RxDocType>[]): Promise<void> {\n        if (documents.length === 0) {\n            throw newRxError('P3', {\n                args: {\n                    documents\n                }\n            });\n        }\n\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('bulkAddRevisions', [documents]);\n        }\n\n        /**\n         * lokijs is in memory and non-async, so we emulate async behavior\n         * to ensure all RxStorage implementations behave equal.\n         */\n        await promiseWait(0);\n\n        documents.forEach(docData => {\n            const startTime = now();\n            const id: string = docData[this.primaryPath] as any;\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n            if (!documentInDb) {\n                // document not here, so we can directly insert\n                localState.collection.insert(flatClone(docData));\n                this.changes$.next({\n                    documentId: id,\n                    eventId: getLokiEventKey(false, id, docData._rev),\n                    change: {\n                        doc: docData,\n                        id,\n                        operation: 'INSERT',\n                        previous: null\n                    },\n                    startTime,\n                    endTime: now()\n                });\n                this.addChangeDocumentMeta(id);\n            } else {\n                const newWriteRevision = parseRevision(docData._rev);\n                const oldRevision = parseRevision(documentInDb._rev);\n\n                let mustUpdate: boolean = false;\n                if (newWriteRevision.height !== oldRevision.height) {\n                    // height not equal, compare base on height\n                    if (newWriteRevision.height > oldRevision.height) {\n                        mustUpdate = true;\n                    }\n                } else if (newWriteRevision.hash > oldRevision.hash) {\n                    // equal height but new write has the 'winning' hash\n                    mustUpdate = true;\n                }\n                if (mustUpdate) {\n                    const storeAtLoki = flatClone(docData) as any;\n                    storeAtLoki.$loki = documentInDb.$loki;\n                    localState.collection.update(storeAtLoki);\n                    let change: ChangeEvent<RxDocumentData<RxDocType>> | null = null;\n                    if (documentInDb._deleted && !docData._deleted) {\n                        change = {\n                            id,\n                            operation: 'INSERT',\n                            previous: null,\n                            doc: docData\n                        };\n                    } else if (!documentInDb._deleted && !docData._deleted) {\n                        change = {\n                            id,\n                            operation: 'UPDATE',\n                            previous: stripLokiKey(documentInDb),\n                            doc: docData\n                        };\n                    } else if (!documentInDb._deleted && docData._deleted) {\n                        change = {\n                            id,\n                            operation: 'DELETE',\n                            previous: stripLokiKey(documentInDb),\n                            doc: null\n                        };\n                    } else if (documentInDb._deleted && docData._deleted) {\n                        change = null;\n                    }\n                    if (change) {\n                        this.changes$.next({\n                            documentId: id,\n                            eventId: getLokiEventKey(false, id, docData._rev),\n                            change,\n                            startTime,\n                            endTime: now()\n                        });\n                        this.addChangeDocumentMeta(id);\n                    }\n                }\n            }\n        });\n        localState.databaseState.saveQueue.addWrite();\n    }\n    async findDocumentsById(ids: string[], deleted: boolean): Promise<Map<string, RxDocumentData<RxDocType>>> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('findDocumentsById', [ids, deleted]);\n        }\n\n        const ret: Map<string, RxDocumentData<RxDocType>> = new Map();\n        ids.forEach(id => {\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n            if (\n                documentInDb &&\n                (!documentInDb._deleted || deleted)\n            ) {\n                ret.set(id, stripLokiKey(documentInDb));\n            }\n        });\n        return ret;\n    }\n    async query(preparedQuery: MangoQuery<RxDocType>): Promise<RxStorageQueryResult<RxDocType>> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('query', [preparedQuery]);\n        }\n\n        let query = localState.collection\n            .chain()\n            .find(preparedQuery.selector);\n\n        if (preparedQuery.sort) {\n            query = query.sort(this.getSortComparator(preparedQuery));\n        }\n\n        /**\n         * Offset must be used before limit in LokiJS\n         * @link https://github.com/techfort/LokiJS/issues/570\n         */\n        if (preparedQuery.skip) {\n            query = query.offset(preparedQuery.skip);\n        }\n\n        if (preparedQuery.limit) {\n            query = query.limit(preparedQuery.limit);\n        }\n\n        const foundDocuments = query.data().map(lokiDoc => stripLokiKey(lokiDoc));\n        return {\n            documents: foundDocuments\n        };\n    }\n    getAttachmentData(_documentId: string, _attachmentId: string): Promise<BlobBuffer> {\n        throw new Error('Attachments are not implemented in the lokijs RxStorage. Make a pull request.');\n    }\n    async getChangedDocuments(\n        options: ChangeStreamOnceOptions\n    ): Promise<{\n        changedDocuments: RxStorageChangedDocumentMeta[];\n        lastSequence: number;\n    }> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('getChangedDocuments', [options]);\n        }\n\n        const desc = options.direction === 'before';\n        const operator = options.direction === 'after' ? '$gt' : '$lt';\n\n        let query = localState.changesCollection\n            .chain()\n            .find({\n                sequence: {\n                    [operator]: options.sinceSequence\n                }\n            })\n            .simplesort(\n                'sequence',\n                desc\n            );\n        if (options.limit) {\n            query = query.limit(options.limit);\n        }\n        const changedDocuments: RxStorageChangedDocumentMeta[] = query\n            .data()\n            .map(result => ({\n                id: result.id,\n                sequence: result.sequence\n            }));\n\n        const useForLastSequence = !desc ? lastOfArray(changedDocuments) : changedDocuments[0];\n\n        const ret: {\n            changedDocuments: RxStorageChangedDocumentMeta[];\n            lastSequence: number;\n        } = {\n            changedDocuments,\n            lastSequence: useForLastSequence ? useForLastSequence.sequence : options.sinceSequence\n        }\n\n        return ret;\n    }\n    changeStream(): Observable<RxStorageChangeEvent<RxDocumentData<RxDocType>>> {\n        return this.changes$.asObservable();\n    }\n    async close(): Promise<void> {\n        this.changes$.complete();\n        OPEN_LOKIJS_STORAGE_INSTANCES.delete(this);\n\n        if (this.internals.localState) {\n            const localState = await this.internals.localState;\n            const dbState = await getLokiDatabase(\n                this.databaseName,\n                this.databaseSettings,\n                this.idleQueue\n            );\n            await dbState.saveQueue.run();\n            await closeLokiCollections(\n                this.databaseName,\n                [\n                    localState.collection,\n                    localState.changesCollection\n                ]\n            );\n        }\n    }\n    async remove(): Promise<void> {\n        const localState = await this.mustUseLocalState();\n        if (!localState) {\n            return this.requestRemoteInstance('remove', []);\n        }\n        localState.databaseState.database.removeCollection(this.collectionName);\n        localState.databaseState.database.removeCollection(localState.changesCollection.name);\n    }\n}\n\nexport async function createLokiLocalState<RxDocType>(\n    params: RxStorageInstanceCreationParams<RxDocType, LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiLocalDatabaseState> {\n    if (!params.options) {\n        params.options = {};\n    }\n\n    const databaseState = await getLokiDatabase(\n        params.databaseName,\n        databaseSettings,\n        params.idleQueue\n    );\n\n    /**\n     * Construct loki indexes from RxJsonSchema indexes.\n     * TODO what about compound indexes? Are they possible in lokijs?\n     */\n    const indices: string[] = [];\n    if (params.schema.indexes) {\n        params.schema.indexes.forEach(idx => {\n            if (!Array.isArray(idx)) {\n                indices.push(idx);\n            }\n        });\n    }\n    /**\n     * LokiJS has no concept of custom primary key, they use a number-id that is generated.\n     * To be able to query fast by primary key, we always add an index to the primary.\n     */\n    const primaryKey = getPrimaryFieldOfPrimaryKey(params.schema.primaryKey);\n    indices.push(primaryKey as string);\n\n    /**\n     * TODO disable stuff we do not need from CollectionOptions\n     */\n    const collectionOptions: Partial<CollectionOptions<RxDocumentData<RxDocType>>> = Object.assign(\n        {},\n        params.options.collection,\n        {\n            indices: indices as string[],\n            unique: [primaryKey]\n        } as any,\n        LOKIJS_COLLECTION_DEFAULT_OPTIONS\n    );\n\n    const collection: Collection = databaseState.database.addCollection(\n        params.collectionName,\n        collectionOptions as any\n    );\n    databaseState.collections[params.collectionName] = collection;\n\n    const changesCollectionName = params.collectionName + CHANGES_COLLECTION_SUFFIX;\n    const changesCollectionOptions = Object.assign({\n        unique: ['eventId'],\n        indices: ['sequence']\n    }, LOKIJS_COLLECTION_DEFAULT_OPTIONS)\n    const changesCollection: Collection = databaseState.database.addCollection(\n        changesCollectionName,\n        changesCollectionOptions\n    );\n    databaseState.collections[params.collectionName] = changesCollection;\n\n    const ret: LokiLocalDatabaseState = {\n        databaseState,\n        collection,\n        changesCollection\n    };\n\n    return ret;\n}\n\n\nexport async function createLokiStorageInstance<RxDocType>(\n    params: RxStorageInstanceCreationParams<RxDocType, LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<RxStorageInstanceLoki<RxDocType>> {\n    const internals: LokiStorageInternals = {};\n    // optimisation shortcut, directly create db is non multi instance.\n    if (!params.broadcastChannel) {\n        internals.localState = createLokiLocalState(params, databaseSettings);\n        await internals.localState;\n    }\n\n    const instance = new RxStorageInstanceLoki(\n        params.databaseName,\n        params.collectionName,\n        params.schema,\n        internals,\n        params.options,\n        databaseSettings,\n        params.idleQueue,\n        params.broadcastChannel\n    );\n\n    return instance;\n}\n"],"file":"rx-storage-instance-loki.js"}