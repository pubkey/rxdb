{"version":3,"file":"loki-save-queue.js","names":["PROMISE_RESOLVE_VOID","requestIdlePromise","LokiSaveQueue","lokiDatabase","databaseSettings","writesSinceLastRun","saveQueue","saveQueueC","addWrite","run","adapter","then","writeAmount","Promise","res","rej","saveDatabase","err","autosaveCallback","catch"],"sources":["../../../../src/plugins/storage-lokijs/loki-save-queue.ts"],"sourcesContent":["import type { LokiDatabaseSettings } from '../../types';\nimport {\n    PROMISE_RESOLVE_VOID,\n    requestIdlePromise\n} from '../utils';\n\n/**\n * The autosave feature of lokijs has strange behaviors\n * and often runs a save in critical moments when other\n * more important tasks are running.\n * So instead we use a custom save queue that ensures we\n * only run loki.saveDatabase() when nothing else is running.\n */\nexport class LokiSaveQueue {\n    public writesSinceLastRun: number = 0;\n\n    /**\n     * Ensures that we do not run multiple saves\n     * in parallel\n     */\n    public saveQueue: Promise<void> = PROMISE_RESOLVE_VOID;\n    // track amount of non-finished save calls in the queue.\n    public saveQueueC = 0;\n\n    constructor(\n        public readonly lokiDatabase: Loki,\n        public readonly databaseSettings: LokiDatabaseSettings\n    ) {\n\n    }\n\n    public addWrite() {\n        this.writesSinceLastRun = this.writesSinceLastRun + 1;\n        this.run();\n    }\n\n    public run() {\n        if (\n            // no persistence adapter given, so we do not need to save\n            !this.databaseSettings.adapter ||\n            // do not add more then two pending calls to the queue.\n            this.saveQueueC > 2\n\n        ) {\n            return this.saveQueue;\n        }\n\n        this.saveQueueC = this.saveQueueC + 1;\n        this.saveQueue = this.saveQueue\n            .then(async () => {\n                /**\n                 * Always wait until the JavaScript process is idle.\n                 * This ensures that CPU blocking writes are finished\n                 * before we proceed.\n                 */\n                await requestIdlePromise();\n\n                // no write happened since the last save call\n                if (this.writesSinceLastRun === 0) {\n                    return;\n                }\n\n                /**\n                 * Because LokiJS is a in-memory database,\n                 * we can just wait until the JavaScript process is idle\n                 * via requestIdlePromise(). Then we know that nothing important\n                 * is running at the moment.\n                 */\n                await requestIdlePromise().then(() => requestIdlePromise());\n\n                if (this.writesSinceLastRun === 0) {\n                    return;\n                }\n\n                const writeAmount = this.writesSinceLastRun;\n                this.writesSinceLastRun = 0;\n                return new Promise<void>((res, rej) => {\n                    this.lokiDatabase.saveDatabase(err => {\n                        if (err) {\n                            this.writesSinceLastRun = this.writesSinceLastRun + writeAmount;\n                            rej(err);\n                        } else {\n                            if (this.databaseSettings.autosaveCallback) {\n                                this.databaseSettings.autosaveCallback();\n                            }\n                            res();\n                        }\n                    });\n                });\n            })\n            .catch(() => { })\n            .then(() => {\n                this.saveQueueC = this.saveQueueC - 1;\n            });\n        return this.saveQueue;\n    }\n}\n"],"mappings":"AACA,SACIA,oBAAoB,EACpBC,kBAAkB,QACf,UAAU;;AAEjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAaC,aAAa;EAGtB;AACJ;AACA;AACA;;EAEI;;EAGA,uBACoBC,YAAkB,EAClBC,gBAAsC,EACxD;IAAA,KAbKC,kBAAkB,GAAW,CAAC;IAAA,KAM9BC,SAAS,GAAkBN,oBAAoB;IAAA,KAE/CO,UAAU,GAAG,CAAC;IAAA,KAGDJ,YAAkB,GAAlBA,YAAkB;IAAA,KAClBC,gBAAsC,GAAtCA,gBAAsC;EAG1D;EAAC;EAAA,OAEMI,QAAQ,GAAf,oBAAkB;IACd,IAAI,CAACH,kBAAkB,GAAG,IAAI,CAACA,kBAAkB,GAAG,CAAC;IACrD,IAAI,CAACI,GAAG,EAAE;EACd,CAAC;EAAA,OAEMA,GAAG,GAAV,eAAa;IACT;IACI;IACA,CAAC,IAAI,CAACL,gBAAgB,CAACM,OAAO;IAC9B;IACA,IAAI,CAACH,UAAU,GAAG,CAAC,EAErB;MACE,OAAO,IAAI,CAACD,SAAS;IACzB;IAEA,IAAI,CAACC,UAAU,GAAG,IAAI,CAACA,UAAU,GAAG,CAAC;IACrC,IAAI,CAACD,SAAS,GAAG,IAAI,CAACA,SAAS,CAC1BK,IAAI,CAAC,YAAY;MACd;AAChB;AACA;AACA;AACA;MACgB,MAAMV,kBAAkB,EAAE;;MAE1B;MACA,IAAI,IAAI,CAACI,kBAAkB,KAAK,CAAC,EAAE;QAC/B;MACJ;;MAEA;AAChB;AACA;AACA;AACA;AACA;MACgB,MAAMJ,kBAAkB,EAAE,CAACU,IAAI,CAAC,MAAMV,kBAAkB,EAAE,CAAC;MAE3D,IAAI,IAAI,CAACI,kBAAkB,KAAK,CAAC,EAAE;QAC/B;MACJ;MAEA,IAAMO,WAAW,GAAG,IAAI,CAACP,kBAAkB;MAC3C,IAAI,CAACA,kBAAkB,GAAG,CAAC;MAC3B,OAAO,IAAIQ,OAAO,CAAO,CAACC,GAAG,EAAEC,GAAG,KAAK;QACnC,IAAI,CAACZ,YAAY,CAACa,YAAY,CAACC,GAAG,IAAI;UAClC,IAAIA,GAAG,EAAE;YACL,IAAI,CAACZ,kBAAkB,GAAG,IAAI,CAACA,kBAAkB,GAAGO,WAAW;YAC/DG,GAAG,CAACE,GAAG,CAAC;UACZ,CAAC,MAAM;YACH,IAAI,IAAI,CAACb,gBAAgB,CAACc,gBAAgB,EAAE;cACxC,IAAI,CAACd,gBAAgB,CAACc,gBAAgB,EAAE;YAC5C;YACAJ,GAAG,EAAE;UACT;QACJ,CAAC,CAAC;MACN,CAAC,CAAC;IACN,CAAC,CAAC,CACDK,KAAK,CAAC,MAAM,CAAE,CAAC,CAAC,CAChBR,IAAI,CAAC,MAAM;MACR,IAAI,CAACJ,UAAU,GAAG,IAAI,CAACA,UAAU,GAAG,CAAC;IACzC,CAAC,CAAC;IACN,OAAO,IAAI,CAACD,SAAS;EACzB,CAAC;EAAA;AAAA"}