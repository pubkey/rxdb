{"version":3,"file":"event-reduce.js","names":["calculateActionName","runAction","rxChangeEventToEventReduceChangeEvent","arrayFilterNotEmpty","clone","ensureNotFalsy","normalizeMangoQuery","getSortFieldsOfQuery","primaryKey","query","sort","length","map","part","Object","keys","RXQUERY_QUERY_PARAMS_CACHE","WeakMap","getQueryParams","rxQuery","has","collection","preparedQuery","getPreparedQuery","normalizedMangoQuery","storageInstance","schema","mangoQuery","primaryPath","sortComparator","database","storage","statics","getSortComparator","jsonSchema","useSortComparator","docA","docB","sortComparatorData","queryMatcher","getQueryMatcher","useQueryMatcher","doc","queryMatcherData","ret","skip","limit","sortFields","set","get","calculateNewResults","rxChangeEvents","eventReduce","runFullQueryAgain","queryParams","previousResults","_result","docsData","slice","previousResultsMap","docsDataMap","changed","eventReduceEvents","cE","filter","foundNonOptimizeable","find","eventReduceEvent","stateResolveFunctionInput","changeEvent","keyDocumentMap","actionName","newResults"],"sources":["../../src/event-reduce.ts"],"sourcesContent":["import {\n    ActionName,\n    calculateActionName,\n    runAction,\n    QueryParams,\n    QueryMatcher,\n    DeterministicSortComparator,\n    StateResolveFunctionInput,\n    ChangeEvent\n} from 'event-reduce-js';\nimport type {\n    RxQuery,\n    MangoQuery,\n    RxChangeEvent,\n    RxDocumentWriteData,\n    PreparedQuery,\n    StringKeys,\n    RxDocumentData\n} from './types';\nimport { rxChangeEventToEventReduceChangeEvent } from './rx-change-event';\nimport { arrayFilterNotEmpty, clone, ensureNotFalsy } from './util';\nimport { normalizeMangoQuery } from './rx-query-helper';\n\nexport type EventReduceResultNeg = {\n    runFullQueryAgain: true,\n};\nexport type EventReduceResultPos<RxDocumentType> = {\n    runFullQueryAgain: false,\n    changed: boolean,\n    newResults: RxDocumentType[];\n};\nexport type EventReduceResult<RxDocumentType> = EventReduceResultNeg | EventReduceResultPos<RxDocumentType>;\n\n\nexport function getSortFieldsOfQuery<RxDocType>(\n    primaryKey: StringKeys<RxDocumentData<RxDocType>>,\n    query: MangoQuery<RxDocType>\n): (string | StringKeys<RxDocType>)[] {\n    if (!query.sort || query.sort.length === 0) {\n        return [primaryKey];\n    } else {\n        return query.sort.map(part => Object.keys(part)[0]);\n    }\n}\n\n\n\nexport const RXQUERY_QUERY_PARAMS_CACHE: WeakMap<RxQuery, QueryParams<any>> = new WeakMap();\nexport function getQueryParams<RxDocType>(\n    rxQuery: RxQuery<RxDocType>\n): QueryParams<RxDocType> {\n    if (!RXQUERY_QUERY_PARAMS_CACHE.has(rxQuery)) {\n        const collection = rxQuery.collection;\n        const preparedQuery: PreparedQuery<RxDocType> = rxQuery.getPreparedQuery();\n        const normalizedMangoQuery = normalizeMangoQuery(\n            collection.storageInstance.schema,\n            clone(rxQuery.mangoQuery)\n        );\n        const primaryKey = collection.schema.primaryPath;\n\n        /**\n         * Create a custom sort comparator\n         * that uses the hooks to ensure\n         * we send for example compressed documents to be sorted by compressed queries.\n         */\n        const sortComparator = collection.database.storage.statics.getSortComparator(\n            collection.schema.jsonSchema,\n            preparedQuery\n        );\n\n        const useSortComparator: DeterministicSortComparator<RxDocType> = (docA: RxDocType, docB: RxDocType) => {\n            const sortComparatorData = {\n                docA,\n                docB,\n                rxQuery\n            };\n            return sortComparator(sortComparatorData.docA, sortComparatorData.docB);\n        };\n\n        /**\n         * Create a custom query matcher\n         * that uses the hooks to ensure\n         * we send for example compressed documents to match compressed queries.\n         */\n        const queryMatcher = collection.database.storage.statics.getQueryMatcher(\n            collection.schema.jsonSchema,\n            preparedQuery\n        );\n        const useQueryMatcher: QueryMatcher<RxDocumentWriteData<RxDocType>> = (doc: RxDocumentWriteData<RxDocType>) => {\n            const queryMatcherData = {\n                doc,\n                rxQuery\n            };\n            return queryMatcher(queryMatcherData.doc);\n        };\n\n\n        const ret: QueryParams<any> = {\n            primaryKey: rxQuery.collection.schema.primaryPath as any,\n            skip: normalizedMangoQuery.skip,\n            limit: normalizedMangoQuery.limit,\n            sortFields: getSortFieldsOfQuery(primaryKey, normalizedMangoQuery) as string[],\n            sortComparator: useSortComparator,\n            queryMatcher: useQueryMatcher\n        };\n        RXQUERY_QUERY_PARAMS_CACHE.set(rxQuery, ret);\n        return ret;\n    } else {\n        return RXQUERY_QUERY_PARAMS_CACHE.get(rxQuery) as QueryParams<RxDocType>;\n    }\n}\n\n\nexport function calculateNewResults<RxDocumentType>(\n    rxQuery: RxQuery<RxDocumentType>,\n    rxChangeEvents: RxChangeEvent<RxDocumentType>[]\n): EventReduceResult<RxDocumentType> {\n    if (!rxQuery.collection.database.eventReduce) {\n        return {\n            runFullQueryAgain: true\n        };\n    }\n    const queryParams = getQueryParams(rxQuery);\n    const previousResults: RxDocumentType[] = ensureNotFalsy(rxQuery._result).docsData.slice(0);\n    const previousResultsMap: Map<string, RxDocumentType> = ensureNotFalsy(rxQuery._result).docsDataMap;\n    let changed: boolean = false;\n\n    const eventReduceEvents: ChangeEvent<RxDocumentType>[] = rxChangeEvents\n        .map(cE => rxChangeEventToEventReduceChangeEvent(cE))\n        .filter(arrayFilterNotEmpty);\n    const foundNonOptimizeable = eventReduceEvents.find(eventReduceEvent => {\n        const stateResolveFunctionInput: StateResolveFunctionInput<RxDocumentType> = {\n            queryParams,\n            changeEvent: eventReduceEvent,\n            previousResults,\n            keyDocumentMap: previousResultsMap\n        }\n\n        const actionName: ActionName = calculateActionName(stateResolveFunctionInput);\n        if (actionName === 'runFullQueryAgain') {\n            return true;\n        } else if (actionName !== 'doNothing') {\n            changed = true;\n            runAction(\n                actionName,\n                queryParams,\n                eventReduceEvent,\n                previousResults,\n                previousResultsMap\n            );\n            return false;\n        }\n    });\n    if (foundNonOptimizeable) {\n        return {\n            runFullQueryAgain: true,\n        };\n    } else {\n        return {\n            runFullQueryAgain: false,\n            changed,\n            newResults: previousResults\n        };\n    }\n}\n"],"mappings":"AAAA,SAEIA,mBAFJ,EAGIC,SAHJ,QASO,iBATP;AAmBA,SAASC,qCAAT,QAAsD,mBAAtD;AACA,SAASC,mBAAT,EAA8BC,KAA9B,EAAqCC,cAArC,QAA2D,QAA3D;AACA,SAASC,mBAAT,QAAoC,mBAApC;AAaA,OAAO,SAASC,oBAAT,CACHC,UADG,EAEHC,KAFG,EAG+B;EAClC,IAAI,CAACA,KAAK,CAACC,IAAP,IAAeD,KAAK,CAACC,IAAN,CAAWC,MAAX,KAAsB,CAAzC,EAA4C;IACxC,OAAO,CAACH,UAAD,CAAP;EACH,CAFD,MAEO;IACH,OAAOC,KAAK,CAACC,IAAN,CAAWE,GAAX,CAAe,UAAAC,IAAI;MAAA,OAAIC,MAAM,CAACC,IAAP,CAAYF,IAAZ,EAAkB,CAAlB,CAAJ;IAAA,CAAnB,CAAP;EACH;AACJ;AAID,OAAO,IAAMG,0BAA8D,GAAG,IAAIC,OAAJ,EAAvE;AACP,OAAO,SAASC,cAAT,CACHC,OADG,EAEmB;EACtB,IAAI,CAACH,0BAA0B,CAACI,GAA3B,CAA+BD,OAA/B,CAAL,EAA8C;IAC1C,IAAME,UAAU,GAAGF,OAAO,CAACE,UAA3B;IACA,IAAMC,aAAuC,GAAGH,OAAO,CAACI,gBAAR,EAAhD;IACA,IAAMC,oBAAoB,GAAGlB,mBAAmB,CAC5Ce,UAAU,CAACI,eAAX,CAA2BC,MADiB,EAE5CtB,KAAK,CAACe,OAAO,CAACQ,UAAT,CAFuC,CAAhD;IAIA,IAAMnB,UAAU,GAAGa,UAAU,CAACK,MAAX,CAAkBE,WAArC;IAEA;AACR;AACA;AACA;AACA;;IACQ,IAAMC,cAAc,GAAGR,UAAU,CAACS,QAAX,CAAoBC,OAApB,CAA4BC,OAA5B,CAAoCC,iBAApC,CACnBZ,UAAU,CAACK,MAAX,CAAkBQ,UADC,EAEnBZ,aAFmB,CAAvB;;IAKA,IAAMa,iBAAyD,GAAG,SAA5DA,iBAA4D,CAACC,IAAD,EAAkBC,IAAlB,EAAsC;MACpG,IAAMC,kBAAkB,GAAG;QACvBF,IAAI,EAAJA,IADuB;QAEvBC,IAAI,EAAJA,IAFuB;QAGvBlB,OAAO,EAAPA;MAHuB,CAA3B;MAKA,OAAOU,cAAc,CAACS,kBAAkB,CAACF,IAApB,EAA0BE,kBAAkB,CAACD,IAA7C,CAArB;IACH,CAPD;IASA;AACR;AACA;AACA;AACA;;;IACQ,IAAME,YAAY,GAAGlB,UAAU,CAACS,QAAX,CAAoBC,OAApB,CAA4BC,OAA5B,CAAoCQ,eAApC,CACjBnB,UAAU,CAACK,MAAX,CAAkBQ,UADD,EAEjBZ,aAFiB,CAArB;;IAIA,IAAMmB,eAA6D,GAAG,SAAhEA,eAAgE,CAACC,GAAD,EAAyC;MAC3G,IAAMC,gBAAgB,GAAG;QACrBD,GAAG,EAAHA,GADqB;QAErBvB,OAAO,EAAPA;MAFqB,CAAzB;MAIA,OAAOoB,YAAY,CAACI,gBAAgB,CAACD,GAAlB,CAAnB;IACH,CAND;;IASA,IAAME,GAAqB,GAAG;MAC1BpC,UAAU,EAAEW,OAAO,CAACE,UAAR,CAAmBK,MAAnB,CAA0BE,WADZ;MAE1BiB,IAAI,EAAErB,oBAAoB,CAACqB,IAFD;MAG1BC,KAAK,EAAEtB,oBAAoB,CAACsB,KAHF;MAI1BC,UAAU,EAAExC,oBAAoB,CAACC,UAAD,EAAagB,oBAAb,CAJN;MAK1BK,cAAc,EAAEM,iBALU;MAM1BI,YAAY,EAAEE;IANY,CAA9B;IAQAzB,0BAA0B,CAACgC,GAA3B,CAA+B7B,OAA/B,EAAwCyB,GAAxC;IACA,OAAOA,GAAP;EACH,CAxDD,MAwDO;IACH,OAAO5B,0BAA0B,CAACiC,GAA3B,CAA+B9B,OAA/B,CAAP;EACH;AACJ;AAGD,OAAO,SAAS+B,mBAAT,CACH/B,OADG,EAEHgC,cAFG,EAG8B;EACjC,IAAI,CAAChC,OAAO,CAACE,UAAR,CAAmBS,QAAnB,CAA4BsB,WAAjC,EAA8C;IAC1C,OAAO;MACHC,iBAAiB,EAAE;IADhB,CAAP;EAGH;;EACD,IAAMC,WAAW,GAAGpC,cAAc,CAACC,OAAD,CAAlC;EACA,IAAMoC,eAAiC,GAAGlD,cAAc,CAACc,OAAO,CAACqC,OAAT,CAAd,CAAgCC,QAAhC,CAAyCC,KAAzC,CAA+C,CAA/C,CAA1C;EACA,IAAMC,kBAA+C,GAAGtD,cAAc,CAACc,OAAO,CAACqC,OAAT,CAAd,CAAgCI,WAAxF;EACA,IAAIC,OAAgB,GAAG,KAAvB;EAEA,IAAMC,iBAAgD,GAAGX,cAAc,CAClEvC,GADoD,CAChD,UAAAmD,EAAE;IAAA,OAAI7D,qCAAqC,CAAC6D,EAAD,CAAzC;EAAA,CAD8C,EAEpDC,MAFoD,CAE7C7D,mBAF6C,CAAzD;EAGA,IAAM8D,oBAAoB,GAAGH,iBAAiB,CAACI,IAAlB,CAAuB,UAAAC,gBAAgB,EAAI;IACpE,IAAMC,yBAAoE,GAAG;MACzEd,WAAW,EAAXA,WADyE;MAEzEe,WAAW,EAAEF,gBAF4D;MAGzEZ,eAAe,EAAfA,eAHyE;MAIzEe,cAAc,EAAEX;IAJyD,CAA7E;IAOA,IAAMY,UAAsB,GAAGvE,mBAAmB,CAACoE,yBAAD,CAAlD;;IACA,IAAIG,UAAU,KAAK,mBAAnB,EAAwC;MACpC,OAAO,IAAP;IACH,CAFD,MAEO,IAAIA,UAAU,KAAK,WAAnB,EAAgC;MACnCV,OAAO,GAAG,IAAV;MACA5D,SAAS,CACLsE,UADK,EAELjB,WAFK,EAGLa,gBAHK,EAILZ,eAJK,EAKLI,kBALK,CAAT;MAOA,OAAO,KAAP;IACH;EACJ,CAtB4B,CAA7B;;EAuBA,IAAIM,oBAAJ,EAA0B;IACtB,OAAO;MACHZ,iBAAiB,EAAE;IADhB,CAAP;EAGH,CAJD,MAIO;IACH,OAAO;MACHA,iBAAiB,EAAE,KADhB;MAEHQ,OAAO,EAAPA,OAFG;MAGHW,UAAU,EAAEjB;IAHT,CAAP;EAKH;AACJ"}