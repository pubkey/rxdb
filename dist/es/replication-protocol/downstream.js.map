{"version":3,"file":"downstream.js","names":["firstValueFrom","filter","stackCheckpoints","createRevision","ensureNotFalsy","flatClone","getDefaultRevision","getDefaultRxDocumentMeta","now","PROMISE_RESOLVE_FALSE","PROMISE_RESOLVE_VOID","getLastCheckpointDoc","setCheckpoint","writeDocToDocState","getAssumedMasterState","getMetaWriteRow","pact","state","value","s","v","o","bind","then","observer","prototype","onFulfilled","onRejected","result","callback","e","_this","thenable","test","update","body","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","startReplicationDownstream","downstreamResyncOnce","stats","down","events","canceled","getValue","checkpointQueue","lastCheckpoint","Promise","all","promises","firstSyncDone","next","lastTimeMasterChangesRequested","timer","replicationHandler","masterChangesSince","input","pullBatchSize","downResult","documents","length","checkpoint","push","persistFromMaster","openTasks","addNewTask","task","taskWithTime","time","streamQueue","useTasks","active","shift","downstreamProcessChanges","sub","masterChangeStream$","subscribe","masterChangeStreamEmit","pipe","unsubscribe","tasks","docsOfAllTasks","forEach","Error","concat","persistenceQueue","nonPersistedFromMaster","docs","docData","docId","primaryPath","downDocsById","useCheckpoint","docIds","Object","keys","writeRowsToFork","writeRowsToForkById","writeRowsToMeta","useMetaWriteRows","forkInstance","findDocumentsById","currentForkState","assumedMasterState","map","forkStateFullDoc","forkStateDocData","undefined","masterState","assumedMaster","metaDocument","isResolvedConflict","_rev","isAssumedMasterEqualToForkStatePromise","conflictHandler","realMasterState","newDocumentState","r","isEqual","isAssumedMasterEqualToForkState","areStatesExactlyEqualPromise","areStatesExactlyEqual","newForkState","assign","_meta","_attachments","lwt","hashFunction","forkWriteRow","previous","document","bulkWrite","downstreamBulkWriteFlag","forkWriteResult","success","processed","metaInstance","unhandledError","error"],"sources":["../../../src/replication-protocol/downstream.ts"],"sourcesContent":["import {\n    firstValueFrom,\n    filter\n} from 'rxjs';\nimport { stackCheckpoints } from '../rx-storage-helper';\nimport type {\n    RxStorageInstanceReplicationState,\n    BulkWriteRow,\n    BulkWriteRowById,\n    RxStorageReplicationMeta,\n    RxDocumentData,\n    ById,\n    WithDeleted,\n    DocumentsWithCheckpoint\n} from '../types';\nimport {\n    createRevision,\n    ensureNotFalsy,\n    flatClone,\n    getDefaultRevision,\n    getDefaultRxDocumentMeta,\n    now,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_VOID\n} from '../util';\nimport {\n    getLastCheckpointDoc,\n    setCheckpoint\n} from './checkpoint';\nimport { writeDocToDocState } from './helper';\nimport {\n    getAssumedMasterState,\n    getMetaWriteRow\n} from './meta-instance';\n\n/**\n * Writes all documents from the master to the fork.\n * The downstream has two operation modes\n * - Sync by iterating over the checkpoints via downstreamResyncOnce()\n * - Sync by listening to the changestream via downstreamProcessChanges()\n * We need this to be able to do initial syncs\n * and still can have fast event based sync when the client is not offline.\n */\nexport function startReplicationDownstream<RxDocType, CheckpointType = any>(\n    state: RxStorageInstanceReplicationState<RxDocType>\n) {\n    const replicationHandler = state.input.replicationHandler;\n\n    // used to detect which tasks etc can in it at which order.\n    let timer = 0;\n\n\n    type Task = DocumentsWithCheckpoint<RxDocType, any> | 'RESYNC';\n    type TaskWithTime = {\n        time: number;\n        task: Task;\n    };\n    const openTasks: TaskWithTime[] = [];\n\n\n    function addNewTask(task: Task): void {\n        state.stats.down.addNewTask = state.stats.down.addNewTask + 1;\n        const taskWithTime = {\n            time: timer++,\n            task\n        };\n        openTasks.push(taskWithTime);\n        state.streamQueue.down = state.streamQueue.down\n            .then(() => {\n                const useTasks: Task[] = [];\n                while (openTasks.length > 0) {\n                    state.events.active.down.next(true);\n                    const taskWithTime = ensureNotFalsy(openTasks.shift());\n\n                    /**\n                     * If the task came in before the last time we started the pull \n                     * from the master, then we can drop the task.\n                     */\n                    if (taskWithTime.time < lastTimeMasterChangesRequested) {\n                        continue;\n                    }\n\n                    if (taskWithTime.task === 'RESYNC') {\n                        if (useTasks.length === 0) {\n                            useTasks.push(taskWithTime.task);\n                            break;\n                        } else {\n                            break;\n                        }\n                    }\n\n                    useTasks.push(taskWithTime.task);\n                }\n\n                if (useTasks.length === 0) {\n                    state.events.active.down.next(false);\n                    return;\n                }\n\n                if (useTasks[0] === 'RESYNC') {\n                    return downstreamResyncOnce();\n                } else {\n                    return downstreamProcessChanges(useTasks);\n                }\n            });\n    }\n    addNewTask('RESYNC');\n\n    /**\n     * If a write on the master happens, we have to trigger the downstream.\n     */\n    const sub = replicationHandler\n        .masterChangeStream$\n        .subscribe((task: Task) => {\n            state.stats.down.masterChangeStreamEmit = state.stats.down.masterChangeStreamEmit + 1;\n            addNewTask(task);\n        });\n    firstValueFrom(\n        state.events.canceled.pipe(\n            filter(canceled => !!canceled)\n        )\n    ).then(() => sub.unsubscribe());\n\n\n    /**\n     * For faster performance, we directly start each write\n     * and then await all writes at the end.\n     */\n    let lastTimeMasterChangesRequested: number = -1;\n    async function downstreamResyncOnce() {\n        state.stats.down.downstreamResyncOnce = state.stats.down.downstreamResyncOnce + 1;\n        if (state.events.canceled.getValue()) {\n            return;\n        }\n\n        state.checkpointQueue = state.checkpointQueue.then(() => getLastCheckpointDoc(state, 'down'));\n        let lastCheckpoint: CheckpointType = await state.checkpointQueue;\n\n        const promises: Promise<any>[] = [];\n        while (!state.events.canceled.getValue()) {\n            lastTimeMasterChangesRequested = timer++;\n            const downResult = await replicationHandler.masterChangesSince(\n                lastCheckpoint,\n                state.input.pullBatchSize\n            );\n\n            if (downResult.documents.length === 0) {\n                break;\n            }\n\n            lastCheckpoint = stackCheckpoints([lastCheckpoint, downResult.checkpoint]);\n            promises.push(\n                persistFromMaster(\n                    downResult.documents,\n                    lastCheckpoint\n                )\n            );\n        }\n        return Promise.all(promises)\n            .then(() => {\n                if (!state.firstSyncDone.down.getValue()) {\n                    state.firstSyncDone.down.next(true);\n                }\n            });\n    }\n\n\n    function downstreamProcessChanges(tasks: Task[]) {\n        state.stats.down.downstreamProcessChanges = state.stats.down.downstreamProcessChanges + 1;\n        let docsOfAllTasks: WithDeleted<RxDocType>[] = [];\n        let lastCheckpoint: CheckpointType | undefined = null as any;\n\n        tasks.forEach(task => {\n            if (task === 'RESYNC') {\n                throw new Error('SNH');\n            }\n            docsOfAllTasks = docsOfAllTasks.concat(task.documents);\n            lastCheckpoint = stackCheckpoints([lastCheckpoint, task.checkpoint]);\n        });\n        return persistFromMaster(\n            docsOfAllTasks,\n            ensureNotFalsy(lastCheckpoint)\n        );\n    }\n\n\n    /**\n     * It can happen that the calls to masterChangesSince() or the changeStream()\n     * are way faster then how fast the documents can be persisted.\n     * Therefore we merge all incoming downResults into the nonPersistedFromMaster object\n     * and process them together if possible.\n     * This often bundles up single writes and improves performance\n     * by processing the documents in bulks.\n     */\n    let persistenceQueue = PROMISE_RESOLVE_VOID;\n    const nonPersistedFromMaster: {\n        checkpoint?: CheckpointType;\n        docs: ById<WithDeleted<RxDocType>>;\n    } = {\n        docs: {}\n    };\n\n    function persistFromMaster(\n        docs: WithDeleted<RxDocType>[],\n        checkpoint: CheckpointType\n    ): Promise<void> {\n        state.stats.down.persistFromMaster = state.stats.down.persistFromMaster + 1;\n\n        /**\n         * Add the new docs to the non-persistend list\n         */\n        docs.forEach(docData => {\n            const docId: string = (docData as any)[state.primaryPath];\n            nonPersistedFromMaster.docs[docId] = docData;\n        });\n        nonPersistedFromMaster.checkpoint = checkpoint;\n\n\n        /**\n         * Run in the queue\n         * with all open documents from nonPersistedFromMaster.\n         */\n        persistenceQueue = persistenceQueue.then(() => {\n            const downDocsById: ById<WithDeleted<RxDocType>> = nonPersistedFromMaster.docs;\n            nonPersistedFromMaster.docs = {};\n            const useCheckpoint = nonPersistedFromMaster.checkpoint;\n            const docIds = Object.keys(downDocsById);\n\n            if (\n                state.events.canceled.getValue() ||\n                docIds.length === 0\n            ) {\n                return PROMISE_RESOLVE_VOID;\n            }\n\n            const writeRowsToFork: BulkWriteRow<RxDocType>[] = [];\n            const writeRowsToForkById: ById<BulkWriteRow<RxDocType>> = {};\n            const writeRowsToMeta: BulkWriteRowById<RxStorageReplicationMeta> = {};\n            const useMetaWriteRows: BulkWriteRow<RxStorageReplicationMeta>[] = [];\n\n            return Promise.all([\n                state.input.forkInstance.findDocumentsById(docIds, true),\n                getAssumedMasterState(\n                    state,\n                    docIds\n                )\n            ]).then(([\n                currentForkState,\n                assumedMasterState\n            ]) => {\n                return Promise.all(\n                    docIds.map(async (docId) => {\n                        const forkStateFullDoc: RxDocumentData<RxDocType> | undefined = currentForkState[docId];\n                        const forkStateDocData: WithDeleted<RxDocType> | undefined = forkStateFullDoc ? writeDocToDocState(forkStateFullDoc) : undefined;\n                        const masterState = downDocsById[docId];\n                        const assumedMaster = assumedMasterState[docId];\n\n                        if (\n                            assumedMaster &&\n                            assumedMaster.metaDocument.isResolvedConflict === forkStateFullDoc._rev\n                        ) {\n                            /**\n                             * The current fork state represents a resolved conflict\n                             * that first must be send to the master in the upstream.\n                             * All conflicts are resolved by the upstream.\n                             */\n                            return PROMISE_RESOLVE_VOID;\n                        }\n\n\n                        const isAssumedMasterEqualToForkStatePromise = !assumedMaster || !forkStateDocData ?\n                            PROMISE_RESOLVE_FALSE :\n                            state.input.conflictHandler({\n                                realMasterState: assumedMaster.docData,\n                                newDocumentState: forkStateDocData\n                            }, 'downstream-check-if-equal-0').then(r => r.isEqual);\n                        const isAssumedMasterEqualToForkState = await isAssumedMasterEqualToForkStatePromise;\n                        if (\n                            (\n                                forkStateFullDoc &&\n                                assumedMaster &&\n                                isAssumedMasterEqualToForkState === false\n                            ) ||\n                            (\n                                forkStateFullDoc && !assumedMaster\n                            )\n                        ) {\n                            /**\n                             * We have a non-upstream-replicated\n                             * local write to the fork.\n                             * This means we ignore the downstream of this document\n                             * because anyway the upstream will first resolve the conflict.\n                             */\n                            return PROMISE_RESOLVE_VOID;\n                        }\n\n\n                        const areStatesExactlyEqualPromise = !forkStateDocData ?\n                            PROMISE_RESOLVE_FALSE :\n                            state.input.conflictHandler({\n                                realMasterState: masterState,\n                                newDocumentState: forkStateDocData\n                            }, 'downstream-check-if-equal-1').then(r => r.isEqual);\n                        const areStatesExactlyEqual = await areStatesExactlyEqualPromise;\n\n                        if (\n                            forkStateDocData &&\n                            areStatesExactlyEqual\n                        ) {\n                            /**\n                             * Document states are exactly equal.\n                             * This can happen when the replication is shut down\n                             * unexpected like when the user goes offline.\n                             * \n                             * Only when the assumedMaster is different from the forkState,\n                             * we have to patch the document in the meta instance.\n                             */\n                            if (\n                                !assumedMaster ||\n                                isAssumedMasterEqualToForkState === false\n                            ) {\n                                useMetaWriteRows.push(\n                                    getMetaWriteRow(\n                                        state,\n                                        forkStateDocData,\n                                        assumedMaster ? assumedMaster.metaDocument : undefined\n                                    )\n                                );\n                            }\n                            return PROMISE_RESOLVE_VOID;\n                        }\n\n                        /**\n                         * All other master states need to be written to the forkInstance\n                         * and metaInstance.\n                         */\n                        const newForkState = Object.assign(\n                            {},\n                            masterState,\n                            forkStateFullDoc ? {\n                                _meta: flatClone(forkStateFullDoc._meta),\n                                _attachments: {},\n                                _rev: getDefaultRevision()\n                            } : {\n                                _meta: getDefaultRxDocumentMeta(),\n                                _rev: getDefaultRevision(),\n                                _attachments: {}\n                            });\n                        newForkState._meta.lwt = now();\n                        newForkState._rev = (masterState as any)._rev ? (masterState as any)._rev : createRevision(\n                            state.input.hashFunction,\n                            newForkState,\n                            forkStateFullDoc\n                        );\n                        const forkWriteRow = {\n                            previous: forkStateFullDoc,\n                            document: newForkState\n                        };\n                        writeRowsToFork.push(forkWriteRow);\n                        writeRowsToForkById[docId] = forkWriteRow;\n                        writeRowsToMeta[docId] = getMetaWriteRow(\n                            state,\n                            masterState,\n                            assumedMaster ? assumedMaster.metaDocument : undefined\n                        );\n                    })\n                );\n            }).then(() => {\n                if (writeRowsToFork.length > 0) {\n                    return state.input.forkInstance.bulkWrite(\n                        writeRowsToFork,\n                        state.downstreamBulkWriteFlag\n                    ).then((forkWriteResult) => {\n                        Object.keys(forkWriteResult.success).forEach((docId) => {\n                            state.events.processed.down.next(writeRowsToForkById[docId]);\n                            useMetaWriteRows.push(writeRowsToMeta[docId]);\n                        });\n                    });\n                }\n            }).then(() => {\n                if (useMetaWriteRows.length > 0) {\n                    return state.input.metaInstance.bulkWrite(\n                        useMetaWriteRows,\n                        'replication-down-write-meta'\n                    );\n                }\n            }).then(() => {\n                /**\n                 * For better performance we do not await checkpoint writes,\n                 * but to ensure order on parallel checkpoint writes,\n                 * we have to use a queue.\n                 */\n                state.checkpointQueue = state.checkpointQueue.then(() => setCheckpoint(\n                    state,\n                    'down',\n                    useCheckpoint\n                ));\n            });\n        }).catch(unhandledError => state.events.error.next(unhandledError));\n        return persistenceQueue;\n    }\n}\n"],"mappings":"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"}