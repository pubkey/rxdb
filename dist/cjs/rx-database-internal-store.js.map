{"version":3,"file":"rx-database-internal-store.js","names":["_rxError","require","_rxSchemaHelper","_rxStorageHelper","_index","_rxQuery","INTERNAL_CONTEXT_COLLECTION","exports","INTERNAL_CONTEXT_STORAGE_TOKEN","INTERNAL_CONTEXT_MIGRATION_STATUS","INTERNAL_STORE_SCHEMA_TITLE","INTERNAL_STORE_SCHEMA","fillWithDefaultSettings","version","title","primaryKey","key","fields","separator","type","properties","id","maxLength","context","enum","data","additionalProperties","indexes","required","sharding","shards","mode","getPrimaryKeyOfInternalDocument","getComposedPrimaryKeyOfDocumentData","getAllCollectionDocuments","storageInstance","getAllQueryPrepared","prepareQuery","schema","selector","_deleted","$eq","sort","skip","queryResult","query","allDocs","documents","STORAGE_TOKEN_DOCUMENT_KEY","STORAGE_TOKEN_DOCUMENT_ID","ensureStorageTokenDocumentExists","rxDatabase","storageToken","randomCouchString","passwordHash","password","hashFunction","JSON","stringify","undefined","docData","rxdbVersion","token","instanceToken","_meta","getDefaultRxDocumentMeta","_rev","getDefaultRevision","_attachments","writeResult","internalStore","bulkWrite","document","success","error","ensureNotFalsy","isError","isBulkWriteConflictError","conflictError","isDatabaseStateVersionCompatibleWithDatabaseCode","documentInDb","newRxError","args","database","name","databaseStateVersion","codeVersion","existingPasswordHash","storageTokenDocInDb","includes","stateMajor","split","codeMajor","addConnectedStorageToCollection","collection","storageCollectionName","collectionNameWithVersion","_collectionNamePrimary","jsonSchema","collectionDocId","collectionDoc","getSingleDocument","saveData","clone","alreadyThere","connectedStorages","find","row","collectionName","push","writeSingle","previous","err"],"sources":["../../src/rx-database-internal-store.ts"],"sourcesContent":["import {\n    isBulkWriteConflictError,\n    newRxError\n} from './rx-error.ts';\nimport {\n    fillWithDefaultSettings,\n    getComposedPrimaryKeyOfDocumentData\n} from './rx-schema-helper.ts';\nimport { getSingleDocument, writeSingle } from './rx-storage-helper.ts';\nimport type {\n    CollectionsOfDatabase,\n    InternalStoreCollectionDocType,\n    InternalStoreDocType,\n    InternalStoreStorageTokenDocType,\n    RxCollection,\n    RxDatabase,\n    RxDocumentData,\n    RxJsonSchema,\n    RxStorageInstance,\n    RxStorageWriteErrorConflict\n} from './types/index.d.ts';\nimport {\n    clone,\n    ensureNotFalsy,\n    getDefaultRevision,\n    getDefaultRxDocumentMeta,\n    randomCouchString\n} from './plugins/utils/index.ts';\nimport { prepareQuery } from './rx-query.ts';\n\nexport const INTERNAL_CONTEXT_COLLECTION = 'collection';\nexport const INTERNAL_CONTEXT_STORAGE_TOKEN = 'storage-token';\nexport const INTERNAL_CONTEXT_MIGRATION_STATUS = 'rx-migration-status';\n\n/**\n * Do not change the title,\n * we have to flag the internal schema so that\n * some RxStorage implementations are able\n * to detect if the created RxStorageInstance\n * is from the internals or not,\n * to do some optimizations in some cases.\n */\nexport const INTERNAL_STORE_SCHEMA_TITLE = 'RxInternalDocument';\n\nexport const INTERNAL_STORE_SCHEMA: RxJsonSchema<RxDocumentData<InternalStoreDocType<any>>> = fillWithDefaultSettings({\n    version: 0,\n    title: INTERNAL_STORE_SCHEMA_TITLE,\n    primaryKey: {\n        key: 'id',\n        fields: [\n            'context',\n            'key'\n        ],\n        separator: '|'\n    },\n    type: 'object',\n    properties: {\n        id: {\n            type: 'string',\n            maxLength: 200\n        },\n        key: {\n            type: 'string'\n        },\n        context: {\n            type: 'string',\n            enum: [\n                INTERNAL_CONTEXT_COLLECTION,\n                INTERNAL_CONTEXT_STORAGE_TOKEN,\n                INTERNAL_CONTEXT_MIGRATION_STATUS,\n                'OTHER'\n            ]\n        },\n        data: {\n            type: 'object',\n            additionalProperties: true\n        }\n    },\n    indexes: [],\n    required: [\n        'key',\n        'context',\n        'data'\n    ],\n    additionalProperties: false,\n    /**\n     * If the sharding plugin is used,\n     * it must not shard on the internal RxStorageInstance\n     * because that one anyway has only a small amount of documents\n     * and also its creation is in the hot path of the initial page load,\n     * so we should spend less time creating multiple RxStorageInstances.\n     */\n    sharding: {\n        shards: 1,\n        mode: 'collection'\n    }\n});\n\n\nexport function getPrimaryKeyOfInternalDocument(\n    key: string,\n    context: string\n): string {\n    return getComposedPrimaryKeyOfDocumentData<InternalStoreDocType>(\n        INTERNAL_STORE_SCHEMA,\n        {\n            key,\n            context\n        }\n    );\n}\n\n/**\n * Returns all internal documents\n * with context 'collection'\n */\nexport async function getAllCollectionDocuments(\n    storageInstance: RxStorageInstance<InternalStoreDocType<any>, any, any>\n): Promise<RxDocumentData<InternalStoreCollectionDocType>[]> {\n    const getAllQueryPrepared = prepareQuery<InternalStoreDocType<any>>(\n        storageInstance.schema,\n        {\n            selector: {\n                context: INTERNAL_CONTEXT_COLLECTION,\n                _deleted: {\n                    $eq: false\n                }\n            },\n            sort: [{ id: 'asc' }],\n            skip: 0\n        }\n    );\n    const queryResult = await storageInstance.query(getAllQueryPrepared);\n    const allDocs = queryResult.documents;\n    return allDocs;\n}\n\n/**\n * to not confuse multiInstance-messages with other databases that have the same\n * name and adapter, but do not share state with this one (for example in-memory-instances),\n * we set a storage-token and use it in the broadcast-channel\n */\nexport const STORAGE_TOKEN_DOCUMENT_KEY = 'storageToken';\n\nexport const STORAGE_TOKEN_DOCUMENT_ID = getPrimaryKeyOfInternalDocument(\n    STORAGE_TOKEN_DOCUMENT_KEY,\n    INTERNAL_CONTEXT_STORAGE_TOKEN\n);\n\nexport async function ensureStorageTokenDocumentExists<Collections extends CollectionsOfDatabase = any>(\n    rxDatabase: RxDatabase<Collections>\n): Promise<RxDocumentData<InternalStoreStorageTokenDocType>> {\n\n    /**\n     * To have less read-write cycles,\n     * we just try to insert a new document\n     * and only fetch the existing one if a conflict happened.\n     */\n    const storageToken = randomCouchString(10);\n\n    const passwordHash = rxDatabase.password ?\n        await rxDatabase.hashFunction(JSON.stringify(rxDatabase.password)) :\n        undefined;\n\n    const docData: RxDocumentData<InternalStoreStorageTokenDocType> = {\n        id: STORAGE_TOKEN_DOCUMENT_ID,\n        context: INTERNAL_CONTEXT_STORAGE_TOKEN,\n        key: STORAGE_TOKEN_DOCUMENT_KEY,\n        data: {\n            rxdbVersion: rxDatabase.rxdbVersion,\n            token: storageToken,\n            /**\n             * We add the instance token here\n             * to be able to detect if a given RxDatabase instance\n             * is the first instance that was ever created\n             * or if databases have existed earlier on that storage\n             * with the same database name.\n             */\n            instanceToken: rxDatabase.token,\n            passwordHash\n        },\n        _deleted: false,\n        _meta: getDefaultRxDocumentMeta(),\n        _rev: getDefaultRevision(),\n        _attachments: {}\n    };\n\n    const writeResult = await rxDatabase.internalStore.bulkWrite(\n        [{ document: docData }],\n        'internal-add-storage-token'\n    );\n    if (writeResult.success[0]) {\n        return writeResult.success[0];\n    }\n\n    /**\n     * If we get a 409 error,\n     * it means another instance already inserted the storage token.\n     * So we get that token from the database and return that one.\n     */\n    const error = ensureNotFalsy(writeResult.error[0]);\n    if (\n        error.isError &&\n        isBulkWriteConflictError(error)\n    ) {\n        const conflictError = (error as RxStorageWriteErrorConflict<InternalStoreStorageTokenDocType>);\n\n        if (\n            !isDatabaseStateVersionCompatibleWithDatabaseCode(\n                conflictError.documentInDb.data.rxdbVersion,\n                rxDatabase.rxdbVersion\n            )\n        ) {\n            throw newRxError('DM5', {\n                args: {\n                    database: rxDatabase.name,\n                    databaseStateVersion: conflictError.documentInDb.data.rxdbVersion,\n                    codeVersion: rxDatabase.rxdbVersion\n                }\n            });\n        }\n\n        if (\n            passwordHash &&\n            passwordHash !== conflictError.documentInDb.data.passwordHash\n        ) {\n            throw newRxError('DB1', {\n                passwordHash,\n                existingPasswordHash: conflictError.documentInDb.data.passwordHash\n            });\n        }\n\n        const storageTokenDocInDb = conflictError.documentInDb;\n        return ensureNotFalsy(storageTokenDocInDb);\n    }\n    throw error;\n}\n\n\nexport function isDatabaseStateVersionCompatibleWithDatabaseCode(\n    databaseStateVersion: string,\n    codeVersion: string\n): boolean {\n    if (!databaseStateVersion) {\n        return false;\n    }\n\n    if (\n        codeVersion.includes('beta') &&\n        codeVersion !== databaseStateVersion\n    ) {\n        return false;\n    }\n\n    const stateMajor = databaseStateVersion.split('.')[0];\n    const codeMajor = codeVersion.split('.')[0];\n    if (stateMajor !== codeMajor) {\n        return false;\n    }\n    return true;\n}\n\n\n\n\n\nexport async function addConnectedStorageToCollection(\n    collection: RxCollection<any>,\n    storageCollectionName: string,\n    schema: RxJsonSchema<any>\n) {\n\n    if (collection.schema.version !== schema.version) {\n        throw newRxError('SNH', {\n            schema,\n            version: collection.schema.version,\n            name: collection.name,\n            collection,\n            args: {\n                storageCollectionName\n            }\n        });\n    }\n\n    const collectionNameWithVersion = _collectionNamePrimary(collection.name, collection.schema.jsonSchema);\n    const collectionDocId = getPrimaryKeyOfInternalDocument(\n        collectionNameWithVersion,\n        INTERNAL_CONTEXT_COLLECTION\n    );\n\n    while (true) {\n        const collectionDoc = await getSingleDocument(\n            collection.database.internalStore,\n            collectionDocId\n        );\n        const saveData: RxDocumentData<InternalStoreCollectionDocType> = clone(ensureNotFalsy(collectionDoc));\n\n        // do nothing if already in array\n        const alreadyThere = saveData.data.connectedStorages\n            .find(row => row.collectionName === storageCollectionName && row.schema.version === schema.version);\n        if (alreadyThere) {\n            return;\n        }\n\n        // otherwise add to array and save\n        saveData.data.connectedStorages.push({\n            collectionName: storageCollectionName,\n            schema\n        });\n        try {\n            await writeSingle(\n                collection.database.internalStore,\n                {\n                    previous: ensureNotFalsy(collectionDoc),\n                    document: saveData\n                },\n                'add-connected-storage-to-collection'\n            );\n        } catch (err) {\n            if (!isBulkWriteConflictError(err)) {\n                throw err;\n            }\n            // retry on conflict\n        }\n    }\n}\n\n\n/**\n * returns the primary for a given collection-data\n * used in the internal store of a RxDatabase\n */\nexport function _collectionNamePrimary(name: string, schema: RxJsonSchema<any>) {\n    return name + '-' + schema.version;\n}\n"],"mappings":"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","ignoreList":[]}