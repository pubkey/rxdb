{"version":3,"file":"index.js","names":["_rxError","require","_index","_index2","_mingoUpdater","updateCRDT","entry","overwritable","deepFreezeWhenDevMode","jsonSchema","collection","schema","crdt","newRxError","queryObj","crdtOptions","ensureNotFalsy","storageToken","database","incrementalModify","docData","crdtDocField","clone","getProperty","field","operation","body","toArray","creator","time","now","lastAr","operations","push","hash","hashCRDTOperations","hashFunction","runOperationOnDocument","setProperty","RX_CRDT_CONTEXT","insertCRDT","Array","isArray","insertData","result","insert","catch","err","code","doc","findOne","parameters","id","exec","sortOperationComparator","a","b","entryParts","forEach","entryPart","isMatching","selector","query","sort","skip","matcher","getQueryMatcher","ifMatch","mingoUpdater","ifNotMatch","crdts","hashObj","map","op","JSON","stringify","getCRDTSchemaPart","operationSchema","type","properties","items","additionalProperties","minItems","minimum","maximum","multipleOf","required","minLength","mergeCRDTFields","crdtsA","crdtsB","length","ret","row","index","mergedOps","ids","Set","add","has","rebuildFromCRDT","base","_deleted","getCRDTConflictHandler","crdtField","getCRDTValue","objectPathMonad","conflictHandler","i","_context","newDocCrdt","newDocumentState","masterDocCrdt","realMasterState","Promise","resolve","isEqual","mergedCrdt","mergedDoc","documentData","exports","RxDBcrdtPlugin","name","rxdb","prototypes","RxDocument","proto","oldRemove","remove","bind","$set","oldincrementalPatch","incrementalPatch","patch","oldincrementalModify","fn","context","primary","args","RxCollection","hooks","preCreateRxCollection","after","data","createRxCollection","getCrdt","isDevMode","bulkWriteBefore","storageInstance","bulkWrite","writes","all","write","newDocState","document","rebuild","docWithoutMeta","Object","entries","k","v","startsWith","deepEqual","recalculatedHash","bulkInsertBefore","bulkInsert","docsData","useDocsData","setMe","key","value","crdtOperations"],"sources":["../../../../src/plugins/crdt/index.ts"],"sourcesContent":["import { newRxError } from '../../rx-error.ts';\nimport type {\n    CRDTDocumentField,\n    CRDTEntry,\n    CRDTOperation,\n    FilledMangoQuery,\n    HashFunction,\n    JsonSchema,\n    RxConflictHandler,\n    RxConflictHandlerInput,\n    RxDocument,\n    RxDocumentData,\n    RxJsonSchema,\n    RxPlugin,\n    WithDeleted\n} from '../../types/index.d.ts';\nimport {\n    clone,\n    deepEqual,\n    ensureNotFalsy,\n    getProperty,\n    now,\n    objectPathMonad,\n    setProperty,\n    toArray\n} from '../../plugins/utils/index.ts';\nimport {\n    getQueryMatcher,\n    overwritable,\n    RxCollection,\n    RxDocumentWriteData,\n    RxError\n} from '../../index.ts';\nimport { mingoUpdater } from '../update/mingo-updater.ts';\n\n\n\nexport async function updateCRDT<RxDocType>(\n    this: RxDocument<RxDocType>,\n    entry: CRDTEntry<RxDocType> | CRDTEntry<RxDocType>[]\n) {\n    entry = overwritable.deepFreezeWhenDevMode(entry) as any;\n\n    const jsonSchema = this.collection.schema.jsonSchema;\n    if (!jsonSchema.crdt) {\n        throw newRxError('CRDT1', {\n            schema: jsonSchema,\n            queryObj: entry\n        });\n    }\n    const crdtOptions = ensureNotFalsy(jsonSchema.crdt);\n    const storageToken = await this.collection.database.storageToken;\n\n    return this.incrementalModify(async (docData) => {\n        const crdtDocField: CRDTDocumentField<RxDocType> = clone(getProperty(docData as any, crdtOptions.field));\n        const operation: CRDTOperation<RxDocType> = {\n            body: toArray(entry),\n            creator: storageToken,\n            time: now()\n        };\n\n        /**\n         * A new write will ALWAYS be an operation in the last\n         * array which was non existing before.\n         */\n        const lastAr: CRDTOperation<RxDocType>[] = [operation];\n        crdtDocField.operations.push(lastAr);\n        crdtDocField.hash = await hashCRDTOperations(this.collection.database.hashFunction, crdtDocField);\n\n        docData = runOperationOnDocument(\n            this.collection.schema.jsonSchema,\n            docData,\n            operation\n        );\n        setProperty(docData, crdtOptions.field, crdtDocField);\n        return docData;\n    }, RX_CRDT_CONTEXT);\n}\n\n\nexport async function insertCRDT<RxDocType>(\n    this: RxCollection<RxDocType>,\n    entry: CRDTEntry<RxDocType> | CRDTEntry<RxDocType>[]\n) {\n    entry = overwritable.deepFreezeWhenDevMode(entry) as any;\n\n    const jsonSchema = this.schema.jsonSchema;\n    if (!jsonSchema.crdt) {\n        throw newRxError('CRDT1', {\n            schema: jsonSchema,\n            queryObj: entry\n        });\n    }\n    const crdtOptions = ensureNotFalsy(jsonSchema.crdt);\n    const storageToken = await this.database.storageToken;\n    const operation: CRDTOperation<RxDocType> = {\n        body: Array.isArray(entry) ? entry : [entry],\n        creator: storageToken,\n        time: now()\n    };\n\n    let insertData: RxDocumentWriteData<RxDocType> = {} as any;\n    insertData = runOperationOnDocument(\n        this.schema.jsonSchema,\n        insertData as any,\n        operation\n    ) as any;\n    const crdtDocField: CRDTDocumentField<RxDocType> = {\n        operations: [],\n        hash: ''\n    };\n    setProperty(insertData as any, crdtOptions.field, crdtDocField);\n\n    const lastAr: CRDTOperation<RxDocType>[] = [operation];\n    crdtDocField.operations.push(lastAr);\n    crdtDocField.hash = await hashCRDTOperations(this.database.hashFunction, crdtDocField);\n\n    const result = await this.insert(insertData).catch(async (err: RxError) => {\n        if (err.code === 'CONFLICT') {\n            // was a conflict, update document instead of inserting\n            const doc = await this.findOne(err.parameters.id).exec(true);\n            return doc.updateCRDT(entry);\n        } else {\n            throw err;\n        }\n    });\n    return result;\n}\n\n\nexport function sortOperationComparator<RxDocType>(a: CRDTOperation<RxDocType>, b: CRDTOperation<RxDocType>) {\n    return a.creator > b.creator ? 1 : -1;\n}\n\n\nfunction runOperationOnDocument<RxDocType>(\n    schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n    docData: WithDeleted<RxDocType>,\n    operation: CRDTOperation<RxDocType>\n): WithDeleted<RxDocType> {\n    const entryParts = operation.body;\n    entryParts.forEach(entryPart => {\n        let isMatching: boolean;\n        if (entryPart.selector) {\n            const query: FilledMangoQuery<RxDocType> = {\n                selector: ensureNotFalsy(entryPart.selector as any),\n                sort: [],\n                skip: 0\n            };\n            const matcher = getQueryMatcher(schema, query);\n            isMatching = matcher(docData as any);\n        } else {\n            isMatching = true;\n        }\n        if (isMatching) {\n            if (entryPart.ifMatch) {\n                docData = mingoUpdater<WithDeleted<RxDocType>>(docData, entryPart.ifMatch);\n            }\n        } else {\n            if (entryPart.ifNotMatch) {\n                docData = mingoUpdater<WithDeleted<RxDocType>>(docData, entryPart.ifNotMatch);\n            }\n        }\n    });\n    return docData;\n}\n\nexport async function hashCRDTOperations(\n    hashFunction: HashFunction,\n    crdts: CRDTDocumentField<any>\n): Promise<string> {\n    const hashObj = crdts.operations.map((operations) => {\n        return operations.map(op => op.creator);\n    });\n    const hash = await hashFunction(JSON.stringify(hashObj));\n    return hash;\n}\n\nexport function getCRDTSchemaPart<RxDocType>(): JsonSchema<CRDTDocumentField<RxDocType>> {\n    const operationSchema: JsonSchema<CRDTOperation<RxDocType>> = {\n        type: 'object',\n        properties: {\n            body: {\n                type: 'array',\n                items: {\n                    type: 'object',\n                    properties: {\n                        selector: {\n                            type: 'object'\n                        },\n                        ifMatch: {\n                            type: 'object'\n                        },\n                        ifNotMatch: {\n                            type: 'object'\n                        }\n                    },\n                    additionalProperties: false\n                },\n                minItems: 1\n            },\n            creator: {\n                type: 'string'\n            },\n            time: {\n                type: 'number',\n                minimum: 1,\n                maximum: 1000000000000000,\n                multipleOf: 0.01\n            }\n        },\n        additionalProperties: false,\n        required: [\n            'body',\n            'creator',\n            'time'\n        ]\n    };\n    return {\n        type: 'object',\n        properties: {\n            operations: {\n                type: 'array',\n                items: {\n                    type: 'array',\n                    items: operationSchema\n                }\n            },\n            hash: {\n                type: 'string',\n                // set a minLength to not accidentally store an empty string\n                minLength: 2\n            }\n        },\n        additionalProperties: false,\n        required: ['operations', 'hash']\n    };\n}\n\n\nexport async function mergeCRDTFields<RxDocType>(\n    hashFunction: HashFunction,\n    crdtsA: CRDTDocumentField<RxDocType>,\n    crdtsB: CRDTDocumentField<RxDocType>\n): Promise<CRDTDocumentField<RxDocType>> {\n\n    // the value with most operations must be A to\n    // ensure we not miss out rows when iterating over both fields.\n    if (crdtsA.operations.length < crdtsB.operations.length) {\n        [crdtsA, crdtsB] = [crdtsB, crdtsA];\n    }\n\n    const ret: CRDTDocumentField<RxDocType> = {\n        operations: [],\n        hash: ''\n    };\n    crdtsA.operations.forEach((row, index) => {\n        let mergedOps: CRDTOperation<RxDocType>[] = [];\n        const ids = new Set<string>(); // used to deduplicate\n\n        row.forEach(op => {\n            ids.add(op.creator);\n            mergedOps.push(op);\n        });\n        if (crdtsB.operations[index]) {\n            crdtsB.operations[index].forEach(op => {\n                if (!ids.has(op.creator)) {\n                    mergedOps.push(op);\n                }\n            });\n        }\n        mergedOps = mergedOps.sort(sortOperationComparator);\n        ret.operations[index] = mergedOps;\n    });\n\n\n    ret.hash = await hashCRDTOperations(hashFunction, ret);\n    return ret;\n}\n\nexport function rebuildFromCRDT<RxDocType>(\n    schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n    docData: WithDeleted<RxDocType>,\n    crdts: CRDTDocumentField<RxDocType>\n): WithDeleted<RxDocType> {\n    let base: WithDeleted<RxDocType> = {\n        _deleted: false\n    } as any;\n    setProperty(base, ensureNotFalsy(schema.crdt).field, crdts);\n    crdts.operations.forEach(operations => {\n        operations.forEach(op => {\n            base = runOperationOnDocument(\n                schema,\n                base,\n                op\n            );\n        });\n    });\n    return base;\n}\n\n\nexport function getCRDTConflictHandler<RxDocType>(\n    hashFunction: HashFunction,\n    schema: RxJsonSchema<RxDocumentData<RxDocType>>\n): RxConflictHandler<RxDocType> {\n    const crdtOptions = ensureNotFalsy(schema.crdt);\n    const crdtField = crdtOptions.field;\n    const getCRDTValue = objectPathMonad<WithDeleted<RxDocType>, CRDTDocumentField<RxDocType>>(crdtField);\n\n    const conflictHandler: RxConflictHandler<RxDocType> = async (\n        i: RxConflictHandlerInput<RxDocType>,\n        _context: string\n    ) => {\n        const newDocCrdt = getCRDTValue(i.newDocumentState);\n        const masterDocCrdt = getCRDTValue(i.realMasterState);\n\n        if (newDocCrdt.hash === masterDocCrdt.hash) {\n            return Promise.resolve({\n                isEqual: true\n            });\n        }\n\n        const mergedCrdt = await mergeCRDTFields(hashFunction, newDocCrdt, masterDocCrdt);\n        const mergedDoc = rebuildFromCRDT(\n            schema,\n            i.newDocumentState,\n            mergedCrdt\n        );\n        return Promise.resolve({\n            isEqual: false,\n            documentData: mergedDoc\n        });\n    };\n\n    return conflictHandler;\n}\n\n\nexport const RX_CRDT_CONTEXT = 'rx-crdt';\n\nexport const RxDBcrdtPlugin: RxPlugin = {\n    name: 'crdt',\n    rxdb: true,\n    prototypes: {\n        RxDocument: (proto: any) => {\n            proto.updateCRDT = updateCRDT;\n\n            const oldRemove = proto.remove;\n            proto.remove = function (this: RxDocument) {\n                if (!this.collection.schema.jsonSchema.crdt) {\n                    return oldRemove.bind(this)();\n                }\n                return this.updateCRDT({\n                    ifMatch: {\n                        $set: {\n                            _deleted: true\n                        }\n                    }\n                });\n            };\n\n            const oldincrementalPatch = proto.incrementalPatch;\n            proto.incrementalPatch = function (this: RxDocument, patch: any) {\n                if (!this.collection.schema.jsonSchema.crdt) {\n                    return oldincrementalPatch.bind(this)(patch);\n                }\n                return this.updateCRDT({\n                    ifMatch: {\n                        $set: patch\n                    }\n                });\n            };\n            const oldincrementalModify = proto.incrementalModify;\n            proto.incrementalModify = function (fn: any, context: string) {\n                if (!this.collection.schema.jsonSchema.crdt) {\n                    return oldincrementalModify.bind(this)(fn);\n                }\n                if (context === RX_CRDT_CONTEXT) {\n                    return oldincrementalModify.bind(this)(fn);\n                } else {\n                    throw newRxError('CRDT2', {\n                        id: this.primary,\n                        args: { context }\n                    });\n                }\n            };\n        },\n        RxCollection: (proto: any) => {\n            proto.insertCRDT = insertCRDT;\n        }\n    },\n    overwritable: {},\n    hooks: {\n        preCreateRxCollection: {\n            after: (data) => {\n                if (!data.schema.crdt) {\n                    return;\n                }\n                if (data.conflictHandler) {\n                    throw newRxError('CRDT3', {\n                        collection: data.name,\n                        schema: data.schema\n                    });\n                }\n                data.conflictHandler = getCRDTConflictHandler(\n                    data.database.hashFunction,\n                    data.schema\n                );\n            }\n        },\n        createRxCollection: {\n            after: ({ collection }) => {\n                if (!collection.schema.jsonSchema.crdt) {\n                    return;\n                }\n\n                const crdtOptions = ensureNotFalsy(collection.schema.jsonSchema.crdt);\n                const crdtField = crdtOptions.field;\n                const getCrdt = objectPathMonad<any, CRDTDocumentField<any>>(crdtOptions.field);\n\n                /**\n                 * In dev-mode we have to ensure that all document writes\n                 * have the correct crdt state so that nothing is missed out\n                 * or could accidentally do non-crdt writes to the document.\n                 */\n                if (overwritable.isDevMode()) {\n                    const bulkWriteBefore = collection.storageInstance.bulkWrite.bind(collection.storageInstance);\n                    collection.storageInstance.bulkWrite = async function (writes, context) {\n\n                        await Promise.all(\n                            writes.map(async (write) => {\n                                const newDocState: typeof write.document = clone(write.document);\n                                const crdts = getCrdt(newDocState);\n\n                                const rebuild = rebuildFromCRDT(\n                                    collection.schema.jsonSchema,\n                                    newDocState,\n                                    crdts\n                                );\n\n                                function docWithoutMeta(doc: any) {\n                                    const ret: any = {};\n                                    Object.entries(doc).forEach(([k, v]) => {\n                                        if (\n                                            !k.startsWith('_') &&\n                                            typeof v !== 'undefined'\n                                        ) {\n                                            ret[k] = v;\n                                        }\n                                    });\n                                    return ret;\n                                }\n                                if (!deepEqual(docWithoutMeta(newDocState), docWithoutMeta(rebuild))) {\n                                    throw newRxError('SNH', {\n                                        document: newDocState\n                                    });\n                                }\n                                const recalculatedHash = await hashCRDTOperations(collection.database.hashFunction, crdts);\n                                if (crdts.hash !== recalculatedHash) {\n                                    throw newRxError('SNH', {\n                                        document: newDocState,\n                                        args: { hash: crdts.hash, recalculatedHash }\n                                    });\n                                }\n                            })\n                        );\n\n                        return bulkWriteBefore(writes, context);\n                    };\n                }\n\n\n                const bulkInsertBefore = collection.bulkInsert.bind(collection);\n                collection.bulkInsert = async function (docsData: any[]) {\n                    const storageToken = await collection.database.storageToken;\n                    const useDocsData = await Promise.all(\n                        docsData.map(async (docData) => {\n                            const setMe: Partial<RxDocumentData<any>> = {};\n                            Object.entries(docData).forEach(([key, value]) => {\n                                if (\n                                    !key.startsWith('_') &&\n                                    key !== crdtField\n                                ) {\n                                    setMe[key] = value;\n                                }\n                            });\n\n                            const crdtOperations: CRDTDocumentField<any> = {\n                                operations: [\n                                    [{\n                                        creator: storageToken,\n                                        body: [{\n                                            ifMatch: {\n                                                $set: setMe\n                                            }\n                                        }],\n                                        time: now()\n                                    }]\n                                ],\n                                hash: ''\n                            };\n                            crdtOperations.hash = await hashCRDTOperations(collection.database.hashFunction, crdtOperations);\n                            setProperty(docData, crdtOptions.field, crdtOperations);\n                            return docData;\n                        })\n                    );\n                    return bulkInsertBefore(useDocsData);\n                };\n            }\n        }\n    }\n};\n"],"mappings":";;;;;;;;;;;;;;AAAA,IAAAA,QAAA,GAAAC,OAAA;AAgBA,IAAAC,MAAA,GAAAD,OAAA;AAUA,IAAAE,OAAA,GAAAF,OAAA;AAOA,IAAAG,aAAA,GAAAH,OAAA;AAIO,eAAeI,UAAUA,CAE5BC,KAAoD,EACtD;EACEA,KAAK,GAAGC,oBAAY,CAACC,qBAAqB,CAACF,KAAK,CAAQ;EAExD,IAAMG,UAAU,GAAG,IAAI,CAACC,UAAU,CAACC,MAAM,CAACF,UAAU;EACpD,IAAI,CAACA,UAAU,CAACG,IAAI,EAAE;IAClB,MAAM,IAAAC,mBAAU,EAAC,OAAO,EAAE;MACtBF,MAAM,EAAEF,UAAU;MAClBK,QAAQ,EAAER;IACd,CAAC,CAAC;EACN;EACA,IAAMS,WAAW,GAAG,IAAAC,qBAAc,EAACP,UAAU,CAACG,IAAI,CAAC;EACnD,IAAMK,YAAY,GAAG,MAAM,IAAI,CAACP,UAAU,CAACQ,QAAQ,CAACD,YAAY;EAEhE,OAAO,IAAI,CAACE,iBAAiB,CAAC,MAAOC,OAAO,IAAK;IAC7C,IAAMC,YAA0C,GAAG,IAAAC,YAAK,EAAC,IAAAC,kBAAW,EAACH,OAAO,EAASL,WAAW,CAACS,KAAK,CAAC,CAAC;IACxG,IAAMC,SAAmC,GAAG;MACxCC,IAAI,EAAE,IAAAC,cAAO,EAACrB,KAAK,CAAC;MACpBsB,OAAO,EAAEX,YAAY;MACrBY,IAAI,EAAE,IAAAC,UAAG,EAAC;IACd,CAAC;;IAED;AACR;AACA;AACA;IACQ,IAAMC,MAAkC,GAAG,CAACN,SAAS,CAAC;IACtDJ,YAAY,CAACW,UAAU,CAACC,IAAI,CAACF,MAAM,CAAC;IACpCV,YAAY,CAACa,IAAI,GAAG,MAAMC,kBAAkB,CAAC,IAAI,CAACzB,UAAU,CAACQ,QAAQ,CAACkB,YAAY,EAAEf,YAAY,CAAC;IAEjGD,OAAO,GAAGiB,sBAAsB,CAC5B,IAAI,CAAC3B,UAAU,CAACC,MAAM,CAACF,UAAU,EACjCW,OAAO,EACPK,SACJ,CAAC;IACD,IAAAa,kBAAW,EAAClB,OAAO,EAAEL,WAAW,CAACS,KAAK,EAAEH,YAAY,CAAC;IACrD,OAAOD,OAAO;EAClB,CAAC,EAAEmB,eAAe,CAAC;AACvB;AAGO,eAAeC,UAAUA,CAE5BlC,KAAoD,EACtD;EACEA,KAAK,GAAGC,oBAAY,CAACC,qBAAqB,CAACF,KAAK,CAAQ;EAExD,IAAMG,UAAU,GAAG,IAAI,CAACE,MAAM,CAACF,UAAU;EACzC,IAAI,CAACA,UAAU,CAACG,IAAI,EAAE;IAClB,MAAM,IAAAC,mBAAU,EAAC,OAAO,EAAE;MACtBF,MAAM,EAAEF,UAAU;MAClBK,QAAQ,EAAER;IACd,CAAC,CAAC;EACN;EACA,IAAMS,WAAW,GAAG,IAAAC,qBAAc,EAACP,UAAU,CAACG,IAAI,CAAC;EACnD,IAAMK,YAAY,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACD,YAAY;EACrD,IAAMQ,SAAmC,GAAG;IACxCC,IAAI,EAAEe,KAAK,CAACC,OAAO,CAACpC,KAAK,CAAC,GAAGA,KAAK,GAAG,CAACA,KAAK,CAAC;IAC5CsB,OAAO,EAAEX,YAAY;IACrBY,IAAI,EAAE,IAAAC,UAAG,EAAC;EACd,CAAC;EAED,IAAIa,UAA0C,GAAG,CAAC,CAAQ;EAC1DA,UAAU,GAAGN,sBAAsB,CAC/B,IAAI,CAAC1B,MAAM,CAACF,UAAU,EACtBkC,UAAU,EACVlB,SACJ,CAAQ;EACR,IAAMJ,YAA0C,GAAG;IAC/CW,UAAU,EAAE,EAAE;IACdE,IAAI,EAAE;EACV,CAAC;EACD,IAAAI,kBAAW,EAACK,UAAU,EAAS5B,WAAW,CAACS,KAAK,EAAEH,YAAY,CAAC;EAE/D,IAAMU,MAAkC,GAAG,CAACN,SAAS,CAAC;EACtDJ,YAAY,CAACW,UAAU,CAACC,IAAI,CAACF,MAAM,CAAC;EACpCV,YAAY,CAACa,IAAI,GAAG,MAAMC,kBAAkB,CAAC,IAAI,CAACjB,QAAQ,CAACkB,YAAY,EAAEf,YAAY,CAAC;EAEtF,IAAMuB,MAAM,GAAG,MAAM,IAAI,CAACC,MAAM,CAACF,UAAU,CAAC,CAACG,KAAK,CAAC,MAAOC,GAAY,IAAK;IACvE,IAAIA,GAAG,CAACC,IAAI,KAAK,UAAU,EAAE;MACzB;MACA,IAAMC,GAAG,GAAG,MAAM,IAAI,CAACC,OAAO,CAACH,GAAG,CAACI,UAAU,CAACC,EAAE,CAAC,CAACC,IAAI,CAAC,IAAI,CAAC;MAC5D,OAAOJ,GAAG,CAAC5C,UAAU,CAACC,KAAK,CAAC;IAChC,CAAC,MAAM;MACH,MAAMyC,GAAG;IACb;EACJ,CAAC,CAAC;EACF,OAAOH,MAAM;AACjB;AAGO,SAASU,uBAAuBA,CAAYC,CAA2B,EAAEC,CAA2B,EAAE;EACzG,OAAOD,CAAC,CAAC3B,OAAO,GAAG4B,CAAC,CAAC5B,OAAO,GAAG,CAAC,GAAG,CAAC,CAAC;AACzC;AAGA,SAASS,sBAAsBA,CAC3B1B,MAA+C,EAC/CS,OAA+B,EAC/BK,SAAmC,EACb;EACtB,IAAMgC,UAAU,GAAGhC,SAAS,CAACC,IAAI;EACjC+B,UAAU,CAACC,OAAO,CAACC,SAAS,IAAI;IAC5B,IAAIC,UAAmB;IACvB,IAAID,SAAS,CAACE,QAAQ,EAAE;MACpB,IAAMC,KAAkC,GAAG;QACvCD,QAAQ,EAAE,IAAA7C,qBAAc,EAAC2C,SAAS,CAACE,QAAe,CAAC;QACnDE,IAAI,EAAE,EAAE;QACRC,IAAI,EAAE;MACV,CAAC;MACD,IAAMC,OAAO,GAAG,IAAAC,uBAAe,EAACvD,MAAM,EAAEmD,KAAK,CAAC;MAC9CF,UAAU,GAAGK,OAAO,CAAC7C,OAAc,CAAC;IACxC,CAAC,MAAM;MACHwC,UAAU,GAAG,IAAI;IACrB;IACA,IAAIA,UAAU,EAAE;MACZ,IAAID,SAAS,CAACQ,OAAO,EAAE;QACnB/C,OAAO,GAAG,IAAAgD,0BAAY,EAAyBhD,OAAO,EAAEuC,SAAS,CAACQ,OAAO,CAAC;MAC9E;IACJ,CAAC,MAAM;MACH,IAAIR,SAAS,CAACU,UAAU,EAAE;QACtBjD,OAAO,GAAG,IAAAgD,0BAAY,EAAyBhD,OAAO,EAAEuC,SAAS,CAACU,UAAU,CAAC;MACjF;IACJ;EACJ,CAAC,CAAC;EACF,OAAOjD,OAAO;AAClB;AAEO,eAAee,kBAAkBA,CACpCC,YAA0B,EAC1BkC,KAA6B,EACd;EACf,IAAMC,OAAO,GAAGD,KAAK,CAACtC,UAAU,CAACwC,GAAG,CAAExC,UAAU,IAAK;IACjD,OAAOA,UAAU,CAACwC,GAAG,CAACC,EAAE,IAAIA,EAAE,CAAC7C,OAAO,CAAC;EAC3C,CAAC,CAAC;EACF,IAAMM,IAAI,GAAG,MAAME,YAAY,CAACsC,IAAI,CAACC,SAAS,CAACJ,OAAO,CAAC,CAAC;EACxD,OAAOrC,IAAI;AACf;AAEO,SAAS0C,iBAAiBA,CAAA,EAAwD;EACrF,IAAMC,eAAqD,GAAG;IAC1DC,IAAI,EAAE,QAAQ;IACdC,UAAU,EAAE;MACRrD,IAAI,EAAE;QACFoD,IAAI,EAAE,OAAO;QACbE,KAAK,EAAE;UACHF,IAAI,EAAE,QAAQ;UACdC,UAAU,EAAE;YACRlB,QAAQ,EAAE;cACNiB,IAAI,EAAE;YACV,CAAC;YACDX,OAAO,EAAE;cACLW,IAAI,EAAE;YACV,CAAC;YACDT,UAAU,EAAE;cACRS,IAAI,EAAE;YACV;UACJ,CAAC;UACDG,oBAAoB,EAAE;QAC1B,CAAC;QACDC,QAAQ,EAAE;MACd,CAAC;MACDtD,OAAO,EAAE;QACLkD,IAAI,EAAE;MACV,CAAC;MACDjD,IAAI,EAAE;QACFiD,IAAI,EAAE,QAAQ;QACdK,OAAO,EAAE,CAAC;QACVC,OAAO,EAAE,gBAAgB;QACzBC,UAAU,EAAE;MAChB;IACJ,CAAC;IACDJ,oBAAoB,EAAE,KAAK;IAC3BK,QAAQ,EAAE,CACN,MAAM,EACN,SAAS,EACT,MAAM;EAEd,CAAC;EACD,OAAO;IACHR,IAAI,EAAE,QAAQ;IACdC,UAAU,EAAE;MACR/C,UAAU,EAAE;QACR8C,IAAI,EAAE,OAAO;QACbE,KAAK,EAAE;UACHF,IAAI,EAAE,OAAO;UACbE,KAAK,EAAEH;QACX;MACJ,CAAC;MACD3C,IAAI,EAAE;QACF4C,IAAI,EAAE,QAAQ;QACd;QACAS,SAAS,EAAE;MACf;IACJ,CAAC;IACDN,oBAAoB,EAAE,KAAK;IAC3BK,QAAQ,EAAE,CAAC,YAAY,EAAE,MAAM;EACnC,CAAC;AACL;AAGO,eAAeE,eAAeA,CACjCpD,YAA0B,EAC1BqD,MAAoC,EACpCC,MAAoC,EACC;EAErC;EACA;EACA,IAAID,MAAM,CAACzD,UAAU,CAAC2D,MAAM,GAAGD,MAAM,CAAC1D,UAAU,CAAC2D,MAAM,EAAE;IACrD,CAACF,MAAM,EAAEC,MAAM,CAAC,GAAG,CAACA,MAAM,EAAED,MAAM,CAAC;EACvC;EAEA,IAAMG,GAAiC,GAAG;IACtC5D,UAAU,EAAE,EAAE;IACdE,IAAI,EAAE;EACV,CAAC;EACDuD,MAAM,CAACzD,UAAU,CAAC0B,OAAO,CAAC,CAACmC,GAAG,EAAEC,KAAK,KAAK;IACtC,IAAIC,SAAqC,GAAG,EAAE;IAC9C,IAAMC,GAAG,GAAG,IAAIC,GAAG,CAAS,CAAC,CAAC,CAAC;;IAE/BJ,GAAG,CAACnC,OAAO,CAACe,EAAE,IAAI;MACduB,GAAG,CAACE,GAAG,CAACzB,EAAE,CAAC7C,OAAO,CAAC;MACnBmE,SAAS,CAAC9D,IAAI,CAACwC,EAAE,CAAC;IACtB,CAAC,CAAC;IACF,IAAIiB,MAAM,CAAC1D,UAAU,CAAC8D,KAAK,CAAC,EAAE;MAC1BJ,MAAM,CAAC1D,UAAU,CAAC8D,KAAK,CAAC,CAACpC,OAAO,CAACe,EAAE,IAAI;QACnC,IAAI,CAACuB,GAAG,CAACG,GAAG,CAAC1B,EAAE,CAAC7C,OAAO,CAAC,EAAE;UACtBmE,SAAS,CAAC9D,IAAI,CAACwC,EAAE,CAAC;QACtB;MACJ,CAAC,CAAC;IACN;IACAsB,SAAS,GAAGA,SAAS,CAAChC,IAAI,CAACT,uBAAuB,CAAC;IACnDsC,GAAG,CAAC5D,UAAU,CAAC8D,KAAK,CAAC,GAAGC,SAAS;EACrC,CAAC,CAAC;EAGFH,GAAG,CAAC1D,IAAI,GAAG,MAAMC,kBAAkB,CAACC,YAAY,EAAEwD,GAAG,CAAC;EACtD,OAAOA,GAAG;AACd;AAEO,SAASQ,eAAeA,CAC3BzF,MAA+C,EAC/CS,OAA+B,EAC/BkD,KAAmC,EACb;EACtB,IAAI+B,IAA4B,GAAG;IAC/BC,QAAQ,EAAE;EACd,CAAQ;EACR,IAAAhE,kBAAW,EAAC+D,IAAI,EAAE,IAAArF,qBAAc,EAACL,MAAM,CAACC,IAAI,CAAC,CAACY,KAAK,EAAE8C,KAAK,CAAC;EAC3DA,KAAK,CAACtC,UAAU,CAAC0B,OAAO,CAAC1B,UAAU,IAAI;IACnCA,UAAU,CAAC0B,OAAO,CAACe,EAAE,IAAI;MACrB4B,IAAI,GAAGhE,sBAAsB,CACzB1B,MAAM,EACN0F,IAAI,EACJ5B,EACJ,CAAC;IACL,CAAC,CAAC;EACN,CAAC,CAAC;EACF,OAAO4B,IAAI;AACf;AAGO,SAASE,sBAAsBA,CAClCnE,YAA0B,EAC1BzB,MAA+C,EACnB;EAC5B,IAAMI,WAAW,GAAG,IAAAC,qBAAc,EAACL,MAAM,CAACC,IAAI,CAAC;EAC/C,IAAM4F,SAAS,GAAGzF,WAAW,CAACS,KAAK;EACnC,IAAMiF,YAAY,GAAG,IAAAC,sBAAe,EAAuDF,SAAS,CAAC;EAErG,IAAMG,eAA6C,GAAG,MAAAA,CAClDC,CAAoC,EACpCC,QAAgB,KACf;IACD,IAAMC,UAAU,GAAGL,YAAY,CAACG,CAAC,CAACG,gBAAgB,CAAC;IACnD,IAAMC,aAAa,GAAGP,YAAY,CAACG,CAAC,CAACK,eAAe,CAAC;IAErD,IAAIH,UAAU,CAAC5E,IAAI,KAAK8E,aAAa,CAAC9E,IAAI,EAAE;MACxC,OAAOgF,OAAO,CAACC,OAAO,CAAC;QACnBC,OAAO,EAAE;MACb,CAAC,CAAC;IACN;IAEA,IAAMC,UAAU,GAAG,MAAM7B,eAAe,CAACpD,YAAY,EAAE0E,UAAU,EAAEE,aAAa,CAAC;IACjF,IAAMM,SAAS,GAAGlB,eAAe,CAC7BzF,MAAM,EACNiG,CAAC,CAACG,gBAAgB,EAClBM,UACJ,CAAC;IACD,OAAOH,OAAO,CAACC,OAAO,CAAC;MACnBC,OAAO,EAAE,KAAK;MACdG,YAAY,EAAED;IAClB,CAAC,CAAC;EACN,CAAC;EAED,OAAOX,eAAe;AAC1B;AAGO,IAAMpE,eAAe,GAAAiF,OAAA,CAAAjF,eAAA,GAAG,SAAS;AAEjC,IAAMkF,cAAwB,GAAAD,OAAA,CAAAC,cAAA,GAAG;EACpCC,IAAI,EAAE,MAAM;EACZC,IAAI,EAAE,IAAI;EACVC,UAAU,EAAE;IACRC,UAAU,EAAGC,KAAU,IAAK;MACxBA,KAAK,CAACzH,UAAU,GAAGA,UAAU;MAE7B,IAAM0H,SAAS,GAAGD,KAAK,CAACE,MAAM;MAC9BF,KAAK,CAACE,MAAM,GAAG,YAA4B;QACvC,IAAI,CAAC,IAAI,CAACtH,UAAU,CAACC,MAAM,CAACF,UAAU,CAACG,IAAI,EAAE;UACzC,OAAOmH,SAAS,CAACE,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACjC;QACA,OAAO,IAAI,CAAC5H,UAAU,CAAC;UACnB8D,OAAO,EAAE;YACL+D,IAAI,EAAE;cACF5B,QAAQ,EAAE;YACd;UACJ;QACJ,CAAC,CAAC;MACN,CAAC;MAED,IAAM6B,mBAAmB,GAAGL,KAAK,CAACM,gBAAgB;MAClDN,KAAK,CAACM,gBAAgB,GAAG,UAA4BC,KAAU,EAAE;QAC7D,IAAI,CAAC,IAAI,CAAC3H,UAAU,CAACC,MAAM,CAACF,UAAU,CAACG,IAAI,EAAE;UACzC,OAAOuH,mBAAmB,CAACF,IAAI,CAAC,IAAI,CAAC,CAACI,KAAK,CAAC;QAChD;QACA,OAAO,IAAI,CAAChI,UAAU,CAAC;UACnB8D,OAAO,EAAE;YACL+D,IAAI,EAAEG;UACV;QACJ,CAAC,CAAC;MACN,CAAC;MACD,IAAMC,oBAAoB,GAAGR,KAAK,CAAC3G,iBAAiB;MACpD2G,KAAK,CAAC3G,iBAAiB,GAAG,UAAUoH,EAAO,EAAEC,OAAe,EAAE;QAC1D,IAAI,CAAC,IAAI,CAAC9H,UAAU,CAACC,MAAM,CAACF,UAAU,CAACG,IAAI,EAAE;UACzC,OAAO0H,oBAAoB,CAACL,IAAI,CAAC,IAAI,CAAC,CAACM,EAAE,CAAC;QAC9C;QACA,IAAIC,OAAO,KAAKjG,eAAe,EAAE;UAC7B,OAAO+F,oBAAoB,CAACL,IAAI,CAAC,IAAI,CAAC,CAACM,EAAE,CAAC;QAC9C,CAAC,MAAM;UACH,MAAM,IAAA1H,mBAAU,EAAC,OAAO,EAAE;YACtBuC,EAAE,EAAE,IAAI,CAACqF,OAAO;YAChBC,IAAI,EAAE;cAAEF;YAAQ;UACpB,CAAC,CAAC;QACN;MACJ,CAAC;IACL,CAAC;IACDG,YAAY,EAAGb,KAAU,IAAK;MAC1BA,KAAK,CAACtF,UAAU,GAAGA,UAAU;IACjC;EACJ,CAAC;EACDjC,YAAY,EAAE,CAAC,CAAC;EAChBqI,KAAK,EAAE;IACHC,qBAAqB,EAAE;MACnBC,KAAK,EAAGC,IAAI,IAAK;QACb,IAAI,CAACA,IAAI,CAACpI,MAAM,CAACC,IAAI,EAAE;UACnB;QACJ;QACA,IAAImI,IAAI,CAACpC,eAAe,EAAE;UACtB,MAAM,IAAA9F,mBAAU,EAAC,OAAO,EAAE;YACtBH,UAAU,EAAEqI,IAAI,CAACrB,IAAI;YACrB/G,MAAM,EAAEoI,IAAI,CAACpI;UACjB,CAAC,CAAC;QACN;QACAoI,IAAI,CAACpC,eAAe,GAAGJ,sBAAsB,CACzCwC,IAAI,CAAC7H,QAAQ,CAACkB,YAAY,EAC1B2G,IAAI,CAACpI,MACT,CAAC;MACL;IACJ,CAAC;IACDqI,kBAAkB,EAAE;MAChBF,KAAK,EAAEA,CAAC;QAAEpI;MAAW,CAAC,KAAK;QACvB,IAAI,CAACA,UAAU,CAACC,MAAM,CAACF,UAAU,CAACG,IAAI,EAAE;UACpC;QACJ;QAEA,IAAMG,WAAW,GAAG,IAAAC,qBAAc,EAACN,UAAU,CAACC,MAAM,CAACF,UAAU,CAACG,IAAI,CAAC;QACrE,IAAM4F,SAAS,GAAGzF,WAAW,CAACS,KAAK;QACnC,IAAMyH,OAAO,GAAG,IAAAvC,sBAAe,EAA8B3F,WAAW,CAACS,KAAK,CAAC;;QAE/E;AAChB;AACA;AACA;AACA;QACgB,IAAIjB,oBAAY,CAAC2I,SAAS,CAAC,CAAC,EAAE;UAC1B,IAAMC,eAAe,GAAGzI,UAAU,CAAC0I,eAAe,CAACC,SAAS,CAACpB,IAAI,CAACvH,UAAU,CAAC0I,eAAe,CAAC;UAC7F1I,UAAU,CAAC0I,eAAe,CAACC,SAAS,GAAG,gBAAgBC,MAAM,EAAEd,OAAO,EAAE;YAEpE,MAAMtB,OAAO,CAACqC,GAAG,CACbD,MAAM,CAAC9E,GAAG,CAAC,MAAOgF,KAAK,IAAK;cACxB,IAAMC,WAAkC,GAAG,IAAAnI,YAAK,EAACkI,KAAK,CAACE,QAAQ,CAAC;cAChE,IAAMpF,KAAK,GAAG2E,OAAO,CAACQ,WAAW,CAAC;cAElC,IAAME,OAAO,GAAGvD,eAAe,CAC3B1F,UAAU,CAACC,MAAM,CAACF,UAAU,EAC5BgJ,WAAW,EACXnF,KACJ,CAAC;cAED,SAASsF,cAAcA,CAAC3G,GAAQ,EAAE;gBAC9B,IAAM2C,GAAQ,GAAG,CAAC,CAAC;gBACnBiE,MAAM,CAACC,OAAO,CAAC7G,GAAG,CAAC,CAACS,OAAO,CAAC,CAAC,CAACqG,CAAC,EAAEC,CAAC,CAAC,KAAK;kBACpC,IACI,CAACD,CAAC,CAACE,UAAU,CAAC,GAAG,CAAC,IAClB,OAAOD,CAAC,KAAK,WAAW,EAC1B;oBACEpE,GAAG,CAACmE,CAAC,CAAC,GAAGC,CAAC;kBACd;gBACJ,CAAC,CAAC;gBACF,OAAOpE,GAAG;cACd;cACA,IAAI,CAAC,IAAAsE,gBAAS,EAACN,cAAc,CAACH,WAAW,CAAC,EAAEG,cAAc,CAACD,OAAO,CAAC,CAAC,EAAE;gBAClE,MAAM,IAAA9I,mBAAU,EAAC,KAAK,EAAE;kBACpB6I,QAAQ,EAAED;gBACd,CAAC,CAAC;cACN;cACA,IAAMU,gBAAgB,GAAG,MAAMhI,kBAAkB,CAACzB,UAAU,CAACQ,QAAQ,CAACkB,YAAY,EAAEkC,KAAK,CAAC;cAC1F,IAAIA,KAAK,CAACpC,IAAI,KAAKiI,gBAAgB,EAAE;gBACjC,MAAM,IAAAtJ,mBAAU,EAAC,KAAK,EAAE;kBACpB6I,QAAQ,EAAED,WAAW;kBACrBf,IAAI,EAAE;oBAAExG,IAAI,EAAEoC,KAAK,CAACpC,IAAI;oBAAEiI;kBAAiB;gBAC/C,CAAC,CAAC;cACN;YACJ,CAAC,CACL,CAAC;YAED,OAAOhB,eAAe,CAACG,MAAM,EAAEd,OAAO,CAAC;UAC3C,CAAC;QACL;QAGA,IAAM4B,gBAAgB,GAAG1J,UAAU,CAAC2J,UAAU,CAACpC,IAAI,CAACvH,UAAU,CAAC;QAC/DA,UAAU,CAAC2J,UAAU,GAAG,gBAAgBC,QAAe,EAAE;UACrD,IAAMrJ,YAAY,GAAG,MAAMP,UAAU,CAACQ,QAAQ,CAACD,YAAY;UAC3D,IAAMsJ,WAAW,GAAG,MAAMrD,OAAO,CAACqC,GAAG,CACjCe,QAAQ,CAAC9F,GAAG,CAAC,MAAOpD,OAAO,IAAK;YAC5B,IAAMoJ,KAAmC,GAAG,CAAC,CAAC;YAC9CX,MAAM,CAACC,OAAO,CAAC1I,OAAO,CAAC,CAACsC,OAAO,CAAC,CAAC,CAAC+G,GAAG,EAAEC,KAAK,CAAC,KAAK;cAC9C,IACI,CAACD,GAAG,CAACR,UAAU,CAAC,GAAG,CAAC,IACpBQ,GAAG,KAAKjE,SAAS,EACnB;gBACEgE,KAAK,CAACC,GAAG,CAAC,GAAGC,KAAK;cACtB;YACJ,CAAC,CAAC;YAEF,IAAMC,cAAsC,GAAG;cAC3C3I,UAAU,EAAE,CACR,CAAC;gBACGJ,OAAO,EAAEX,YAAY;gBACrBS,IAAI,EAAE,CAAC;kBACHyC,OAAO,EAAE;oBACL+D,IAAI,EAAEsC;kBACV;gBACJ,CAAC,CAAC;gBACF3I,IAAI,EAAE,IAAAC,UAAG,EAAC;cACd,CAAC,CAAC,CACL;cACDI,IAAI,EAAE;YACV,CAAC;YACDyI,cAAc,CAACzI,IAAI,GAAG,MAAMC,kBAAkB,CAACzB,UAAU,CAACQ,QAAQ,CAACkB,YAAY,EAAEuI,cAAc,CAAC;YAChG,IAAArI,kBAAW,EAAClB,OAAO,EAAEL,WAAW,CAACS,KAAK,EAAEmJ,cAAc,CAAC;YACvD,OAAOvJ,OAAO;UAClB,CAAC,CACL,CAAC;UACD,OAAOgJ,gBAAgB,CAACG,WAAW,CAAC;QACxC,CAAC;MACL;IACJ;EACJ;AACJ,CAAC"}