{"version":3,"file":"index.js","names":["_index","require","_plugin","_index2","_rxjs","_helper","_index3","RxSupabaseReplicationState","exports","_RxReplicationState","replicationIdentifier","collection","pull","push","live","retryTime","autoStart","_this","call","_inheritsLoose2","default","RxReplicationState","replicateSupabase","options","flatClone","addRxPlugin","RxDBLeaderElectionPlugin","primaryPath","schema","waitForLeadership","modifiedField","DEFAULT_MODIFIED_FIELD","deletedField","DEFAULT_DELETED_FIELD","pullStream$","Subject","replicationPrimitivesPull","rowToDoc","row","deleted","modified","doc","_deleted","jsonSchema","properties","fetchById","id","data","error","client","from","tableName","select","eq","limit","length","Error","handler","lastPulledCheckpoint","batchSize","query","queryBuilder","maybeNewQuery","or","order","ascending","lastDoc","lastOfArray","newCheckpoint","undefined","docs","map","documents","checkpoint","ensureNotFalsy","modifier","stream$","asObservable","initialCheckpoint","replicationPrimitivesPush","rows","insertOrReturnConflict","insert","code","POSTGRES_INSERT_CONFLICT_CODE","conflict","updateOrReturnConflict","assumedMasterState","toRow","update","addDocEqualityToQuery","conflicts","Promise","all","newDoc","newDocumentState","c","replicationState","startBefore","start","bind","cancelBefore","cancel","sub","channel","on","event","table","payload","eventType","new","next","subscribe","status","unsubscribe","startReplicationOnLeaderShip"],"sources":["../../../../src/plugins/replication-supabase/index.ts"],"sourcesContent":["import { RxReplicationState, startReplicationOnLeaderShip } from '../replication/index.ts';\nimport { SupabaseCheckpoint, SyncOptionsSupabase } from './types.ts';\nimport { addRxPlugin } from '../../plugin.ts';\nimport { RxDBLeaderElectionPlugin } from '../leader-election/index.ts';\nimport {\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxCollection,\n    RxDocumentData,\n    RxJsonSchema,\n    RxReplicationPullStreamItem,\n    RxReplicationWriteToMasterRow,\n    WithDeleted\n} from '../../types/index';\nimport { Subject } from 'rxjs';\nimport {\n    DEFAULT_DELETED_FIELD,\n    DEFAULT_MODIFIED_FIELD,\n    POSTGRES_INSERT_CONFLICT_CODE,\n    addDocEqualityToQuery\n} from './helper.ts';\nimport { ensureNotFalsy, flatClone, lastOfArray } from '../utils/index.ts';\n\n\n\nexport class RxSupabaseReplicationState<RxDocType> extends RxReplicationState<RxDocType, SupabaseCheckpoint> {\n    constructor(\n        public readonly replicationIdentifier: string,\n        public readonly collection: RxCollection<RxDocType, any, any, any>,\n        public readonly pull?: ReplicationPullOptions<RxDocType, SupabaseCheckpoint>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live: boolean = true,\n        public retryTime: number = 1000 * 5,\n        public autoStart: boolean = true\n    ) {\n        super(\n            replicationIdentifier,\n            collection,\n            '_deleted',\n            pull,\n            push,\n            live,\n            retryTime,\n            autoStart\n        );\n    }\n}\n\n\nexport function replicateSupabase<RxDocType>(\n    options: SyncOptionsSupabase<RxDocType>\n) {\n    options = flatClone(options);\n    addRxPlugin(RxDBLeaderElectionPlugin);\n    const collection = options.collection;\n    const primaryPath = collection.schema.primaryPath;\n\n    // set defaults\n    options.waitForLeadership = typeof options.waitForLeadership === 'undefined' ? true : options.waitForLeadership;\n    options.live = typeof options.live === 'undefined' ? true : options.live;\n    const modifiedField = options.modifiedField ? options.modifiedField : DEFAULT_MODIFIED_FIELD;\n    const deletedField = options.deletedField ? options.deletedField : DEFAULT_DELETED_FIELD;\n\n    const pullStream$: Subject<RxReplicationPullStreamItem<RxDocType, SupabaseCheckpoint>> = new Subject();\n    let replicationPrimitivesPull: ReplicationPullOptions<RxDocType, SupabaseCheckpoint> | undefined;\n\n\n    function rowToDoc(row: any): WithDeleted<RxDocType> {\n        const deleted = !!row[deletedField];\n        const modified = row[modifiedField];\n\n        const doc: WithDeleted<RxDocType> = flatClone(row);\n        delete (doc as any)[deletedField];\n        delete (doc as any)[modifiedField];\n\n        doc._deleted = deleted;\n\n        /**\n         * Only keep the modified value if that field is defined\n         * in the schema.\n         */\n        if ((collection.schema.jsonSchema.properties as any)[modifiedField]) {\n            (doc as any)[modifiedField] = modified;\n        }\n\n        return doc;\n    }\n    async function fetchById(id: string): Promise<WithDeleted<RxDocType>> {\n        const { data, error } = await options.client\n            .from(options.tableName)\n            .select()\n            .eq(primaryPath, id)\n            .limit(1)\n        if (error) throw error\n        if (data.length != 1) throw new Error('doc not found ' + id)\n        return rowToDoc(data[0])\n    }\n\n\n    if (options.pull) {\n        replicationPrimitivesPull = {\n            async handler(\n                lastPulledCheckpoint: SupabaseCheckpoint | undefined,\n                batchSize: number\n            ) {\n                let query = options.client\n                    .from(options.tableName)\n                    .select('*');\n\n                if (options.pull?.queryBuilder) {\n                    const maybeNewQuery = options.pull.queryBuilder({\n                        query,\n                        lastPulledCheckpoint,\n                        batchSize,\n                    });\n                    if (maybeNewQuery) {\n                        query = maybeNewQuery;\n                    }\n                }\n\n                if (lastPulledCheckpoint) {\n                    const { modified, id } = lastPulledCheckpoint;\n\n                    // WHERE modified > :m OR (modified = :m AND id > :id)\n                    // PostgREST or() takes comma-separated disjuncts; use nested and() for the tie-breaker.\n                    // Wrap identifiers with double quotes to be safe if they're mixed-case.\n                    query = query.or(\n                        `\"${modifiedField}\".gt.${modified},and(\"${modifiedField}\".eq.${modified},\"${primaryPath}\".gt.${id})`\n                    );\n                }\n\n                // deterministic order & batch size\n                query = query\n                    .order(modifiedField as any, { ascending: true })\n                    .order(primaryPath as any, { ascending: true })\n                    .limit(batchSize);\n\n                const { data, error } = await query;\n                if (error) {\n                    throw error;\n                }\n\n                const lastDoc = lastOfArray(data);\n                const newCheckpoint: SupabaseCheckpoint | undefined = lastDoc ? {\n                    id: lastDoc[primaryPath],\n                    modified: lastDoc[modifiedField]\n                } : undefined;\n\n                const docs = data.map(row => rowToDoc(row))\n                return {\n                    documents: docs,\n                    checkpoint: newCheckpoint\n                };\n            },\n            batchSize: ensureNotFalsy(options.pull).batchSize,\n            modifier: ensureNotFalsy(options.pull).modifier,\n            stream$: pullStream$.asObservable(),\n            initialCheckpoint: options.pull.initialCheckpoint\n        };\n    }\n\n    const replicationPrimitivesPush: ReplicationPushOptions<RxDocType> | undefined = options.push ? {\n        batchSize: options.push.batchSize,\n        initialCheckpoint: options.push.initialCheckpoint,\n        modifier: options.push.modifier,\n        async handler(\n            rows: RxReplicationWriteToMasterRow<RxDocType>[]\n        ) {\n            async function insertOrReturnConflict(doc: WithDeleted<RxDocType>): Promise<WithDeleted<RxDocType> | undefined> {\n                const id = (doc as any)[primaryPath];\n                const { error } = await options.client.from(options.tableName).insert(doc)\n                if (!error) {\n                    return;\n                } else if (error.code == POSTGRES_INSERT_CONFLICT_CODE) {\n                    // conflict!\n                    const conflict = await fetchById(id);\n                    return conflict;\n                } else {\n                    throw error\n                }\n            }\n            async function updateOrReturnConflict(\n                doc: WithDeleted<RxDocType>,\n                assumedMasterState: WithDeleted<RxDocType>\n            ): Promise<WithDeleted<RxDocType> | undefined> {\n                ensureNotFalsy(assumedMasterState);\n                const id = (doc as any)[primaryPath];\n                const toRow: Record<string, any> = flatClone(doc);\n                if (doc._deleted) {\n                    toRow[deletedField] = !!doc._deleted;\n                    if (deletedField !== '_deleted') {\n                        delete toRow._deleted;\n                    }\n                }\n\n                // modified field will be set server-side\n                delete toRow[modifiedField];\n\n                let query = options.client\n                    .from(options.tableName)\n                    .update(toRow);\n\n                query = addDocEqualityToQuery(\n                    collection.schema.jsonSchema,\n                    deletedField,\n                    modifiedField,\n                    assumedMasterState,\n                    query\n                );\n\n                const { data, error } = await query.select();\n                if (error) {\n                    throw error;\n                }\n\n                if (data && data.length > 0) {\n                    return;\n                } else {\n                    // no match -> conflict\n                    return await fetchById(id);\n                }\n            }\n\n            const conflicts: WithDeleted<RxDocType>[] = [];\n            await Promise.all(\n                rows.map(async (row) => {\n                    const newDoc = row.newDocumentState as WithDeleted<RxDocType>;\n                    if (!row.assumedMasterState) {\n                        const c = await insertOrReturnConflict(newDoc);\n                        if (c) conflicts.push(c);\n                    } else {\n                        const c = await updateOrReturnConflict(newDoc, row.assumedMasterState as any);\n                        if (c) conflicts.push(c);\n                    }\n                })\n            );\n\n            return conflicts;\n        }\n    } : undefined;\n\n\n    const replicationState = new RxSupabaseReplicationState<RxDocType>(\n        options.replicationIdentifier,\n        collection,\n        replicationPrimitivesPull,\n        replicationPrimitivesPush,\n        options.live,\n        options.retryTime,\n        options.autoStart\n    );\n\n    /**\n     * Subscribe to changes for the pull.stream$\n     */\n    if (options.live && options.pull) {\n        const startBefore = replicationState.start.bind(replicationState);\n        const cancelBefore = replicationState.cancel.bind(replicationState);\n        replicationState.start = () => {\n            const sub = options.client\n                .channel('realtime:' + options.tableName)\n                .on(\n                    'postgres_changes',\n                    { event: '*', schema: 'public', table: options.tableName },\n                    (payload) => {\n                        /**\n                         * We assume soft-deletes in supabase\n                         * and therefore cleanup-hard-deletes\n                         * are not relevant for the sync.\n                         */\n                        if (payload.eventType === 'DELETE') {\n                            return;\n                        }\n\n                        const row = payload.new;\n                        const doc = rowToDoc(row);\n                        pullStream$.next({\n                            checkpoint: {\n                                id: (doc as any)[primaryPath],\n                                modified: (row as any)[modifiedField]\n                            },\n                            documents: [doc as any],\n                        });\n                    }\n                )\n                .subscribe((status: string) => {\n                    /**\n                     * Trigger resync flag on reconnects\n                     */\n                    if (status === 'SUBSCRIBED') {\n                        pullStream$.next('RESYNC');\n                    }\n                });\n            replicationState.cancel = () => {\n                sub.unsubscribe();\n                return cancelBefore();\n            };\n            return startBefore();\n        };\n    }\n\n\n    startReplicationOnLeaderShip(options.waitForLeadership, replicationState);\n    return replicationState;\n}\n\n\n"],"mappings":";;;;;;;;;AAAA,IAAAA,MAAA,GAAAC,OAAA;AAEA,IAAAC,OAAA,GAAAD,OAAA;AACA,IAAAE,OAAA,GAAAF,OAAA;AAWA,IAAAG,KAAA,GAAAH,OAAA;AACA,IAAAI,OAAA,GAAAJ,OAAA;AAMA,IAAAK,OAAA,GAAAL,OAAA;AAA2E,IAI9DM,0BAA0B,GAAAC,OAAA,CAAAD,0BAAA,0BAAAE,mBAAA;EACnC,SAAAF,2BACoBG,qBAA6B,EAC7BC,UAAkD,EAClDC,IAA4D,EAC5DC,IAAwC,EACxCC,IAAa,GAAG,IAAI,EAC7BC,SAAiB,GAAG,IAAI,GAAG,CAAC,EAC5BC,SAAkB,GAAG,IAAI,EAClC;IAAA,IAAAC,KAAA;IACEA,KAAA,GAAAR,mBAAA,CAAAS,IAAA,OACIR,qBAAqB,EACrBC,UAAU,EACV,UAAU,EACVC,IAAI,EACJC,IAAI,EACJC,IAAI,EACJC,SAAS,EACTC,SACJ,CAAC;IAACC,KAAA,CAjBcP,qBAA6B,GAA7BA,qBAA6B;IAAAO,KAAA,CAC7BN,UAAkD,GAAlDA,UAAkD;IAAAM,KAAA,CAClDL,IAA4D,GAA5DA,IAA4D;IAAAK,KAAA,CAC5DJ,IAAwC,GAAxCA,IAAwC;IAAAI,KAAA,CACxCH,IAAa,GAAbA,IAAa;IAAAG,KAAA,CACtBF,SAAiB,GAAjBA,SAAiB;IAAAE,KAAA,CACjBD,SAAkB,GAAlBA,SAAkB;IAAA,OAAAC,KAAA;EAY7B;EAAC,IAAAE,eAAA,CAAAC,OAAA,EAAAb,0BAAA,EAAAE,mBAAA;EAAA,OAAAF,0BAAA;AAAA,EApBsDc,yBAAkB;AAwBtE,SAASC,iBAAiBA,CAC7BC,OAAuC,EACzC;EACEA,OAAO,GAAG,IAAAC,iBAAS,EAACD,OAAO,CAAC;EAC5B,IAAAE,mBAAW,EAACC,gCAAwB,CAAC;EACrC,IAAMf,UAAU,GAAGY,OAAO,CAACZ,UAAU;EACrC,IAAMgB,WAAW,GAAGhB,UAAU,CAACiB,MAAM,CAACD,WAAW;;EAEjD;EACAJ,OAAO,CAACM,iBAAiB,GAAG,OAAON,OAAO,CAACM,iBAAiB,KAAK,WAAW,GAAG,IAAI,GAAGN,OAAO,CAACM,iBAAiB;EAC/GN,OAAO,CAACT,IAAI,GAAG,OAAOS,OAAO,CAACT,IAAI,KAAK,WAAW,GAAG,IAAI,GAAGS,OAAO,CAACT,IAAI;EACxE,IAAMgB,aAAa,GAAGP,OAAO,CAACO,aAAa,GAAGP,OAAO,CAACO,aAAa,GAAGC,8BAAsB;EAC5F,IAAMC,YAAY,GAAGT,OAAO,CAACS,YAAY,GAAGT,OAAO,CAACS,YAAY,GAAGC,6BAAqB;EAExF,IAAMC,WAAgF,GAAG,IAAIC,aAAO,CAAC,CAAC;EACtG,IAAIC,yBAA4F;EAGhG,SAASC,QAAQA,CAACC,GAAQ,EAA0B;IAChD,IAAMC,OAAO,GAAG,CAAC,CAACD,GAAG,CAACN,YAAY,CAAC;IACnC,IAAMQ,QAAQ,GAAGF,GAAG,CAACR,aAAa,CAAC;IAEnC,IAAMW,GAA2B,GAAG,IAAAjB,iBAAS,EAACc,GAAG,CAAC;IAClD,OAAQG,GAAG,CAAST,YAAY,CAAC;IACjC,OAAQS,GAAG,CAASX,aAAa,CAAC;IAElCW,GAAG,CAACC,QAAQ,GAAGH,OAAO;;IAEtB;AACR;AACA;AACA;IACQ,IAAK5B,UAAU,CAACiB,MAAM,CAACe,UAAU,CAACC,UAAU,CAASd,aAAa,CAAC,EAAE;MAChEW,GAAG,CAASX,aAAa,CAAC,GAAGU,QAAQ;IAC1C;IAEA,OAAOC,GAAG;EACd;EACA,eAAeI,SAASA,CAACC,EAAU,EAAmC;IAClE,IAAM;MAAEC,IAAI;MAAEC;IAAM,CAAC,GAAG,MAAMzB,OAAO,CAAC0B,MAAM,CACvCC,IAAI,CAAC3B,OAAO,CAAC4B,SAAS,CAAC,CACvBC,MAAM,CAAC,CAAC,CACRC,EAAE,CAAC1B,WAAW,EAAEmB,EAAE,CAAC,CACnBQ,KAAK,CAAC,CAAC,CAAC;IACb,IAAIN,KAAK,EAAE,MAAMA,KAAK;IACtB,IAAID,IAAI,CAACQ,MAAM,IAAI,CAAC,EAAE,MAAM,IAAIC,KAAK,CAAC,gBAAgB,GAAGV,EAAE,CAAC;IAC5D,OAAOT,QAAQ,CAACU,IAAI,CAAC,CAAC,CAAC,CAAC;EAC5B;EAGA,IAAIxB,OAAO,CAACX,IAAI,EAAE;IACdwB,yBAAyB,GAAG;MACxB,MAAMqB,OAAOA,CACTC,oBAAoD,EACpDC,SAAiB,EACnB;QACE,IAAIC,KAAK,GAAGrC,OAAO,CAAC0B,MAAM,CACrBC,IAAI,CAAC3B,OAAO,CAAC4B,SAAS,CAAC,CACvBC,MAAM,CAAC,GAAG,CAAC;QAEhB,IAAI7B,OAAO,CAACX,IAAI,EAAEiD,YAAY,EAAE;UAC5B,IAAMC,aAAa,GAAGvC,OAAO,CAACX,IAAI,CAACiD,YAAY,CAAC;YAC5CD,KAAK;YACLF,oBAAoB;YACpBC;UACJ,CAAC,CAAC;UACF,IAAIG,aAAa,EAAE;YACfF,KAAK,GAAGE,aAAa;UACzB;QACJ;QAEA,IAAIJ,oBAAoB,EAAE;UACtB,IAAM;YAAElB,QAAQ;YAAEM;UAAG,CAAC,GAAGY,oBAAoB;;UAE7C;UACA;UACA;UACAE,KAAK,GAAGA,KAAK,CAACG,EAAE,QACRjC,aAAa,cAAQU,QAAQ,eAASV,aAAa,cAAQU,QAAQ,WAAKb,WAAW,cAAQmB,EAAE,MACrG,CAAC;QACL;;QAEA;QACAc,KAAK,GAAGA,KAAK,CACRI,KAAK,CAAClC,aAAa,EAAS;UAAEmC,SAAS,EAAE;QAAK,CAAC,CAAC,CAChDD,KAAK,CAACrC,WAAW,EAAS;UAAEsC,SAAS,EAAE;QAAK,CAAC,CAAC,CAC9CX,KAAK,CAACK,SAAS,CAAC;QAErB,IAAM;UAAEZ,IAAI;UAAEC;QAAM,CAAC,GAAG,MAAMY,KAAK;QACnC,IAAIZ,KAAK,EAAE;UACP,MAAMA,KAAK;QACf;QAEA,IAAMkB,OAAO,GAAG,IAAAC,mBAAW,EAACpB,IAAI,CAAC;QACjC,IAAMqB,aAA6C,GAAGF,OAAO,GAAG;UAC5DpB,EAAE,EAAEoB,OAAO,CAACvC,WAAW,CAAC;UACxBa,QAAQ,EAAE0B,OAAO,CAACpC,aAAa;QACnC,CAAC,GAAGuC,SAAS;QAEb,IAAMC,IAAI,GAAGvB,IAAI,CAACwB,GAAG,CAACjC,GAAG,IAAID,QAAQ,CAACC,GAAG,CAAC,CAAC;QAC3C,OAAO;UACHkC,SAAS,EAAEF,IAAI;UACfG,UAAU,EAAEL;QAChB,CAAC;MACL,CAAC;MACDT,SAAS,EAAE,IAAAe,sBAAc,EAACnD,OAAO,CAACX,IAAI,CAAC,CAAC+C,SAAS;MACjDgB,QAAQ,EAAE,IAAAD,sBAAc,EAACnD,OAAO,CAACX,IAAI,CAAC,CAAC+D,QAAQ;MAC/CC,OAAO,EAAE1C,WAAW,CAAC2C,YAAY,CAAC,CAAC;MACnCC,iBAAiB,EAAEvD,OAAO,CAACX,IAAI,CAACkE;IACpC,CAAC;EACL;EAEA,IAAMC,yBAAwE,GAAGxD,OAAO,CAACV,IAAI,GAAG;IAC5F8C,SAAS,EAAEpC,OAAO,CAACV,IAAI,CAAC8C,SAAS;IACjCmB,iBAAiB,EAAEvD,OAAO,CAACV,IAAI,CAACiE,iBAAiB;IACjDH,QAAQ,EAAEpD,OAAO,CAACV,IAAI,CAAC8D,QAAQ;IAC/B,MAAMlB,OAAOA,CACTuB,IAAgD,EAClD;MACE,eAAeC,sBAAsBA,CAACxC,GAA2B,EAA+C;QAC5G,IAAMK,EAAE,GAAIL,GAAG,CAASd,WAAW,CAAC;QACpC,IAAM;UAAEqB;QAAM,CAAC,GAAG,MAAMzB,OAAO,CAAC0B,MAAM,CAACC,IAAI,CAAC3B,OAAO,CAAC4B,SAAS,CAAC,CAAC+B,MAAM,CAACzC,GAAG,CAAC;QAC1E,IAAI,CAACO,KAAK,EAAE;UACR;QACJ,CAAC,MAAM,IAAIA,KAAK,CAACmC,IAAI,IAAIC,qCAA6B,EAAE;UACpD;UACA,IAAMC,QAAQ,GAAG,MAAMxC,SAAS,CAACC,EAAE,CAAC;UACpC,OAAOuC,QAAQ;QACnB,CAAC,MAAM;UACH,MAAMrC,KAAK;QACf;MACJ;MACA,eAAesC,sBAAsBA,CACjC7C,GAA2B,EAC3B8C,kBAA0C,EACC;QAC3C,IAAAb,sBAAc,EAACa,kBAAkB,CAAC;QAClC,IAAMzC,EAAE,GAAIL,GAAG,CAASd,WAAW,CAAC;QACpC,IAAM6D,KAA0B,GAAG,IAAAhE,iBAAS,EAACiB,GAAG,CAAC;QACjD,IAAIA,GAAG,CAACC,QAAQ,EAAE;UACd8C,KAAK,CAACxD,YAAY,CAAC,GAAG,CAAC,CAACS,GAAG,CAACC,QAAQ;UACpC,IAAIV,YAAY,KAAK,UAAU,EAAE;YAC7B,OAAOwD,KAAK,CAAC9C,QAAQ;UACzB;QACJ;;QAEA;QACA,OAAO8C,KAAK,CAAC1D,aAAa,CAAC;QAE3B,IAAI8B,KAAK,GAAGrC,OAAO,CAAC0B,MAAM,CACrBC,IAAI,CAAC3B,OAAO,CAAC4B,SAAS,CAAC,CACvBsC,MAAM,CAACD,KAAK,CAAC;QAElB5B,KAAK,GAAG,IAAA8B,6BAAqB,EACzB/E,UAAU,CAACiB,MAAM,CAACe,UAAU,EAC5BX,YAAY,EACZF,aAAa,EACbyD,kBAAkB,EAClB3B,KACJ,CAAC;QAED,IAAM;UAAEb,IAAI;UAAEC;QAAM,CAAC,GAAG,MAAMY,KAAK,CAACR,MAAM,CAAC,CAAC;QAC5C,IAAIJ,KAAK,EAAE;UACP,MAAMA,KAAK;QACf;QAEA,IAAID,IAAI,IAAIA,IAAI,CAACQ,MAAM,GAAG,CAAC,EAAE;UACzB;QACJ,CAAC,MAAM;UACH;UACA,OAAO,MAAMV,SAAS,CAACC,EAAE,CAAC;QAC9B;MACJ;MAEA,IAAM6C,SAAmC,GAAG,EAAE;MAC9C,MAAMC,OAAO,CAACC,GAAG,CACbb,IAAI,CAACT,GAAG,CAAC,MAAOjC,GAAG,IAAK;QACpB,IAAMwD,MAAM,GAAGxD,GAAG,CAACyD,gBAA0C;QAC7D,IAAI,CAACzD,GAAG,CAACiD,kBAAkB,EAAE;UACzB,IAAMS,CAAC,GAAG,MAAMf,sBAAsB,CAACa,MAAM,CAAC;UAC9C,IAAIE,CAAC,EAAEL,SAAS,CAAC9E,IAAI,CAACmF,CAAC,CAAC;QAC5B,CAAC,MAAM;UACH,IAAMA,EAAC,GAAG,MAAMV,sBAAsB,CAACQ,MAAM,EAAExD,GAAG,CAACiD,kBAAyB,CAAC;UAC7E,IAAIS,EAAC,EAAEL,SAAS,CAAC9E,IAAI,CAACmF,EAAC,CAAC;QAC5B;MACJ,CAAC,CACL,CAAC;MAED,OAAOL,SAAS;IACpB;EACJ,CAAC,GAAGtB,SAAS;EAGb,IAAM4B,gBAAgB,GAAG,IAAI1F,0BAA0B,CACnDgB,OAAO,CAACb,qBAAqB,EAC7BC,UAAU,EACVyB,yBAAyB,EACzB2C,yBAAyB,EACzBxD,OAAO,CAACT,IAAI,EACZS,OAAO,CAACR,SAAS,EACjBQ,OAAO,CAACP,SACZ,CAAC;;EAED;AACJ;AACA;EACI,IAAIO,OAAO,CAACT,IAAI,IAAIS,OAAO,CAACX,IAAI,EAAE;IAC9B,IAAMsF,WAAW,GAAGD,gBAAgB,CAACE,KAAK,CAACC,IAAI,CAACH,gBAAgB,CAAC;IACjE,IAAMI,YAAY,GAAGJ,gBAAgB,CAACK,MAAM,CAACF,IAAI,CAACH,gBAAgB,CAAC;IACnEA,gBAAgB,CAACE,KAAK,GAAG,MAAM;MAC3B,IAAMI,GAAG,GAAGhF,OAAO,CAAC0B,MAAM,CACrBuD,OAAO,CAAC,WAAW,GAAGjF,OAAO,CAAC4B,SAAS,CAAC,CACxCsD,EAAE,CACC,kBAAkB,EAClB;QAAEC,KAAK,EAAE,GAAG;QAAE9E,MAAM,EAAE,QAAQ;QAAE+E,KAAK,EAAEpF,OAAO,CAAC4B;MAAU,CAAC,EACzDyD,OAAO,IAAK;QACT;AACxB;AACA;AACA;AACA;QACwB,IAAIA,OAAO,CAACC,SAAS,KAAK,QAAQ,EAAE;UAChC;QACJ;QAEA,IAAMvE,GAAG,GAAGsE,OAAO,CAACE,GAAG;QACvB,IAAMrE,GAAG,GAAGJ,QAAQ,CAACC,GAAG,CAAC;QACzBJ,WAAW,CAAC6E,IAAI,CAAC;UACbtC,UAAU,EAAE;YACR3B,EAAE,EAAGL,GAAG,CAASd,WAAW,CAAC;YAC7Ba,QAAQ,EAAGF,GAAG,CAASR,aAAa;UACxC,CAAC;UACD0C,SAAS,EAAE,CAAC/B,GAAG;QACnB,CAAC,CAAC;MACN,CACJ,CAAC,CACAuE,SAAS,CAAEC,MAAc,IAAK;QAC3B;AACpB;AACA;QACoB,IAAIA,MAAM,KAAK,YAAY,EAAE;UACzB/E,WAAW,CAAC6E,IAAI,CAAC,QAAQ,CAAC;QAC9B;MACJ,CAAC,CAAC;MACNd,gBAAgB,CAACK,MAAM,GAAG,MAAM;QAC5BC,GAAG,CAACW,WAAW,CAAC,CAAC;QACjB,OAAOb,YAAY,CAAC,CAAC;MACzB,CAAC;MACD,OAAOH,WAAW,CAAC,CAAC;IACxB,CAAC;EACL;EAGA,IAAAiB,mCAA4B,EAAC5F,OAAO,CAACM,iBAAiB,EAAEoE,gBAAgB,CAAC;EACzE,OAAOA,gBAAgB;AAC3B","ignoreList":[]}