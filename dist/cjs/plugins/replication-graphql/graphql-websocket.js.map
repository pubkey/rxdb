{"version":3,"file":"graphql-websocket.js","names":["_graphqlWs","require","_index","_isomorphicWs","_interopRequireDefault","WebSocket","IsomorphicWebSocket","ws","GRAPHQL_WEBSOCKET_BY_URL","exports","Map","getGraphQLWebSocket","url","headers","options","has","getFromMapOrCreate","connectionParamsHeaders","undefined","wsClient","createClient","shouldRetry","webSocketImpl","connectionParams","socket","refCount","value","removeGraphQLWebSocketRef","obj","getFromMapOrThrow","delete","dispose"],"sources":["../../../../src/plugins/replication-graphql/graphql-websocket.ts"],"sourcesContent":["import { Client, createClient } from 'graphql-ws';\nimport { getFromMapOrCreate, getFromMapOrThrow } from '../../plugins/utils/index.ts';\nimport ws from 'isomorphic-ws';\nimport { RxGraphQLPullWSOptions } from '../../types';\n\nconst { WebSocket: IsomorphicWebSocket } = ws;\n\nexport type WebsocketWithRefCount = {\n    url: string;\n    socket: Client;\n    refCount: number;\n};\n\nexport const GRAPHQL_WEBSOCKET_BY_URL: Map<string, WebsocketWithRefCount> = new Map();\n\n\nexport function getGraphQLWebSocket(\n    url: string,\n    headers?: { [k: string]: string; },\n    options: RxGraphQLPullWSOptions = {},\n): Client {\n\n    const has = getFromMapOrCreate(\n        GRAPHQL_WEBSOCKET_BY_URL,\n        url,\n        () => {\n            const connectionParamsHeaders = headers ? { headers } : undefined;\n            const wsClient = createClient({\n                ...options,\n                url,\n                shouldRetry: () => true,\n                webSocketImpl: IsomorphicWebSocket,\n                connectionParams: options.connectionParams || connectionParamsHeaders,\n            });\n            return {\n                url,\n                socket: wsClient,\n                refCount: 1\n            };\n        },\n        (value) => {\n            value.refCount = value.refCount + 1;\n        }\n    );\n    return has.socket;\n}\n\n\nexport function removeGraphQLWebSocketRef(\n    url: string\n) {\n    const obj = getFromMapOrThrow(GRAPHQL_WEBSOCKET_BY_URL, url);\n    obj.refCount = obj.refCount - 1;\n    if (obj.refCount === 0) {\n        GRAPHQL_WEBSOCKET_BY_URL.delete(url);\n        obj.socket.dispose();\n    }\n}\n"],"mappings":";;;;;;;;;AAAA,IAAAA,UAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AACA,IAAAE,aAAA,GAAAC,sBAAA,CAAAH,OAAA;AAGA,IAAM;EAAEI,SAAS,EAAEC;AAAoB,CAAC,GAAGC,qBAAE;AAQtC,IAAMC,wBAA4D,GAAAC,OAAA,CAAAD,wBAAA,GAAG,IAAIE,GAAG,CAAC,CAAC;AAG9E,SAASC,mBAAmBA,CAC/BC,GAAW,EACXC,OAAkC,EAClCC,OAA+B,GAAG,CAAC,CAAC,EAC9B;EAEN,IAAMC,GAAG,GAAG,IAAAC,yBAAkB,EAC1BR,wBAAwB,EACxBI,GAAG,EACH,MAAM;IACF,IAAMK,uBAAuB,GAAGJ,OAAO,GAAG;MAAEA;IAAQ,CAAC,GAAGK,SAAS;IACjE,IAAMC,QAAQ,GAAG,IAAAC,uBAAY,EAAC;MAC1B,GAAGN,OAAO;MACVF,GAAG;MACHS,WAAW,EAAEA,CAAA,KAAM,IAAI;MACvBC,aAAa,EAAEhB,mBAAmB;MAClCiB,gBAAgB,EAAET,OAAO,CAACS,gBAAgB,IAAIN;IAClD,CAAC,CAAC;IACF,OAAO;MACHL,GAAG;MACHY,MAAM,EAAEL,QAAQ;MAChBM,QAAQ,EAAE;IACd,CAAC;EACL,CAAC,EACAC,KAAK,IAAK;IACPA,KAAK,CAACD,QAAQ,GAAGC,KAAK,CAACD,QAAQ,GAAG,CAAC;EACvC,CACJ,CAAC;EACD,OAAOV,GAAG,CAACS,MAAM;AACrB;AAGO,SAASG,yBAAyBA,CACrCf,GAAW,EACb;EACE,IAAMgB,GAAG,GAAG,IAAAC,wBAAiB,EAACrB,wBAAwB,EAAEI,GAAG,CAAC;EAC5DgB,GAAG,CAACH,QAAQ,GAAGG,GAAG,CAACH,QAAQ,GAAG,CAAC;EAC/B,IAAIG,GAAG,CAACH,QAAQ,KAAK,CAAC,EAAE;IACpBjB,wBAAwB,CAACsB,MAAM,CAAClB,GAAG,CAAC;IACpCgB,GAAG,CAACJ,MAAM,CAACO,OAAO,CAAC,CAAC;EACxB;AACJ","ignoreList":[]}