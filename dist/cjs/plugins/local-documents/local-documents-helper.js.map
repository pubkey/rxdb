{"version":3,"file":"local-documents-helper.js","names":["_rxError","require","_rxSchemaHelper","_index","_overwritable","LOCAL_DOC_STATE_BY_PARENT","exports","WeakMap","LOCAL_DOC_STATE_BY_PARENT_RESOLVED","getLocalDocStateByParent","parent","statePromise","get","database","collectionName","name","newRxError","collection","createLocalDocumentStorageInstance","databaseInstanceToken","storage","databaseName","instanceCreationOptions","multiInstance","createStorageInstance","getCollectionLocalInstanceName","schema","RX_LOCAL_DOCUMENT_SCHEMA","options","devMode","overwritable","isDevMode","closeStateByParent","delete","then","state","storageInstance","close","removeLocalDocumentsStorageInstance","randomToken","remove","fillWithDefaultSettings","title","version","primaryKey","type","properties","id","maxLength","data","additionalProperties","required"],"sources":["../../../../src/plugins/local-documents/local-documents-helper.ts"],"sourcesContent":["import { newRxError } from '../../rx-error.ts';\nimport { fillWithDefaultSettings } from '../../rx-schema-helper.ts';\nimport type {\n    LocalDocumentParent,\n    LocalDocumentState,\n    RxDatabase,\n    RxDocumentData,\n    RxJsonSchema,\n    RxLocalDocumentData,\n    RxStorage\n} from '../../types/index.d.ts';\nimport { randomToken } from '../../plugins/utils/index.ts';\nimport { overwritable } from '../../overwritable.ts';\n\nexport const LOCAL_DOC_STATE_BY_PARENT: WeakMap<LocalDocumentParent, Promise<LocalDocumentState>> = new WeakMap();\nexport const LOCAL_DOC_STATE_BY_PARENT_RESOLVED: WeakMap<LocalDocumentParent, LocalDocumentState> = new WeakMap();\n\nexport function getLocalDocStateByParent(parent: LocalDocumentParent): Promise<LocalDocumentState> {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (!statePromise) {\n        const database: RxDatabase = parent.database ? parent.database : parent as any;\n        const collectionName = parent.database ? parent.name : '';\n        throw newRxError('LD8', {\n            database: database.name,\n            collection: collectionName\n        });\n    }\n    return statePromise;\n}\n\nexport function createLocalDocumentStorageInstance(\n    databaseInstanceToken: string,\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string,\n    instanceCreationOptions: any,\n    multiInstance: boolean\n) {\n    return storage.createStorageInstance<RxLocalDocumentData>({\n        databaseInstanceToken,\n        databaseName: databaseName,\n        /**\n         * Use a different collection name for the local documents instance\n         * so that the local docs can be kept while deleting the normal instance\n         * after migration.\n         */\n        collectionName: getCollectionLocalInstanceName(collectionName),\n        schema: RX_LOCAL_DOCUMENT_SCHEMA,\n        options: instanceCreationOptions,\n        multiInstance,\n        devMode: overwritable.isDevMode()\n    });\n}\n\nexport function closeStateByParent(parent: LocalDocumentParent) {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (statePromise) {\n        LOCAL_DOC_STATE_BY_PARENT.delete(parent);\n        return statePromise.then(state => state.storageInstance.close());\n    }\n}\n\nexport async function removeLocalDocumentsStorageInstance(\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string\n) {\n    const databaseInstanceToken = randomToken(10);\n    const storageInstance = await createLocalDocumentStorageInstance(\n        databaseInstanceToken,\n        storage,\n        databaseName,\n        collectionName,\n        {},\n        false\n    );\n    await storageInstance.remove();\n}\n\nexport function getCollectionLocalInstanceName(collectionName: string): string {\n    return 'plugin-local-documents-' + collectionName;\n}\n\nexport const RX_LOCAL_DOCUMENT_SCHEMA: RxJsonSchema<RxDocumentData<RxLocalDocumentData>> = fillWithDefaultSettings({\n    title: 'RxLocalDocument',\n    version: 0,\n    primaryKey: 'id',\n    type: 'object',\n    properties: {\n        id: {\n            type: 'string',\n            maxLength: 128\n        },\n        data: {\n            type: 'object',\n            additionalProperties: true\n        }\n    },\n    required: [\n        'id',\n        'data'\n    ]\n});\n"],"mappings":";;;;;;;;;;;AAAA,IAAAA,QAAA,GAAAC,OAAA;AACA,IAAAC,eAAA,GAAAD,OAAA;AAUA,IAAAE,MAAA,GAAAF,OAAA;AACA,IAAAG,aAAA,GAAAH,OAAA;AAEO,IAAMI,yBAAoF,GAAAC,OAAA,CAAAD,yBAAA,GAAG,IAAIE,OAAO,CAAC,CAAC;AAC1G,IAAMC,kCAAoF,GAAAF,OAAA,CAAAE,kCAAA,GAAG,IAAID,OAAO,CAAC,CAAC;AAE1G,SAASE,wBAAwBA,CAACC,MAA2B,EAA+B;EAC/F,IAAMC,YAAY,GAAGN,yBAAyB,CAACO,GAAG,CAACF,MAAM,CAAC;EAC1D,IAAI,CAACC,YAAY,EAAE;IACf,IAAME,QAAoB,GAAGH,MAAM,CAACG,QAAQ,GAAGH,MAAM,CAACG,QAAQ,GAAGH,MAAa;IAC9E,IAAMI,cAAc,GAAGJ,MAAM,CAACG,QAAQ,GAAGH,MAAM,CAACK,IAAI,GAAG,EAAE;IACzD,MAAM,IAAAC,mBAAU,EAAC,KAAK,EAAE;MACpBH,QAAQ,EAAEA,QAAQ,CAACE,IAAI;MACvBE,UAAU,EAAEH;IAChB,CAAC,CAAC;EACN;EACA,OAAOH,YAAY;AACvB;AAEO,SAASO,kCAAkCA,CAC9CC,qBAA6B,EAC7BC,OAA4B,EAC5BC,YAAoB,EACpBP,cAAsB,EACtBQ,uBAA4B,EAC5BC,aAAsB,EACxB;EACE,OAAOH,OAAO,CAACI,qBAAqB,CAAsB;IACtDL,qBAAqB;IACrBE,YAAY,EAAEA,YAAY;IAC1B;AACR;AACA;AACA;AACA;IACQP,cAAc,EAAEW,8BAA8B,CAACX,cAAc,CAAC;IAC9DY,MAAM,EAAEC,wBAAwB;IAChCC,OAAO,EAAEN,uBAAuB;IAChCC,aAAa;IACbM,OAAO,EAAEC,0BAAY,CAACC,SAAS,CAAC;EACpC,CAAC,CAAC;AACN;AAEO,SAASC,kBAAkBA,CAACtB,MAA2B,EAAE;EAC5D,IAAMC,YAAY,GAAGN,yBAAyB,CAACO,GAAG,CAACF,MAAM,CAAC;EAC1D,IAAIC,YAAY,EAAE;IACdN,yBAAyB,CAAC4B,MAAM,CAACvB,MAAM,CAAC;IACxC,OAAOC,YAAY,CAACuB,IAAI,CAACC,KAAK,IAAIA,KAAK,CAACC,eAAe,CAACC,KAAK,CAAC,CAAC,CAAC;EACpE;AACJ;AAEO,eAAeC,mCAAmCA,CACrDlB,OAA4B,EAC5BC,YAAoB,EACpBP,cAAsB,EACxB;EACE,IAAMK,qBAAqB,GAAG,IAAAoB,kBAAW,EAAC,EAAE,CAAC;EAC7C,IAAMH,eAAe,GAAG,MAAMlB,kCAAkC,CAC5DC,qBAAqB,EACrBC,OAAO,EACPC,YAAY,EACZP,cAAc,EACd,CAAC,CAAC,EACF,KACJ,CAAC;EACD,MAAMsB,eAAe,CAACI,MAAM,CAAC,CAAC;AAClC;AAEO,SAASf,8BAA8BA,CAACX,cAAsB,EAAU;EAC3E,OAAO,yBAAyB,GAAGA,cAAc;AACrD;AAEO,IAAMa,wBAA2E,GAAArB,OAAA,CAAAqB,wBAAA,GAAG,IAAAc,uCAAuB,EAAC;EAC/GC,KAAK,EAAE,iBAAiB;EACxBC,OAAO,EAAE,CAAC;EACVC,UAAU,EAAE,IAAI;EAChBC,IAAI,EAAE,QAAQ;EACdC,UAAU,EAAE;IACRC,EAAE,EAAE;MACAF,IAAI,EAAE,QAAQ;MACdG,SAAS,EAAE;IACf,CAAC;IACDC,IAAI,EAAE;MACFJ,IAAI,EAAE,QAAQ;MACdK,oBAAoB,EAAE;IAC1B;EACJ,CAAC;EACDC,QAAQ,EAAE,CACN,IAAI,EACJ,MAAM;AAEd,CAAC,CAAC","ignoreList":[]}