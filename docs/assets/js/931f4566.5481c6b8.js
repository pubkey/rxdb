"use strict";(globalThis.webpackChunkrxdb=globalThis.webpackChunkrxdb||[]).push([[3595],{1270:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"schema-validation","title":"Schema Validation","description":"RxDB has multiple validation implementations that can be used to ensure that your document data is always matching the provided JSON","source":"@site/docs/schema-validation.md","sourceDirName":".","slug":"/schema-validation.html","permalink":"/schema-validation.html","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Schema Validation","slug":"schema-validation.html"},"sidebar":"tutorialSidebar","previous":{"title":"FoundationDB","permalink":"/rx-storage-foundationdb.html"},"next":{"title":"Encryption","permalink":"/encryption.html"}}');var s=a(4848),i=a(8453);const r={title:"Schema Validation",slug:"schema-validation.html"},o="Schema validation",l={},d=[{value:"validate-ajv",id:"validate-ajv",level:3},{value:"validate-z-schema",id:"validate-z-schema",level:3},{value:"validate-is-my-json-valid",id:"validate-is-my-json-valid",level:3},{value:"Custom Formats",id:"custom-formats",level:2},{value:"Ajv Custom Format",id:"ajv-custom-format",level:3},{value:"Z-Schema Custom Format",id:"z-schema-custom-format",level:3},{value:"Performance comparison of the validators",id:"performance-comparison-of-the-validators",level:2}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"schema-validation",children:"Schema validation"})}),"\n",(0,s.jsxs)(t.p,{children:["RxDB has multiple validation implementations that can be used to ensure that your document data is always matching the provided JSON\nschema of your ",(0,s.jsx)(t.code,{children:"RxCollection"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["The schema validation is ",(0,s.jsx)(t.strong,{children:"not a plugin"})," but comes in as a wrapper around any other ",(0,s.jsx)(t.code,{children:"RxStorage"})," and it will then validate all data that is written into that storage. This is required for multiple reasons:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["It allows us to run the validation inside of a ",(0,s.jsx)(t.a,{href:"/rx-storage-worker.html",children:"Worker RxStorage"})," instead of running it in the main JavaScript process."]}),"\n",(0,s.jsxs)(t.li,{children:["It allows us to configure which ",(0,s.jsx)(t.code,{children:"RxDatabase"})," instance must use the validation and which does not. In production it often makes sense to validate user data, but you might not need the validation for data that is only replicated from the backend."]}),"\n"]}),"\n",(0,s.jsx)(t.admonition,{type:"warning",children:(0,s.jsxs)(t.p,{children:["Schema validation can be ",(0,s.jsx)(t.strong,{children:"CPU expensive"})," and increases your build size. You should always use a schema validation in development mode. For most use cases, you ",(0,s.jsx)(t.strong,{children:"should not"})," use a validation in production for better performance."]})}),"\n",(0,s.jsxs)(t.p,{children:["When no validation is used, any document data can be saved but there might be ",(0,s.jsx)(t.strong,{children:"undefined behavior"})," when saving data that does not comply to the schema of a ",(0,s.jsx)(t.code,{children:"RxCollection"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["RxDB has different implementations to validate data, each of them is based on a different ",(0,s.jsx)(t.a,{href:"https://json-schema.org/tools",children:"JSON Schema library"}),". In this example we use the ",(0,s.jsx)(t.a,{href:"/rx-storage-localstorage.html",children:"LocalStorage RxStorage"}),", but you can wrap the validation around ",(0,s.jsx)(t.strong,{children:"any other"})," ",(0,s.jsx)(t.a,{href:"/rx-storage.html",children:"RxStorage"}),"."]}),"\n",(0,s.jsx)(t.h3,{id:"validate-ajv",children:"validate-ajv"}),"\n",(0,s.jsxs)(t.p,{children:["A validation-module that does the schema-validation. This one is using ",(0,s.jsx)(t.a,{href:"https://github.com/epoberezkin/ajv",children:"ajv"})," as validator which is a bit faster. Better compliant to the jsonschema-standard but also has a bigger build-size."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-javascript",children:"import { wrappedValidateAjvStorage } from 'rxdb/plugins/validate-ajv';\nimport { getRxStorageLocalstorage } from 'rxdb/plugins/storage-localstorage';\n\n// wrap the validation around the main RxStorage\nconst storage = wrappedValidateAjvStorage({\n    storage: getRxStorageLocalstorage()\n});\n\nconst db = await createRxDatabase({\n    name: randomCouchString(10),\n    storage\n});\n"})}),"\n",(0,s.jsx)(t.h3,{id:"validate-z-schema",children:"validate-z-schema"}),"\n",(0,s.jsxs)(t.p,{children:["Both ",(0,s.jsx)(t.code,{children:"is-my-json-valid"})," and ",(0,s.jsx)(t.code,{children:"validate-ajv"})," use ",(0,s.jsx)(t.code,{children:"eval()"})," to perform validation which might not be wanted when ",(0,s.jsx)(t.code,{children:"'unsafe-eval'"})," is not allowed in Content Security Policies. This one is using ",(0,s.jsx)(t.a,{href:"https://github.com/zaggino/z-schema",children:"z-schema"})," as validator which doesn't use ",(0,s.jsx)(t.code,{children:"eval"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-javascript",children:"import { wrappedValidateZSchemaStorage } from 'rxdb/plugins/validate-z-schema';\nimport { getRxStorageLocalstorage } from 'rxdb/plugins/storage-localstorage';\n\n// wrap the validation around the main RxStorage\nconst storage = wrappedValidateZSchemaStorage({\n    storage: getRxStorageLocalstorage()\n});\n\nconst db = await createRxDatabase({\n    name: randomCouchString(10),\n    storage\n});\n"})}),"\n",(0,s.jsx)(t.h3,{id:"validate-is-my-json-valid",children:"validate-is-my-json-valid"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"WARNING"}),": The ",(0,s.jsx)(t.code,{children:"is-my-json-valid"})," validation is no longer supported until ",(0,s.jsx)(t.a,{href:"https://github.com/mafintosh/is-my-json-valid/pull/192",children:"this bug"})," is fixed."]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"validate-is-my-json-valid"})," plugin uses ",(0,s.jsx)(t.a,{href:"https://www.npmjs.com/package/is-my-json-valid",children:"is-my-json-valid"})," for schema validation."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-javascript",children:"import { wrappedValidateIsMyJsonValidStorage } from 'rxdb/plugins/validate-is-my-json-valid';\nimport { getRxStorageLocalstorage } from 'rxdb/plugins/storage-localstorage';\n\n// wrap the validation around the main RxStorage\nconst storage = wrappedValidateIsMyJsonValidStorage({\n    storage: getRxStorageLocalstorage()\n});\n\nconst db = await createRxDatabase({\n    name: randomCouchString(10),\n    storage\n});\n"})}),"\n",(0,s.jsx)(t.h2,{id:"custom-formats",children:"Custom Formats"}),"\n",(0,s.jsxs)(t.p,{children:["The schema validators provide methods to add custom formats like a ",(0,s.jsx)(t.code,{children:"email"})," format.\nYou have to add these formats ",(0,s.jsx)(t.strong,{children:"before"})," you create your database."]}),"\n",(0,s.jsx)(t.h3,{id:"ajv-custom-format",children:"Ajv Custom Format"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import { getAjv } from 'rxdb/plugins/validate-ajv';\nconst ajv = getAjv();\najv.addFormat('email', {\n    type: 'string',\n    validate: v => v.includes('@') // ensure email fields contain the @ symbol\n});\n"})}),"\n",(0,s.jsx)(t.h3,{id:"z-schema-custom-format",children:"Z-Schema Custom Format"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"import { ZSchemaClass } from 'rxdb/plugins/validate-z-schema';\nZSchemaClass.registerFormat('email', function (v: string) {\n    return v.includes('@'); // ensure email fields contain the @ symbol\n});\n"})}),"\n",(0,s.jsx)(t.h2,{id:"performance-comparison-of-the-validators",children:"Performance comparison of the validators"}),"\n",(0,s.jsxs)(t.p,{children:["The RxDB team ran performance benchmarks using two storage options on an Ubuntu 24.04 machine with Chrome version ",(0,s.jsx)(t.code,{children:"131.0.6778.85"}),". The testing machine has 32 core ",(0,s.jsx)(t.code,{children:"13th Gen Intel(R) Core(TM) i9-13900HX"})," CPU."]}),"\n",(0,s.jsx)(t.p,{children:"IndexedDB Storage (based on the IndexedDB API in the browser):"}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:(0,s.jsx)(t.strong,{children:"IndexedDB Storage"})}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Time to First insert"}),(0,s.jsx)(t.th,{style:{textAlign:"right"},children:"Insert 3000 documents"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"no validator"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"68 ms"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"213 ms"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"ajv"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"67 ms"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"216 ms"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"z-schema"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"71 ms"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"230 ms"})]})]})]}),"\n",(0,s.jsx)(t.p,{children:"Memory Storage: stores everything in memory for extremely fast reads and writes, with no persistence by default. Often used with the RxDB memory-mapped plugin that processes data in memory an later persists to disc in background:"}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:(0,s.jsx)(t.strong,{children:"Memory Storage"})}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Time to First insert"}),(0,s.jsx)(t.th,{style:{textAlign:"right"},children:"Insert 3000 documents"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"no validator"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"1.15 ms"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"0.8 ms"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"ajv"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"3.05 ms"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"2.7 ms"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"z-schema"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"0.9 ms"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"18 ms"})]})]})]}),"\n",(0,s.jsx)(t.p,{children:"Including a validator library also increases your JavaScript bundle size. Here's how it breaks down (minified + gzip):"}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsxs)(t.th,{children:[(0,s.jsx)(t.strong,{children:"Build Size"})," (minified+gzip)"]}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Build Size (IndexedDB)"}),(0,s.jsx)(t.th,{style:{textAlign:"right"},children:"Build Size (memory)"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"no validator"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"73103 B"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"39976 B"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"ajv"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"106135 B"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"72773 B"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"z-schema"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"125186 B"}),(0,s.jsx)(t.td,{style:{textAlign:"right"},children:"91882 B"})]})]})]})]})}function c(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},8453:(e,t,a)=>{a.d(t,{R:()=>r,x:()=>o});var n=a(6540);const s={},i=n.createContext(s);function r(e){const t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);