"use strict";(globalThis.webpackChunkrxdb=globalThis.webpackChunkrxdb||[]).push([[7149],{3247(e,s,n){n.d(s,{g:()=>o});var r=n(4848);function o(e){const s=[];let n=null;return e.children.forEach(e=>{e.props.id?(n&&s.push(n),n={headline:e,paragraphs:[]}):n&&n.paragraphs.push(e)}),n&&s.push(n),(0,r.jsx)("div",{style:i.stepsContainer,children:s.map((e,s)=>(0,r.jsxs)("div",{style:i.stepWrapper,children:[(0,r.jsxs)("div",{style:i.stepIndicator,children:[(0,r.jsx)("div",{style:i.stepNumber,children:s+1}),(0,r.jsx)("div",{style:i.verticalLine})]}),(0,r.jsxs)("div",{style:i.stepContent,children:[(0,r.jsx)("div",{children:e.headline}),e.paragraphs.map((e,s)=>(0,r.jsx)("div",{style:i.item,children:e},s))]})]},s))})}const i={stepsContainer:{display:"flex",flexDirection:"column"},stepWrapper:{display:"flex",alignItems:"stretch",marginBottom:"1.5rem",position:"relative",minWidth:0},stepIndicator:{position:"relative",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-start",width:"33px",marginRight:"1rem",minWidth:0},stepNumber:{width:"33px",height:"33px",borderRadius:"50%",backgroundColor:"var(--color-top)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"bold",marginTop:-4},verticalLine:{position:"absolute",top:29,bottom:"0",left:"50%",width:"1px",background:"linear-gradient(to bottom, var(--color-top) 0%, var(--color-top) 80%, rgba(0,0,0,0) 100%)",transform:"translateX(-50%)"},stepContent:{flex:1,minWidth:0,overflowWrap:"break-word"},item:{marginTop:"0.5rem"}}},5384(e,s,n){n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>t,metadata:()=>r,toc:()=>h});const r=JSON.parse('{"id":"replication-http","title":"HTTP Replication","description":"Learn how to establish HTTP replication between RxDB clients and a Node.js Express server for data synchronization.","source":"@site/docs/replication-http.md","sourceDirName":".","slug":"/replication-http.html","permalink":"/replication-http.html","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"HTTP Replication","slug":"replication-http.html","description":"Learn how to establish HTTP replication between RxDB clients and a Node.js Express server for data synchronization."},"sidebar":"tutorialSidebar","previous":{"title":"\u2699\ufe0f Sync Engine","permalink":"/replication.html"},"next":{"title":"RxServer Replication","permalink":"/replication-server.html"}}');var o=n(4848),i=n(8453),l=n(3247);n(2636);const t={title:"HTTP Replication",slug:"replication-http.html",description:"Learn how to establish HTTP replication between RxDB clients and a Node.js Express server for data synchronization."},a="HTTP Replication from a custom server to RxDB clients",c={},h=[{value:"Setup",id:"setup",level:2},{value:"Start the Replication on the RxDB Client",id:"start-the-replication-on-the-rxdb-client",level:3},{value:"Start a Node.js process with Express and MongoDB",id:"start-a-nodejs-process-with-express-and-mongodb",level:3},{value:"Implement the Pull Endpoint",id:"implement-the-pull-endpoint",level:3},{value:"Implement the Pull Handler",id:"implement-the-pull-handler",level:3},{value:"Implement the Push Endpoint",id:"implement-the-push-endpoint",level:3},{value:"Implement the Push Handler",id:"implement-the-push-handler",level:3},{value:"Implement the pullStream$ Endpoint",id:"implement-the-pullstream-endpoint",level:3},{value:"Implement the pullStream$ Handler",id:"implement-the-pullstream-handler",level:3},{value:"pullStream$ RESYNC flag",id:"pullstream-resync-flag",level:3},{value:"Missing implementation details",id:"missing-implementation-details",level:2}];function d(e){const s={a:"a",admonition:"admonition",code:"code",figure:"figure",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",span:"span",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(s.header,{children:(0,o.jsx)(s.h1,{id:"http-replication-from-a-custom-server-to-rxdb-clients",children:"HTTP Replication from a custom server to RxDB clients"})}),"\n",(0,o.jsxs)(s.p,{children:["While RxDB has a range of backend-specific replication plugins (like ",(0,o.jsx)(s.a,{href:"/replication-graphql.html",children:"GraphQL"})," or ",(0,o.jsx)(s.a,{href:"/replication-firestore.html",children:"Firestore"}),"), the replication is build in a way to make it very easy to replicate data from a custom server to RxDB clients."]}),"\n",(0,o.jsx)("p",{align:"center",children:(0,o.jsx)("img",{src:"./files/icons/with-gradient/replication.svg",alt:"HTTP replication",height:"60"})}),"\n",(0,o.jsxs)(s.p,{children:["Using ",(0,o.jsx)(s.strong,{children:"HTTP"})," as a transport protocol makes it simple to create a compatible backend on top of your existing infrastructure. For events that must be sent from the server to the client, we can use ",(0,o.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events",children:"Server Send Events"}),"."]}),"\n",(0,o.jsx)(s.p,{children:"In this tutorial we will implement a HTTP replication between an RxDB client and a MongoDB express server. You can adapt this for any other backend database technology like PostgreSQL or even a non-Node.js server like go or java."}),"\n",(0,o.jsxs)(s.p,{children:["To create a compatible server for replication, we will start a server and implement the correct HTTP routes and replication handlers. We need a push-handler, a pull-handler and for the ongoing changes ",(0,o.jsx)(s.code,{children:"pull.stream"})," we use ",(0,o.jsx)(s.strong,{children:"Server Send Events"}),"."]}),"\n",(0,o.jsx)(s.h2,{id:"setup",children:"Setup"}),"\n",(0,o.jsxs)(l.g,{children:[(0,o.jsx)(s.h3,{id:"start-the-replication-on-the-rxdb-client",children:"Start the Replication on the RxDB Client"}),(0,o.jsxs)(s.p,{children:["RxDB does not have a specific HTTP-replication plugin because the ",(0,o.jsx)(s.a,{href:"/replication.html",children:"replication primitives plugin"})," is simple enough to start a HTTP replication on top of it.\nWe import the ",(0,o.jsx)(s.code,{children:"replicateRxCollection"})," function and start the replication from there for a single ",(0,o.jsx)(s.a,{href:"/rx-collection.html",children:"RxCollection"}),"."]}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > client.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { replicateRxCollection } "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxdb/plugins/replication'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" replicationState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" replicateRxCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    collection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" myRxCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    replicationIdentifier"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'my-http-replication'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    push"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"/* add settings from below */"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" }"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    pull"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"/* add settings from below */"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" }"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),(0,o.jsx)(s.h3,{id:"start-a-nodejs-process-with-express-and-mongodb",children:"Start a Node.js process with Express and MongoDB"}),(0,o.jsx)(s.p,{children:"On the server side, we start an express server that has a MongoDB connection and serves the HTTP requests of the client."}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > server.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { MongoClient } "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'mongodb'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" express "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'express'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" mongoClient"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" new"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" MongoClient"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'mongodb://localhost:27017/'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" mongoConnection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" mongoClient"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".connect"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" mongoDatabase"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" mongoConnection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".db"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'myDatabase'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" mongoCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" mongoDatabase"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".collection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'myDocs'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:" "}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" app"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" express"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"app"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".use"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"express"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".json"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"());"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:" "}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"/* ... add routes from below */"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:" "}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"app"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".listen"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"80"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"  console"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".log"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`Example app listening on port 80`"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:")"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),(0,o.jsx)(s.h3,{id:"implement-the-pull-endpoint",children:"Implement the Pull Endpoint"}),(0,o.jsxs)(s.p,{children:["As first HTTP Endpoint, we need to implement the pull handler. This is used by the RxDB replication to fetch all documents writes that happened after a given ",(0,o.jsx)(s.code,{children:"checkpoint"}),"."]}),(0,o.jsxs)(s.p,{children:["The ",(0,o.jsx)(s.code,{children:"checkpoint"})," format is not determined by RxDB, instead the server can use any type of changepoint that can be used to iterate across document writes. Here we will just use a unix timestamp ",(0,o.jsx)(s.code,{children:"updatedAt"})," and a string ",(0,o.jsx)(s.code,{children:"id"})," which is the most common used format."]}),(0,o.jsx)(s.p,{children:"When the pull endpoint is called, the server responds with an array of document data based on the given checkpoint and a new checkpoint.\nAlso the server has to respect the batchSize so that RxDB knows when there are no more new documents and the server returns a non-full array."}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > server.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { lastOfArray } "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxdb/plugins/core'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"app"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".get"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'/pull'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" (req"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" res) "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" req"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"query"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".id;"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" updatedAt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" parseFloat"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"req"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"query"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".updatedAt);"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" mongoCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".find"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"            $or"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" ["})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"                /**"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"                 * Notice that we have to compare the updatedAt AND the id field"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"                 * because the updateAt field is not unique and when two documents"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:'                 * have the same updateAt, we can still "sort" them by their id.'})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"                 */"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                {"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                    updateAt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { $gt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" updatedAt }"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                }"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                {"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                    updateAt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { $eq"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" updatedAt }"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                    id: { $gt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" id }"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                }"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"            ]"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        })"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"        .sort"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({updateAt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" 1"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" 1"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"})"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"        .limit"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"parseInt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"req"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"query"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".batchSize"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" 10"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"))"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".toArray"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" newCheckpoint"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"length"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ==="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" 0"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ?"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" updatedAt } "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" lastOfArray"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(documents).id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        updatedAt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" lastOfArray"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(documents).updatedAt"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    };"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"    res"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".setHeader"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'Content-Type'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'application/json'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"    res"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".end"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"JSON"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".stringify"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({ documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" checkpoint"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" newCheckpoint }));"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),(0,o.jsx)(s.h3,{id:"implement-the-pull-handler",children:"Implement the Pull Handler"}),(0,o.jsxs)(s.p,{children:["On the client we add the ",(0,o.jsx)(s.code,{children:"pull.handler"})," to the replication setting. The handler request the correct server url and fetches the documents."]}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > client.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" replicationState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" replicateRxCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"    /* ... */"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    pull"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"        async"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" handler"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(checkpointOrNull"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" batchSize){"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"            const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" updatedAt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" checkpointOrNull "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"?"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" checkpointOrNull"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".updatedAt "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" 0"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"            const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" checkpointOrNull "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"?"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" checkpointOrNull"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".id "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" ''"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"            const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" response"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" fetch"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"                `https://localhost/pull?updatedAt="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"updatedAt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"&id="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"&limit="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"${"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"batchSize"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"}"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"`"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"            );"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"            const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" data"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" response"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".json"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"            return"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" data"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                checkpoint"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" data"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".checkpoint"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"            };"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        }"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:" "}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"    /* ... */"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),(0,o.jsx)(s.h3,{id:"implement-the-push-endpoint",children:"Implement the Push Endpoint"}),(0,o.jsxs)(s.p,{children:["To send client side writes to the server, we have to implement the ",(0,o.jsx)(s.code,{children:"push.handler"}),". It gets an array of change rows as input and has to return only the conflicting documents that did not have been written to the server. Each change row contains a ",(0,o.jsx)(s.code,{children:"newDocumentState"})," and an optional ",(0,o.jsx)(s.code,{children:"assumedMasterState"}),"."]}),(0,o.jsxs)(s.p,{children:["For ",(0,o.jsx)(s.a,{href:"/transactions-conflicts-revisions.html",children:"conflict detection"}),", on the server we first have to detect if the ",(0,o.jsx)(s.code,{children:"assumedMasterState"}),' is correct for each row. If yes, we have to write the new document state to the database, otherwise we have to return the "real" master state in the conflict array.']}),(0,o.jsxs)(s.p,{children:["The server also creates an ",(0,o.jsx)(s.code,{children:"event"})," that is emitted to the ",(0,o.jsx)(s.code,{children:"pullStream$"})," which is later used in the ",(0,o.jsx)(s.a,{href:"#pullstream-for-ongoing-changes",children:"pull.stream$"}),"."]}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > server.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { lastOfArray } "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxdb/plugins/core'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { Subject } "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxjs'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:" "}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// used in the pull.stream$ below"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"let"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" lastEventId "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" 0"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" pullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" new"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" Subject"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:" "}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"app"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".get"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'/push'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" (req"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" res) "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" changeRows"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" req"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".body;"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" conflicts"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" [];"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" event"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" lastEventId"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"++"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" []"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        checkpoint"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" null"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    };"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    for"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" of"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" changeRows){"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"        const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" realMasterState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" mongoCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".findOne"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"newDocumentState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".id});"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"        if"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"            realMasterState "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"&&"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" !"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".assumedMasterState "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"||"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"            ("})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                realMasterState "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"&&"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".assumedMasterState "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"&&"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"                /*"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"                 * For simplicity we detect conflicts on the server by only compare the updateAt value."})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"                 * In reality you might want to do a more complex check or do a deep-equal comparison."})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"                 */"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"                realMasterState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".updatedAt "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"!=="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"assumedMasterState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".updatedAt"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"            )"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        ) {"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"            // we have a conflict"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"            conflicts"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".push"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(realMasterState);"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        } "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"else"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"            // no conflict -> write the document"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"            mongoCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".updateOne"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                {id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"newDocumentState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".id}"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"                changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".newDocumentState"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"            );"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"            event"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".push"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".newDocumentState);"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"            event"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".checkpoint "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"newDocumentState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".id"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" updatedAt"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" changeRow"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"newDocumentState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".updatedAt };"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        }"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    if"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"event"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"length"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" >"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" 0"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"){"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"        myPullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".next"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(event);"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"    res"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".setHeader"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'Content-Type'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'application/json'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"    res"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".end"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"JSON"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".stringify"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(conflicts));"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),(0,o.jsx)(s.admonition,{type:"note",children:(0,o.jsx)(s.p,{children:"For simplicity in this tutorial, we do not use transactions. In reality you should run the full push function inside of a MongoDB transaction to ensure that no other process can mix up the document state while the writes are processed. Also you should call batch operations on MongoDB instead of running the operations for each change row."})}),(0,o.jsx)(s.h3,{id:"implement-the-push-handler",children:"Implement the Push Handler"}),(0,o.jsxs)(s.p,{children:["With the push endpoint in place, we can add a ",(0,o.jsx)(s.code,{children:"push.handler"})," to the replication settings on the client."]}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > client.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" replicationState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" replicateRxCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"    /* ... */"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    push"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"        async"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" handler"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(changeRows){"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"            const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" rawResponse"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" fetch"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'https://localhost/push'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                method"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'POST'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                headers"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"                    'Accept'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'application/json'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"                    'Content-Type'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'application/json'"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                }"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"                body"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" JSON"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".stringify"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(changeRows)"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"            });"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"            const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" conflictsArray"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" rawResponse"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".json"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"            return"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" conflictsArray;"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        }"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"    /* ... */"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),(0,o.jsx)(s.h3,{id:"implement-the-pullstream-endpoint",children:"Implement the pullStream$ Endpoint"}),(0,o.jsxs)(s.p,{children:["While the normal pull handler is used when the replication is in ",(0,o.jsx)(s.a,{href:"/replication.html#checkpoint-iteration",children:"iteration mode"}),", we also need a stream of ongoing changes when the replication is in ",(0,o.jsx)(s.a,{href:"/replication.html#event-observation",children:"event observation mode"}),". This brings the realtime replication to RxDB where changes on the server or on a client will directly get propagated to the other instances."]}),(0,o.jsxs)(s.p,{children:["On the server we have to implement the ",(0,o.jsx)(s.code,{children:"pullStream"})," route and emit the events. We use the ",(0,o.jsx)(s.code,{children:"pullStream$"})," observable from ",(0,o.jsx)(s.a,{href:"#push-from-the-client-to-the-server",children:"above"})," to fetch all ongoing events and respond them to the client. Here we use Server-Sent-Events (SSE) which is the most common used way to stream data from the server to the client. Other method also exist like ",(0,o.jsx)(s.a,{href:"/articles/websockets-sse-polling-webrtc-webtransport.html",children:"WebSockets or Long-Polling"}),"."]}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > server.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"app"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".get"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'/pullStream'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" (req"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" res) "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"    res"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".writeHead"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"200"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"        'Content-Type'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'text/event-stream'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"        'Connection'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'keep-alive'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"        'Cache-Control'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'no-cache'"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    });"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" subscription"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" pullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".subscribe"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(event "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"        res"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".write"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'data: '"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" +"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" JSON"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".stringify"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"(event) "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"+"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" '\\n\\n'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    });"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"    req"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".on"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'close'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" subscription"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".unsubscribe"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"());"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),(0,o.jsx)(s.admonition,{type:"note",children:(0,o.jsxs)(s.p,{children:["How the build the ",(0,o.jsx)(s.code,{children:"pullStream$"})," Observable is not part of this tutorial. This heavily depends on your backend and infrastructure. Likely you have to observe the MongoDB event stream."]})}),(0,o.jsx)(s.h3,{id:"implement-the-pullstream-handler",children:"Implement the pullStream$ Handler"}),(0,o.jsxs)(s.p,{children:["From the client we can observe this endpoint and create a ",(0,o.jsx)(s.code,{children:"pull.stream$"})," observable that emits all events that are send from the server to the client.\nThe client connects to an url and receives server-sent-events that contain all ongoing writes."]}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > client.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { Subject } "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxjs'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" myPullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" new"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" Subject"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" eventSource"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" new"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" EventSource"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"    'http://localhost/pullStream'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    { withCredentials"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" true"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" }"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"eventSource"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"onmessage"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" event "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" eventData"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" JSON"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".parse"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"event"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".data);"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"    myPullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".next"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" eventData"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".documents"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        checkpoint"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" eventData"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:".checkpoint"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    });"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"};"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:" "}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" replicationState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" replicateRxCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"    /* ... */"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    pull"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"        /* ... */"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        stream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" myPullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".asObservable"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"()"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"    /* ... */"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),(0,o.jsx)(s.h3,{id:"pullstream-resync-flag",children:"pullStream$ RESYNC flag"}),(0,o.jsxs)(s.p,{children:["In case the client looses the connection, the EventSource will automatically reconnect but there might have been some changes that have been missed out in the meantime. The replication has to be informed that it might have missed events by emitting a ",(0,o.jsx)(s.code,{children:"RESYNC"})," flag from the ",(0,o.jsx)(s.code,{children:"pull.stream$"}),".\nThe replication will then catch up by switching to the ",(0,o.jsx)(s.a,{href:"/replication.html#checkpoint-iteration",children:"iteration mode"})," until it is in sync with the server again."]}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > client.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"eventSource"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"onerror"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" myPullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".next"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'RESYNC'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})]})]})})}),(0,o.jsxs)(s.p,{children:["The purpose of the ",(0,o.jsx)(s.code,{children:"RESYNC"}),' flag is to tell the client that "something might have changed" and then the client can react on that information without having to run operations in an interval.']}),(0,o.jsxs)(s.p,{children:["If your backend is not capable of emitting the actual documents and checkpoint in the pull stream, you could just map all events to the ",(0,o.jsx)(s.code,{children:"RESYNC"})," flag. This would make the replication work with a slight performance drawback:"]}),(0,o.jsx)(s.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(s.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(s.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// > client.ts"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" { Subject } "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxjs'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" myPullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" new"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" Subject"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" eventSource"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" new"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" EventSource"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"    'http://localhost/pullStream'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    { withCredentials"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" true"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" }"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"eventSource"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"onmessage"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" myPullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".next"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'RESYNC'"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:");"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" replicationState"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" replicateRxCollection"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    pull"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(s.span,{"data-line":"",children:[(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"        stream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:" myPullStream$"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:".asObservable"}),(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"()"})]}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsx)(s.span,{"data-line":"",children:(0,o.jsx)(s.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})})]}),"\n",(0,o.jsx)(s.h2,{id:"missing-implementation-details",children:"Missing implementation details"}),"\n",(0,o.jsx)(s.p,{children:"In this tutorial we only covered the basics of doing a HTTP replication between RxDB clients and a server. We did not cover the following aspects of the implementation:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:"Authentication: To authenticate the client on the server, you might want to send authentication headers with the HTTP requests"}),"\n",(0,o.jsxs)(s.li,{children:["Skip events on the ",(0,o.jsx)(s.code,{children:"pull.stream$"})," for the client that caused the changes to improve performance."]}),"\n",(0,o.jsxs)(s.li,{children:["Version upgrades: You should add a version-flag to the endpoint urls. If you then update the version of your endpoints in any way, your old endpoints should emit a ",(0,o.jsx)(s.code,{children:"Code 426"})," to outdated clients so that they can updated their client version."]}),"\n"]})]})}function p(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453(e,s,n){n.d(s,{R:()=>l,x:()=>t});var r=n(6540);const o={},i=r.createContext(o);function l(e){const s=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function t(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),r.createElement(i.Provider,{value:s},e.children)}}}]);