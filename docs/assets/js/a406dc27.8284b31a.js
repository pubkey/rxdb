"use strict";(globalThis.webpackChunkrxdb=globalThis.webpackChunkrxdb||[]).push([[1500],{2774:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>i,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"migration-storage","title":"Migration Storage","description":"Effortlessly migrate your data between storages in RxDB using the Storage Migration plugin. Retain your documents when switching storages or major versions.","source":"@site/docs/migration-storage.md","sourceDirName":".","slug":"/migration-storage.html","permalink":"/migration-storage.html","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Migration Storage","slug":"migration-storage.html","description":"Effortlessly migrate your data between storages in RxDB using the Storage Migration plugin. Retain your documents when switching storages or major versions."},"sidebar":"tutorialSidebar","previous":{"title":"Schema Migration","permalink":"/migration-schema.html"},"next":{"title":"Attachments","permalink":"/rx-attachment.html"}}');var r=a(4848),o=a(8453);const i={title:"Migration Storage",slug:"migration-storage.html",description:"Effortlessly migrate your data between storages in RxDB using the Storage Migration plugin. Retain your documents when switching storages or major versions."},s="Storage Migration",l={},d=[{value:"Usage",id:"usage",level:2},{value:"Migrate from a previous RxDB major version",id:"migrate-from-a-previous-rxdb-major-version",level:2},{value:"Disable Version Check on RxDB Premium \ud83d\udc51",id:"disable-version-check-on-rxdb-premium-",level:2}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"storage-migration",children:"Storage Migration"})}),"\n",(0,r.jsx)(t.p,{children:"The storage migration plugin can be used to migrate all data from one existing RxStorage into another. This is useful when:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["You want to migrate from one ",(0,r.jsx)(t.a,{href:"/rx-storage.html",children:"RxStorage"})," to another one."]}),"\n",(0,r.jsx)(t.li,{children:"You want to migrate to a new major RxDB version while keeping the previous saved data. This function only works from the previous major version upwards. Do not use it to migrate like rxdb v9 to v14."}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["The storage migration ",(0,r.jsx)(t.strong,{children:"drops deleted documents"})," and filters them out during the migration."]}),"\n",(0,r.jsxs)(t.admonition,{title:"Do never change the schema while doing a storage migration",type:"warning",children:[(0,r.jsx)(t.p,{children:"When you migrate between storages, you might want to change the schema in the same process. You should never do that because it will lead to problems afterwards and might make your database unusable."}),(0,r.jsxs)(t.p,{children:["When you also want to change your schema, first run the storage migration and afterwards run a normal ",(0,r.jsx)(t.a,{href:"/migration-schema.html",children:"schema migration"}),"."]})]}),"\n",(0,r.jsx)(t.h2,{id:"usage",children:"Usage"}),"\n",(0,r.jsxs)(t.p,{children:["Lets say you want to migrate from ",(0,r.jsx)(t.a,{href:"/rx-storage-localstorage.html",children:"LocalStorage RxStorage"})," to the ",(0,r.jsx)(t.a,{href:"/rx-storage-indexeddb.html",children:"IndexedDB RxStorage"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"import { migrateStorage } from 'rxdb/plugins/migration-storage';\nimport { getRxStorageIndexedDB } from 'rxdb-premium/plugins/storage-indexeddb';\nimport { getRxStorageLocalstorage } from 'rxdb-old/plugins/storage-localstorage';\n\n// create the new RxDatabase\nconst db = await createRxDatabase({\n    name: dbLocation,\n    storage: getRxStorageIndexedDB(),\n    multiInstance: false\n});\n\nawait migrateStorage({\n    database: db as any,\n    /**\n     * Name of the old database,\n     * using the storage migration requires that the\n     * new database has a different name.\n     */\n    oldDatabaseName: 'myOldDatabaseName',\n    oldStorage: getRxStorageLocalstorage(), // RxStorage of the old database\n    batchSize: 500, // batch size\n    parallel: false, // <- true if it should migrate all collections in parallel. False (default) if should migrate in serial\n    afterMigrateBatch: (input: AfterMigrateBatchHandlerInput) => {\n        console.log('storage migration: batch processed');\n    }\n});\n"})}),"\n",(0,r.jsxs)(t.admonition,{type:"note",children:[(0,r.jsx)(t.p,{children:"Only collections that exist in the new database at the time you call migrateStorage() will have their data migrated."}),(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["If your old database had collections ",(0,r.jsx)(t.code,{children:"['users', 'posts', 'comments']"})," but your new database only defines ",(0,r.jsx)(t.code,{children:"['users', 'posts']"}),", then only users and posts data will be migrated."]}),"\n",(0,r.jsx)(t.li,{children:"Any collections missing from the new database will simply be skipped - no data for them will be read or written."}),"\n"]}),(0,r.jsxs)(t.p,{children:["This allows you to selectively migrate only certain collections if desired, by choosing which collections to define before invoking ",(0,r.jsx)(t.code,{children:"migrateStorage()"}),"."]})]}),"\n",(0,r.jsx)(t.h2,{id:"migrate-from-a-previous-rxdb-major-version",children:"Migrate from a previous RxDB major version"}),"\n",(0,r.jsxs)(t.p,{children:["To migrate from a previous RxDB major version, you have to install the 'old' RxDB in the ",(0,r.jsx)(t.code,{children:"package.json"})]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{\n    "dependencies": {\n        "rxdb-old": "npm:rxdb@14.17.1",\n    }\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:"Then you can run the migration by providing the old storage:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"/* ... */\nimport { migrateStorage } from 'rxdb/plugins/migration-storage';\nimport { getRxStorageLocalstorage } from 'rxdb-old/plugins/storage-localstorage'; // <- import from the old RxDB version\n\nawait migrateStorage({\n    database: db as any,\n    /**\n     * Name of the old database,\n     * using the storage migration requires that the\n     * new database has a different name.\n     */\n    oldDatabaseName: 'myOldDatabaseName',\n    oldStorage: getRxStorageLocalstorage(), // RxStorage of the old database\n    batchSize: 500, // batch size\n    parallel: false,\n    afterMigrateBatch: (input: AfterMigrateBatchHandlerInput) => {\n        console.log('storage migration: batch processed');\n    }\n});\n/* ... */\n"})}),"\n",(0,r.jsxs)(t.h2,{id:"disable-version-check-on-rxdb-premium-",children:["Disable Version Check on ",(0,r.jsx)(t.a,{href:"/premium/",children:"RxDB Premium \ud83d\udc51"})]}),"\n",(0,r.jsxs)(t.p,{children:["RxDB Premium has a check in place that ensures that you do not accidentally use the wrong RxDB core and \ud83d\udc51 Premium version together which could break your database state.\nThis can be a problem during migrations where you have multiple versions of RxDB in use and it will throw the error ",(0,r.jsx)(t.code,{children:"Version mismatch detected"}),".\nYou can disable that check by importing and running the ",(0,r.jsx)(t.code,{children:"disableVersionCheck()"})," function from RxDB Premium."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"// RxDB Premium v15 or newer:\nimport {\n    disableVersionCheck\n} from 'rxdb-premium-old/plugins/shared';\ndisableVersionCheck();\n\n\n// RxDB Premium v14:\n\n// for esm\nimport {\n    disableVersionCheck\n} from 'rxdb-premium-old/dist/es/shared/version-check.js';\ndisableVersionCheck();\n\n// for cjs\nimport {\n    disableVersionCheck\n} from 'rxdb-premium-old/dist/lib/shared/version-check.js';\ndisableVersionCheck();\n"})})]})}function c(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},8453:(e,t,a)=>{a.d(t,{R:()=>i,x:()=>s});var n=a(6540);const r={},o=n.createContext(r);function i(e){const t=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);