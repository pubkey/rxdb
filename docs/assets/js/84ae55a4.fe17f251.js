"use strict";(globalThis.webpackChunkrxdb=globalThis.webpackChunkrxdb||[]).push([[588],{7465(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"replication-nats","title":"RxDB & NATS - Realtime Sync","description":"Seamlessly sync your RxDB data with NATS for real-time, two-way replication. Handle conflicts, errors, and retries with ease.","source":"@site/docs/replication-nats.md","sourceDirName":".","slug":"/replication-nats.html","permalink":"/replication-nats.html","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"RxDB & NATS - Realtime Sync","slug":"replication-nats.html","description":"Seamlessly sync your RxDB data with NATS for real-time, two-way replication. Handle conflicts, errors, and retries with ease."},"sidebar":"tutorialSidebar","previous":{"title":"Supabase Replication","permalink":"/replication-supabase.html"},"next":{"title":"Appwrite Replication","permalink":"/replication-appwrite.html"}}');var r=s(4848),t=s(8453);const a={title:"RxDB & NATS - Realtime Sync",slug:"replication-nats.html",description:"Seamlessly sync your RxDB data with NATS for real-time, two-way replication. Handle conflicts, errors, and retries with ease."},o="Replication with NATS",l={},c=[{value:"Precondition",id:"precondition",level:2},{value:"Usage",id:"usage",level:2},{value:"Handling deletes",id:"handling-deletes",level:2}];function d(e){const n={a:"a",code:"code",em:"em",figure:"figure",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",span:"span",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"replication-with-nats",children:"Replication with NATS"})}),"\n",(0,r.jsxs)(n.p,{children:["With this RxDB plugin you can run a two-way realtime replication with a ",(0,r.jsx)(n.a,{href:"https://nats.io/",children:"NATS"})," server."]}),"\n",(0,r.jsxs)(n.p,{children:["The replication itself uses the ",(0,r.jsx)(n.a,{href:"/replication.html",children:"RxDB Sync Engine"})," which handles conflicts, errors and retries.\nOn the client side the official ",(0,r.jsx)(n.a,{href:"https://www.npmjs.com/package/nats",children:"NATS npm package"})," is used to connect to the NATS server."]}),"\n",(0,r.jsx)(n.p,{children:"NATS is a messaging system that by itself does not have a validation or granulary access control build in.\nTherefore it is not recommended to directly replicate the NATS server with an untrusted RxDB client application. Instead you should replicated from NATS to your Node.js server side RxDB database."}),"\n",(0,r.jsx)(n.h2,{id:"precondition",children:"Precondition"}),"\n",(0,r.jsxs)(n.p,{children:["For the replication endpoint the NATS cluster must have enabled ",(0,r.jsx)(n.a,{href:"https://docs.nats.io/nats-concepts/jetstream",children:"JetStream"})," and store all message data as ",(0,r.jsx)(n.a,{href:"https://docs.nats.io/using-nats/developer/sending/structure",children:"structured JSON"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"The easiest way to start a compatible NATS server is to use the official docker image:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"docker run --rm --name rxdb-nats -p 4222:4222 nats:2.9.17 -js"})}),"\n",(0,r.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,r.jsxs)(n.p,{children:["To start the replication, import the ",(0,r.jsx)(n.code,{children:"replicateNats()"})," method from the RxDB plugin and call it with the collection\nthat must be replicated.\nThe replication runs ",(0,r.jsx)(n.em,{children:"per RxCollection"}),", you can replicate multiple RxCollections by starting a new replication for each of them."]}),"\n",(0,r.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,r.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"typescript","data-theme":"css-variables",children:(0,r.jsxs)(n.code,{"data-language":"typescript","data-theme":"css-variables",style:{display:"grid"},children:[(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsx)(n.span,{"data-line":"",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    replicateNats"})}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"} "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxdb/plugins/replication-nats'"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,r.jsx)(n.span,{"data-line":"",children:" "}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" replicationState"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" replicateNats"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    collection"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" myRxCollection"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    replicationIdentifier"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'my-nats-replication-collection-A'"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsx)(n.span,{"data-line":"",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"    // in NATS, each stream need a name"})}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    streamName"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'stream-for-replication-A'"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsx)(n.span,{"data-line":"",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"    /**"})}),"\n",(0,r.jsx)(n.span,{"data-line":"",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"     * The subject prefix determines how the documents are stored in NATS."})}),"\n",(0,r.jsx)(n.span,{"data-line":"",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"     * For example the document with id 'alice' will have the subject 'foobar.alice'"})}),"\n",(0,r.jsx)(n.span,{"data-line":"",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"     */"})}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    subjectPrefix"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'foobar'"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    connection"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" { servers"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'localhost:4222'"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" }"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    live"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" true"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    pull"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"        batchSize"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" 30"})]}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    }"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    push"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{"data-line":"",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"        batchSize"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" 30"})]}),"\n",(0,r.jsx)(n.span,{"data-line":"",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,r.jsx)(n.span,{"data-line":"",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),"\n",(0,r.jsx)(n.h2,{id:"handling-deletes",children:"Handling deletes"}),"\n",(0,r.jsxs)(n.p,{children:["RxDB requires you to never ",(0,r.jsx)(n.a,{href:"/replication.html#data-layout-on-the-server",children:"fully delete documents"}),". This is needed to be able to replicate the deletion state of a document to other instances. The NATS replication will set a boolean ",(0,r.jsx)(n.code,{children:"_deleted"})," field to all documents to indicate the deletion state. You can change this by setting a different ",(0,r.jsx)(n.code,{children:"deletedField"})," in the sync options."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>a,x:()=>o});var i=s(6540);const r={},t=i.createContext(r);function a(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);