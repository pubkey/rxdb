"use strict";(globalThis.webpackChunkrxdb=globalThis.webpackChunkrxdb||[]).push([[2845],{4787(s,n,e){e.r(n),e.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"migration-schema","title":"Seamless Schema Data Migration with RxDB","description":"Upgrade your RxDB collections without losing data. Learn how to seamlessly migrate schema changes and keep your apps running smoothly.","source":"@site/docs/migration-schema.md","sourceDirName":".","slug":"/migration-schema.html","permalink":"/migration-schema.html","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Seamless Schema Data Migration with RxDB","slug":"migration-schema.html","description":"Upgrade your RxDB collections without losing data. Learn how to seamlessly migrate schema changes and keep your apps running smoothly."},"sidebar":"tutorialSidebar","previous":{"title":"Errors","permalink":"/errors.html"},"next":{"title":"Storage Migration","permalink":"/migration-storage.html"}}');var o=e(4848),i=e(8453);const a={title:"Seamless Schema Data Migration with RxDB",slug:"migration-schema.html",description:"Upgrade your RxDB collections without losing data. Learn how to seamlessly migrate schema changes and keep your apps running smoothly."},l="Migrate Database Data on schema changes",t={},c=[{value:"Providing strategies",id:"providing-strategies",level:2},{value:"autoMigrate",id:"automigrate",level:2},{value:"migrationStates()",id:"migrationstates",level:2},{value:"Migrating attachments",id:"migrating-attachments",level:2},{value:"Migration on multi-tab in browsers",id:"migration-on-multi-tab-in-browsers",level:2},{value:"Migration and Replication",id:"migration-and-replication",level:2},{value:"Migration should be run on all database instances",id:"migration-should-be-run-on-all-database-instances",level:2}];function d(s){const n={a:"a",code:"code",figure:"figure",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",span:"span",strong:"strong",...(0,i.R)(),...s.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"migrate-database-data-on-schema-changes",children:"Migrate Database Data on schema changes"})}),"\n",(0,o.jsxs)(n.p,{children:["The RxDB Data Migration Plugin helps developers easily update stored data in their apps when they make changes to the data structure by changing the schema of a ",(0,o.jsx)(n.a,{href:"/rx-collection.html",children:"RxCollection"}),". This is useful when developers release a new version of the app with a different schema."]}),"\n",(0,o.jsxs)(n.p,{children:["Imagine you have your awesome messenger-app distributed to many users. After a while, you decide that in your new version, you want to change the schema of the messages-collection. Instead of saving the message-date like ",(0,o.jsx)(n.code,{children:"2017-02-12T23:03:05+00:00"})," you want to have the unix-timestamp like ",(0,o.jsx)(n.code,{children:"1486940585"})," to make it easier to compare dates. To accomplish this, you change the schema and ",(0,o.jsx)(n.strong,{children:"increase the version-number"})," and you also change your code where you save the incoming messages. But one problem remains: what happens with the messages which are already stored in the database on the user's device in the old schema?"]}),"\n",(0,o.jsx)(n.p,{children:"With RxDB you can provide migrationStrategies for your collections that automatically (or on call) transform your existing data from older to newer schemas. This assures that the client's data always matches your newest code-version."}),"\n",(0,o.jsx)(n.h1,{id:"add-the-migration-plugin",children:"Add the migration plugin"}),"\n",(0,o.jsxs)(n.p,{children:["To enable the data migration, you have to add the ",(0,o.jsx)(n.code,{children:"migration-schema"})," plugin."]}),"\n",(0,o.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,o.jsxs)(n.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" { addRxPlugin } "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxdb'"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" { RxDBMigrationSchemaPlugin } "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxdb/plugins/migration-schema'"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"addRxPlugin"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(RxDBMigrationSchemaPlugin);"})]})]})})}),"\n",(0,o.jsx)(n.h2,{id:"providing-strategies",children:"Providing strategies"}),"\n",(0,o.jsxs)(n.p,{children:["Upon creation of a collection, you have to provide migrationStrategies when your schema's version-number is greater than ",(0,o.jsx)(n.code,{children:"0"}),". To do this, you have to add an object to the ",(0,o.jsx)(n.code,{children:"migrationStrategies"})," property where a function for every schema-version is assigned. A migrationStrategy is a function which gets the old document-data as a parameter and returns the new, transformed document-data. If the strategy returns ",(0,o.jsx)(n.code,{children:"null"}),", the document will be removed instead of migrated."]}),"\n",(0,o.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"javascript","data-theme":"css-variables",children:(0,o.jsxs)(n.code,{"data-language":"javascript","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"myDatabase"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".addCollections"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  messages"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    schema"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" messageSchemaV1"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    migrationStrategies"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"      // 1 means, this transforms data from version 0 to version 1"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      1"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" function"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(oldDoc){"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"        oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".time "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" new"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" Date"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".time)"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".getTime"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(); "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"// string to unix"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" oldDoc;"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),"\n",(0,o.jsx)(n.p,{children:"Asynchronous strategies can also be used:"}),"\n",(0,o.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"javascript","data-theme":"css-variables",children:(0,o.jsxs)(n.code,{"data-language":"javascript","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"myDatabase"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".addCollections"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  messages"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    schema"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" messageSchemaV1"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    migrationStrategies"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      1"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" function"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(oldDoc){"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"        oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".time "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" new"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" Date"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".time)"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".getTime"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(); "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"// string to unix"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" oldDoc;"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      }"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"      /**"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"       * 2 means, this transforms data from version 1 to version 2"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"       * this returns a promise which resolves with the new document-data"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"       */"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      2"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" function"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(oldDoc){"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"        // in the new schema (version: 2) we defined 'senderCountry' as required field (string)"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"        // so we must get the country of the message-sender from the server"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        const"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" coordinates"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".coordinates;"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" fetch"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'http://myserver.com/api/countryByCoordinates/'"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"+"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"coordinates"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"+"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'/'"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:")"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"          .then"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(response "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"            const"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" response"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" response"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".json"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"            oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".senderCountry "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" response;"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"            return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" oldDoc;"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"          });"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),"\n",(0,o.jsx)(n.p,{children:"you can also filter which documents should be migrated:"}),"\n",(0,o.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"js","data-theme":"css-variables",children:(0,o.jsxs)(n.code,{"data-language":"js","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"myDatabase"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".addCollections"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  messages"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    schema"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" messageSchemaV1"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    migrationStrategies"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"      // 1 means, this transforms data from version 0 to version 1"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      1"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" function"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(oldDoc){"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"        oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".time "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" new"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" Date"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".time)"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".getTime"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(); "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"// string to unix"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" oldDoc;"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      }"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"      /**"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"       * this removes all documents older then 2017-02-12"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"       * they will not appear in the new collection"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"       */"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      2"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" function"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(oldDoc){"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        if"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".time "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"<"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" 1486940585"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:") "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" null"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        else"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" oldDoc;"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),"\n",(0,o.jsx)(n.h2,{id:"automigrate",children:"autoMigrate"}),"\n",(0,o.jsxs)(n.p,{children:["By default, the migration automatically happens when the collection is created. Calling ",(0,o.jsx)(n.code,{children:"RxDatabase.addCollections()"})," returns only when the migration has finished.\nIf you have lots of data or the migrationStrategies take a long time, it might be better to start the migration 'by hand' and show the migration-state to the user as a loading-bar."]}),"\n",(0,o.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"javascript","data-theme":"css-variables",children:(0,o.jsxs)(n.code,{"data-language":"javascript","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" messageCol"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" myDatabase"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".addCollections"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  messages"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    schema"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" messageSchemaV1"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    autoMigrate"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" false"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:" // <- migration will not run at creation"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    migrationStrategies"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      1"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" async"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" function"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(oldDoc){"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        ..."})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"        anything that takes very long"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        ..."})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" oldDoc;"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:" "}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"// check if migration is needed"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" needed"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" messageCol"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".migrationNeeded"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"if"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(needed "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"==="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" false"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:") {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"}"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:" "}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"// start the migration"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"messageCol"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".startMigration"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"10"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"); "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"// 10 is the batch-size, how many docs will run at parallel"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:" "}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" migrationState"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" messageCol"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".getMigrationState"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:" "}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"// 'start' the observable"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"migrationState"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"$"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".subscribe"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"    next"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" state "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" console"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".dir"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(state)"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"    error"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" error "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" console"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".error"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(error)"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"    complete"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" console"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".log"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'done'"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:")"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:" "}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"// the emitted states look like this:"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"{"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    status"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'RUNNING'"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:" // oneOf 'RUNNING' | 'DONE' | 'ERROR'"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    count"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      total"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" 50"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"   // amount of documents which must be migrated"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      handled"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" 0"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"  // amount of handled docs"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      percent"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" 0"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"   // percentage [0-100]"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"}"})})]})})}),"\n",(0,o.jsxs)(n.p,{children:["If you don't want to show the state to the user, you can also use ",(0,o.jsx)(n.code,{children:".migratePromise()"}),":"]}),"\n",(0,o.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"js","data-theme":"css-variables",children:(0,o.jsxs)(n.code,{"data-language":"js","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" migrationPromise"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" messageCol"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".migratePromise"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"10"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:");"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"await"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" migratePromise;"})]})]})})}),"\n",(0,o.jsx)(n.h2,{id:"migrationstates",children:"migrationStates()"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"RxDatabase.migrationStates()"})," returns an ",(0,o.jsx)(n.code,{children:"Observable"})," that emits all migration states of any collection of the database.\nUse this when you add collections dynamically and want to show a loading-state of the migrations to the user."]}),"\n",(0,o.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"js","data-theme":"css-variables",children:(0,o.jsxs)(n.code,{"data-language":"js","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" allStatesObservable"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" myDatabase"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".migrationStates"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"allStatesObservable"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".subscribe"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(allStates "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"  allStates"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".forEach"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(migrationState "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"    console"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".log"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:"      'migration state of '"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" +"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      migrationState"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"collection"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".name"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    );"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  });"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),"\n",(0,o.jsx)(n.h2,{id:"migrating-attachments",children:"Migrating attachments"}),"\n",(0,o.jsxs)(n.p,{children:["When you store ",(0,o.jsx)(n.code,{children:"RxAttachment"}),"s together with your document, they can also be changed, added or removed while running the migration.\nYou can do this by mutating the ",(0,o.jsx)(n.code,{children:"oldDoc._attachments"})," property."]}),"\n",(0,o.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,o.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"js","data-theme":"css-variables",children:(0,o.jsxs)(n.code,{"data-language":"js","data-theme":"css-variables",style:{display:"grid"},children:[(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" { createBlob } "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxdb'"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" migrationStrategies"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      1"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" async"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" function"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(oldDoc){"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"        // do nothing with _attachments to keep all attachments and have them in the new collection version."})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" oldDoc;"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      }"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      2"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" async"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" function"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(oldDoc){"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"        // set _attachments to an empty object to delete all existing ones during the migration."})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"        oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"._attachments "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {};"})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" oldDoc;"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      }"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"      3"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:": "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"async"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" function"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(oldDoc){"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"        // update the data field of a single attachment to change its data. "})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"        oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"_attachments"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"myFile"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".data "}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" createBlob"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:"          'my new text'"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"          oldDoc"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"_attachments"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"myFile"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".content_type"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"        );"})}),"\n",(0,o.jsxs)(n.span,{"data-line":"",children:[(0,o.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"        return"}),(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" oldDoc;"})]}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      }"})}),"\n",(0,o.jsx)(n.span,{"data-line":"",children:(0,o.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"}"})})]})})}),"\n",(0,o.jsx)(n.h2,{id:"migration-on-multi-tab-in-browsers",children:"Migration on multi-tab in browsers"}),"\n",(0,o.jsxs)(n.p,{children:["If you use RxDB in a multiInstance environment, like a browser, it will ensure that exactly one tab is running a migration of a collection.\nAlso the ",(0,o.jsx)(n.code,{children:"migrationState.$"})," events are emitted between browser tabs."]}),"\n",(0,o.jsx)(n.h2,{id:"migration-and-replication",children:"Migration and Replication"}),"\n",(0,o.jsxs)(n.p,{children:["If you use any of the ",(0,o.jsx)(n.a,{href:"/replication.html",children:"RxReplication"})," plugins, the migration will also run on the internal replication-state storage. It will migrate all ",(0,o.jsx)(n.code,{children:"assumedMasterState"})," documents\nso that after the migration is done, you do not have to re-run the replication from scratch.\nRxDB assumes that you run the exact same migration on the servers and the clients. Notice that the replication ",(0,o.jsx)(n.code,{children:"pull-checkpoint"})," will not be migrated. Your backend must be compatible with pull-checkpoints of older versions."]}),"\n",(0,o.jsx)(n.h2,{id:"migration-should-be-run-on-all-database-instances",children:"Migration should be run on all database instances"}),"\n",(0,o.jsxs)(n.p,{children:["If you have multiple database instances (for example, if you are running replication inside of a ",(0,o.jsx)(n.a,{href:"/rx-storage-worker.html",children:"Worker"})," or ",(0,o.jsx)(n.a,{href:"/rx-storage-shared-worker.html",children:"SharedWorker"})," and have created a database instance inside of the worker), schema migration should be started on all database instances. All instances must know about all migration strategies and any updated schema versions."]})]})}function h(s={}){const{wrapper:n}={...(0,i.R)(),...s.components};return n?(0,o.jsx)(n,{...s,children:(0,o.jsx)(d,{...s})}):d(s)}},8453(s,n,e){e.d(n,{R:()=>a,x:()=>l});var r=e(6540);const o={},i=r.createContext(o);function a(s){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof s?s(n):{...n,...s}},[n,s])}function l(s){let n;return n=s.disableParentContext?"function"==typeof s.components?s.components(o):s.components||o:a(s.components),r.createElement(i.Provider,{value:n},s.children)}}}]);