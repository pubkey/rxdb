"use strict";(globalThis.webpackChunkrxdb=globalThis.webpackChunkrxdb||[]).push([[9796],{8453(e,n,r){r.d(n,{R:()=>o,x:()=>a});var s=r(6540);const i={},t=s.createContext(i);function o(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:n},e.children)}},8908(e,n,r){r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"replication-server","title":"RxDB Server Replication","description":"The Server Replication Plugin connects to the replication endpoint of an RxDB Server Replication Endpoint and replicates data between the client and the server.","source":"@site/docs/replication-server.md","sourceDirName":".","slug":"/replication-server.html","permalink":"/replication-server.html","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"RxDB Server Replication","slug":"replication-server.html"},"sidebar":"tutorialSidebar","previous":{"title":"HTTP Replication","permalink":"/replication-http.html"},"next":{"title":"GraphQL Replication","permalink":"/replication-graphql.html"}}');var i=r(4848),t=r(8453);const o={title:"RxDB Server Replication",slug:"replication-server.html"},a="RxDB Server Replication",l={},c=[{value:"Usage",id:"usage",level:2},{value:"outdatedClient$",id:"outdatedclient",level:2},{value:"unauthorized$",id:"unauthorized",level:2},{value:"forbidden$",id:"forbidden",level:2},{value:"Custom EventSource implementation",id:"custom-eventsource-implementation",level:2}];function d(e){const n={a:"a",code:"code",em:"em",figure:"figure",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",span:"span",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"rxdb-server-replication",children:"RxDB Server Replication"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.em,{children:"Server Replication Plugin"})," connects to the replication endpoint of an ",(0,i.jsx)(n.a,{href:"/rx-server.html#replication-endpoint",children:"RxDB Server Replication Endpoint"})," and replicates data between the client and the server."]}),"\n",(0,i.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,i.jsxs)(n.p,{children:["The replication server plugin is imported from the ",(0,i.jsx)(n.code,{children:"rxdb-server"})," npm package. Then you start the replication with a given collection and endpoint url by calling ",(0,i.jsx)(n.code,{children:"replicateServer()"}),"."]}),"\n",(0,i.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,i.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,i.jsxs)(n.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" { replicateServer } "}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'rxdb-server/plugins/replication-server'"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:";"})]}),"\n",(0,i.jsx)(n.span,{"data-line":"",children:" "}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" replicationState"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" replicateServer"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    collection"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" usersCollection"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    replicationIdentifier"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'my-server-replication'"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    url"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'http://localhost:80/users/0'"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:" // endpoint url with the servers collection schema version at the end"})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    headers"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"        Authorization"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'Bearer S0VLU0UhI...'"})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    }"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    push"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {}"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    pull"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {}"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    live"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" true"})]}),"\n",(0,i.jsx)(n.span,{"data-line":"",children:(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),"\n",(0,i.jsx)(n.h2,{id:"outdatedclient",children:"outdatedClient$"}),"\n",(0,i.jsxs)(n.p,{children:["When you update your schema at the server and run a migration, you end up with a different replication url that has a new schema version number at the end.\nYour clients might still be running an old version of your application that will no longer be compatible with the endpoint. Therefore when the client tries to call a server endpoint with an outdated schema version, the ",(0,i.jsx)(n.code,{children:"outdatedClient$"})," observable emits to tell your client that the application must be updated. With that event you can tell the client to update the application.\nOn browser application you might want to just reload the page on that event:"]}),"\n",(0,i.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,i.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,i.jsxs)(n.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"replicationState"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"outdatedClient$"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".subscribe"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(() "}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"    location"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".reload"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"();"})]}),"\n",(0,i.jsx)(n.span,{"data-line":"",children:(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),"\n",(0,i.jsx)(n.h2,{id:"unauthorized",children:"unauthorized$"}),"\n",(0,i.jsxs)(n.p,{children:["When you clients auth data is not valid (or no longer valid), the server will no longer accept any requests from you client and inform the client that the auth headers must be updated.\nThe ",(0,i.jsx)(n.code,{children:"unauthorized$"})," observable will emit and expects you to update the headers accordingly so that following requests will be accepted again."]}),"\n",(0,i.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,i.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,i.jsxs)(n.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"replicationState"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"unauthorized$"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".subscribe"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(() "}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"    replicationState"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".setHeaders"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"        Authorization"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'Bearer S0VLU0UhI...'"})]}),"\n",(0,i.jsx)(n.span,{"data-line":"",children:(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    });"})}),"\n",(0,i.jsx)(n.span,{"data-line":"",children:(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),"\n",(0,i.jsx)(n.h2,{id:"forbidden",children:"forbidden$"}),"\n",(0,i.jsxs)(n.p,{children:["When you client behaves wrong in any case, like update non-allowed values or changing documents that it is not allowed to,\nthe server will drop the connection and the replication state will emit on the ",(0,i.jsx)(n.code,{children:"forbidden$"})," observable.\nIt will also automatically stop the replication so that your client does not accidentally DOS attack the server."]}),"\n",(0,i.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,i.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,i.jsxs)(n.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"replicationState"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"."}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"forbidden$"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".subscribe"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(() "}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"    console"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".log"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:"'Client is behaving wrong'"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:");"})]}),"\n",(0,i.jsx)(n.span,{"data-line":"",children:(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})}),"\n",(0,i.jsx)(n.h2,{id:"custom-eventsource-implementation",children:"Custom EventSource implementation"}),"\n",(0,i.jsxs)(n.p,{children:["For the server send events, the ",(0,i.jsx)(n.a,{href:"https://github.com/EventSource/eventsource",children:"eventsource"})," npm package is used instead of the native ",(0,i.jsx)(n.code,{children:"EventSource"})," API. We need this because the native browser API does not support sending headers with the request which is required by the server to parse the auth data."]}),"\n",(0,i.jsx)(n.p,{children:"If the eventsource package does not work for you, you can set an own implementation when creating the replication."}),"\n",(0,i.jsx)(n.figure,{"data-rehype-pretty-code-figure":"",children:(0,i.jsx)(n.pre,{style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0","data-language":"ts","data-theme":"css-variables",children:(0,i.jsxs)(n.code,{"data-language":"ts","data-theme":"css-variables",style:{display:"grid"},children:[(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" replicationState"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" replicateServer"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"({"})]}),"\n",(0,i.jsx)(n.span,{"data-line":"",children:(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"    /* ... */"})}),"\n",(0,i.jsxs)(n.span,{"data-line":"",children:[(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    eventSource"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" MyEventSourceConstructor"})]}),"\n",(0,i.jsx)(n.span,{"data-line":"",children:(0,i.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"    /* ... */"})}),"\n",(0,i.jsx)(n.span,{"data-line":"",children:(0,i.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"});"})})]})})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);