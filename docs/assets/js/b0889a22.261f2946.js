"use strict";(globalThis.webpackChunkrxdb=globalThis.webpackChunkrxdb||[]).push([[1107],{2303:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>r});const l=JSON.parse('{"id":"cleanup","title":"Cleanup","description":"Optimize storage and speed up queries with RxDB\'s Cleanup Plugin, automatically removing old deleted docs while preserving replication states.","source":"@site/docs/cleanup.md","sourceDirName":".","slug":"/cleanup.html","permalink":"/cleanup.html","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Cleanup","slug":"cleanup.html","description":"Optimize storage and speed up queries with RxDB\'s Cleanup Plugin, automatically removing old deleted docs while preserving replication states."},"sidebar":"tutorialSidebar","previous":{"title":"Local Documents","permalink":"/rx-local-document.html"},"next":{"title":"Backup","permalink":"/backup.html"}}');var a=t(4848),i=t(8453);const o={title:"Cleanup",slug:"cleanup.html",description:"Optimize storage and speed up queries with RxDB's Cleanup Plugin, automatically removing old deleted docs while preserving replication states."},s="\ud83e\uddf9 Cleanup",c={},r=[{value:"Installation",id:"installation",level:2},{value:"Create a database with cleanup options",id:"create-a-database-with-cleanup-options",level:2},{value:"Calling cleanup manually",id:"calling-cleanup-manually",level:2},{value:"Using the cleanup plugin to empty a collection",id:"using-the-cleanup-plugin-to-empty-a-collection",level:2},{value:"FAQ",id:"faq",level:2}];function u(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components},{Details:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"-cleanup",children:"\ud83e\uddf9 Cleanup"})}),"\n",(0,a.jsx)(n.p,{children:"To make the replication work, and for other reasons, RxDB has to keep deleted documents in storage so that it can replicate their deletion state.\nThis ensures that when a client is offline, the deletion state is still known and can be replicated with the backend when the client goes online again."}),"\n",(0,a.jsx)(n.p,{children:"Keeping too many deleted documents in the storage, can slow down queries or fill up too much disc space.\nWith the cleanup plugin, RxDB will run cleanup cycles that clean up deleted documents when it can be done safely."}),"\n",(0,a.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"import { addRxPlugin } from 'rxdb';\nimport { RxDBCleanupPlugin } from 'rxdb/plugins/cleanup';\naddRxPlugin(RxDBCleanupPlugin);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"create-a-database-with-cleanup-options",children:"Create a database with cleanup options"}),"\n",(0,a.jsxs)(n.p,{children:["You can set a specific cleanup policy when a ",(0,a.jsx)(n.code,{children:"RxDatabase"})," is created. For most use cases, the defaults should be ok."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"import { createRxDatabase } from 'rxdb';\nimport { getRxStorageLocalstorage } from 'rxdb/plugins/storage-localstorage';\nconst db = await createRxDatabase({\n  name: 'heroesdb',\n  storage: getRxStorageLocalstorage(),\n  cleanupPolicy: {\n      /**\n       * The minimum time in milliseconds for how long\n       * a document has to be deleted before it is\n       * purged by the cleanup.\n       * [default=one month]\n       */\n      minimumDeletedTime: 1000 * 60 * 60 * 24 * 31, // one month,\n      /**\n       * The minimum amount of that that the RxCollection must have existed.\n       * This ensures that at the initial page load, more important\n       * tasks are not slowed down because a cleanup process is running.\n       * [default=60 seconds]\n       */\n      minimumCollectionAge: 1000 * 60, // 60 seconds\n      /**\n       * After the initial cleanup is done,\n       * a new cleanup is started after [runEach] milliseconds \n       * [default=5 minutes]\n       */\n      runEach: 1000 * 60 * 5, // 5 minutes\n      /**\n       * If set to true,\n       * RxDB will await all running replications\n       * to not have a replication cycle running.\n       * This ensures we do not remove deleted documents\n       * when they might not have already been replicated.\n       * [default=true]\n       */\n      awaitReplicationsInSync: true,\n      /**\n       * If true, it will only start the cleanup\n       * when the current instance is also the leader.\n       * This ensures that when RxDB is used in multiInstance mode,\n       * only one instance will start the cleanup.\n       * [default=true]\n       */\n      waitForLeadership: true\n  }\n});\n"})}),"\n",(0,a.jsx)(n.h2,{id:"calling-cleanup-manually",children:"Calling cleanup manually"}),"\n",(0,a.jsxs)(n.p,{children:["You can manually run a cleanup per collection by calling ",(0,a.jsx)(n.code,{children:"RxCollection.cleanup()"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"\n/**\n * Manually run the cleanup with the\n * minimumDeletedTime from the cleanupPolicy.\n */\nawait myRxCollection.cleanup();\n\n\n/**\n * Overwrite the minimumDeletedTime\n * be setting it explicitly (time in milliseconds)\n */\nawait myRxCollection.cleanup(1000);\n\n/**\n * Purge all deleted documents no\n * matter when they where deleted\n * by setting minimumDeletedTime to zero.\n */\nawait myRxCollection.cleanup(0);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"using-the-cleanup-plugin-to-empty-a-collection",children:"Using the cleanup plugin to empty a collection"}),"\n",(0,a.jsxs)(n.p,{children:["When you have a collection with documents and you want to empty it by purging all documents, the recommended way is to call ",(0,a.jsx)(n.code,{children:"myRxCollection.remove()"}),". However, this will destroy the JavaScript class of the collection and stop all listeners and observables.\nSometimes the better option might be to manually delete all documents and then use the cleanup plugin to purge the deleted documents:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"// delete all documents\nawait myRxCollection.find().remove();\n// purge all deleted documents\nawait myRxCollection.cleanup(0);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"faq",children:"FAQ"}),"\n",(0,a.jsxs)(t,{children:[(0,a.jsx)("summary",{children:"When does the cleanup run"}),(0,a.jsx)("div",{children:(0,a.jsxs)(n.p,{children:["The cleanup cycles are optimized to run only when the database is idle and it is unlikely that another database interaction performance will be decreased in the meantime. For example, by default, the cleanup does not run in the first 60 seconds of the creation of a collection to ensure the initial page load of your website does not slow down. Also, we use mechanisms like the ",(0,a.jsx)(n.code,{children:"requestIdleCallback()"})," API to improve the correct timing of the cleanup cycle."]})})]})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(u,{...e})}):u(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var l=t(6540);const a={},i=l.createContext(a);function o(e){const n=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),l.createElement(i.Provider,{value:n},e.children)}}}]);