
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Replication Â· RxDB - JavaScript Database</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="replication-graphql.html" />
    
    
    <link rel="prev" href="electron.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="/" target="_blank" class="custom-link">RxDB</a>
        </li>
    
        
        <li>
            <a href="https://twitter.com/intent/user?screen_name=rxdbjs" target="_blank" class="custom-link">Follow @twitter </a>
        </li>
    
        
        <li>
            <a href="https://discord.gg/tqt9ZttJfD" target="_blank" class="custom-link">Chat @discord </a>
        </li>
    
        
        <li>
            <a href="https://github.com/pubkey/rxdb" target="_blank" class="custom-link">Star @github </a>
        </li>
    
        
        <li>
            <a href="https://github.com/sponsors/pubkey" target="_blank" class="custom-link">Donate @github </a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="quickstart.html">
            
                <a href="quickstart.html">
            
                    
                    Quickstart
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="install.html">
            
                <a href="install.html">
            
                    
                    Install
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="install.html">
            
                <a href="install.html#npm">
            
                    
                    npm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="install.html">
            
                <a href="install.html#import">
            
                    
                    import
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="dev-mode.html">
            
                <a href="dev-mode.html">
            
                    
                    Dev Mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="rx-database.html">
            
                <a href="rx-database.html">
            
                    
                    RxDatabase
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="rx-database.html">
            
                <a href="rx-database.html#creation">
            
                    
                    Creation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="rx-database.html">
            
                <a href="rx-database.html#name">
            
                    
                    name
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="rx-database.html">
            
                <a href="rx-database.html#adapter">
            
                    
                    adapter
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="rx-database.html">
            
                <a href="rx-database.html#password">
            
                    
                    password
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.4" data-path="rx-database.html">
            
                <a href="rx-database.html#multiinstance">
            
                    
                    multiInstance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.5" data-path="rx-database.html">
            
                <a href="rx-database.html#eventreduce">
            
                    
                    eventReduce
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.6" data-path="rx-database.html">
            
                <a href="rx-database.html#ignoreduplicate">
            
                    
                    ignoreDuplicate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.7" data-path="rx-database.html">
            
                <a href="rx-database.html#pouchSettings">
            
                    
                    pouchSettings
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="rx-database.html">
            
                <a href="rx-database.html#functions">
            
                    
                    Functions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="rx-database.html">
            
                <a href="rx-database.html#observe-with-">
            
                    
                    $
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="rx-database.html">
            
                <a href="rx-database.html#dump">
            
                    
                    exportJSON()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="rx-database.html">
            
                <a href="rx-database.html#importdump">
            
                    
                    importJSON()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="rx-database.html">
            
                <a href="rx-database.html#server">
            
                    
                    server()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="rx-database.html">
            
                <a href="rx-database.html#waitforleadership">
            
                    
                    waitForLeadership()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.6" data-path="rx-database.html">
            
                <a href="rx-database.html#requestidlepromise">
            
                    
                    requestIdlePromise()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7" data-path="rx-database.html">
            
                <a href="rx-database.html#destroy">
            
                    
                    destroy()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.8" data-path="rx-database.html">
            
                <a href="rx-database.html#remove">
            
                    
                    remove()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.9" data-path="rx-database.html">
            
                <a href="rx-database.html#checkadapter">
            
                    
                    checkAdapter()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.10" data-path="rx-database.html">
            
                <a href="rx-database.html#isrxdatabase">
            
                    
                    isRxDatabase()
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="rx-schema.html">
            
                <a href="rx-schema.html">
            
                    
                    RxSchema
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="rx-schema.html">
            
                <a href="rx-schema.html#example">
            
                    
                    Example
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="rx-schema.html">
            
                <a href="rx-schema.html#create-a-collection-with-the-schema">
            
                    
                    Create a collection with the schema
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="rx-schema.html">
            
                <a href="rx-schema.html#version">
            
                    
                    version
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="rx-schema.html">
            
                <a href="rx-schema.html#keycompression">
            
                    
                    keyCompression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="rx-schema.html">
            
                <a href="rx-schema.html#indexes">
            
                    
                    indexes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="rx-schema.html">
            
                <a href="rx-schema.html#attachments">
            
                    
                    attachments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="rx-schema.html">
            
                <a href="rx-schema.html#default">
            
                    
                    default
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="rx-schema.html">
            
                <a href="rx-schema.html#final">
            
                    
                    final
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="schema-validation.html">
            
                <a href="schema-validation.html">
            
                    
                    Schema Validation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="rx-collection.html">
            
                <a href="rx-collection.html">
            
                    
                    RxCollection
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="rx-collection.html">
            
                <a href="rx-collection.html#creating-a-collection">
            
                    
                    Creation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1.1" data-path="rx-collection.html">
            
                <a href="rx-collection.html#name">
            
                    
                    name
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.2" data-path="rx-collection.html">
            
                <a href="rx-collection.html#schema">
            
                    
                    schema
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.3" data-path="rx-collection.html">
            
                <a href="rx-collection.html#pouchSettings">
            
                    
                    pouchSettings
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.4" data-path="rx-collection.html">
            
                <a href="rx-collection.html#orm-functions">
            
                    
                    ORM-functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.5" data-path="rx-collection.html">
            
                <a href="rx-collection.html#Migration">
            
                    
                    Migration
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="rx-collection.html">
            
                <a href="rx-collection.html#functions">
            
                    
                    Functions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.2.1" data-path="rx-collection.html">
            
                <a href="rx-collection.html#observe-">
            
                    
                    $
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.2" data-path="rx-collection.html">
            
                <a href="rx-collection.html#insert">
            
                    
                    insert()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.3" data-path="rx-collection.html">
            
                <a href="rx-collection.html#bulkinsert">
            
                    
                    bulkInsert()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.4" data-path="rx-collection.html">
            
                <a href="rx-collection.html#bulkremove">
            
                    
                    bulkRemove()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.5" data-path="rx-collection.html">
            
                <a href="rx-collection.html#upsert">
            
                    
                    upsert()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.6" data-path="rx-collection.html">
            
                <a href="rx-collection.html#atomicupsert">
            
                    
                    atomicUpsert()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.7" data-path="rx-collection.html">
            
                <a href="rx-collection.html#find">
            
                    
                    find()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.8" data-path="rx-collection.html">
            
                <a href="rx-collection.html#findone">
            
                    
                    findOne()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.9" data-path="rx-collection.html">
            
                <a href="rx-collection.html#findbyids">
            
                    
                    findByIds()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.10" data-path="rx-collection.html">
            
                <a href="rx-collection.html#findbyids$">
            
                    
                    findByIds$()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.11" data-path="rx-collection.html">
            
                <a href="rx-collection.html#dump">
            
                    
                    exportJSON()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.12" data-path="rx-collection.html">
            
                <a href="rx-collection.html#importdump">
            
                    
                    importJSON()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.13" data-path="rx-collection.html">
            
                <a href="rx-collection.html#synccouchdb">
            
                    
                    syncCouchDB()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.14" data-path="rx-collection.html">
            
                <a href="rx-collection.html#syncgraphql">
            
                    
                    syncGraphQL()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.15" data-path="rx-collection.html">
            
                <a href="rx-collection.html#remove">
            
                    
                    remove()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.16" data-path="rx-collection.html">
            
                <a href="rx-collection.html#destroy">
            
                    
                    destroy()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.17" data-path="rx-collection.html">
            
                <a href="rx-collection.html#isrxcollection">
            
                    
                    isRxCollection()
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="rx-document.html">
            
                <a href="rx-document.html">
            
                    
                    RxDocument
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="rx-document.html">
            
                <a href="rx-document.html#insert">
            
                    
                    Insert
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="rx-document.html">
            
                <a href="rx-document.html#find">
            
                    
                    Find
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="rx-document.html">
            
                <a href="rx-document.html#functions">
            
                    
                    Functions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.3.1" data-path="rx-document.html">
            
                <a href="rx-document.html#get">
            
                    
                    get()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.2" data-path="rx-document.html">
            
                <a href="rx-document.html#get$">
            
                    
                    get$()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.3" data-path="rx-document.html">
            
                <a href="rx-document.html#proxy-get">
            
                    
                    proxy-get
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.4" data-path="rx-document.html">
            
                <a href="rx-document.html#update">
            
                    
                    update()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.5" data-path="rx-document.html">
            
                <a href="rx-document.html#atomicupdate">
            
                    
                    atomicUpdate()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.6" data-path="rx-document.html">
            
                <a href="rx-document.html#atomicpatch">
            
                    
                    atomicPatch()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.7" data-path="rx-document.html">
            
                <a href="rx-document.html#observe-">
            
                    
                    $
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.8" data-path="rx-document.html">
            
                <a href="rx-document.html#remove">
            
                    
                    remove()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.9" data-path="rx-document.html">
            
                <a href="rx-document.html#deleted$">
            
                    
                    deleted$
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.10" data-path="rx-document.html">
            
                <a href="rx-document.html#tojson">
            
                    
                    toJSON()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.11" data-path="rx-document.html">
            
                <a href="rx-document.html#set">
            
                    
                    set()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.12" data-path="rx-document.html">
            
                <a href="rx-document.html#save">
            
                    
                    save()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.13" data-path="rx-document.html">
            
                <a href="rx-document.html#isrxdocument">
            
                    
                    isRxDocument()
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="rx-query.html">
            
                <a href="rx-query.html">
            
                    
                    RxQuery
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="rx-query.html">
            
                <a href="rx-query.html#find">
            
                    
                    find()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="rx-query.html">
            
                <a href="rx-query.html#findOne">
            
                    
                    findOne()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="rx-query.html">
            
                <a href="rx-query.html#exec">
            
                    
                    exec()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="rx-query.html">
            
                <a href="rx-query.html#observe-">
            
                    
                    $
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="rx-query.html">
            
                <a href="rx-query.html#update">
            
                    
                    update()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="rx-query.html">
            
                <a href="rx-query.html#remove">
            
                    
                    remove()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="rx-query.html">
            
                <a href="rx-query.html#doesDocumentDataMatch">
            
                    
                    doesDocumentDataMatch()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="rx-query.html">
            
                <a href="rx-query.html#setting-a-specific-index">
            
                    
                    Specific Index
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9" data-path="rx-query.html">
            
                <a href="rx-query.html#examples">
            
                    
                    Examples
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.10" data-path="rx-query.html">
            
                <a href="rx-query.html#isrxquery">
            
                    
                    isRxQuery()
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="rx-attachment.html">
            
                <a href="rx-attachment.html">
            
                    
                    RxAttachment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="middleware.html">
            
                <a href="middleware.html">
            
                    
                    Middleware-hooks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="orm.html">
            
                <a href="orm.html">
            
                    
                    ORM/DRM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="population.html">
            
                <a href="population.html">
            
                    
                    Population
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="encryption.html">
            
                <a href="encryption.html">
            
                    
                    Encryption
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="key-compression.html">
            
                <a href="key-compression.html">
            
                    
                    Key Compression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="data-migration.html">
            
                <a href="data-migration.html">
            
                    
                    DataMigration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="leader-election.html">
            
                <a href="leader-election.html">
            
                    
                    LeaderElection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19" data-path="rx-storage.html">
            
                <a href="rx-storage.html">
            
                    
                    RxStorage
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.19.1" data-path="rx-storage-pouchdb.html">
            
                <a href="rx-storage-pouchdb.html">
            
                    
                    RxStorage PouchDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.2" data-path="adapters.html">
            
                <a href="adapters.html">
            
                    
                    PouchDB Adapters
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.3" data-path="rx-storage-dexie.html">
            
                <a href="rx-storage-dexie.html">
            
                    
                    RxStorage Dexie.js
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.4" data-path="rx-storage-lokijs.html">
            
                <a href="rx-storage-lokijs.html">
            
                    
                    RxStorage LokiJS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.5" data-path="rx-storage-memory.html">
            
                <a href="rx-storage-memory.html">
            
                    
                    RxStorage Memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.6" data-path="rx-storage-indexeddb.html">
            
                <a href="rx-storage-indexeddb.html">
            
                    
                    RxStorage IndexedDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.7" data-path="rx-storage-sqlite.html">
            
                <a href="rx-storage-sqlite.html">
            
                    
                    RxStorage SQLite
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.8" data-path="rx-storage-foundationdb.html">
            
                <a href="rx-storage-foundationdb.html">
            
                    
                    RxStorage FoundationDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.9" data-path="rx-storage-worker.html">
            
                <a href="rx-storage-worker.html">
            
                    
                    RxStorage Worker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.10" data-path="rx-storage-memory-synced.html">
            
                <a href="rx-storage-memory-synced.html">
            
                    
                    RxStorage Memory Synced
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.11" data-path="rx-storage-sharding.html">
            
                <a href="rx-storage-sharding.html">
            
                    
                    RxStorage Sharding
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.12" data-path="rx-storage-localstorage-meta-optimizer.html">
            
                <a href="rx-storage-localstorage-meta-optimizer.html">
            
                    
                    RxStorage Localstorage Meta Optimizer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19.13" data-path="electron.html">
            
                <a href="electron.html#rxstorage-electron-ipcrenderer--ipcmain">
            
                    
                    RxStorage Electron IpcRenderer & IpcMain
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.20" data-path="replication.html">
            
                <a href="replication.html">
            
                    
                    Replication
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.20.1" data-path="replication-graphql.html">
            
                <a href="replication-graphql.html">
            
                    
                    Replication GraphQL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20.2" data-path="replication-websocket.html">
            
                <a href="replication-websocket.html">
            
                    
                    Replication Websocket
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20.3" data-path="replication-couchdb-new.html">
            
                <a href="replication-couchdb-new.html">
            
                    
                    Replication CouchDB (new)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20.4" data-path="replication-p2p.html">
            
                <a href="replication-p2p.html">
            
                    
                    Replication P2P
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20.5" data-path="replication-firestore.html">
            
                <a href="replication-firestore.html">
            
                    
                    Replication Firestore
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20.6" data-path="replication-couchdb.html">
            
                <a href="replication-couchdb.html">
            
                    
                    Replication CouchDB/PouchDB
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.21" data-path="cleanup.html">
            
                <a href="cleanup.html">
            
                    
                    Cleanup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.22" data-path="backup.html">
            
                <a href="backup.html">
            
                    
                    Backup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.23" data-path="query-cache.html">
            
                <a href="query-cache.html">
            
                    
                    QueryCache
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.24" data-path="rx-local-document.html">
            
                <a href="rx-local-document.html">
            
                    
                    LocalDocuments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.25" data-path="crdt.html">
            
                <a href="crdt.html">
            
                    
                    CRDT
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.26" data-path="third-party-plugins.html">
            
                <a href="third-party-plugins.html">
            
                    
                    Third Party Plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.27" data-path="plugins.html">
            
                <a href="plugins.html">
            
                    
                    Creating Plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.28" data-path="query-optimizer.html">
            
                <a href="query-optimizer.html">
            
                    
                    Query Optimizer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.29" data-path="storage-migration.html">
            
                <a href="storage-migration.html">
            
                    
                    Storage Migration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.30" data-path="transactions-conflicts-revisions.html">
            
                <a href="transactions-conflicts-revisions.html">
            
                    
                    Transactions, Conflicts and Revisions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.31" >
            
                <a target="_blank" href="https://rxdb.info/premium.html">
            
                    
                    RxDB Premium
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.32" >
            
                <span>
            
                    
                    Tutorials
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.32.1" data-path="tutorials/typescript.html">
            
                <a href="tutorials/typescript.html">
            
                    
                    Use RxDB with Typescript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.32.2" data-path="tutorials/server-couchdb.html">
            
                <a href="tutorials/server-couchdb.html">
            
                    
                    Using the CouchDB Server Plugin
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.33" >
            
                <span>
            
                    
                    Opinions
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.33.1" data-path="offline-first.html">
            
                <a href="offline-first.html">
            
                    
                    About Offline First
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.33.2" data-path="downsides-of-offline-first.html">
            
                <a href="downsides-of-offline-first.html">
            
                    
                    Downsides of Offline First
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.33.3" data-path="slow-indexeddb.html">
            
                <a href="slow-indexeddb.html">
            
                    
                    Slow IndexedDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.33.4" data-path="why-nosql.html">
            
                <a href="why-nosql.html">
            
                    
                    Why NoSQL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.33.5" data-path="alternatives.html">
            
                <a href="alternatives.html">
            
                    
                    Alternatives
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.33.6" data-path="react-native-database.html">
            
                <a href="react-native-database.html">
            
                    
                    React Native Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.33.7" data-path="capacitor-database.html">
            
                <a href="capacitor-database.html">
            
                    
                    Capacitor Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.33.8" data-path="electron-database.html">
            
                <a href="electron-database.html">
            
                    
                    Electron Database
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.34" data-path="questions-answers.html">
            
                <a href="questions-answers.html">
            
                    
                    Questions & Answers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.35" data-path="contribute.html">
            
                <a href="contribute.html">
            
                    
                    Contribute
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.36" >
            
                <span>
            
                    
                    Release Notes
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.36.1" >
            
                <a target="_blank" href="https://github.com/pubkey/rxdb/blob/master/CHANGELOG.md">
            
                    
                    CHANGELOG
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.36.2" data-path="releases/13.0.0.html">
            
                <a href="releases/13.0.0.html">
            
                    
                    13.0.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.36.3" data-path="releases/12.0.0.html">
            
                <a href="releases/12.0.0.html">
            
                    
                    12.0.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.36.4" data-path="releases/11.0.0.html">
            
                <a href="releases/11.0.0.html">
            
                    
                    11.0.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.36.5" data-path="releases/10.0.0.html">
            
                <a href="releases/10.0.0.html">
            
                    
                    10.0.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.36.6" data-path="releases/9.0.0.html">
            
                <a href="releases/9.0.0.html">
            
                    
                    9.0.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.36.7" data-path="releases/8.0.0.html">
            
                <a href="releases/8.0.0.html">
            
                    
                    8.0.0
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Replication</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="database-replication">Database Replication</h1>
<p>The RxDB replication protocol provides the ability to replicate the database state in <strong>realtime</strong> between the clients and the server.</p>
<p>The backend server does not have to be a RxDB instance; you can build a replication with <strong>any infrastructure</strong>.
For example you can replicate with a custom GraphQL endpoint or a http server on top of a PostgreSQL database.</p>
<p>The replication is made to support the <a href="http://offlinefirst.org/" target="_blank">Offline-First</a> paradigm, so that when the client goes offline, the RxDB database can still read and write locally and will continue the replication when the client goes online again.</p>
<h2 id="replication-protocol-on-the-document-level">Replication protocol on the document level</h2>
<p>On the RxDocument level, the replication works like git, where the fork/client contains all new writes and must be merged with the master/server before it can push its new state to the master/server.</p>
<pre><code>A---B-----------D   master/server state
     \         /
      B---C---D     fork/client state
</code></pre><ul>
<li>The client pulls the latest state <code>B</code> from the master.</li>
<li>The client does some changes <code>C+D</code>.</li>
<li>The client pushes these changes to the master by sending the latest known master state <code>B</code> and the new client state <code>D</code> of the document.</li>
<li>If the master state is equal to the latest master <code>B</code> state of the client, the new client state <code>D</code> is set as the latest master state.</li>
<li>If the master also had changes and so the latest master change is different then the one that the client assumes, we have a conflict that has to be resolved on the client.</li>
</ul>
<h2 id="replication-protocol-on-the-transfer-level">Replication protocol on the transfer level</h2>
<p>When document states are transferred, all handlers use batches of documents for better performance.
The server <strong>must</strong> implement the following methods to be compatible with the replication:</p>
<ul>
<li><strong>pullHandler</strong> Get the last checkpoint (or null) as input. Returns all documents that have been written <strong>after</strong> the given checkpoint. Also returns the checkpoint of the latest written returned document.</li>
<li><strong>pushHandler</strong> a method that can be called by the client to send client side writes to the master. It gets an array with the the <code>assumedMasterState</code> and the <code>newForkState</code> of each document write as input. It must return an array that contains the master document states of all conflicts. If there are no conflicts, it must return an empty array.</li>
<li><strong>pullStream</strong> an observable that emits batches of all master writes and the latest checkpoint of the write batches.</li>
</ul>
<pre><code>        +--------+                             +--------+   
        |        | pullHandler()               |        |
        |        |---------------------&gt;       |        |   
        |        |                             |        | 
        |        |                             |        |  
        | Client | pushHandler()               | Server |  
        |        |---------------------&gt;       |        | 
        |        |                             |        |
        |        |   pullStream$               |        | 
        |        |   &lt;-------------------------|        | 
        +--------+                             +--------+
</code></pre><p>The replication runs in two <strong>different modes</strong>:</p>
<h3 id="checkpoint-iteration">Checkpoint iteration</h3>
<p>On first initial replication, or when the client comes online again, a checkpoint based iteration is used to catch up with the server state.
A checkpoint is a subset of the fields of the last pulled document. When the checkpoint is send to the backend via <code>pullHandler()</code>, the backend must be able to respond with all documents that have been written <strong>after</strong> the given checkpoint.
For example if your documents contain an <code>id</code> and an <code>updatedAt</code> field, these two can be used as checkpoint.</p>
<p>When the checkpoint iteration reaches the last checkpoint, where the backend returns an empty array because there are no newer documents, the replication will automatically switch to the <code>event observation</code> mode.</p>
<h3 id="event-observation">Event observation</h3>
<p>While the client is connected to the backend, the events from the backend are observed via <code>pullStream$</code> and persisted to the client.</p>
<p>If your backend for any reason is not able to provide a full <code>pullStream$</code> that contains all events and the checkpoint, you can instead only emit <code>RESYNC</code> events that tell RxDB that anything unknown has changed on the server and it should run the pull replication via <a href="#checkpoint-iteration">checkpoint iteration</a>.</p>
<p>When the client goes offline and online again, it might happen that the <code>pullStream$</code> has missed out some events. Therefore the <code>pullStream$</code> should also emit a <code>RESYNC</code> event each time the client reconnects, so that the client can become in sync with the backend via the <a href="#checkpoint-iteration">checkpoint iteration</a> mode.</p>
<h2 id="data-layout-on-the-server">Data layout on the server</h2>
<p>To use the replication you first have to ensure that:</p>
<ul>
<li><p><strong>documents are deterministic sortable by their last write time</strong></p>
<p><em>deterministic</em> means that even if two documents have the same <em>last write time</em>, they have a predictable sort order.
  This is most often ensured by using the <em>primaryKey</em> as second sort parameter as part of the checkpoint.</p>
</li>
<li><p><strong>documents are never deleted, instead the <code>_deleted</code> field is set to <code>true</code>.</strong></p>
<p>This is needed so that the deletion state of a document exists in the database and can be replicated with other instances. If your backend uses a different field to mark deleted documents, you have to transform the data in the push/pull handlers or with the modifiers.</p>
</li>
</ul>
<p>For example if your documents look like this:</p>
<pre><code class="lang-json">{
    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;foobar&quot;</span>,
    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Alice&quot;</span>,
    <span class="hljs-string">&quot;lastName&quot;</span>: <span class="hljs-string">&quot;Wilson&quot;</span>,
    <span class="hljs-comment">/**
     * Contains the last write timestamp
     * so all documents writes can be sorted by that value
     * when they are fetched from the remote instance.
     */</span>
    <span class="hljs-string">&quot;updatedAt&quot;</span>: <span class="hljs-number">1564483474</span>,
    <span class="hljs-comment">/**
     * Instead of physically deleting documents,
     * a deleted document gets replicated.
     */</span>
    <span class="hljs-string">&quot;_deleted&quot;</span>: <span class="hljs-literal">false</span>
}
</code></pre>
<p>Then your data is always sortable by <code>updatedAt</code>. This ensures that when RxDB fetches &apos;new&apos; changes via <code>pullHandler()</code>, it can send the latest <code>updatedAt+id</code> checkpoint to the remote endpoint and then receive all newer documents.</p>
<p>By default, the field is <code>_deleted</code>. If your remote endpoint uses a different field to mark deleted documents, you can set the <code>deletedField</code> in the replication options which will automatically map the field on all pull and push requests.</p>
<h2 id="conflict-handling">Conflict handling</h2>
<p>When multiple clients (or the server) modify the same document at the same time (or when they are offline), it can happen that a conflict arises during the replication.</p>
<pre><code>A---B1---C1---X    master/server state
     \       /
      B1---C2      fork/client state
</code></pre><p>In the case above, the client would tell the master to move the document state from <code>B1</code> to <code>C2</code> by calling <code>pushHandler()</code>. But because the actual master state is <code>C1</code> and not <code>B1</code>, the master would reject the write by sending back the actual master state <code>C1</code>. 
<strong>RxDB resolves all conflicts on the client</strong> so it would call the conflict handler of the <code>RxCollection</code> and create a new document state <code>D</code> that can then be written to the master.</p>
<pre><code>A---B1---C1---X---D    master/server state
     \       / \ /
      B1---C2---D      fork/client state
</code></pre><p>The default conflict handler will always drop the fork state and use the master state. This ensures that clients that are offline for a very long time, do not accidentally overwrite other peoples changes when they go online again.
You can specify a custom conflict handler by setting the property <code>conflictHandler</code> when calling <code>addCollection()</code>.</p>
<p>Learn how to create a <a href="transactions-conflicts-revisions.html#custom-conflict-handler">custom conflict handler</a>.</p>
<h2 id="replicaterxcollection">replicateRxCollection()</h2>
<p>You can start the replication of a single <code>RxCollection</code> by calling <code>replicateRxCollection()</code> like in the following:</p>
<pre><code class="lang-ts"><span class="hljs-keyword">import</span> { replicateRxCollection } from <span class="hljs-string">&apos;rxdb/plugins/replication&apos;</span>;
<span class="hljs-keyword">import</span> {
    lastOfArray
} from <span class="hljs-string">&apos;rxdb&apos;</span>;
<span class="hljs-keyword">const</span> replicationState = await replicateRxCollection({
    collection: myRxCollection,
    <span class="hljs-comment">/**
     * An id for the replication to identify it
     * and so that RxDB is able to resume the replication on app reload.
     * If you replicate with a remote server, it is recommended to put the
     * server url into the replicationIdentifier.
     */</span>
    replicationIdentifier: <span class="hljs-string">&apos;my-rest-replication-to-https://example.com/api/sync&apos;</span>,
    <span class="hljs-comment">/**
     * By default it will do an ongoing realtime replication.
     * By settings live: false the replication will run once until the local state
     * is in sync with the remote state, then it will cancel itself.
     * (optional), default is true.
     */</span>
    live: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">/**
     * Time in milliseconds after when a failed backend request
     * has to be retried.
     * This time will be skipped if a offline-&gt;online switch is detected
     * via navigator.onLine
     * (optional), default is 5 seconds.
     */</span>
    retryTime: <span class="hljs-number">5</span> * <span class="hljs-number">1000</span>,
    <span class="hljs-comment">/**
     * When multiInstance is true, like when you use RxDB in multiple browser tabs,
     * the replication should always run in only one of the open browser tabs.
     * If waitForLeadership is true, it will wait until the current instance is leader.
     * If waitForLeadership is false, it will start replicating, even if it is not leader.
     * [default=true]
     */</span>
    waitForLeadership: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">/**
     * If this is set to false,
     * the replication will not start automatically
     * but will wait for replicationState.start() being called.
     * (optional), default is true
     */</span>
    autoStart: <span class="hljs-literal">true</span>,

    <span class="hljs-comment">/**
     * Custom deleted field, the boolean property of the document data that
     * marks a document as being deleted.
     * If your backend uses a different fieldname then &apos;_deleted&apos;, set the fieldname here.
     * RxDB will still store the documents internally with &apos;_deleted&apos;, setting this field
     * only maps the data on the data layer.
     * 
     * If a custom deleted field contains a non-boolean value, the deleted state
     * of the documents depends on if the value is truthy or not. So instead of providing a boolean * * deleted value, you could also work with using a &apos;deletedAt&apos; timestamp instead.
     * 
     * [default=&apos;_deleted&apos;]
     */</span>
    deletedField: <span class="hljs-string">&apos;deleted&apos;</span>,

    <span class="hljs-comment">/**
     * Optional,
     * only needed when you want to replicate local changes to the remote instance.
     */</span>
    push: {
        <span class="hljs-comment">/**
         * Push handler
         */</span>
        async handler(docs) {
            <span class="hljs-comment">/**
             * Push the local documents to a remote REST server.
             */</span>
            <span class="hljs-keyword">const</span> rawResponse = await fetch(<span class="hljs-string">&apos;https://example.com/api/sync/push&apos;</span>, {
                method: <span class="hljs-string">&apos;POST&apos;</span>,
                headers: {
                    <span class="hljs-string">&apos;Accept&apos;</span>: <span class="hljs-string">&apos;application/json&apos;</span>,
                    <span class="hljs-string">&apos;Content-Type&apos;</span>: <span class="hljs-string">&apos;application/json&apos;</span>
                },
                body: <span class="hljs-built_in">JSON</span>.stringify({ docs })
            });
            <span class="hljs-comment">/**
             * Contains an array with all conflicts that appeared during this push.
             * If there were no conflicts, return an empty array.
             */</span>
            <span class="hljs-keyword">const</span> response = await rawResponse.json();
            <span class="hljs-keyword">return</span> response;
        },
        <span class="hljs-comment">/**
         * Batch size, optional
         * Defines how many documents will be given to the push handler at once.
         */</span>
        batchSize: <span class="hljs-number">5</span>,
        <span class="hljs-comment">/**
         * Modifies all documents before they are given to the push handler.
         * Can be used to swap out a custom deleted flag instead of the &apos;_deleted&apos; field.
         * (optional)
         */</span>
        modifier: d =&gt; d
    },
    <span class="hljs-comment">/**
     * Optional,
     * only needed when you want to replicate remote changes to the local state.
     */</span>
    pull: {
        <span class="hljs-comment">/**
         * Pull handler
         */</span>
        async handler(lastCheckpoint, batchSize) {
            <span class="hljs-keyword">const</span> minTimestamp = lastCheckpoint ? lastCheckpoint.updatedAt : <span class="hljs-number">0</span>;
            <span class="hljs-comment">/**
             * In this example we replicate with a remote REST server
             */</span>
            <span class="hljs-keyword">const</span> response = await fetch(
                <span class="hljs-string">`https://example.com/api/sync/?minUpdatedAt=<span class="hljs-subst">${minTimestamp}</span>&amp;limit=<span class="hljs-subst">${batchSize}</span>`</span>
            );
            <span class="hljs-keyword">const</span> documentsFromRemote = await response.json();
            <span class="hljs-keyword">return</span> {
                <span class="hljs-comment">/**
                 * Contains the pulled documents from the remote.
                 * Notice: If documentsFromRemote.length &lt; batchSize,
                 * then RxDB assumes that there are no more un-replicated documents
                 * on the backend, so the replication will switch to &apos;Event observation&apos; mode.
                 */</span>
                documents: documentsFromRemote,
                <span class="hljs-comment">/**
                 * The last checkpoint of the returned documents.
                 * On the next call to the pull handler,
                 * this checkpoint will be passed as &apos;lastCheckpoint&apos;
                 */</span>
                checkpoint: documentsFromRemote.length === <span class="hljs-number">0</span> ? lastCheckpoint : {
                    id: lastOfArray(documentsFromRemote).id,
                    updatedAt: lastOfArray(documentsFromRemote).updatedAt
                }
            };
        },
        batchSize: <span class="hljs-number">10</span>,
        <span class="hljs-comment">/**
         * Modifies all documents after they have been pulled
         * but before they are used by RxDB.
         * (optional)
         */</span>
        modifier: d =&gt; d,
        <span class="hljs-comment">/**
         * Stream of the backend document writes.
         * See below.
         * You only need a stream$ when you have set live=true
         */</span>
        stream$: pullStream$.asObservable()
    },
});


<span class="hljs-comment">/**
 * Creating the pull stream for realtime replication.
 * Here we use a websocket but any other way of sending data to the client can be used,
 * like long polling or server-send events.
 */</span>
<span class="hljs-keyword">const</span> pullStream$ = <span class="hljs-keyword">new</span> Subject&lt;RxReplicationPullStreamItem&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt;&gt;();
<span class="hljs-keyword">let</span> firstOpen = <span class="hljs-literal">true</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connectSocket</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> WebSocket(<span class="hljs-string">&apos;wss://example.com/api/sync/stream&apos;</span>);
    <span class="hljs-comment">/**
     * When the backend sends a new batch of documents+checkpoint,
     * emit it into the stream$.
     * 
     * event.data must look like this
     * {
     *     documents: [
     *        {
     *            id: &apos;foobar&apos;,
     *            _deleted: false,
     *            updatedAt: 1234
     *        }
     *     ],
     *     checkpoint: {
     *         id: &apos;foobar&apos;,
     *         updatedAt: 1234
     *     }
     * }
     */</span>
    socket.onmessage = event =&gt; pullStream$.next(event.data);
    <span class="hljs-comment">/**
     * Automatically reconnect the socket on close and error.
     */</span>
    socket.onclose = () =&gt; connectSocket();
    socket.onerror = () =&gt; socket.close();

    socket.onopen = () =&gt; {
        <span class="hljs-keyword">if</span>(firstOpen) {
            firstOpen = <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">/**
             * When the client is offline and goes online again,
             * it might have missed out events that happened on the server.
             * So we have to emit a RESYNC so that the replication goes
             * into &apos;Checkpoint iteration&apos; mode until the client is in sync
             * and then it will go back into &apos;Event observation&apos; mode again.
             */</span>
            pullStream$.next(<span class="hljs-string">&apos;RESYNC&apos;</span>);
        }
    }
}
</code></pre>
<h2 id="multi-tab-support">Multi Tab support</h2>
<p>For better performance, the replication runs only in one instance when RxDB is used in multiple browser tabs or Node.js processes.
By setting <code>waitForLeadership: false</code> you can enforce that each tab runs its own replication cycles.
If used in a multi instance setting, so when at database creation <code>multiInstance: false</code> was not set,
you need to import the <a href="leader-election.html">leader election plugin</a> so that RxDB can know how many instances exist and which browser tab should run the replication.</p>
<h2 id="limitations">Limitations</h2>
<ul>
<li>At the moment it is not possible to replicate <a href="rx-attachment.html">attachments</a>, make a pull request if you need this.</li>
<li>It is not possible to do a multi-master replication, like with CouchDB. RxDB always assumes that the backend is the single source of truth.</li>
</ul>
<h2 id="error-handling">Error handling</h2>
<p>When sending a document to the remote fails for any reason, RxDB will send it again in a later point in time.
This happens for <strong>all</strong> errors. The document write could have already reached the remote instance and be processed, while only the answering fails.
The remote instance must be designed to handle this properly and to not crash on duplicate data transmissions. 
Depending on your use case, it might be ok to just write the duplicate document data again.
But for a more resilient error handling you could compare the last write timestamps or add a unique write id field to the document. This field can then be used to detect duplicates and ignore re-send data.</p>
<p>Also the replication has an <code>.error$</code> stream that emits all <code>RxError</code> objects that arise during replication.
Notice that these errors are contain an inner <code>.parameters.errors</code> field that contains the original error. Also they contain a <code>.parameters.direction</code> field that indicates if the error was thrown during <code>pull</code> or <code>push</code>. You can use these to properly handle errors. For example when the client is outdated, the server might respond with a <code>426 Upgrade Required</code> error code that can then be used to force a page reload.</p>
<pre><code class="lang-ts">replicationState.error$.subscribe((error) =&gt; {
    <span class="hljs-keyword">if</span>(
        error.parameters.errors &amp;&amp;
        error.parameters.errors[<span class="hljs-number">0</span>] &amp;&amp;
        error.parameters.errors[<span class="hljs-number">0</span>].code === <span class="hljs-number">426</span>
    ) {
        <span class="hljs-comment">// client is outdated -&gt; enforce a page reload</span>
        location.reload();
    }
});
</code></pre>
<h2 id="security">Security</h2>
<p>Be aware that client side clocks can never be trusted. When you have a client-backend replication, the backend should overwrite the <code>updatedAt</code> timestamp or use another field, when it receives the change from the client.</p>
<h2 id="rxreplicationstate">RxReplicationState</h2>
<p>The function <code>replicateRxCollection()</code> returns a <code>RxReplicationState</code> that can be used to manage and observe the replication.</p>
<h3 id="observable">Observable</h3>
<p>To observe the replication, the <code>RxReplicationState</code> has some <code>Observable</code> properties:</p>
<pre><code class="lang-ts"><span class="hljs-comment">// emits each document that was received from the remote</span>
myRxReplicationState.received$.subscribe(doc =&gt; <span class="hljs-built_in">console</span>.dir(doc));

<span class="hljs-comment">// emits each document that was send to the remote</span>
myRxReplicationState.send$.subscribe(doc =&gt; <span class="hljs-built_in">console</span>.dir(doc));

<span class="hljs-comment">// emits all errors that happen when running the push- &amp; pull-handlers.</span>
myRxReplicationState.error$.subscribe(error =&gt; <span class="hljs-built_in">console</span>.dir(error));

<span class="hljs-comment">// emits true when the replication was canceled, false when not.</span>
myRxReplicationState.canceled$.subscribe(bool =&gt; <span class="hljs-built_in">console</span>.dir(bool));

<span class="hljs-comment">// emits true when a replication cycle is running, false when not.</span>
myRxReplicationState.active$.subscribe(bool =&gt; <span class="hljs-built_in">console</span>.dir(bool));
</code></pre>
<h3 id="awaitinitialreplication">awaitInitialReplication()</h3>
<p>With <code>awaitInitialReplication()</code> you can await the initial replication that is done when a full replication cycle was finished for the first time.</p>
<p><strong>WARNING:</strong> When <code>multiInstance: true</code> and <code>waitForLeadership: true</code> and another tab is already running the replication, <code>awaitInitialReplication()</code> will not resolve until the other tab is closed and the replication starts in this tab.</p>
<pre><code class="lang-ts">await myRxReplicationState.awaitInitialReplication();
</code></pre>
<h3 id="awaitinsync">awaitInSync()</h3>
<p>Returns a <code>Promise</code> that resolves when:</p>
<ul>
<li><code>awaitInitialReplication()</code> has emitted.</li>
<li>All local data is replicated with the remote.</li>
<li>No replication cycle is running or in retry-state.</li>
</ul>
<p><strong>WARNING:</strong> When <code>multiInstance: true</code> and <code>waitForLeadership: true</code> and another tab is already running the replication, <code>awaitInSync()</code> will not resolve until the other tab is closed and the replication starts in this tab.</p>
<pre><code class="lang-ts">await myRxReplicationState.awaitInSync();
</code></pre>
<h3 id="resync">reSync()</h3>
<p>Triggers a <code>RESYNC</code> cycle where the replication goes into <a href="#checkpoint-iteration">checkpoint iteration</a> until the client is in sync with the backend. Used in unit tests or when no proper <code>pull.stream$</code> can be implemented so that the client only knows that something has been changed but not what.</p>
<pre><code class="lang-ts">myRxReplicationState.reSync();
</code></pre>
<p>If your backend is not capable of sending events to the client at all, you could run <code>reSync()</code> in an interval so that the client will automatically fetch server changes after some time at least.</p>
<pre><code class="lang-ts"><span class="hljs-comment">// trigger RESYNC each 10 seconds.</span>
setInterval(() =&gt; myRxReplicationState.reSync(), <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>);
</code></pre>
<h3 id="cancel">cancel()</h3>
<p>Cancels the replication. Returns a promise that resolved when everything has been cleaned up.</p>
<pre><code class="lang-ts">await myRxReplicationState.cancel()
</code></pre>
<h3 id="isstopped">isStopped()</h3>
<p>Returns <code>true</code> if the replication is stopped. This can be if a non-live replication is finished or a replication got canceled.</p>
<pre><code class="lang-js">replicationState.isStopped(); <span class="hljs-comment">// true/false</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="electron.html#rxstorage-electron-ipcrenderer--ipcmain" class="navigation navigation-prev " aria-label="Previous page: RxStorage Electron IpcRenderer & IpcMain">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="replication-graphql.html" class="navigation navigation-next " aria-label="Next page: Replication GraphQL">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Replication","level":"1.20","depth":1,"next":{"title":"Replication GraphQL","level":"1.20.1","depth":2,"path":"replication-graphql.md","ref":"./replication-graphql.md","articles":[]},"previous":{"title":"RxStorage Electron IpcRenderer & IpcMain","level":"1.19.13","depth":2,"anchor":"#rxstorage-electron-ipcrenderer--ipcmain","path":"electron.md","ref":"./electron.md#rxstorage-electron-ipcrenderer--ipcmain","articles":[]},"dir":"ltr"},"config":{"plugins":["edit-link","github","custom-favicon","-sharing","expandable-chapters","scripts"],"root":".","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"github":{"url":"https://github.com/pubkey/rxdb"},"scripts":{"files":["./analytics.js","./next-button.js"]},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"favicon":"./files/logo/icon.ico","custom-favicon":{},"edit-link":{"label":"Edit This Page","base":"https://github.com/pubkey/rxdb/tree/master/docs-src"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"expandable-chapters":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"RxDB - JavaScript Database","links":{"sidebar":{"RxDB":"/","Follow @twitter ":"https://twitter.com/intent/user?screen_name=rxdbjs","Chat @discord ":"https://discord.gg/tqt9ZttJfD","Star @github ":"https://github.com/pubkey/rxdb","Donate @github ":"https://github.com/sponsors/pubkey"}},"gitbook":"3.2.3"},"file":{"path":"replication.md","mtime":"","type":"markdown"},"gitbook":{"version":"3.2.3","time":""},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-scripts/28fd35f20e40e37a9994a4812fc3c7cc-analytics.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-scripts/9bc541ba5d318730a5b44c9770ae18fc-next-button.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

