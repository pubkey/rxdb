<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-articles/javascript-vector-database" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Local JavaScript Vector Database that works offline | RxDB - JavaScript Database</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://rxdb.info/img/rxdb_social_card.png"><meta data-rh="true" name="twitter:image" content="https://rxdb.info/img/rxdb_social_card.png"><meta data-rh="true" property="og:url" content="https://rxdb.info/articles/javascript-vector-database.html"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Local JavaScript Vector Database that works offline | RxDB - JavaScript Database"><meta data-rh="true" name="description" content="Create a blazing-fast vector database in JavaScript. Leverage RxDB and transformers.js for instant, offline semantic search - no servers required!"><meta data-rh="true" property="og:description" content="Create a blazing-fast vector database in JavaScript. Leverage RxDB and transformers.js for instant, offline semantic search - no servers required!"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rxdb.info/articles/javascript-vector-database.html"><link data-rh="true" rel="alternate" href="https://rxdb.info/articles/javascript-vector-database.html" hreflang="en"><link data-rh="true" rel="alternate" href="https://rxdb.info/articles/javascript-vector-database.html" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-62D63SY3S0"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-62D63SY3S0",{})</script>
<link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var g=t.getElementsByTagName(a)[0],m=t.createElement(a);m.async=!0,m.src="https://www.googletagmanager.com/gtm.js?id=GTM-PL63TR5",g.parentNode.insertBefore(m,g)}(window,document,"script","dataLayer")</script>





<meta name="theme-color" content="#ed168f">
<link rel="icon" type="image/svg+xml" href="/files/logo/logo.svg">
<link rel="apple-touch-icon" href="/img/apple-touch-icon.png" sizes="180x180">
<link rel="preconnect" href="https://consentcdn.cookiebot.com/">
<link rel="preconnect" href="https://consent.cookiebot.com/">
<link rel="preconnect" href="https://region1.analytics.google.com/">
<link rel="preconnect" href="https://www.redditstatic.com/">
<link rel="preconnect" href="https://pixel-config.reddit.com/"><link rel="stylesheet" href="/assets/css/styles.2ef26a93.css">
<script src="/assets/js/runtime~main.4baf12f6.js" defer="defer"></script>
<script src="/assets/js/main.ea6b8f7a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PL63TR5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>


<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme","dark"),document.documentElement.setAttribute("data-theme-choice","dark"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/files/logo/logo_text_white.svg"><link rel="preload" as="image" href="../files/logo/rxdb_javascript_database.svg"><link rel="preload" as="image" href="../files/icons/transformers.js.svg"><link rel="preload" as="image" href="../files/vector-database-result.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/files/logo/logo_text_white.svg" alt="RxDB" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/files/logo/logo_text_white.svg" alt="RxDB" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/overview.html">Docs</a><div class="dropdown-wrapper"><a class="navbar__item navbar__link" dropdown="sync" href="/replication.html">Sync</a></div><div class="dropdown-wrapper"><a class="navbar__item navbar__link" dropdown="storages" href="/rx-storage.html">Storages</a></div><a class="navbar__item navbar__link" href="/premium/">Premium</a><a class="navbar__item navbar__link" href="/consulting/">Support</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="/chat/" class="navbar__item navbar__link navbar-icon navbar__item navbar-icon-discord" target="_blank"> </a><a href="/code/" class="navbar__item navbar__link navbar-icon navbar__item navbar-icon-github" target="_blank"> </a></div></div><div class="navbar-line" style="position:fixed;left:0;z-index:10;height:2px;width:100vw;background-color:var(--color-top);border-top-right-radius:2px;border-bottom-right-radius:2px;transform-origin:left center;will-change:transform;backface-visibility:hidden;contain:layout;transform:scaleX(0)"></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_mhZE"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_Y1UP"><div style="padding:10px;padding-top:30px;margin-left:auto;margin-right:auto"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" aria-label="Search" class="navbar__search-input search-bar" style="margin-left:auto;margin-right:auto;display:block"></div></div><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/overview.html"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/overview.html"><span title="Overview" class="linkLabel_WmDU">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/quickstart.html"><span title="ðŸš€ Quickstart" class="linkLabel_WmDU">ðŸš€ Quickstart</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/install.html"><span title="Installation" class="linkLabel_WmDU">Installation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/dev-mode.html"><span title="Development Mode" class="linkLabel_WmDU">Development Mode</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tutorials/typescript.html"><span title="TypeScript Setup" class="linkLabel_WmDU">TypeScript Setup</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/rx-database.html"><span title="Core Entities" class="categoryLinkLabel_W154">Core Entities</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/rx-storage.html"><span title="ðŸ’¾ Storages" class="categoryLinkLabel_W154">ðŸ’¾ Storages</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/schema-validation.html"><span title="Storage Wrappers" class="categoryLinkLabel_W154">Storage Wrappers</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/replication.html"><span title="ðŸ”„ Replication" class="categoryLinkLabel_W154">ðŸ”„ Replication</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/rx-server.html"><span title="Server" class="categoryLinkLabel_W154">Server</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/transactions-conflicts-revisions.html"><span title="How RxDB works" class="categoryLinkLabel_W154">How RxDB works</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/migration-schema.html"><span title="Advanced Features" class="categoryLinkLabel_W154">Advanced Features</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/migration-schema.html"><span title="Migration" class="categoryLinkLabel_W154">Migration</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rx-attachment.html"><span title="Attachments" class="linkLabel_WmDU">Attachments</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rx-pipeline.html"><span title="RxPipelines" class="linkLabel_WmDU">RxPipelines</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reactivity.html"><span title="Custom Reactivity" class="linkLabel_WmDU">Custom Reactivity</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rx-state.html"><span title="RxState" class="linkLabel_WmDU">RxState</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rx-local-document.html"><span title="Local Documents" class="linkLabel_WmDU">Local Documents</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cleanup.html"><span title="Cleanup" class="linkLabel_WmDU">Cleanup</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/backup.html"><span title="Backup" class="linkLabel_WmDU">Backup</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/leader-election.html"><span title="Leader Election" class="linkLabel_WmDU">Leader Election</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/middleware.html"><span title="Middleware" class="linkLabel_WmDU">Middleware</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/crdt.html"><span title="CRDT" class="linkLabel_WmDU">CRDT</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/population.html"><span title="Population" class="linkLabel_WmDU">Population</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/orm.html"><span title="ORM" class="linkLabel_WmDU">ORM</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/fulltext-search.html"><span title="Fulltext Search ðŸ‘‘" class="linkLabel_WmDU">Fulltext Search ðŸ‘‘</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/articles/javascript-vector-database.html"><span title="Vector Database" class="linkLabel_WmDU">Vector Database</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/query-optimizer.html"><span title="Query Optimizer ðŸ‘‘" class="linkLabel_WmDU">Query Optimizer ðŸ‘‘</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/third-party-plugins.html"><span title="Third Party Plugins" class="linkLabel_WmDU">Third Party Plugins</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/rx-storage-performance.html"><span title="Performance" class="categoryLinkLabel_W154">Performance</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/releases/16.0.0.html"><span title="Releases" class="categoryLinkLabel_W154">Releases</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/articles/browser-database.html"><span title="Articles" class="categoryLinkLabel_W154">Articles</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contribution.html"><span title="Contribute" class="linkLabel_WmDU">Contribute</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/consulting/"><span title="Contact" class="categoryLinkLabel_W154">Contact</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Local Vector Database with RxDB and transformers.js in JavaScript</h1></header>
<p>The <a class="" href="/offline-first.html">local-first</a> revolution is here, changing the way we build apps! Imagine a world where your app&#x27;s data lives right on the user&#x27;s device, always available, even when there&#x27;s no internet. That&#x27;s the magic of local-first apps. Not only do they bring faster performance and limitless scalability, but they also empower users to work offline without missing a beat. And leading the charge in this space are local database solutions, like <a href="https://rxdb.info/" target="_blank" rel="noopener noreferrer" class="">RxDB</a>.</p>
<center><a href="https://rxdb.info/"><img src="../files/logo/rxdb_javascript_database.svg" alt="JavaScript Database" width="220"></a></center>
<p>But here&#x27;s where things get even more exciting: when building <a class="" href="/articles/local-first-future.html">local-first</a> apps, traditional databases often fall short. They&#x27;re great at searching for exact matches, like <code>numbers</code> or <code>strings</code>, but what if you want to search by <strong>meaning</strong>, like sifting through emails to find a specific topic? Sure, you could use <strong>RegExp</strong>, but to truly unlock the power of semantic search and similarity-based queries, you need something more cutting-edge. Something that really understands the content of the data.</p>
<p>Enter <strong>vector databases</strong>, the game-changers for searching data by meaning! They have unlocked these new possibilities for storing and querying data, especially in tasks requiring <strong>semantic search</strong> and <strong>similarity-based</strong> queries. With the help of a <strong>machine learning model</strong>, data is transformed into a vector representation that can be stored, queried and compared in a database.</p>
<p>But unfortunately, most vector databases are designed for server-side use, typically running in large cloud clusters, not to run on a users device. To fix that, in this article, we will combine <strong>RxDB</strong> and <strong>transformers.js</strong> to create a local vector database running in the <strong>browser</strong> with <strong>JavaScript</strong>. It stores data in <strong>IndexedDB</strong>, and uses a machine learning model with <strong>WebAssembly</strong> locally, without the need for external servers.</p>
<ul>
<li class="">
<p><a href="https://github.com/xenova/transformers.js" target="_blank" rel="noopener noreferrer" class="">transformers.js</a> is a powerful framework that allows machine learning models to run directly within JavaScript using WebAssembly or WebGPU.</p>
</li>
<li class="">
<p><a href="https://rxdb.info/" target="_blank" rel="noopener noreferrer" class="">RxDB</a> is a NoSQL, local-first database with a flexible storage layer that can run on any JavaScript runtime, including browsers and mobile environments. (You are reading this article on the RxDB docs).</p>
</li>
</ul>
<p>A local vector database offers several key benefits:</p>
<ul>
<li class=""><strong>Zero network latency</strong>: Data is processed locally on the user&#x27;s device, ensuring near-instant responses.</li>
<li class=""><strong>Offline functionality</strong>: Data can be queried even without an internet connection.</li>
<li class=""><strong>Enhanced privacy</strong>: Sensitive information remains on the device, never needing to leave for external processing.</li>
<li class=""><strong>Simple setup</strong>: No backend servers are required, making deployment straightforward.</li>
<li class=""><strong>Cost savings</strong>: By running everything locally, you avoid fees for API access or cloud services for large language models.</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>In this article only the important source code parts are shown. You can find the full open-source vector database implementation at the <a href="https://github.com/pubkey/javascript-vector-database" target="_blank" rel="noopener noreferrer" class="">github repository</a>.</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-a-vector-database">What is a Vector Database?<a href="#what-is-a-vector-database" class="hash-link" aria-label="Direct link to What is a Vector Database?" title="Direct link to What is a Vector Database?" translate="no">â€‹</a></h2>
<p>A vector database is a specialized database optimized for storing and querying data in the form of <strong>high-dimensional</strong> vectors, often referred to as <strong>embeddings</strong>. These embeddings are numerical representations of data, such as text, images, or audio, created by machine learning models like <a href="https://huggingface.co/Xenova/all-MiniLM-L6-v2" target="_blank" rel="noopener noreferrer" class="">MiniLM</a>. Unlike traditional databases that work with exact matches on predefined fields, vector databases focus on <strong>semantic similarity</strong>, allowing you to query data based on meaning rather than exact values.</p>
<blockquote>
<p>A vector, or embedding, is essentially an array of numbers, like <code>[0.56, 0.12, -0.34, -0.90]</code>.</p>
</blockquote>
<p>For example, instead of asking &quot;Which document has the word &#x27;database&#x27;?&quot;, you can query &quot;Which documents discuss similar topics to this one?&quot; The vector database compares embeddings and returns results based on how similar the vectors are to each other.</p>
<p>Vector databases handle multiple types of data beyond <strong>text</strong>, including <strong>images</strong>, <strong>videos</strong>, and <strong>audio</strong> files, all transformed into embeddings for efficient querying. Mostly you would not train a model by yourself and instead use one of the public available <a href="https://huggingface.co/models?pipeline_tag=feature-extraction&amp;library=transformers.js" target="_blank" rel="noopener noreferrer" class="">transformer models</a>.</p>
<p>Vector databases are highly effective in various types of applications:</p>
<ul>
<li class=""><strong>Similarity Search</strong>: Finds the closest matches to a query, even when the query doesn&#x27;t contain the exact terms.</li>
<li class=""><strong>Clustering</strong>: Groups similar items based on the proximity of their vector representations.</li>
<li class=""><strong>Recommendations</strong>: Suggests items based on shared characteristics.</li>
<li class=""><strong>Anomaly Detection</strong>: Identifies outliers that differ from the norm.</li>
<li class=""><strong>Classification</strong>: Assigns categories to data based on its vector&#x27;s nearest neighbors.</li>
</ul>
<p>In this tutorial, we will build a vector database designed as a <strong>Similarity Search</strong> for <strong>text</strong>. For other use cases, the setup can be adapted accordingly. This flexibility is why <a href="https://rxdb.info/" target="_blank" rel="noopener noreferrer" class="">RxDB</a> doesn&#x27;t provide a dedicated vector-database plugin, but rather offers utility functions to help you build your own vector search system.</p>
<center><img src="../files/icons/transformers.js.svg" alt="transformers.js" width="40"></center>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="generating-embeddings-locally-in-a-browser">Generating Embeddings Locally in a Browser<a href="#generating-embeddings-locally-in-a-browser" class="hash-link" aria-label="Direct link to Generating Embeddings Locally in a Browser" title="Direct link to Generating Embeddings Locally in a Browser" translate="no">â€‹</a></h2>
<p>For the first step to build a local-first vector database we need to compute embeddings directly on the user&#x27;s device. This is where <a href="https://github.com/xenova/transformers.js" target="_blank" rel="noopener noreferrer" class="">transformers.js</a> from <a href="https://huggingface.co/docs/transformers.js/index" target="_blank" rel="noopener noreferrer" class="">huggingface</a> comes in, allowing us to run machine learning models in the browser with <strong>WebAssembly</strong>. Below is an implementation of a <code>getEmbeddingFromText()</code> function, which takes a piece of text and transforms it into an embedding using the <a href="https://huggingface.co/Xenova/all-MiniLM-L6-v2" target="_blank" rel="noopener noreferrer" class="">Xenova/all-MiniLM-L6-v2</a> model:</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="js" data-theme="css-variables"><code data-language="js" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">import</span><span style="color:var(--shiki-foreground)"> { pipeline } </span><span style="color:var(--shiki-token-keyword)">from</span><span style="color:var(--shiki-token-string-expression)"> &quot;@xenova/transformers&quot;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> pipePromise</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-function)"> pipeline</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-string-expression)">&#x27;feature-extraction&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-string-expression)"> &#x27;Xenova/all-MiniLM-L6-v2&#x27;</span><span style="color:var(--shiki-foreground)">);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">async</span><span style="color:var(--shiki-token-keyword)"> function</span><span style="color:var(--shiki-token-function)"> getEmbeddingFromText</span><span style="color:var(--shiki-foreground)">(text) {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">  const</span><span style="color:var(--shiki-token-constant)"> pipe</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-foreground)"> pipePromise;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">  const</span><span style="color:var(--shiki-token-constant)"> output</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-function)"> pipe</span><span style="color:var(--shiki-foreground)">(text</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    pooling</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &quot;mean&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    normalize</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> true</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">  });</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">  return</span><span style="color:var(--shiki-token-constant)"> Array</span><span style="color:var(--shiki-token-function)">.from</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">output</span><span style="color:var(--shiki-foreground)">.data);</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">}</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>This function creates an embedding by running the text through a pre-trained model and returning it in the form of an array of numbers, which can then be stored and further processed locally.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Vector embeddings from different machine learning models or versions are not compatible with each other. When you change your model, you have to recreate all embeddings for your data.</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="storing-the-embeddings-in-rxdb">Storing the Embeddings in RxDB<a href="#storing-the-embeddings-in-rxdb" class="hash-link" aria-label="Direct link to Storing the Embeddings in RxDB" title="Direct link to Storing the Embeddings in RxDB" translate="no">â€‹</a></h2>
<p>To store the embeddings, first we have to create our <a class="" href="/rx-database.html">RxDB Database</a> with the <a class="" href="/rx-storage-localstorage.html">localstorage storage</a> that stores data in the browsers <a class="" href="/articles/localstorage.html">localstorage</a>. For more advanced projects, you can use any other <a class="" href="/rx-storage.html">RxStorage</a>.</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">import</span><span style="color:var(--shiki-foreground)"> { createRxDatabase } </span><span style="color:var(--shiki-token-keyword)">from</span><span style="color:var(--shiki-token-string-expression)"> &#x27;rxdb&#x27;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">import</span><span style="color:var(--shiki-foreground)"> { getRxStorageLocalstorage } </span><span style="color:var(--shiki-token-keyword)">from</span><span style="color:var(--shiki-token-string-expression)"> &#x27;rxdb/plugins/storage-localstorage&#x27;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> db</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-function)"> createRxDatabase</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    name</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;mydatabase&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    storage</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-function)"> getRxStorageLocalstorage</span><span style="color:var(--shiki-foreground)">()</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">});</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>Then we add a <code>items</code> collection that stores our documents with the <code>text</code> field that stores the content.</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">await</span><span style="color:var(--shiki-token-constant)"> db</span><span style="color:var(--shiki-token-function)">.addCollections</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">  items</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    schema</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        version</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> 0</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        primaryKey</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;id&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        type</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;object&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        properties</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            id</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                type</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;string&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                maxLength</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> 20</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            text</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                type</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;string&#x27;</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        required</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> [</span><span style="color:var(--shiki-token-string-expression)">&#x27;id&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-string-expression)"> &#x27;text&#x27;</span><span style="color:var(--shiki-foreground)">]</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">  }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">});</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> itemsCollection</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> db</span><span style="color:var(--shiki-foreground)">.items;</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>In our <a href="https://github.com/pubkey/javascript-vector-database" target="_blank" rel="noopener noreferrer" class="">example repo</a>, we use the <a href="https://huggingface.co/datasets/Supabase/wikipedia-en-embeddings" target="_blank" rel="noopener noreferrer" class="">Wiki Embeddings</a> dataset from supabase which was transformed and used to fill up the <code>items</code> collection with test data.</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> imported</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-constant)"> itemsCollection</span><span style="color:var(--shiki-token-function)">.count</span><span style="color:var(--shiki-foreground)">()</span><span style="color:var(--shiki-token-function)">.exec</span><span style="color:var(--shiki-foreground)">();</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> response</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-function)"> fetch</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-string-expression)">&#x27;./files/items.json&#x27;</span><span style="color:var(--shiki-foreground)">);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> items</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-constant)"> response</span><span style="color:var(--shiki-token-function)">.json</span><span style="color:var(--shiki-foreground)">();</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> insertResult</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-constant)"> itemsCollection</span><span style="color:var(--shiki-token-function)">.bulkInsert</span><span style="color:var(--shiki-foreground)">(</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    items</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">);</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>Also we need a <code>vector</code> collection that stores our embeddings.
RxDB, as a NoSQL database, allows for the storage of flexible data structures, such as embeddings, within documents. To achieve this, we need to define a <a class="" href="/rx-schema.html">schema</a> that specifies how the embeddings will be stored alongside each document. The schema includes fields for an <code>id</code> and the <code>embedding</code> array itself.</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">await</span><span style="color:var(--shiki-token-constant)"> db</span><span style="color:var(--shiki-token-function)">.addCollections</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">  vector</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    schema</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        version</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> 0</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        primaryKey</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;id&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        type</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;object&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        properties</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            id</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                type</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;string&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                maxLength</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> 20</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            embedding</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                type</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;array&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                items</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    type</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;string&#x27;</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        required</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> [</span><span style="color:var(--shiki-token-string-expression)">&#x27;id&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-string-expression)"> &#x27;embedding&#x27;</span><span style="color:var(--shiki-foreground)">]</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">  }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">});</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> vectorCollection</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> db</span><span style="color:var(--shiki-foreground)">.vector;</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>When storing documents in the database, we need to ensure that the embeddings for these documents are generated and stored automatically. This requires a handler that runs during every document write, calling the machine learning model to generate the embeddings and storing them in a separate vector collection.</p>
<p>Since our app runs in a browser, it&#x27;s essential to avoid duplicate work when <strong>multiple browser tabs</strong> are open and ensure efficient use of resources. Furthermore, we want the app to resume processing documents from where it left off if it&#x27;s closed or interrupted. To achieve this, RxDB provides a <a class="" href="/rx-pipeline.html">pipeline plugin</a>, which allows us to set up a workflow that processes items and stores their embeddings. In our example, a pipeline takes batches of 10 documents, generates embeddings, and stores them in a separate vector collection.</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> pipeline</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-constant)"> itemsCollection</span><span style="color:var(--shiki-token-function)">.addPipeline</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    identifier</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;my-embeddings-pipeline&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    destination</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> vectorCollection</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    batchSize</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> 10</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-function)">    handler</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-keyword)"> async</span><span style="color:var(--shiki-foreground)"> (docs) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        await</span><span style="color:var(--shiki-token-constant)"> Promise</span><span style="color:var(--shiki-token-function)">.all</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">docs</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-keyword)">async</span><span style="color:var(--shiki-foreground)">(doc) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            const</span><span style="color:var(--shiki-token-constant)"> embedding</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-function)"> getVectorFromText</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">doc</span><span style="color:var(--shiki-foreground)">.text);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            await</span><span style="color:var(--shiki-token-constant)"> vectorCollection</span><span style="color:var(--shiki-token-function)">.upsert</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                id</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> doc</span><span style="color:var(--shiki-foreground)">.primary</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                embedding</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            });</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        }));</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">});</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>However, processing data locally presents performance challenges. Running the handler with a batch size of 10 takes around <strong>2-4 seconds per batch</strong>, meaning processing 10k documents would take up to an hour. To improve performance, we can do parallel processing using <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" target="_blank" rel="noopener noreferrer" class="">WebWorkers</a>. A WebWorker runs on a different JavaScript process and we can start and run many of them in parallel.</p>
<p>Our worker listens for messages and performance the embedding generation on each request. It then sends the result embedding back to the main thread.</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-comment)">// worker.js</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">import</span><span style="color:var(--shiki-foreground)"> { getVectorFromText } </span><span style="color:var(--shiki-token-keyword)">from</span><span style="color:var(--shiki-token-string-expression)"> &#x27;./vector.js&#x27;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-function)">onmessage</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> async</span><span style="color:var(--shiki-foreground)"> (e) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> embedding</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-function)"> getVectorFromText</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">e</span><span style="color:var(--shiki-foreground)">.</span><span style="color:var(--shiki-token-constant)">data</span><span style="color:var(--shiki-foreground)">.text);</span></span>
<span data-line=""><span style="color:var(--shiki-token-function)">    postMessage</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        id</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> e</span><span style="color:var(--shiki-foreground)">.</span><span style="color:var(--shiki-token-constant)">data</span><span style="color:var(--shiki-foreground)">.id</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        embedding</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    });</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">};</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>On the main thread we spawn one worker per core and send the tasks to the worker instead of processing them on the main thread.</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-comment)">// create one WebWorker per core</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> workers</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> new</span><span style="color:var(--shiki-token-function)"> Array</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">navigator</span><span style="color:var(--shiki-foreground)">.hardwareConcurrency)</span></span>
<span data-line=""><span style="color:var(--shiki-token-function)">    .fill</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">0</span><span style="color:var(--shiki-foreground)">)</span></span>
<span data-line=""><span style="color:var(--shiki-token-function)">    .map</span><span style="color:var(--shiki-foreground)">(() </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-token-keyword)"> new</span><span style="color:var(--shiki-token-function)"> Worker</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-keyword)">new</span><span style="color:var(--shiki-token-function)"> URL</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-string-expression)">&quot;worker.js&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-keyword)"> import</span><span style="color:var(--shiki-foreground)">.</span><span style="color:var(--shiki-token-constant)">meta</span><span style="color:var(--shiki-foreground)">.url)));</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">let</span><span style="color:var(--shiki-foreground)"> lastWorkerId </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-token-constant)"> 0</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">let</span><span style="color:var(--shiki-foreground)"> lastId </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-token-constant)"> 0</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">export</span><span style="color:var(--shiki-token-keyword)"> async</span><span style="color:var(--shiki-token-keyword)"> function</span><span style="color:var(--shiki-token-function)"> getVectorFromTextWithWorker</span><span style="color:var(--shiki-foreground)">(text</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> string</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-function)"> Promise</span><span style="color:var(--shiki-foreground)">&lt;</span><span style="color:var(--shiki-token-constant)">number</span><span style="color:var(--shiki-foreground)">[]&gt; {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    let</span><span style="color:var(--shiki-foreground)"> worker </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-foreground)"> workers[lastWorkerId</span><span style="color:var(--shiki-token-keyword)">++</span><span style="color:var(--shiki-foreground)">];</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    if</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-keyword)">!</span><span style="color:var(--shiki-foreground)">worker) {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        lastWorkerId </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-token-constant)"> 0</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        worker </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-foreground)"> workers[lastWorkerId</span><span style="color:var(--shiki-token-keyword)">++</span><span style="color:var(--shiki-foreground)">];</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    }</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> id</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-foreground)"> (lastId</span><span style="color:var(--shiki-token-keyword)">++</span><span style="color:var(--shiki-foreground)">) </span><span style="color:var(--shiki-token-keyword)">+</span><span style="color:var(--shiki-token-string-expression)"> &#x27;&#x27;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    return</span><span style="color:var(--shiki-token-keyword)"> new</span><span style="color:var(--shiki-token-constant)"> Promise</span><span style="color:var(--shiki-foreground)">&lt;</span><span style="color:var(--shiki-token-constant)">number</span><span style="color:var(--shiki-foreground)">[]&gt;(res </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        const</span><span style="color:var(--shiki-token-function)"> listener</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-foreground)"> (ev</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> any</span><span style="color:var(--shiki-foreground)">) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            if</span><span style="color:var(--shiki-foreground)"> (</span><span style="color:var(--shiki-token-constant)">ev</span><span style="color:var(--shiki-foreground)">.</span><span style="color:var(--shiki-token-constant)">data</span><span style="color:var(--shiki-foreground)">.id </span><span style="color:var(--shiki-token-keyword)">===</span><span style="color:var(--shiki-foreground)"> id) {</span></span>
<span data-line=""><span style="color:var(--shiki-token-function)">                res</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">ev</span><span style="color:var(--shiki-foreground)">.</span><span style="color:var(--shiki-token-constant)">data</span><span style="color:var(--shiki-foreground)">.embedding);</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">                worker</span><span style="color:var(--shiki-token-function)">.removeEventListener</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-string-expression)">&#x27;message&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> listener);</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        };</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">        worker</span><span style="color:var(--shiki-token-function)">.addEventListener</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-string-expression)">&#x27;message&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> listener);</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">        worker</span><span style="color:var(--shiki-token-function)">.postMessage</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            id</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            text</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        });</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    });</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> pipeline</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-constant)"> itemsCollection</span><span style="color:var(--shiki-token-function)">.addPipeline</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    identifier</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;my-embeddings-pipeline&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    destination</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> vectorCollection</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    batchSize</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> navigator</span><span style="color:var(--shiki-foreground)">.hardwareConcurrency</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-comment)"> // one per CPU core</span></span>
<span data-line=""><span style="color:var(--shiki-token-function)">    handler</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-keyword)"> async</span><span style="color:var(--shiki-foreground)"> (docs) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        await</span><span style="color:var(--shiki-token-constant)"> Promise</span><span style="color:var(--shiki-token-function)">.all</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">docs</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-keyword)">async</span><span style="color:var(--shiki-foreground)"> (doc</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> i) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            const</span><span style="color:var(--shiki-token-constant)"> embedding</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-function)"> getVectorFromTextWithWorker</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">doc</span><span style="color:var(--shiki-foreground)">.body);</span></span>
<span data-line=""><span style="color:var(--shiki-token-comment)">            /* ... */</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        });</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">});</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>This setup allows us to utilize the full hardware capacity of the client&#x27;s machine. By setting the batch size to match the number of logical processors available (using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/hardwareConcurrency" target="_blank" rel="noopener noreferrer" class="">navigator.hardwareConcurrency</a> API) and running one worker per processor, we can reduce the processing time for 10k embeddings to <strong>about 5 minutes</strong> on my developer laptop with 32 CPU cores.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="comparing-vectors-by-calculating-the-distance">Comparing Vectors by calculating the distance<a href="#comparing-vectors-by-calculating-the-distance" class="hash-link" aria-label="Direct link to Comparing Vectors by calculating the distance" title="Direct link to Comparing Vectors by calculating the distance" translate="no">â€‹</a></h2>
<p>Now that we have stored our embeddings in the database, the next step is to compare these vectors to each other. Various methods are available to measure the similarity or difference between two vectors, such as <a href="https://en.wikipedia.org/wiki/Euclidean_distance" target="_blank" rel="noopener noreferrer" class="">Euclidean distance</a>, <a href="https://www.singlestore.com/blog/distance-metrics-in-machine-learning-simplfied/" target="_blank" rel="noopener noreferrer" class="">Manhattan distance</a>, <a href="https://tomhazledine.com/cosine-similarity/" target="_blank" rel="noopener noreferrer" class="">Cosine similarity</a>, and <strong>Jaccard similarity</strong> (and more). RxDB provides utility functions for each of these methods, making it easy to choose the most suitable method for your application. In this tutorial, we will use <strong>Euclidean distance</strong> to compare vectors. However, the ideal algorithm may vary depending on your data&#x27;s distribution and the specific type of query you are performing. To find the optimal method for your app, it is up to you to try out all of these and compare the results.</p>
<p>Each method gets two vectors as input and returns a single number. Here&#x27;s how to calculate the Euclidean distance between two embeddings with the vector utilities from RxDB:</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">import</span><span style="color:var(--shiki-foreground)"> { euclideanDistance } </span><span style="color:var(--shiki-token-keyword)">from</span><span style="color:var(--shiki-token-string-expression)"> &#x27;rxdb/plugins/vector&#x27;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> distance</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-function)"> euclideanDistance</span><span style="color:var(--shiki-foreground)">(embedding1</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> embedding2);</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">console</span><span style="color:var(--shiki-token-function)">.log</span><span style="color:var(--shiki-foreground)">(distance); </span><span style="color:var(--shiki-token-comment)">// 25.20443</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>With this we can sort multiple embeddings by how good they match our search query vector.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="searching-the-vector-database-with-a-full-table-scan">Searching the Vector database with a full table scan<a href="#searching-the-vector-database-with-a-full-table-scan" class="hash-link" aria-label="Direct link to Searching the Vector database with a full table scan" title="Direct link to Searching the Vector database with a full table scan" translate="no">â€‹</a></h2>
<p>To find out if our embeddings have been stored correctly and that our vector comparison works as should, let&#x27;s run a basic query to ensure everything functions as expected. In this query, we aim to find documents similar to a given user input text. The process involves calculating the embedding from the input text, fetching all documents, calculating the distance between their embeddings and the query embedding, and then sorting them based on their similarity.</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">import</span><span style="color:var(--shiki-foreground)"> { euclideanDistance } </span><span style="color:var(--shiki-token-keyword)">from</span><span style="color:var(--shiki-token-string-expression)"> &#x27;rxdb/plugins/vector&#x27;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">import</span><span style="color:var(--shiki-foreground)"> { sortByObjectNumberProperty } </span><span style="color:var(--shiki-token-keyword)">from</span><span style="color:var(--shiki-token-string-expression)"> &#x27;rxdb/plugins/core&#x27;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> userInput</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-string-expression)"> &#x27;new york people&#x27;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> queryVector</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-function)"> getEmbeddingFromText</span><span style="color:var(--shiki-foreground)">(userInput);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> candidates</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-constant)"> vectorCollection</span><span style="color:var(--shiki-token-function)">.find</span><span style="color:var(--shiki-foreground)">()</span><span style="color:var(--shiki-token-function)">.exec</span><span style="color:var(--shiki-foreground)">();</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> withDistance</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> candidates</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(doc </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> ({ </span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    doc</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    distance</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-function)"> euclideanDistance</span><span style="color:var(--shiki-foreground)">(queryVector</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-constant)"> doc</span><span style="color:var(--shiki-foreground)">.embedding)</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">}));</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> queryResult</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> withDistance</span><span style="color:var(--shiki-token-function)">.sort</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-function)">sortByObjectNumberProperty</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-string-expression)">&#x27;distance&#x27;</span><span style="color:var(--shiki-foreground)">))</span><span style="color:var(--shiki-token-function)">.reverse</span><span style="color:var(--shiki-foreground)">();</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">console</span><span style="color:var(--shiki-token-function)">.dir</span><span style="color:var(--shiki-foreground)">(queryResult);</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>For <strong>distance</strong>-based comparisons, sorting should be in ascending order (smallest first), while for <strong>similarity</strong>-based algorithms, the sorting should be in descending order (largest first).</p></div></div>
<p>If we inspect the results, we can see that the documents returned are ordered by relevance, with the most similar document at the top:</p>
<center><img src="../files/vector-database-result.png" alt="Vector Database Result"></center>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This demo page can be <a href="https://pubkey.github.io/javascript-vector-database/" target="_blank" rel="noopener noreferrer" class="">run online here</a>.</p></div></div>
<p>However our full-scan method presents a significant challenge: it does not scale well. As the number of stored documents increases, the time taken to fetch and compare embeddings grows proportionally. For example, retrieving embeddings from our <a href="https://huggingface.co/datasets/Supabase/wikipedia-en-embeddings" target="_blank" rel="noopener noreferrer" class="">test dataset</a> of 10k documents takes around <strong>700 milliseconds</strong>. If we scale up to 100k documents, this delay would rise to approximately <strong>7 seconds</strong>, making the search process inefficient for larger datasets.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="indexing-the-embeddings-for-better-performance">Indexing the Embeddings for Better Performance<a href="#indexing-the-embeddings-for-better-performance" class="hash-link" aria-label="Direct link to Indexing the Embeddings for Better Performance" title="Direct link to Indexing the Embeddings for Better Performance" translate="no">â€‹</a></h2>
<p>To address the scalability issue, we need to store embeddings in a way that allows us to avoid fetching all of them from storage during a query. In traditional databases, you can sort documents by an <strong>index field</strong>, allowing efficient queries that retrieve only the necessary documents. An index organizes data in a structured, sortable manner, much <strong>like a phone book</strong>. However, with vector embeddings we are not dealing with simple, single values. Instead, we have large <strong>lists of numbers</strong>, which makes indexing more complex because we have more than one dimension.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="vector-indexing-methods">Vector Indexing Methods<a href="#vector-indexing-methods" class="hash-link" aria-label="Direct link to Vector Indexing Methods" title="Direct link to Vector Indexing Methods" translate="no">â€‹</a></h3>
<p>Various methods exist for indexing these vectors to improve query efficiency and performance:</p>
<ul>
<li class=""><a href="https://www.youtube.com/watch?v=Arni-zkqMBA" target="_blank" rel="noopener noreferrer" class="">Locality Sensitive Hashing (LSH)</a>: LSH hashes data so that similar items are likely to fall into the same bucket, optimizing approximate nearest neighbor searches in high-dimensional spaces by reducing the number of comparisons.</li>
<li class=""><a href="https://www.youtube.com/watch?v=77QH0Y2PYKg" target="_blank" rel="noopener noreferrer" class="">Hierarchical Small World</a>: HSW is a graph structure designed for efficient navigation, allowing quick jumps across the graph while maintaining short paths between nodes, forming the basis for HNSW&#x27;s optimization.</li>
<li class=""><a href="https://www.youtube.com/watch?v=77QH0Y2PYKg" target="_blank" rel="noopener noreferrer" class="">Hierarchical Navigable Small Worlds (HNSW)</a>: HNSW builds a hierarchical graph for fast approximate nearest neighbor search. It uses multiple layers where higher layers represent fewer, more connected nodes, improving search efficiency in large datasetsâ€‹.</li>
<li class=""><strong>Distance to samples</strong>: While testing different indexing strategies, <a href="https://github.com/pubkey" target="_blank" rel="noopener noreferrer" class="">I</a> found out that using the distance to a sample set of items is a good way to index embeddings. You pick like 5 random items of your data and get the embeddings for them out of the model. These are your 5 index vectors. For each embedding stored in the vector database, we calculate the distance to our 5 index vectors and store that <code>number</code> as an index value. This seems to work good because similar things have similar distances to other things. For example the words &quot;shoe&quot; and &quot;socks&quot; have a similar distance to &quot;boat&quot; and therefore should have roughly the same index value.</li>
</ul>
<p>When building <strong>local-first</strong> applications, performance is often a challenge, especially in JavaScript. With <strong>IndexedDB</strong>, certain operations, like many sequential <code>get by id</code> calls, <a class="" href="/slow-indexeddb.html">are slow</a>, while bulk operations, such as <code>get by index range</code>, are fast. Therefore, it&#x27;s essential to use an indexing method that allows embeddings to be stored in a sortable way, like <strong>Locality Sensitive Hashing</strong> or <strong>Distance to Samples</strong>. In this article, we&#x27;ll use <strong>Distance to Samples</strong>, because for <a href="https://github.com/pubkey" target="_blank" rel="noopener noreferrer" class="">me</a> it provides the best default behavior for the sample dataset.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="storing-indexed-embeddings-in-rxdb">Storing indexed embeddings in RxDB<a href="#storing-indexed-embeddings-in-rxdb" class="hash-link" aria-label="Direct link to Storing indexed embeddings in RxDB" title="Direct link to Storing indexed embeddings in RxDB" translate="no">â€‹</a></h3>
<p>The optimal way to store index values alongside embeddings in RxDB is to place them within the same <a class="" href="/rx-collection.html">RxCollection</a>. To ensure that the index values are both sortable and precise, we convert them into strings with a fixed length of <code>10</code> characters. This standardization helps in managing values with many decimals and ensures proper sorting in the database.</p>
<p>Here&#x27;s is our schema example schema where each document contains an embedding and corresponding index fields:</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> indexSchema</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    type</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;string&#x27;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    maxLength</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> 10</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">};</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> schema</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">    &quot;version&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> 0</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">    &quot;primaryKey&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &quot;id&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">    &quot;type&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &quot;object&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">    &quot;properties&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;id&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">            &quot;type&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &quot;string&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">            &quot;maxLength&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> 100</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;embedding&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">            &quot;type&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &quot;array&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">            &quot;items&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">                &quot;type&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &quot;number&quot;</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-comment)">        // index fields</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx0&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> indexSchema</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx1&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> indexSchema</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx2&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> indexSchema</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx3&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> indexSchema</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx4&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> indexSchema</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">    &quot;required&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> [</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;id&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;embedding&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx0&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx1&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx2&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx3&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx4&quot;</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    ]</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">    &quot;indexes&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> [</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx0&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx1&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx2&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx3&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">        &quot;idx4&quot;</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    ]</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">}</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>To populate these index fields, we modify the <a class="" href="/rx-pipeline.html">RxPipeline</a> handler accordingly to the <strong>Distance to samples</strong> method. We calculate the distance between the document&#x27;s embedding and our set of <code>5</code> index vectors. The calculated distances are converted to <code>string</code> and stored in the appropriate index fields:</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">import</span><span style="color:var(--shiki-foreground)"> { euclideanDistance } </span><span style="color:var(--shiki-token-keyword)">from</span><span style="color:var(--shiki-token-string-expression)"> &#x27;rxdb/plugins/vector&#x27;</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> sampleVectors</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> number</span><span style="color:var(--shiki-foreground)">[][] </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-foreground)"> [</span><span style="color:var(--shiki-token-comment)">/* the index vectors */</span><span style="color:var(--shiki-foreground)">];</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> pipeline</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-constant)"> itemsCollection</span><span style="color:var(--shiki-token-function)">.addPipeline</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-token-function)">    handler</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-keyword)"> async</span><span style="color:var(--shiki-foreground)"> (docs) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        await</span><span style="color:var(--shiki-token-constant)"> Promise</span><span style="color:var(--shiki-token-function)">.all</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">docs</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-keyword)">async</span><span style="color:var(--shiki-foreground)">(doc) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            const</span><span style="color:var(--shiki-token-constant)"> embedding</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-function)"> getEmbedding</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">doc</span><span style="color:var(--shiki-foreground)">.text);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            const</span><span style="color:var(--shiki-token-constant)"> docData</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-foreground)"> { id</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> doc</span><span style="color:var(--shiki-foreground)">.primary</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> embedding };</span></span>
<span data-line=""><span style="color:var(--shiki-token-comment)">            // calculate the distance to all samples and store them in the index fields</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            new</span><span style="color:var(--shiki-token-function)"> Array</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">5</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-function)">.fill</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">0</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">((_</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> idx) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">                const</span><span style="color:var(--shiki-token-constant)"> indexValue</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-function)"> euclideanDistance</span><span style="color:var(--shiki-foreground)">(sampleVectors[idx]</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> embedding);</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                docData[</span><span style="color:var(--shiki-token-string-expression)">&#x27;idx&#x27;</span><span style="color:var(--shiki-token-keyword)"> +</span><span style="color:var(--shiki-foreground)"> idx] </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-token-function)"> indexNrToString</span><span style="color:var(--shiki-foreground)">(indexValue);</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            });</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            await</span><span style="color:var(--shiki-token-constant)"> vectorCollection</span><span style="color:var(--shiki-token-function)">.upsert</span><span style="color:var(--shiki-foreground)">(docData);</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        }));</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">});</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="searching-the-vector-database-with-utilization-of-the-indexes">Searching the Vector database with utilization of the indexes<a href="#searching-the-vector-database-with-utilization-of-the-indexes" class="hash-link" aria-label="Direct link to Searching the Vector database with utilization of the indexes" title="Direct link to Searching the Vector database with utilization of the indexes" translate="no">â€‹</a></h2>
<p>Once our embeddings are stored in an indexed format, we can perform searches much <strong>more efficiently</strong> than through a full table scan. While this indexing method boosts performance, it comes with a tradeoff: a slight loss in precision, meaning that the result set may not always be the optimal one. However, this is generally acceptable for <strong>similarity search</strong> use cases.</p>
<p>There are multiple ways to leverage indexes for faster queries. Here are two effective methods:</p>
<ol>
<li class=""><strong>Query for Index Similarity in Both Directions</strong>: For each index vector, calculate the distance to the search embedding and fetch all relevant embeddings in both directions (sorted before and after) from that value.</li>
</ol>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">async</span><span style="color:var(--shiki-token-keyword)"> function</span><span style="color:var(--shiki-token-function)"> vectorSearchIndexSimilarity</span><span style="color:var(--shiki-foreground)">(searchEmbedding</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> number</span><span style="color:var(--shiki-foreground)">[]) {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> docsPerIndexSide</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> 100</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> candidates</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> new</span><span style="color:var(--shiki-token-function)"> Set</span><span style="color:var(--shiki-foreground)">&lt;</span><span style="color:var(--shiki-token-function)">RxDocument</span><span style="color:var(--shiki-foreground)">&gt;();</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    await</span><span style="color:var(--shiki-token-constant)"> Promise</span><span style="color:var(--shiki-token-function)">.all</span><span style="color:var(--shiki-foreground)">(</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        new</span><span style="color:var(--shiki-token-function)"> Array</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">5</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-function)">.fill</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">0</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-keyword)">async</span><span style="color:var(--shiki-foreground)"> (_</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> i) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            const</span><span style="color:var(--shiki-token-constant)"> distanceToIndex</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-function)"> euclideanDistance</span><span style="color:var(--shiki-foreground)">(sampleVectors[i]</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> searchEmbedding);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            const</span><span style="color:var(--shiki-foreground)"> [</span><span style="color:var(--shiki-token-constant)">docsBefore</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-constant)"> docsAfter</span><span style="color:var(--shiki-foreground)">] </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-constant)"> Promise</span><span style="color:var(--shiki-token-function)">.all</span><span style="color:var(--shiki-foreground)">([</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">                vectorCollection</span><span style="color:var(--shiki-token-function)">.find</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    selector</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                        [</span><span style="color:var(--shiki-token-string-expression)">&#x27;idx&#x27;</span><span style="color:var(--shiki-token-keyword)"> +</span><span style="color:var(--shiki-foreground)"> i]</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                            $lt</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-function)"> indexNrToString</span><span style="color:var(--shiki-foreground)">(distanceToIndex)</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                        }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    sort</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> [{ [</span><span style="color:var(--shiki-token-string-expression)">&#x27;idx&#x27;</span><span style="color:var(--shiki-token-keyword)"> +</span><span style="color:var(--shiki-foreground)"> i]</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;desc&#x27;</span><span style="color:var(--shiki-foreground)"> }]</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    limit</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> docsPerIndexSide</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                })</span><span style="color:var(--shiki-token-function)">.exec</span><span style="color:var(--shiki-foreground)">()</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">                vectorCollection</span><span style="color:var(--shiki-token-function)">.find</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    selector</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                        [</span><span style="color:var(--shiki-token-string-expression)">&#x27;idx&#x27;</span><span style="color:var(--shiki-token-keyword)"> +</span><span style="color:var(--shiki-foreground)"> i]</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                            $gt</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-function)"> indexNrToString</span><span style="color:var(--shiki-foreground)">(distanceToIndex)</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                        }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    sort</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> [{ [</span><span style="color:var(--shiki-token-string-expression)">&#x27;idx&#x27;</span><span style="color:var(--shiki-token-keyword)"> +</span><span style="color:var(--shiki-foreground)"> i]</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;asc&#x27;</span><span style="color:var(--shiki-foreground)"> }]</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    limit</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> docsPerIndexSide</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                })</span><span style="color:var(--shiki-token-function)">.exec</span><span style="color:var(--shiki-foreground)">()</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            ]);</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">            docsBefore</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(d </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-token-constant)"> candidates</span><span style="color:var(--shiki-token-function)">.add</span><span style="color:var(--shiki-foreground)">(d));</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">            docsAfter</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(d </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-token-constant)"> candidates</span><span style="color:var(--shiki-token-function)">.add</span><span style="color:var(--shiki-foreground)">(d));</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        })</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    );</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> docsWithDistance</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> Array</span><span style="color:var(--shiki-token-function)">.from</span><span style="color:var(--shiki-foreground)">(candidates)</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(doc </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        const</span><span style="color:var(--shiki-token-constant)"> distance</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-function)"> euclideanDistance</span><span style="color:var(--shiki-foreground)">((doc </span><span style="color:var(--shiki-token-keyword)">as</span><span style="color:var(--shiki-token-constant)"> any</span><span style="color:var(--shiki-foreground)">).embedding</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> searchEmbedding);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        return</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            distance</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            doc</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        };</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    });</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> sorted</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> docsWithDistance</span><span style="color:var(--shiki-token-function)">.sort</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-function)">sortByObjectNumberProperty</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-string-expression)">&#x27;distance&#x27;</span><span style="color:var(--shiki-foreground)">))</span><span style="color:var(--shiki-token-function)">.reverse</span><span style="color:var(--shiki-foreground)">();</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    return</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        result</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> sorted</span><span style="color:var(--shiki-token-function)">.slice</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">0</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-constant)"> 10</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        docReads</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    };</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">}</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<ol start="2">
<li class=""><strong>Query for an Index Range with a Defined Distance</strong>: Set an <code>indexDistance</code> and retrieve all embeddings within a specified range from the index vector to the search embedding.</li>
</ol>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">async</span><span style="color:var(--shiki-token-keyword)"> function</span><span style="color:var(--shiki-token-function)"> vectorSearchIndexRange</span><span style="color:var(--shiki-foreground)">(searchEmbedding</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> number</span><span style="color:var(--shiki-foreground)">[]) {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    await</span><span style="color:var(--shiki-token-constant)"> pipeline</span><span style="color:var(--shiki-token-function)">.awaitIdle</span><span style="color:var(--shiki-foreground)">();</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> indexDistance</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> 0.003</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> candidates</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> new</span><span style="color:var(--shiki-token-function)"> Set</span><span style="color:var(--shiki-foreground)">&lt;</span><span style="color:var(--shiki-token-function)">RxDocument</span><span style="color:var(--shiki-foreground)">&gt;();</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    let</span><span style="color:var(--shiki-foreground)"> docReads </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-token-constant)"> 0</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    await</span><span style="color:var(--shiki-token-constant)"> Promise</span><span style="color:var(--shiki-token-function)">.all</span><span style="color:var(--shiki-foreground)">(</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        new</span><span style="color:var(--shiki-token-function)"> Array</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">5</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-function)">.fill</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">0</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-keyword)">async</span><span style="color:var(--shiki-foreground)"> (_</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> i) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            const</span><span style="color:var(--shiki-token-constant)"> distanceToIndex</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-function)"> euclideanDistance</span><span style="color:var(--shiki-foreground)">(sampleVectors[i]</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> searchEmbedding);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            const</span><span style="color:var(--shiki-token-constant)"> range</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-foreground)"> distanceToIndex </span><span style="color:var(--shiki-token-keyword)">*</span><span style="color:var(--shiki-foreground)"> indexDistance;</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">            const</span><span style="color:var(--shiki-token-constant)"> docs</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-constant)"> vectorCollection</span><span style="color:var(--shiki-token-function)">.find</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                selector</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    [</span><span style="color:var(--shiki-token-string-expression)">&#x27;idx&#x27;</span><span style="color:var(--shiki-token-keyword)"> +</span><span style="color:var(--shiki-foreground)"> i]</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                        $gt</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-function)"> indexNrToString</span><span style="color:var(--shiki-foreground)">(distanceToIndex </span><span style="color:var(--shiki-token-keyword)">-</span><span style="color:var(--shiki-foreground)"> range)</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                        $lt</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-function)"> indexNrToString</span><span style="color:var(--shiki-foreground)">(distanceToIndex </span><span style="color:var(--shiki-token-keyword)">+</span><span style="color:var(--shiki-foreground)"> range)</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                    }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">                sort</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> [{ [</span><span style="color:var(--shiki-token-string-expression)">&#x27;idx&#x27;</span><span style="color:var(--shiki-token-keyword)"> +</span><span style="color:var(--shiki-foreground)"> i]</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &#x27;asc&#x27;</span><span style="color:var(--shiki-foreground)"> }]</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            })</span><span style="color:var(--shiki-token-function)">.exec</span><span style="color:var(--shiki-foreground)">();</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">            docs</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(d </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-token-constant)"> candidates</span><span style="color:var(--shiki-token-function)">.add</span><span style="color:var(--shiki-foreground)">(d));</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            docReads </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-foreground)"> docReads </span><span style="color:var(--shiki-token-keyword)">+</span><span style="color:var(--shiki-token-constant)"> docs</span><span style="color:var(--shiki-foreground)">.</span><span style="color:var(--shiki-token-constant)">length</span><span style="color:var(--shiki-foreground)">;</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        })</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    );</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> docsWithDistance</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> Array</span><span style="color:var(--shiki-token-function)">.from</span><span style="color:var(--shiki-foreground)">(candidates)</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">(doc </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        const</span><span style="color:var(--shiki-token-constant)"> distance</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-function)"> euclideanDistance</span><span style="color:var(--shiki-foreground)">((doc </span><span style="color:var(--shiki-token-keyword)">as</span><span style="color:var(--shiki-token-constant)"> any</span><span style="color:var(--shiki-foreground)">).embedding</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> searchEmbedding);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        return</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            distance</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            doc</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        };</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    });</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    const</span><span style="color:var(--shiki-token-constant)"> sorted</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-constant)"> docsWithDistance</span><span style="color:var(--shiki-token-function)">.sort</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-function)">sortByObjectNumberProperty</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-string-expression)">&#x27;distance&#x27;</span><span style="color:var(--shiki-foreground)">))</span><span style="color:var(--shiki-token-function)">.reverse</span><span style="color:var(--shiki-foreground)">();</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">    return</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        result</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> sorted</span><span style="color:var(--shiki-token-function)">.slice</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">0</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-constant)"> 10</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        docReads</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    };</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">};</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>Both methods allow you to limit the number of embeddings fetched from storage while still ensuring a reasonably precise search result. However, they differ in how many embeddings are read and how precise the results are, with trade-offs between performance and accuracy. The first method has a known embedding read amount of <code>docsPerIndexSide * 2 * [amount of indexes]</code>. The second method reads out an unknown amount of embeddings, depending on the sparsity of the dataset and the value of <code>indexDistance</code>.</p>
<p>And that&#x27;s it for the implementation. We now have a local first vector database that is able to store and query vector data.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance-benchmarks">Performance benchmarks<a href="#performance-benchmarks" class="hash-link" aria-label="Direct link to Performance benchmarks" title="Direct link to Performance benchmarks" translate="no">â€‹</a></h2>
<p>In server-side databases, performance can be improved by scaling hardware or adding more servers. However, <a class="" href="/offline-first.html">local-first</a> apps face the unique challenge that the hardware is determined by the end user, making performance unpredictable. Some users may have <strong>high-end gaming PCs</strong>, while others might be using <strong>outdated smartphones in power-saving mode</strong>. Therefore, when building a local-first app that processes more than a few documents, performance becomes a critical factor and should be thoroughly tested upfront.</p>
<p>Let&#x27;s run performance benchmarks on my <strong>high-end gaming PC</strong> to give you a sense of how long different operations take and what&#x27;s achievable.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance-of-the-query-methods">Performance of the Query Methods<a href="#performance-of-the-query-methods" class="hash-link" aria-label="Direct link to Performance of the Query Methods" title="Direct link to Performance of the Query Methods" translate="no">â€‹</a></h3>
<table><thead><tr><th>Query Method</th><th>Time in milliseconds</th><th>Docs read from storage</th></tr></thead><tbody><tr><td>Full Scan</td><td>765</td><td>10000</td></tr><tr><td>Index Similarity</td><td>1647</td><td>934</td></tr><tr><td>Index Range</td><td>88</td><td>2187</td></tr></tbody></table>
<p>As shown, the <strong>index similarity</strong> query method takes significantly longer compared to others. This is due to the need for descending sort orders in some queries <code>sort: [{ [&#x27;idx&#x27; + i]: &#x27;desc&#x27; }]</code>. While RxDB supports descending sorts, performance suffers because IndexedDB does not efficiently handle <a href="https://github.com/w3c/IndexedDB/issues/130" target="_blank" rel="noopener noreferrer" class="">reverse indexed bulk operations</a>. As a result, the <strong>index range method</strong> performs much better for this use case and should be used instead. With its query time of only <code>88</code> milliseconds it is fast enough for all most things and likely such fast that you do not even need to show a loading spinner. Also it is faster compared to fetching the query result from a server-side vector database over the internet.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance-of-the-models">Performance of the Models<a href="#performance-of-the-models" class="hash-link" aria-label="Direct link to Performance of the Models" title="Direct link to Performance of the Models" translate="no">â€‹</a></h3>
<p>Let&#x27;s also look at the time taken to calculate a single embedding across various models from the <a href="https://huggingface.co/models?pipeline_tag=feature-extraction&amp;library=transformers.js" target="_blank" rel="noopener noreferrer" class="">huggingface transformers list</a>:</p>
<table><thead><tr><th>Model Name</th><th>Time per Embedding in (ms)</th><th>Vector Size</th><th>Model Size (MB)</th></tr></thead><tbody><tr><td>Xenova/all-MiniLM-L6-v2</td><td>173</td><td>384</td><td>23</td></tr><tr><td>Supabase/gte-small</td><td>341</td><td>384</td><td>34</td></tr><tr><td>Xenova/paraphrase-multilingual-mpnet-base-v2</td><td>1000</td><td>768</td><td>279</td></tr><tr><td>jinaai/jina-embeddings-v2-base-de</td><td>1291</td><td>768</td><td>162</td></tr><tr><td>jinaai/jina-embeddings-v2-base-zh</td><td>1437</td><td>768</td><td>162</td></tr><tr><td>jinaai/jina-embeddings-v2-base-code</td><td>1769</td><td>768</td><td>162</td></tr><tr><td>mixedbread-ai/mxbai-embed-large-v1</td><td>3359</td><td>1024</td><td>337</td></tr><tr><td>WhereIsAI/UAE-Large-V1</td><td>3499</td><td>1024</td><td>337</td></tr><tr><td>Xenova/multilingual-e5-large</td><td>4215</td><td>1024</td><td>562</td></tr></tbody></table>
<p>From these benchmarks, it&#x27;s evident that models with larger vector outputs <strong>take longer to process</strong>. Additionally, the model size significantly affects performance, with larger models requiring more time to compute embeddings. This trade-off between model complexity and performance must be considered when choosing the right model for your use case.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="potential-performance-optimizations">Potential Performance Optimizations<a href="#potential-performance-optimizations" class="hash-link" aria-label="Direct link to Potential Performance Optimizations" title="Direct link to Potential Performance Optimizations" translate="no">â€‹</a></h2>
<p>There are multiple other techniques to improve the performance of your local vector database:</p>
<ul>
<li class="">
<p><strong>Shorten embeddings</strong>: The storing and retrieval of embeddings can be improved by &quot;shortening&quot; the embedding. To do that, you just strip away numbers from your vector. For example <code>[0.56, 0.12, -0.34, 0.78, -0.90]</code> becomes <code>[0.56, 0.12]</code>. That&#x27;s it, you now have a smaller embedding that is faster to read out of the storage and calculating distances is faster because it has to process less numbers. The downside is that you loose precision in your search results. Sometimes shortening the embeddings makes more sense as a pre-query step where you first compare the shortened vectors and later fetch the &quot;real&quot; vectors for the 10 most matching documents to improve their sort order.</p>
</li>
<li class="">
<p><strong>Optimize the variables in our Setup</strong>: In this examples we picked our variables in a non-optimal way. You can get huge performance improvements by setting different values:</p>
<ul>
<li class="">We picked 5 indexes for the embeddings. Using less indexes improves your query performance with the cost of less good results.</li>
<li class="">For queries that search by fetching a specific embedding distance we used the <code>indexDistance</code> value of <code>0.003</code>. Using a lower value means we read less document from the storage. This is faster but reduces the precision of the results which means we will get a less optimal result compared to a full table scan.</li>
<li class="">For queries that search by fetching a given amount of documents per index side, we set the value <code>docsPerIndexSide</code> to <code>100</code>. Increasing this value means you fetch more data from the storage but also get a better precision in the search results. Decreasing it can improve query performance with worse precision.</li>
</ul>
</li>
<li class="">
<p><strong>Use faster models</strong>: There are many ways to improve performance of machine learning models. If your embedding calculation is too slow, try other models. <strong>Smaller</strong> mostly means <strong>faster</strong>. The model <code>Xenova/all-MiniLM-L6-v2</code> which is used in this tutorial is about <a href="https://huggingface.co/Xenova/all-MiniLM-L6-v2/tree/main" target="_blank" rel="noopener noreferrer" class="">1 year old</a>. There exist better, more modern models to use. Huggingface makes these convenient to use. You only have to switch out the model name with any other model from <a href="https://huggingface.co/models?pipeline_tag=feature-extraction&amp;library=transformers.js" target="_blank" rel="noopener noreferrer" class="">that site</a>.</p>
</li>
<li class="">
<p><strong>Narrow down the search space</strong>: By utilizing other &quot;normal&quot; filter operators to your query, you can narrow down the search space and optimize performance. For example in an email search you could additionally use a operator that limits the results to all emails that are not older than one year.</p>
</li>
<li class="">
<p><strong>Dimensionality Reduction</strong> with an <a href="https://www.youtube.com/watch?v=D16rii8Azuw" target="_blank" rel="noopener noreferrer" class="">autoencoder</a>: An autoencoder encodes vector data with minimal loss which can improve the performance by having to store and compare less numbers in an embedding.</p>
</li>
<li class="">
<p><strong>Different RxDB Plugins</strong>: RxDB has different storages and plugins that can improve the performance like the <a class="" href="/rx-storage-indexeddb.html">IndexedDB RxStorage</a>, the <a class="" href="/rx-storage-opfs.html">OPFS RxStorage</a>, the <a class="" href="/rx-storage-sharding.html">sharding</a> plugin and the <a class="" href="/rx-storage-worker.html">Worker</a> and <a class="" href="/rx-storage-shared-worker.html">SharedWorker</a> storages.</p>
</li>
</ul>
<center><a href="https://rxdb.info/"><img src="../files/logo/rxdb_javascript_database.svg" alt="JavaScript Database" width="220"></a></center>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="migrating-data-on-modelindex-changes">Migrating Data on Model/Index Changes<a href="#migrating-data-on-modelindex-changes" class="hash-link" aria-label="Direct link to Migrating Data on Model/Index Changes" title="Direct link to Migrating Data on Model/Index Changes" translate="no">â€‹</a></h2>
<p>When you change the index parameter or even update the whole model which was used to create the embeddings, you have to migrate the data that is already stored on your users devices. RxDB offers the <a class="" href="/migration-schema.html">Schema Migration Plugin</a> for that.</p>
<p>When the app is reloaded and the updated source code is started, RxDB detects changes in your <a class="" href="/rx-schema.html#version">schema version</a> and runs the <a class="" href="/migration-schema.html#providing-strategies">migration strategy</a> accordingly. So to update the stored data, increase the schema version and define a handler:</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">const</span><span style="color:var(--shiki-token-constant)"> schemaV1</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">    &quot;version&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-constant)"> 1</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-token-comment)"> // &lt;- increase schema version by 1</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">    &quot;primaryKey&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-string-expression)"> &quot;id&quot;</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-string-expression)">    &quot;properties&quot;</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-comment)">        /* ... */</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-token-comment)">    /* ... */</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">};</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<p>In the migration handler we recreate the new embeddings and index values.</p>
<figure data-rehype-pretty-code-figure=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="position:relative;--prism-background-color:var(--bg-color-code);--prism-color:var(--shiki-foreground)"><pre style="background-color:var(--shiki-background);color:var(--shiki-foreground)" tabindex="0" data-language="ts" data-theme="css-variables"><code data-language="ts" data-theme="css-variables" style="display:grid"><span data-line=""><span style="color:var(--shiki-token-keyword)">await</span><span style="color:var(--shiki-token-constant)"> myDatabase</span><span style="color:var(--shiki-token-function)">.addCollections</span><span style="color:var(--shiki-foreground)">({</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">  vectors</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    schema</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> schemaV1</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    migrationStrategies</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-token-constant)">      1</span><span style="color:var(--shiki-token-keyword)">:</span><span style="color:var(--shiki-token-keyword)"> function</span><span style="color:var(--shiki-foreground)">(docData){</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        const</span><span style="color:var(--shiki-token-constant)"> embedding</span><span style="color:var(--shiki-token-keyword)"> =</span><span style="color:var(--shiki-token-keyword)"> await</span><span style="color:var(--shiki-token-function)"> getEmbedding</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">docData</span><span style="color:var(--shiki-foreground)">.body);</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        new</span><span style="color:var(--shiki-token-function)"> Array</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">5</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-function)">.fill</span><span style="color:var(--shiki-foreground)">(</span><span style="color:var(--shiki-token-constant)">0</span><span style="color:var(--shiki-foreground)">)</span><span style="color:var(--shiki-token-function)">.map</span><span style="color:var(--shiki-foreground)">((_</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> idx) </span><span style="color:var(--shiki-token-keyword)">=&gt;</span><span style="color:var(--shiki-foreground)"> {</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">            docData[</span><span style="color:var(--shiki-token-string-expression)">&#x27;idx&#x27;</span><span style="color:var(--shiki-token-keyword)"> +</span><span style="color:var(--shiki-foreground)"> idx] </span><span style="color:var(--shiki-token-keyword)">=</span><span style="color:var(--shiki-token-function)"> euclideanDistance</span><span style="color:var(--shiki-foreground)">(mySampleVectors[idx]</span><span style="color:var(--shiki-token-punctuation)">,</span><span style="color:var(--shiki-foreground)"> embedding);</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">        });</span></span>
<span data-line=""><span style="color:var(--shiki-token-keyword)">        return</span><span style="color:var(--shiki-foreground)"> docData;</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">      }</span><span style="color:var(--shiki-token-punctuation)">,</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">    }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">  }</span></span>
<span data-line=""><span style="color:var(--shiki-foreground)">});</span></span></code></pre><div class="buttonGroup_M5ko"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_IEyt" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_TrPX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_cVMy"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></figure>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="possible-future-improvements-to-local-first-vector-databases">Possible Future Improvements to Local-First Vector Databases<a href="#possible-future-improvements-to-local-first-vector-databases" class="hash-link" aria-label="Direct link to Possible Future Improvements to Local-First Vector Databases" title="Direct link to Possible Future Improvements to Local-First Vector Databases" translate="no">â€‹</a></h2>
<p>For now our vector database works and we are good to go. However there are some things to consider for the future:</p>
<ul>
<li class=""><strong>WebGPU</strong> is <a href="https://caniuse.com/webgpu" target="_blank" rel="noopener noreferrer" class="">not fully supported</a> yet. When this changes, creating embeddings in the browser have the potential to become faster. You can check if your current chrome supports WebGPU by opening <code>chrome://gpu/</code>. Notice that WebGPU has been reported to sometimes be <a href="https://github.com/xenova/transformers.js/issues/894#issuecomment-2323897485" target="_blank" rel="noopener noreferrer" class="">even slower</a> compared to WASM but likely it will be faster in the long term.</li>
<li class=""><strong>Cross-Modal AI Models</strong>: While progress is being made, AI models that can understand and integrate multiple modalities are still in development. For example you could query for an <strong>image</strong> together with a <strong>text</strong> prompt to get a more detailed output.</li>
<li class=""><strong>Multi-Step queries</strong>: In this article we only talked about having a single query as input and an ordered list of outputs. But there is big potential in chaining models or queries together where you take the results of one query and input them into a different model with different embeddings or outputs.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="follow-up">Follow Up<a href="#follow-up" class="hash-link" aria-label="Direct link to Follow Up" title="Direct link to Follow Up" translate="no">â€‹</a></h2>
<ul>
<li class="">Shared/Like my <a href="https://x.com/rxdbjs/status/1833429569434427494" target="_blank" rel="noopener noreferrer" class="">announcement tweet</a></li>
<li class="">Read the source code that belongs to this article <a href="https://github.com/pubkey/javascript-vector-database" target="_blank" rel="noopener noreferrer" class="">at github</a></li>
<li class="">Learn how to use RxDB with the <a class="" href="/quickstart.html">RxDB Quickstart</a></li>
<li class="">Check out the <a href="https://github.com/pubkey/rxdb" target="_blank" rel="noopener noreferrer" class="">RxDB github repo</a> and leave a star â­</li>
</ul></div></article><ul style="margin-top:25px;list-style-type:none"><li style="line-height:4;color:var(--expo-theme-text-secondary)">Was this page helpful?<div style="border-radius:3px;border-color:var(--fontColor-offwhite);border-style:solid;border-width:1px;vertical-align:middle;padding:5px;padding-left:8px;padding-right:8px;text-align:center;justify-content:center;display:inline-flex;margin-left:20px;cursor:pointer"><img src="/img/thumbs-up-white.svg" loading="lazy" height="14"></div><div style="border-radius:3px;border-color:var(--fontColor-offwhite);border-style:solid;border-width:1px;vertical-align:middle;padding:5px;padding-left:8px;padding-right:8px;text-align:center;justify-content:center;display:inline-flex;margin-left:20px;cursor:pointer;transform:scale(1, -1)"><img src="/img/thumbs-up-white.svg" loading="lazy" height="14"></div></li><li><a href="/chat/" target="_blank" style="color:var(--fontColor-offwhite)"><img src="/img/community-links/discord-logo.svg" style="padding-right:16px;height:18px;vertical-align:middle" loading="lazy">Ask a question on the forums about <!-- -->Local JavaScript...</a></li></ul><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a href="/fulltext-search.html" class="padding-button" style="display:inline-flex;height:auto;flex-direction:row;justify-content:left;align-items:center;gap:10px;font-size:1rem;font-weight:500;cursor:pointer;text-align:left;transition:all 0.2s ease-in-out;line-height:initial;user-select:none;box-sizing:border-box;text-decoration:none;position:relative;overflow:hidden;background:transparent;color:#fff;border:2px solid #fff;padding-top:14px;padding-bottom:14px"><span style="font-size:80%;display:contents">Previous</span><br>Â« <!-- -->Fulltext Search ðŸ‘‘</a><a href="/query-optimizer.html" class="padding-button" style="display:inline-flex;height:auto;flex-direction:row;justify-content:right;align-items:center;gap:10px;font-size:1rem;font-weight:500;cursor:pointer;text-align:right;transition:all 0.2s ease-in-out;line-height:initial;user-select:none;box-sizing:border-box;text-decoration:none;position:relative;overflow:hidden;background:transparent;color:#fff;border:2px solid #fff;padding-top:14px;padding-bottom:14px"><span style="font-size:80%;display:contents">Next</span><br>Query Optimizer ðŸ‘‘<!-- --> Â»</a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-a-vector-database" class="table-of-contents__link toc-highlight">What is a Vector Database?</a></li><li><a href="#generating-embeddings-locally-in-a-browser" class="table-of-contents__link toc-highlight">Generating Embeddings Locally in a Browser</a></li><li><a href="#storing-the-embeddings-in-rxdb" class="table-of-contents__link toc-highlight">Storing the Embeddings in RxDB</a></li><li><a href="#comparing-vectors-by-calculating-the-distance" class="table-of-contents__link toc-highlight">Comparing Vectors by calculating the distance</a></li><li><a href="#searching-the-vector-database-with-a-full-table-scan" class="table-of-contents__link toc-highlight">Searching the Vector database with a full table scan</a></li><li><a href="#indexing-the-embeddings-for-better-performance" class="table-of-contents__link toc-highlight">Indexing the Embeddings for Better Performance</a><ul><li><a href="#vector-indexing-methods" class="table-of-contents__link toc-highlight">Vector Indexing Methods</a></li><li><a href="#storing-indexed-embeddings-in-rxdb" class="table-of-contents__link toc-highlight">Storing indexed embeddings in RxDB</a></li></ul></li><li><a href="#searching-the-vector-database-with-utilization-of-the-indexes" class="table-of-contents__link toc-highlight">Searching the Vector database with utilization of the indexes</a></li><li><a href="#performance-benchmarks" class="table-of-contents__link toc-highlight">Performance benchmarks</a><ul><li><a href="#performance-of-the-query-methods" class="table-of-contents__link toc-highlight">Performance of the Query Methods</a></li><li><a href="#performance-of-the-models" class="table-of-contents__link toc-highlight">Performance of the Models</a></li></ul></li><li><a href="#potential-performance-optimizations" class="table-of-contents__link toc-highlight">Potential Performance Optimizations</a></li><li><a href="#migrating-data-on-modelindex-changes" class="table-of-contents__link toc-highlight">Migrating Data on Model/Index Changes</a></li><li><a href="#possible-future-improvements-to-local-first-vector-databases" class="table-of-contents__link toc-highlight">Possible Future Improvements to Local-First Vector Databases</a></li><li><a href="#follow-up" class="table-of-contents__link toc-highlight">Follow Up</a></li></ul></div></div></div></div></main></div></div></div><div class="block footer dark"><div style="display:flex;flex-wrap:wrap;gap:44px" class="content"><div class="half left"><span><a variant="text" href="/" class="footer-logo-button"><img src="/files/logo/logo_text_white.svg" alt="RxDB" loading="lazy" class="width-140-120"></a><div class="footer-community-links"><a variant="text" href="/newsletter/" target="_blank" aria-label="Newsletter"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none"><path stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22.5 13.5v-7a2 2 0 0 0-2-2h-16a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8"></path><path stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m22.5 7.5-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2.5 7.5M19.5 16.5v6M16.5 19.5h6"></path></svg></a><a variant="text" href="https://twitter.com/intent/user?screen_name=rxdbjs" target="_blank" aria-label="Twitter"><img src="/files/icons/twitter-blue.svg" alt="Twitter" loading="lazy"></a><a variant="text" href="https://www.linkedin.com/company/rxdb" target="_blank" aria-label="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 21"><g clip-path="url(#a)"><path fill="#fff" d="M17.3 17.6h-3V13c0-1 0-2.5-1.6-2.5-1.5 0-1.8 1.2-1.8 2.5v4.7H8V8h2.9v1.3a3 3 0 0 1 2.9-1.6c3 0 3.6 2 3.6 4.6zM4.5 6.6a1.7 1.7 0 1 1 0-3.5 1.7 1.7 0 0 1 0 3.5m1.5 11H3V8h3zM18.8.4H1.5A1.5 1.5 0 0 0 0 1.8v17.4a1.5 1.5 0 0 0 1.5 1.4h17.3a1.5 1.5 0 0 0 1.5-1.4V1.8A1.5 1.5 0 0 0 18.8.4"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 .4h24v20.5H0z"></path></clipPath></defs></svg></a><a variant="text" href="/code/" target="_blank" aria-label="Github"><span class="navbar-icon-github" style="width:22px;height:22px;display:inline-block"></span></a><a variant="text" href="/chat/" target="_blank" aria-label="Discord"><span class="navbar-icon-discord" style="width:22px;height:22px;display:inline-block"></span></a></div></span></div><div class="half right" style="display:flex;flex:1"><div style="display:flex"><div class="footer-links min-width-180-135"><a variant="text" href="/overview.html" target="">Docs</a><a variant="text" href="/replication.html" target="">Sync</a><a variant="text" href="/rx-storage.html" target="">Storages</a><a variant="text" href="/premium/" target="_blank">Premium</a><a variant="text" href="/consulting/" target="_blank">Support</a></div><div class="footer-links min-width-180-135"><a variant="text" href="/#reviews" target="">Our Customers</a><a variant="text" href="/consulting#become-partner" target="">Become a Partner</a><a variant="text" href="/legal-notice/" target="_blank">Legal Notice</a></div></div></div></div></div><div class="navbar-line" style="display:block;z-index:10;height:1.5px;background-color:var(--color-top);border-top-right-radius:2px;border-bottom-right-radius:2px;width:100%"></div><div class="call-to-action-popup"><div class="close"><div class="text">âœ•</div></div></div></div>
</body>
</html>